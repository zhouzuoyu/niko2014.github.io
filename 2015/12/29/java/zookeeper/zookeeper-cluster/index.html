<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="zookeeper," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="本文记录zookeeper集群的搭建过程及简单测试。
配置
zk1
tickTime=2000dataDir=/foo/datadataLogDir=/foo/logsclientPort=2181initLimit=5syncLimit=2server.1=zk1:2888:3888server.2=zk2:2889:3889server.3=zk3:2890:3890

The entries">
<meta property="og:type" content="article">
<meta property="og:title" content="【zookeeper】 集群搭建和测试">
<meta property="og:url" content="http://www.nikoai.pw/2015/12/29/java/zookeeper/zookeeper-cluster/index.html">
<meta property="og:site_name" content="保持简单">
<meta property="og:description" content="本文记录zookeeper集群的搭建过程及简单测试。
配置
zk1
tickTime=2000dataDir=/foo/datadataLogDir=/foo/logsclientPort=2181initLimit=5syncLimit=2server.1=zk1:2888:3888server.2=zk2:2889:3889server.3=zk3:2890:3890

The entries">
<meta property="og:updated_time" content="2017-10-01T18:12:35.473Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【zookeeper】 集群搭建和测试">
<meta name="twitter:description" content="本文记录zookeeper集群的搭建过程及简单测试。
配置
zk1
tickTime=2000dataDir=/foo/datadataLogDir=/foo/logsclientPort=2181initLimit=5syncLimit=2server.1=zk1:2888:3888server.2=zk2:2889:3889server.3=zk3:2890:3890

The entries">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://www.nikoai.pw/2015/12/29/java/zookeeper/zookeeper-cluster/"/>


  <title> 【zookeeper】 集群搭建和测试 | 保持简单 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c4a2e0d0f7d88e69bc22f35fd12b1f3f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">保持简单</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">简单是最难的事</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
            日程
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                【zookeeper】 集群搭建和测试
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-29T00:00:00+08:00" content="2015-12-29">
              2015-12-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/29/java/zookeeper/zookeeper-cluster/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/29/java/zookeeper/zookeeper-cluster/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文记录zookeeper集群的搭建过程及简单测试。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><hr>
<p>zk1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">dataDir=/foo/data</div><div class="line">dataLogDir=/foo/logs</div><div class="line">clientPort=2181</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">server.1=zk1:2888:3888</div><div class="line">server.2=zk2:2889:3889</div><div class="line">server.3=zk3:2890:3890</div></pre></td></tr></table></figure>
<blockquote>
<p>The entries of the form server.X list the servers that make up the ZooKeeper service. When the server starts up, it knows which server it is by looking for the file myid in the data directory. That file has the contains the server number, in ASCII.</p>
<p>Finally, note the two port numbers after each server name: “ 2888” and “3888”. Peers use the former port to connect to other peers. Such a connection is necessary so that peers can communicate, for example, to agree upon the order of updates. More specifically, a ZooKeeper server uses this port to connect followers to the leader. When a new leader arises, a follower opens a TCP connection to the leader using this port. Because the default leader election also uses TCP, we currently require another port for leader election. This is the second port in the server entry.</p>
</blockquote>
<p>zk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">dataDir=/foo/data</div><div class="line">dataLogDir=/foo/logs</div><div class="line">clientPort=2182</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">server.1=zk1:2888:3888</div><div class="line">server.2=zk2:2889:3889</div><div class="line">server.3=zk3:2890:3890</div></pre></td></tr></table></figure>
<p>zk3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">dataDir=/foo/data</div><div class="line">dataLogDir=/foo/logs</div><div class="line">clientPort=2183</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">server.1=zk1:2888:3888</div><div class="line">server.2=zk2:2889:3889</div><div class="line">server.3=zk3:2890:3890</div></pre></td></tr></table></figure>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><hr>
<p>zk1</p>
<p>echo 1 &gt; data/myid</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-01$ bin/zkServer.sh start</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-01/bin/../conf/zoo.cfg</div><div class="line">Starting zookeeper ... STARTED</div></pre></td></tr></table></figure>
<p>日志在<code>./zookeeper.out</code>文件中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">2015-12-29 22:07:45,673 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-01/bin/../conf/zoo.cfg</div><div class="line">2015-12-29 22:07:45,675 [myid:] - INFO  [main:QuorumPeerConfig@340] - Defaulting to majority quorums</div><div class="line">2015-12-29 22:07:45,677 [myid:1] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount set to 3</div><div class="line">2015-12-29 22:07:45,677 [myid:1] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval set to 0</div><div class="line">2015-12-29 22:07:45,678 [myid:1] - INFO  [main:DatadirCleanupManager@101] - Purge task is not scheduled.</div><div class="line">2015-12-29 22:07:45,684 [myid:1] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer</div><div class="line">2015-12-29 22:07:45,693 [myid:1] - INFO  [main:NIOServerCnxnFactory@94] - binding to port 0.0.0.0/0.0.0.0:2181</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@959] - tickTime set to 2000</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@979] - minSessionTimeout set to -1</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@990] - maxSessionTimeout set to -1</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@1005] - initLimit set to 5</div><div class="line">2015-12-29 22:07:45,714 [myid:1] - INFO  [main:QuorumPeer@473] - currentEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</div><div class="line">2015-12-29 22:07:45,717 [myid:1] - INFO  [main:QuorumPeer@488] - acceptedEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</div><div class="line">2015-12-29 22:07:45,721 [myid:1] - INFO  [Thread-1:QuorumCnxManager$Listener@504] - My election bind port: zk1/127.0.1.1:3888</div><div class="line">2015-12-29 22:07:45,726 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumPeer@714] - LOOKING</div><div class="line">2015-12-29 22:07:45,727 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@815] - New election. My id =  1, proposed zxid=0x0</div><div class="line">2015-12-29 22:07:45,729 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@597] - Notification: 1 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEpoch) LOOKING (my state)</div><div class="line">2015-12-29 22:07:45,731 [myid:1] - WARN  [WorkerSender[myid=1]:QuorumCnxManager@382] - Cannot open channel to 2 at election address zk2/127.0.1.1:3889</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:341)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:449)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:430)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">2015-12-29 22:07:45,732 [myid:1] - WARN  [WorkerSender[myid=1]:QuorumCnxManager@382] - Cannot open channel to 3 at election address zk3/127.0.1.1:3890</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:341)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:449)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:430)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">2015-12-29 22:07:45,931 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumCnxManager@382] - Cannot open channel to 2 at election address zk2/127.0.1.1:3889</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">2015-12-29 22:09:27,956 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumCnxManager@382] - Cannot open channel to 2 at election address zk2/127.0.1.1:3889</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)</div><div class="line">2015-12-29 22:09:27,957 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumCnxManager@382] - Cannot open channel to 3 at election address zk3/127.0.1.1:3890</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)</div><div class="line">2015-12-29 22:09:27,958 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@849] - Notification time out: 60000</div></pre></td></tr></table></figure>
<p>zk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">echo 2 &gt; data/myid</div><div class="line">.../zookeeper-3.4.6_server-02$ bin/zkServer.sh start</div></pre></td></tr></table></figure>
<p>zk3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">echo 3 &gt; data/myid</div><div class="line">.../zookeeper-3.4.6_server-03$ bin/zkServer.sh start</div></pre></td></tr></table></figure>
<h1 id="检查-status"><a href="#检查-status" class="headerlink" title="检查 status"></a>检查 status</h1><hr>
<p>zk1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-01$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-01/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure>
<p>zk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-02$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-02/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div></pre></td></tr></table></figure>
<p>zk3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-03$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-03/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure>
<p>可知， zk2 被选为 leader。</p>
<h1 id="宕机测试"><a href="#宕机测试" class="headerlink" title="宕机测试"></a>宕机测试</h1><hr>
<p>把 zk2 kill掉后, 查看各个 zk server 的 status, 发现 zk3 变成 master :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">zookeeper-3.4.6_server-03$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-03/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div></pre></td></tr></table></figure>
<p>用<a href="https://zookeeper.apache.org/doc/trunk/javaExample.html#sc_completeSourceCode" target="_blank" rel="external">java客户端api</a>连接三个服务器, 然后用zkCli.sh测试, java client 工作正常:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[zk: 127.0.0.1:2182(CONNECTED) 3] set /test niko2</div><div class="line">$ cat /tmp/niko/zk_test</div><div class="line">niko2</div></pre></td></tr></table></figure>
<p>然后关掉master zk3后, 集群将停止服务, 因为选举不能获得不能超过<code>3/2=1</code>张票了, 无法得出leader :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">  &lt;2015-12-29 22:42:57,889&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Unable to read additional data from server sessionid 0x3585e1413050000, likely server has closed socket, closing socket connection and attempting reconnect</div><div class="line">  &lt;2015-12-29 22:42:58,324&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Opening socket connection to server 127.0.0.1/127.0.0.1:2182. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">  &lt;2015-12-29 22:42:58,325&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Socket connection established to 127.0.0.1/127.0.0.1:2182, initiating session</div><div class="line">  &lt;2015-12-29 22:42:58,327&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Unable to read additional data from server sessionid 0x3585e1413050000, likely server has closed socket, closing socket connection and attempting reconnect</div><div class="line">  &lt;2015-12-29 22:42:58,699&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Opening socket connection to server 127.0.0.1/127.0.0.1:2183. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">  &lt;2015-12-29 22:42:58,700&gt; &lt;ClientCnxn:WARN&gt;	main-SendThread(127.0.0.1:2183)	Session 0x3585e1413050000 for server null, unexpected error, closing socket connection and attempting reconnect</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)</div><div class="line">	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)</div><div class="line">	at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)</div><div class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)</div><div class="line">  &lt;2015-12-29 22:43:00,543&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">  &lt;2015-12-29 22:43:00,543&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Socket connection established to 127.0.0.1/127.0.0.1:2181, initiating session</div><div class="line">  &lt;2015-12-29 22:43:00,545&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Session establishment complete on server 127.0.0.1/127.0.0.1:2181, sessionid = 0x3585e1413050000, negotiated timeout = 4000</div></pre></td></tr></table></figure>
<p>我们重新启动zk3, 集群将恢复服务:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;2015-12-29 22:53:34,232&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Opening socket connection to server 127.0.0.1/127.0.0.1:2183. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:34,232&gt; &lt;ClientCnxn:WARN&gt;	main-SendThread(127.0.0.1:2183)	Session 0x3585e2c18ed0000 for server null, unexpected error, closing socket connection and attempting reconnect</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">  at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)</div><div class="line">  at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)</div><div class="line">  at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)</div><div class="line">  at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)</div><div class="line">&lt;2015-12-29 22:53:34,485&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:34,486&gt; &lt;ClientCnxn:WARN&gt;	main-SendThread(127.0.0.1:2181)	Session 0x3585e2c18ed0000 for server null, unexpected error, closing socket connection and attempting reconnect</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">  at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)</div><div class="line">  at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)</div><div class="line">  at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)</div><div class="line">  at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)</div><div class="line">&lt;2015-12-29 22:53:36,450&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Opening socket connection to server 127.0.0.1/127.0.0.1:2182. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:36,451&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Socket connection established to 127.0.0.1/127.0.0.1:2182, initiating session</div><div class="line">&lt;2015-12-29 22:53:36,451&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Unable to read additional data from server sessionid 0x3585e2c18ed0000, likely server has closed socket, closing socket connection and attempting reconnect</div><div class="line">&lt;2015-12-29 22:53:37,115&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Opening socket connection to server 127.0.0.1/127.0.0.1:2183. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:37,116&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Socket connection established to 127.0.0.1/127.0.0.1:2183, initiating session</div><div class="line">&lt;2015-12-29 22:53:37,164&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Session establishment complete on server 127.0.0.1/127.0.0.1:2183, sessionid = 0x3585e2c18ed0000, negotiated timeout = 4000</div></pre></td></tr></table></figure>
<p>接下来将会了解<code>基于docker搭建zookeeper集群</code>及其<code>zookeeper集群的选举算法</code>, 另起博客介绍.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://zookeeper.apache.org/doc/trunk/zookeeperStarted.html#sc_RunningReplicatedZooKeeper" target="_blank" rel="external">https://zookeeper.apache.org/doc/trunk/zookeeperStarted.html#sc_RunningReplicatedZooKeeper</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/zookeeper/" rel="tag">#zookeeper</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/26/git/git_cmd/" rel="next" title="git 常用命令清单">
                <i class="fa fa-chevron-left"></i> git 常用命令清单
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/12/30/books/self_ctrl/self_ctrl_6/" rel="prev" title="【书：自控力】（六） 低落的情绪 为何使人屈服于诱惑？">
                【书：自控力】（六） 低落的情绪 为何使人屈服于诱惑？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2015/12/29/java/zookeeper/zookeeper-cluster/"
           data-title="【zookeeper】 集群搭建和测试" data-url="http://www.nikoai.pw/2015/12/29/java/zookeeper/zookeeper-cluster/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="niko chueng" />
          <p class="site-author-name" itemprop="name">niko chueng</p>
          <p class="site-description motion-element" itemprop="description">保持简单</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">97</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">49</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">143</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#配置"><span class="nav-number">1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#启动"><span class="nav-number">2.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#检查-status"><span class="nav-number">3.</span> <span class="nav-text">检查 status</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#宕机测试"><span class="nav-number">4.</span> <span class="nav-text">宕机测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">niko chueng</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"niko2014"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
