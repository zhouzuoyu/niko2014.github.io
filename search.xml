<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[tmux FAQ]]></title>
      <url>http://www.nikoai.pw/2017/05/15/linux/tools/tmux/tmux-faq/</url>
      <content type="html"><![CDATA[<h1 id="使用-vi-mode"><a href="#使用-vi-mode" class="headerlink" title="使用 vi mode"></a>使用 vi mode</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">setw -g mode-keys vi</div></pre></td></tr></table></figure>
<h1 id="复制粘贴"><a href="#复制粘贴" class="headerlink" title="复制粘贴"></a>复制粘贴</h1><p><a href="http://www.rushiagr.com/blog/2016/06/16/everything-you-need-to-know-about-tmux-copy-pasting/" target="_blank" rel="external">http://www.rushiagr.com/blog/2016/06/16/everything-you-need-to-know-about-tmux-copy-pasting/</a></p>
<ol>
<li>使用 tmux buffer</li>
</ol>
<p>增加配置:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#bind P paste-buffer</div><div class="line">#bind-key -t vi-copy &apos;v&apos; begin-selection</div><div class="line">bind-key -t vi-copy &apos;y&apos; copy-selection</div><div class="line">#bind-key -t vi-copy &apos;r&apos; rectangle-toggle</div></pre></td></tr></table></figure>
<p>复制:<br><code>PREFIX + [</code> 进入选择模式,<br>space 键选择开始字符,<br>y 结束选择, 并 copy 到 tmux buffer</p>
<p>粘贴:<br><code>PREFIX + ]</code></p>
<ol>
<li>使用系统粘贴板</li>
</ol>
<h1 id="关闭自动重命名"><a href="#关闭自动重命名" class="headerlink" title="关闭自动重命名."></a>关闭自动重命名.</h1><p><code>set-option -g allow-rename off</code></p>
<h1 id="远程登录时-显示空间很小"><a href="#远程登录时-显示空间很小" class="headerlink" title="远程登录时, 显示空间很小"></a>远程登录时, 显示空间很小</h1><p>方法一:</p>
<p>取消所有 client 的 attach 状态<br>tmux detach -a<br><code>tmux ls</code> , 检查是否都 detach 了, 如果还不行, 那么<br><code>ps -ef | grep tmux</code>, 找出还在 attach 某个 session 的 client, kill 之.</p>
<p>方法二 (未验证) :</p>
<p>使用以下设置, 那些点点就会被作为可用空间了. 可能是不同 client 的显示器不同导致.<br><code>set-window-option -g aggressive-resize</code></p>
<p>参考:<br><a href="http://stackoverflow.com/questions/7814612/is-there-any-way-to-redraw-tmux-window-when-switching-smaller-monitor-to-bigger" target="_blank" rel="external">http://stackoverflow.com/questions/7814612/is-there-any-way-to-redraw-tmux-window-when-switching-smaller-monitor-to-bigger</a><br><a href="https://superuser.com/questions/880497/how-do-i-resize-the-usable-area-of-a-tmux-session" target="_blank" rel="external">https://superuser.com/questions/880497/how-do-i-resize-the-usable-area-of-a-tmux-session</a></p>
<h1 id="ctrl-←-→-不能生效"><a href="#ctrl-←-→-不能生效" class="headerlink" title="ctrl + ( ← / → ) 不能生效"></a>ctrl + ( ← / → ) 不能生效</h1><p><a href="https://superuser.com/questions/360832/how-can-i-make-ctrlleft-right-keys-work-right-in-tmux" target="_blank" rel="external">https://superuser.com/questions/360832/how-can-i-make-ctrlleft-right-keys-work-right-in-tmux</a></p>
<p>vim ~/.tmux.conf , 增加配置 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">set-window-option -g xterm-keys on</div></pre></td></tr></table></figure>
<p>当前生效:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">PREFIX + :set-window-option xterm-keys on</div></pre></td></tr></table></figure>
<h1 id="修改-前缀-组合键-ctrl-b"><a href="#修改-前缀-组合键-ctrl-b" class="headerlink" title="修改 前缀 组合键 (ctrl + b)"></a>修改 前缀 组合键 (ctrl + b)</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 设置前缀键, 双引号表示字符串需要对 \ 进行转义 (\\)</div><div class="line">set-option -g prefix &apos;C-\&apos;</div></pre></td></tr></table></figure>
<h1 id="关闭鼠标模式"><a href="#关闭鼠标模式" class="headerlink" title="关闭鼠标模式"></a>关闭鼠标模式</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">set -g mode-mouse off</div></pre></td></tr></table></figure>
<h1 id="延长-PREFIX-q-的显示时间"><a href="#延长-PREFIX-q-的显示时间" class="headerlink" title="延长 PREFIX + q 的显示时间"></a>延长 PREFIX + q 的显示时间</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 延长 pane indicators display time</div><div class="line">set -g display-panes-time 1000</div></pre></td></tr></table></figure>
<h1 id="设置状态栏左侧"><a href="#设置状态栏左侧" class="headerlink" title="设置状态栏左侧"></a>设置状态栏左侧</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">set -g status-left &quot;#[fg=green] A good book is your best friend. #[fg=brightblue]#(curl icanhazip.com) #[fg=yellow]#(ifconfig en0 | grep &apos;inet &apos; | awk &apos;&#123;print \&quot;en0 \&quot; $2&#125;&apos;) #(ifconfig en1 | grep &apos;inet &apos; | awk &apos;&#123;print \&quot;en1 \&quot; $2&#125;&apos;) #[fg=red]#(ifconfig tun0 | grep &apos;inet &apos; | awk &apos;&#123;print \&quot;vpn \&quot; $2&#125;&apos;) &quot;</div></pre></td></tr></table></figure>
<h1 id="设置窗口格式文本"><a href="#设置窗口格式文本" class="headerlink" title="设置窗口格式文本"></a>设置窗口格式文本</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">set -g window-status-format &quot;#[fg=white,bg=colour234] #I.#W&quot;</div></pre></td></tr></table></figure>
<p>当前窗口 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">set -g window-status-current-format &quot;#[fg=white]#[bg=blue,noreverse,bold] #I. #W #[fg=colour39,noreverse,bold] &quot;</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[calcite druid adapter 的分页死循环 bug 分析排查]]></title>
      <url>http://www.nikoai.pw/2017/04/05/dtai/data/druid.io/calcite-druid-sql-errors-dead-loop-paging/</url>
      <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><hr>
<p>前一阵子, 部署一个后台应用, 上线后发现内存泄露. jvm 内存分析和日志回查后发现, calcite druid adapter 有一个死循环, 这个死循环不断的进行 query 请求, 而 query sql 只是一个简单的 select 语句.</p>
<h2 id="依赖说明"><a href="#依赖说明" class="headerlink" title="依赖说明 :"></a>依赖说明 :</h2><hr>
<p><code>org.apache.calcite:calcite-druid:1.11.0</code> 和 <code>druid-0.9.1</code> .</p>
<h2 id="sql"><a href="#sql" class="headerlink" title="sql"></a>sql</h2><hr>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span>   *   <span class="keyword">FROM</span> <span class="string">"alert_message"</span>  <span class="keyword">WHERE</span>  <span class="string">"time"</span> &gt;= <span class="string">'1970-01-01 00:00:00'</span> <span class="keyword">AND</span> <span class="string">"time"</span> &lt;= <span class="string">'2017-04-05 10:00:39'</span>  <span class="keyword">AND</span> <span class="string">"host_id"</span>  = <span class="string">'xxx'</span></div></pre></td></tr></table></figure>
<h2 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h2><hr>
<p>一开始我怀疑是 calcite-druid-adapter 的 bug, 于是我开始分析源码.</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><hr>
<p>首先要找到为什么会重复发送 query, 或是什么条件或场景导致. 因此, 我们先可以定位发请求的代码位置.</p>
<h2 id="发起-rest-请求的位置"><a href="#发起-rest-请求的位置" class="headerlink" title="发起 rest 请求的位置"></a>发起 rest 请求的位置</h2><hr>
<p>在我敏锐的眼睛扫描下, 找到了 <code>DruidConnectionImpl</code> 的 <code>request</code> 方法:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">org.apache.calcite.adapter.druid.DruidConnectionImpl#request - (org/apache/calcite/adapter/druid/DruidConnectionImpl.java:94)</div><div class="line">|- org.apache.calcite.adapter.druid.DruidQuery.DruidQueryNode#run</div></pre></td></tr></table></figure>
<p>他被 <code>DruidQueryNode</code> 的 <code>run</code> 方法调用, 如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">  <span class="keyword">final</span> List&lt;ColumnMetaData.Rep&gt; fieldTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">  <span class="keyword">for</span> (RelDataTypeField field : query.getRowType().getFieldList()) &#123;</div><div class="line">    fieldTypes.add(getPrimitive(field));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">final</span> DruidConnectionImpl connection =</div><div class="line">      <span class="keyword">new</span> DruidConnectionImpl(query.druidTable.schema.url,</div><div class="line">          query.druidTable.schema.coordinatorUrl);</div><div class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> limitQuery = containsLimit(querySpec);</div><div class="line">  <span class="keyword">final</span> DruidConnectionImpl.Page page = <span class="keyword">new</span> DruidConnectionImpl.Page();</div><div class="line">  do &#123;</div><div class="line">    <span class="keyword">final</span> String queryString =</div><div class="line">        querySpec.getQueryString(page.pagingIdentifier, page.offset);</div><div class="line">    connection.request(querySpec.queryType, queryString, sink,</div><div class="line">        querySpec.fieldNames, fieldTypes, page);</div><div class="line">  &#125; <span class="keyword">while</span> (!limitQuery</div><div class="line">      &amp;&amp; page.pagingIdentifier != <span class="keyword">null</span></div><div class="line">      &amp;&amp; page.totalRowCount &gt; <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中, while 就是死循环的位置了, 那么什么时候 while 循环才会停止呢 ? 三个条件</p>
<h3 id="limitQuery-为-true"><a href="#limitQuery-为-true" class="headerlink" title="limitQuery 为 true"></a><code>limitQuery</code> 为 true</h3><hr>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> limitQuery = containsLimit(querySpec);</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">containsLimit</span><span class="params">(QuerySpec querySpec)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> querySpec.queryString.contains(<span class="string">"\"context\":&#123;\""</span></div><div class="line">          + DRUID_QUERY_FETCH + <span class="string">"\":true"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>就是说如果请求 json 包含了 <code>&quot;context&quot;:{&quot;druid.query.fetch&quot;:false}</code> , 那么,  limitQuery 将会为 true.<br>那么 fetch 又是在哪里设置呢 ?</p>
<p>druid 文档并没有发现 <code>druid.query.fetch</code>, 只有一个简单描述:</p>
<blockquote>
<p>context    An additional JSON Object which can be used to specify certain flags.</p>
</blockquote>
<p>fetch 设置在这一行代码 <code>org/apache/calcite/adapter/druid/DruidQuery.java:395</code> , 因为不是导致死循环的原因, 因此不在赘述.</p>
<h3 id="page-pagingIdentifier"><a href="#page-pagingIdentifier" class="headerlink" title="page.pagingIdentifier"></a>page.pagingIdentifier</h3><hr>
<p>如果 <code>page.pagingIdentifier</code> = null, 那么循环将会停止.</p>
<p>druid 查询的结果解析方法 parse() <code>org.apache.calcite.adapter.druid.DruidConnectionImpl#parse</code> 中:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(QueryType queryType, InputStream in, Sink sink,</span></span></div><div class="line">  List&lt;String&gt; fieldNames, List&lt;ColumnMetaData.Rep&gt; fieldTypes, Page page) &#123;</div><div class="line">      <span class="comment">// ...</span></div><div class="line">      <span class="keyword">case</span> SELECT:</div><div class="line">          <span class="keyword">if</span> (parser.nextToken() == JsonToken.START_ARRAY</div><div class="line">              &amp;&amp; parser.nextToken() == JsonToken.START_OBJECT) &#123;</div><div class="line">            page.pagingIdentifier = <span class="keyword">null</span>;</div><div class="line">            page.offset = -<span class="number">1</span>;</div><div class="line">            page.totalRowCount = <span class="number">0</span>;</div><div class="line">            expectScalarField(parser, DEFAULT_RESPONSE_TIMESTAMP_COLUMN);</div><div class="line">            <span class="keyword">if</span> (parser.nextToken() == JsonToken.FIELD_NAME</div><div class="line">                &amp;&amp; parser.getCurrentName().equals(<span class="string">"result"</span>)</div><div class="line">                &amp;&amp; parser.nextToken() == JsonToken.START_OBJECT) &#123;</div><div class="line">              <span class="keyword">if</span> (parser.nextToken() == JsonToken.FIELD_NAME</div><div class="line">                  &amp;&amp; parser.getCurrentName().equals(<span class="string">"pagingIdentifiers"</span>)</div><div class="line">                  &amp;&amp; parser.nextToken() == JsonToken.START_OBJECT) &#123;</div><div class="line">                JsonToken token = parser.nextToken();</div><div class="line">                <span class="keyword">while</span> (parser.getCurrentToken() == JsonToken.FIELD_NAME) &#123;</div><div class="line">                  page.pagingIdentifier = parser.getCurrentName();</div><div class="line">                  <span class="keyword">if</span> (parser.nextToken() == JsonToken.VALUE_NUMBER_INT) &#123;</div><div class="line">                    page.offset = parser.getIntValue();</div><div class="line">                  &#125;</div><div class="line">                  token = parser.nextToken();</div><div class="line">                &#125;</div><div class="line">                expect(token, JsonToken.END_OBJECT);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (parser.nextToken() == JsonToken.FIELD_NAME</div><div class="line">                  &amp;&amp; parser.getCurrentName().equals(<span class="string">"events"</span>)</div><div class="line">                  &amp;&amp; parser.nextToken() == JsonToken.START_ARRAY) &#123;</div><div class="line">                <span class="keyword">while</span> (parser.nextToken() == JsonToken.START_OBJECT) &#123;</div><div class="line">                  expectScalarField(parser, <span class="string">"segmentId"</span>);</div><div class="line">                  expectScalarField(parser, <span class="string">"offset"</span>);</div><div class="line">                  <span class="keyword">if</span> (parser.nextToken() == JsonToken.FIELD_NAME</div><div class="line">                      &amp;&amp; parser.getCurrentName().equals(<span class="string">"event"</span>)</div><div class="line">                      &amp;&amp; parser.nextToken() == JsonToken.START_OBJECT) &#123;</div><div class="line">                    parseFields(fieldNames, fieldTypes, posTimestampField, rowBuilder, parser);</div><div class="line">                    sink.send(rowBuilder.build());</div><div class="line">                    rowBuilder.reset();</div><div class="line">                    page.totalRowCount += <span class="number">1</span>;</div><div class="line">                  &#125;</div><div class="line">                  expect(parser, JsonToken.END_OBJECT);</div><div class="line">                &#125;</div><div class="line">                parser.nextToken();</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">       <span class="comment">// ...</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>其中, 在 response 的 <code>pagingIdentifiers</code> 中, 如果有下一页, 则设置给 <code>page.pagingIdentifier</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> (parser.nextToken() == JsonToken.FIELD_NAME</div><div class="line">                &amp;&amp; parser.getCurrentName().equals(<span class="string">"pagingIdentifiers"</span>)</div><div class="line">                &amp;&amp; parser.nextToken() == JsonToken.START_OBJECT) &#123;</div><div class="line">      JsonToken token = parser.nextToken();</div><div class="line">      <span class="keyword">while</span> (parser.getCurrentToken() == JsonToken.FIELD_NAME) &#123;</div><div class="line">        page.pagingIdentifier = parser.getCurrentName();</div><div class="line">        <span class="keyword">if</span> (parser.nextToken() == JsonToken.VALUE_NUMBER_INT) &#123;</div><div class="line">          page.offset = parser.getIntValue();</div><div class="line">        &#125;</div><div class="line">        token = parser.nextToken();</div><div class="line">      &#125;</div><div class="line">      expect(token, JsonToken.END_OBJECT);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>测试发现, page.pagingIdentifier 总是不为 null, 因此导致死循环.</p>
<p>于是, 我仔细分析 druid 的 query 和 response, 发现:</p>
<p>query json 1:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"queryType"</span>:<span class="string">"select"</span>,<span class="attr">"dataSource"</span>:<span class="string">"system_alerts_01"</span>,<span class="attr">"descending"</span>:<span class="literal">false</span>,<span class="attr">"intervals"</span>:[<span class="string">"1970-01-01T00:00:00.000Z/2017-04-05T10:00:39.001Z"</span>],<span class="attr">"filter"</span>:&#123;<span class="attr">"type"</span>:<span class="string">"selector"</span>,<span class="attr">"dimension"</span>:<span class="string">"host_id"</span>,<span class="attr">"value"</span>:<span class="string">"fadf4b05-c78c-5aa4-a5b3-82b618bd395b"</span>&#125;,<span class="attr">"dimensions"</span>:[<span class="string">"host_id"</span>,<span class="string">"threshold_metric_name"</span>,<span class="string">"type"</span>,<span class="string">"threshold_compare"</span>,<span class="string">"threshold_last_time"</span>],<span class="attr">"metrics"</span>:[<span class="string">"alert_value"</span>,<span class="string">"threshold_value"</span>,<span class="string">"threshold_duration"</span>,<span class="string">"alert_time"</span>],<span class="attr">"granularity"</span>:<span class="string">"all"</span>,<span class="attr">"pagingSpec"</span>:&#123;<span class="attr">"pagingIdentifiers"</span>:&#123;<span class="attr">"system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z_1"</span>:<span class="number">0</span>&#125;,<span class="attr">"threshold"</span>:<span class="number">16384</span>,<span class="attr">"fromNext"</span>:<span class="literal">true</span>&#125;,<span class="attr">"context"</span>:&#123;<span class="attr">"druid.query.fetch"</span>:<span class="literal">false</span>&#125;&#125;</div></pre></td></tr></table></figure>
<p>query json 2:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"queryType"</span>:<span class="string">"select"</span>,<span class="attr">"dataSource"</span>:<span class="string">"system_alerts_01"</span>,<span class="attr">"descending"</span>:<span class="literal">false</span>,<span class="attr">"intervals"</span>:[<span class="string">"1970-01-01T00:00:00.000Z/2017-04-05T09:51:13.001Z"</span>],<span class="attr">"filter"</span>:&#123;<span class="attr">"type"</span>:<span class="string">"selector"</span>,<span class="attr">"dimension"</span>:<span class="string">"host_id"</span>,<span class="attr">"value"</span>:<span class="string">"fadf4b05-c78c-5aa4-a5b3-82b618bd395b"</span>&#125;,<span class="attr">"dimensions"</span>:[<span class="string">"host_id"</span>,<span class="string">"threshold_metric_name"</span>,<span class="string">"type"</span>,<span class="string">"threshold_compare"</span>,<span class="string">"threshold_last_time"</span>],<span class="attr">"metrics"</span>:[<span class="string">"alert_value"</span>,<span class="string">"threshold_value"</span>,<span class="string">"threshold_duration"</span>,<span class="string">"alert_time"</span>],<span class="attr">"granularity"</span>:<span class="string">"all"</span>,<span class="attr">"pagingSpec"</span>:&#123;<span class="attr">"pagingIdentifiers"</span>:&#123;<span class="attr">"system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T09:51:13.001Z_2017-04-05T09:10:11.149Z_2"</span>:<span class="number">0</span>&#125;,<span class="attr">"threshold"</span>:<span class="number">16384</span>,<span class="attr">"fromNext"</span>:<span class="literal">true</span>&#125;,<span class="attr">"context"</span>:&#123;<span class="attr">"druid.query.fetch"</span>:<span class="literal">false</span>&#125;&#125;</div></pre></td></tr></table></figure>
<p>以上两个请求, 发现一直在交替发送. 只是 <code>2017-04-05T09:10:11.149Z_1</code> 和 <code>2017-04-05T09:10:11.149Z_2</code> 不同.</p>
<p>这时再结合源码, 就可以知道为何出现这种情况.</p>
<h2 id="罪魁祸首"><a href="#罪魁祸首" class="headerlink" title="罪魁祸首"></a>罪魁祸首</h2><hr>
<p>是的, 这是 druid 的问题.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;&quot;queryType&quot;:&quot;select&quot;,&quot;dataSource&quot;:&quot;system_alerts_01&quot;,&quot;descending&quot;:false,&quot;intervals&quot;:[&quot;1970-01-01T00:00:00.000Z/2017-04-05T10:00:39.001Z&quot;],&quot;filter&quot;:&#123;&quot;type&quot;:&quot;selector&quot;,&quot;dimension&quot;:&quot;host_id&quot;,&quot;value&quot;:&quot;xxx&quot;&#125;,&quot;dimensions&quot;:[&quot;host_id&quot;,&quot;threshold_metric_name&quot;,&quot;type&quot;,&quot;threshold_compare&quot;,&quot;threshold_last_time&quot;],&quot;metrics&quot;:[&quot;alert_value&quot;,&quot;threshold_value&quot;,&quot;threshold_duration&quot;,&quot;alert_time&quot;],&quot;granularity&quot;:&quot;all&quot;,&quot;pagingSpec&quot;:&#123;&quot;pagingIdentifiers&quot;:&#123;&quot;system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z_2&quot;:0&#125;,&quot;threshold&quot;:16384,&quot;fromNext&quot;:true&#125;,&quot;context&quot;:&#123;&quot;druid.query.fetch&quot;:false&#125;&#125;</div><div class="line"></div><div class="line"></div><div class="line">Response: [ &#123;</div><div class="line">  &quot;timestamp&quot; : &quot;2017-04-05T09:10:11.000Z&quot;,</div><div class="line">  &quot;result&quot; : &#123;</div><div class="line">    &quot;pagingIdentifiers&quot; : &#123;</div><div class="line">      &quot;system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z&quot; : 0,</div><div class="line">      &quot;system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z_1&quot; : 0</div><div class="line">    &#125;,</div></pre></td></tr></table></figure>
<p>请求 pagingIdentifiers 是 <code>_2017-04-05T09:10:11.149Z_2</code> 的 segment :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&quot;pagingSpec&quot;:&#123;&quot;pagingIdentifiers&quot;:&#123;&quot;system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z_2&quot;:0&#125;,&quot;threshold&quot;:16384,&quot;fromNext&quot;:true&#125;,&quot;context&quot;:&#123;&quot;druid.query.fetch&quot;:false&#125;&#125;</div></pre></td></tr></table></figure>
<p>response 返回却是前面的 <code>2017-04-05T09:10:11.149Z</code> 和 <code>2017-04-05T09:10:11.149Z_1</code> 两个 segment :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Response: [ &#123;</div><div class="line">  &quot;timestamp&quot; : &quot;2017-04-05T09:10:11.000Z&quot;,</div><div class="line">  &quot;result&quot; : &#123;</div><div class="line">    &quot;pagingIdentifiers&quot; : &#123;</div><div class="line">      &quot;system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z&quot; : 0,</div><div class="line">      &quot;system_alerts_01_2017-04-05T09:00:00.000Z_2017-04-05T10:00:00.000Z_2017-04-05T09:10:11.149Z_1&quot; : 0</div><div class="line">    &#125;,</div></pre></td></tr></table></figure>
<h3 id="github-上的-druid-相关-issue"><a href="#github-上的-druid-相关-issue" class="headerlink" title="github 上的 druid 相关 issue"></a>github 上的 druid 相关 issue</h3><hr>
<p><a href="https://github.com/druid-io/druid/pull/2480" target="_blank" rel="external">https://github.com/druid-io/druid/pull/2480</a><br><a href="https://github.com/druid-io/druid/issues/3618" target="_blank" rel="external">https://github.com/druid-io/druid/issues/3618</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[druid.io - Not enough direct memory]]></title>
      <url>http://www.nikoai.pw/2017/03/24/dtai/data/druid.io/druid-error-directMemory-not-enough/</url>
      <content type="html"><![CDATA[<p>今天在新的机器上部署 druid , 起来后发现有 task 错误, 提示是 direct memory 不够.</p>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><hr>
<p>错误日志如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">2017-03-23T16:49:43,161 ERROR [main] io.druid.cli.CliPeon - Error when starting up.  Failing.</div><div class="line">com.google.inject.ProvisionException: Guice provision errors:</div><div class="line"></div><div class="line">1) Not enough direct memory.  Please adjust -XX:MaxDirectMemorySize, druid.processing.buffer.sizeBytes, or druid.processing.numThreads: maxDirectMemory[1,908,932,608], memoryNeeded[2,684,354,560] = druid.processing.buffer.sizeBytes[536,870,912] * ( druid.processing.numThreads[4] + 1 )</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  while locating io.druid.collections.StupidPool&lt;java.nio.ByteBuffer&gt; annotated with @io.druid.guice.annotations.Global()</div><div class="line">    for parameter 1 at io.druid.query.groupby.GroupByQueryEngine.&lt;init&gt;(GroupByQueryEngine.java:79)</div><div class="line">  at io.druid.guice.QueryRunnerFactoryModule.configure(QueryRunnerFactoryModule.java:85)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryEngine</div><div class="line">    for parameter 0 at io.druid.query.groupby.GroupByQueryRunnerFactory.&lt;init&gt;(GroupByQueryRunnerFactory.java:64)</div><div class="line">  at io.druid.guice.QueryRunnerFactoryModule.configure(QueryRunnerFactoryModule.java:82)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryRunnerFactory</div><div class="line">  while locating io.druid.query.QueryRunnerFactory annotated with @com.google.inject.multibindings.Element(setName=,uniqueId=28, type=MAPBINDER)</div><div class="line">  at io.druid.guice.DruidBinders.queryRunnerFactoryBinder(DruidBinders.java:38)</div><div class="line">  while locating java.util.Map&lt;java.lang.Class&lt;? extends io.druid.query.Query&gt;, io.druid.query.QueryRunnerFactory&gt;</div><div class="line">    for parameter 0 at io.druid.query.DefaultQueryRunnerFactoryConglomerate.&lt;init&gt;(DefaultQueryRunnerFactoryConglomerate.java:36)</div><div class="line">  while locating io.druid.query.DefaultQueryRunnerFactoryConglomerate</div><div class="line">  at io.druid.guice.StorageNodeModule.configure(StorageNodeModule.java:55)</div><div class="line">  while locating io.druid.query.QueryRunnerFactoryConglomerate</div><div class="line">    for parameter 9 at io.druid.indexing.common.TaskToolboxFactory.&lt;init&gt;(TaskToolboxFactory.java:95)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:153)</div><div class="line">  while locating io.druid.indexing.common.TaskToolboxFactory</div><div class="line">    for parameter 0 at io.druid.indexing.overlord.ThreadPoolTaskRunner.&lt;init&gt;(ThreadPoolTaskRunner.java:96)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:180)</div><div class="line">  while locating io.druid.indexing.overlord.ThreadPoolTaskRunner</div><div class="line">  while locating io.druid.indexing.overlord.TaskRunner</div><div class="line">    for parameter 3 at io.druid.indexing.worker.executor.ExecutorLifecycle.&lt;init&gt;(ExecutorLifecycle.java:78)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:170)</div><div class="line">  while locating io.druid.indexing.worker.executor.ExecutorLifecycle</div><div class="line"></div><div class="line">2) Not enough direct memory.  Please adjust -XX:MaxDirectMemorySize, druid.processing.buffer.sizeBytes, or druid.processing.numThreads: maxDirectMemory[1,908,932,608], memoryNeeded[2,684,354,560] = druid.processing.buffer.sizeBytes[536,870,912] * ( druid.processing.numThreads[4] + 1 )</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  while locating io.druid.collections.StupidPool&lt;java.nio.ByteBuffer&gt; annotated with @io.druid.guice.annotations.Global()</div><div class="line">    for parameter 1 at io.druid.query.groupby.GroupByQueryEngine.&lt;init&gt;(GroupByQueryEngine.java:79)</div><div class="line">  at io.druid.guice.QueryRunnerFactoryModule.configure(QueryRunnerFactoryModule.java:85)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryEngine</div><div class="line">    for parameter 2 at io.druid.query.groupby.GroupByQueryQueryToolChest.&lt;init&gt;(GroupByQueryQueryToolChest.java:113)</div><div class="line">  at io.druid.guice.QueryToolChestModule.configure(QueryToolChestModule.java:74)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryQueryToolChest</div><div class="line">    for parameter 3 at io.druid.query.groupby.GroupByQueryRunnerFactory.&lt;init&gt;(GroupByQueryRunnerFactory.java:64)</div><div class="line">  at io.druid.guice.QueryRunnerFactoryModule.configure(QueryRunnerFactoryModule.java:82)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryRunnerFactory</div><div class="line">  while locating io.druid.query.QueryRunnerFactory annotated with @com.google.inject.multibindings.Element(setName=,uniqueId=28, type=MAPBINDER)</div><div class="line">  at io.druid.guice.DruidBinders.queryRunnerFactoryBinder(DruidBinders.java:38)</div><div class="line">  while locating java.util.Map&lt;java.lang.Class&lt;? extends io.druid.query.Query&gt;, io.druid.query.QueryRunnerFactory&gt;</div><div class="line">    for parameter 0 at io.druid.query.DefaultQueryRunnerFactoryConglomerate.&lt;init&gt;(DefaultQueryRunnerFactoryConglomerate.java:36)</div><div class="line">  while locating io.druid.query.DefaultQueryRunnerFactoryConglomerate</div><div class="line">  at io.druid.guice.StorageNodeModule.configure(StorageNodeModule.java:55)</div><div class="line">  while locating io.druid.query.QueryRunnerFactoryConglomerate</div><div class="line">    for parameter 9 at io.druid.indexing.common.TaskToolboxFactory.&lt;init&gt;(TaskToolboxFactory.java:95)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:153)</div><div class="line">  while locating io.druid.indexing.common.TaskToolboxFactory</div><div class="line">    for parameter 0 at io.druid.indexing.overlord.ThreadPoolTaskRunner.&lt;init&gt;(ThreadPoolTaskRunner.java:96)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:180)</div><div class="line">  while locating io.druid.indexing.overlord.ThreadPoolTaskRunner</div><div class="line">  while locating io.druid.indexing.overlord.TaskRunner</div><div class="line">    for parameter 3 at io.druid.indexing.worker.executor.ExecutorLifecycle.&lt;init&gt;(ExecutorLifecycle.java:78)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:170)</div><div class="line">  while locating io.druid.indexing.worker.executor.ExecutorLifecycle</div><div class="line"></div><div class="line">3) Not enough direct memory.  Please adjust -XX:MaxDirectMemorySize, druid.processing.buffer.sizeBytes, or druid.processing.numThreads: maxDirectMemory[1,908,932,608], memoryNeeded[2,684,354,560] = druid.processing.buffer.sizeBytes[536,870,912] * ( druid.processing.numThreads[4] + 1 )</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  while locating io.druid.collections.StupidPool&lt;java.nio.ByteBuffer&gt; annotated with @io.druid.guice.annotations.Global()</div><div class="line">    for parameter 3 at io.druid.query.groupby.GroupByQueryQueryToolChest.&lt;init&gt;(GroupByQueryQueryToolChest.java:113)</div><div class="line">  at io.druid.guice.QueryToolChestModule.configure(QueryToolChestModule.java:74)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryQueryToolChest</div><div class="line">    for parameter 3 at io.druid.query.groupby.GroupByQueryRunnerFactory.&lt;init&gt;(GroupByQueryRunnerFactory.java:64)</div><div class="line">  at io.druid.guice.QueryRunnerFactoryModule.configure(QueryRunnerFactoryModule.java:82)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryRunnerFactory</div><div class="line">  while locating io.druid.query.QueryRunnerFactory annotated with @com.google.inject.multibindings.Element(setName=,uniqueId=28, type=MAPBINDER)</div><div class="line">  at io.druid.guice.DruidBinders.queryRunnerFactoryBinder(DruidBinders.java:38)</div><div class="line">  while locating java.util.Map&lt;java.lang.Class&lt;? extends io.druid.query.Query&gt;, io.druid.query.QueryRunnerFactory&gt;</div><div class="line">    for parameter 0 at io.druid.query.DefaultQueryRunnerFactoryConglomerate.&lt;init&gt;(DefaultQueryRunnerFactoryConglomerate.java:36)</div><div class="line">  while locating io.druid.query.DefaultQueryRunnerFactoryConglomerate</div><div class="line">  at io.druid.guice.StorageNodeModule.configure(StorageNodeModule.java:55)</div><div class="line">  while locating io.druid.query.QueryRunnerFactoryConglomerate</div><div class="line">    for parameter 9 at io.druid.indexing.common.TaskToolboxFactory.&lt;init&gt;(TaskToolboxFactory.java:95)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:153)</div><div class="line">  while locating io.druid.indexing.common.TaskToolboxFactory</div><div class="line">    for parameter 0 at io.druid.indexing.overlord.ThreadPoolTaskRunner.&lt;init&gt;(ThreadPoolTaskRunner.java:96)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:180)</div><div class="line">  while locating io.druid.indexing.overlord.ThreadPoolTaskRunner</div><div class="line">  while locating io.druid.indexing.overlord.TaskRunner</div><div class="line">    for parameter 3 at io.druid.indexing.worker.executor.ExecutorLifecycle.&lt;init&gt;(ExecutorLifecycle.java:78)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:170)</div><div class="line">  while locating io.druid.indexing.worker.executor.ExecutorLifecycle</div><div class="line"></div><div class="line">4) Not enough direct memory.  Please adjust -XX:MaxDirectMemorySize, druid.processing.buffer.sizeBytes, or druid.processing.numThreads: maxDirectMemory[1,908,932,608], memoryNeeded[2,684,354,560] = druid.processing.buffer.sizeBytes[536,870,912] * ( druid.processing.numThreads[4] + 1 )</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  at io.druid.guice.DruidProcessingModule.getIntermediateResultsPool(DruidProcessingModule.java:108)</div><div class="line">  while locating io.druid.collections.StupidPool&lt;java.nio.ByteBuffer&gt; annotated with @io.druid.guice.annotations.Global()</div><div class="line">    for parameter 4 at io.druid.query.groupby.GroupByQueryRunnerFactory.&lt;init&gt;(GroupByQueryRunnerFactory.java:64)</div><div class="line">  at io.druid.guice.QueryRunnerFactoryModule.configure(QueryRunnerFactoryModule.java:82)</div><div class="line">  while locating io.druid.query.groupby.GroupByQueryRunnerFactory</div><div class="line">  while locating io.druid.query.QueryRunnerFactory annotated with @com.google.inject.multibindings.Element(setName=,uniqueId=28, type=MAPBINDER)</div><div class="line">  at io.druid.guice.DruidBinders.queryRunnerFactoryBinder(DruidBinders.java:38)</div><div class="line">  while locating java.util.Map&lt;java.lang.Class&lt;? extends io.druid.query.Query&gt;, io.druid.query.QueryRunnerFactory&gt;</div><div class="line">    for parameter 0 at io.druid.query.DefaultQueryRunnerFactoryConglomerate.&lt;init&gt;(DefaultQueryRunnerFactoryConglomerate.java:36)</div><div class="line">  while locating io.druid.query.DefaultQueryRunnerFactoryConglomerate</div><div class="line">  at io.druid.guice.StorageNodeModule.configure(StorageNodeModule.java:55)</div><div class="line">  while locating io.druid.query.QueryRunnerFactoryConglomerate</div><div class="line">    for parameter 9 at io.druid.indexing.common.TaskToolboxFactory.&lt;init&gt;(TaskToolboxFactory.java:95)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:153)</div><div class="line">  while locating io.druid.indexing.common.TaskToolboxFactory</div><div class="line">    for parameter 0 at io.druid.indexing.overlord.ThreadPoolTaskRunner.&lt;init&gt;(ThreadPoolTaskRunner.java:96)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:180)</div><div class="line">  while locating io.druid.indexing.overlord.ThreadPoolTaskRunner</div><div class="line">  while locating io.druid.indexing.overlord.TaskRunner</div><div class="line">    for parameter 3 at io.druid.indexing.worker.executor.ExecutorLifecycle.&lt;init&gt;(ExecutorLifecycle.java:78)</div><div class="line">  at io.druid.cli.CliPeon$1.configure(CliPeon.java:170)</div><div class="line">  while locating io.druid.indexing.worker.executor.ExecutorLifecycle</div><div class="line"></div><div class="line">4 errors</div><div class="line">	at com.google.inject.internal.InjectorImpl$3.get(InjectorImpl.java:1014) ~[guice-4.0-beta.jar:?]</div><div class="line">	at com.google.inject.internal.InjectorImpl.getInstance(InjectorImpl.java:1036) ~[guice-4.0-beta.jar:?]</div><div class="line">	at io.druid.guice.LifecycleModule$2.start(LifecycleModule.java:153) ~[druid-api-0.9.1.1.jar:0.9.1.1]</div><div class="line">	at io.druid.cli.GuiceRunnable.initLifecycle(GuiceRunnable.java:91) [druid-services-0.9.1.1.jar:0.9.1.1]</div><div class="line">	at io.druid.cli.CliPeon.run(CliPeon.java:274) [druid-services-0.9.1.1.jar:0.9.1.1]</div><div class="line">	at io.druid.cli.Main.main(Main.java:105) [druid-services-0.9.1.1.jar:0.9.1.1]</div></pre></td></tr></table></figure>
<p>如上日志所示, 当前需要 <code>memoryNeeded[2,684,354,560]</code> 的 direct memory, 但是当前只有 <code>maxDirectMemory[1,908,932,608]</code> 这么多.<br>因为 memoryNeeded 的值是这么计算出来的: <code>druid.processing.buffer.sizeBytes * ( druid.processing.numThreads + 1 )</code>,<br>因此可以调整 <code>-XX:MaxDirectMemorySize</code>, <code>druid.processing.buffer.sizeBytes</code>, or <code>druid.processing.numThreads</code> 这三者之一.</p>
<h2 id="druid-processing-的-buffer-和-numThreads-设置"><a href="#druid-processing-的-buffer-和-numThreads-设置" class="headerlink" title="druid.processing 的 buffer 和 numThreads 设置"></a><code>druid.processing</code> 的 buffer 和 numThreads 设置</h2><hr>
<p><code>druid.processing.buffer.sizeBytes</code> 设置是在 <code>middleManager/runtime.properties:15:druid.processing.buffer.sizeBytes=</code><br><code>druid.processing.numThreads</code> 设置是在 <code>middleManager/runtime.properties:16:druid.processing.numThreads=</code></p>
<p>具体的值要根据 <code>-XX:MaxDirectMemorySize</code> 来选择设置, 计算后不能超过 <code>-XX:MaxDirectMemorySize</code>, 而默认的 <code>-XX:MaxDirectMemorySize</code> 值, 可以参考这篇博文 : <a href="https://dzone.com/articles/default-hotspot-maximum-direct-memory-size" target="_blank" rel="external">Default HotSpot Maximum Direct Memory Size - DZone Java</a>.</p>
<h2 id="XX-MaxDirectMemorySize"><a href="#XX-MaxDirectMemorySize" class="headerlink" title="-XX:MaxDirectMemorySize"></a><code>-XX:MaxDirectMemorySize</code></h2><hr>
<p>如果的确有需求, <code>druid.processing.buffer.sizeBytes</code> 和 <code>druid.processing.numThreads</code> 都需要保留, 那么只有改 <code>-XX:MaxDirectMemorySize</code> 了,<br>可以把设置加到这个地方 <code>druid/middleManager/runtime.properties:8:druid.indexer.runner.javaOpts=</code>.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[康威定律 - Conway’s law 简介]]></title>
      <url>http://www.nikoai.pw/2017/03/11/cs/engineering/conway_law_01/</url>
      <content type="html"><![CDATA[<h1 id="什么是康威定律"><a href="#什么是康威定律" class="headerlink" title="什么是康威定律"></a>什么是康威定律</h1><p>梅尔 • 康威于 1968 年 4 月在 Datamation 杂志上发表了一篇名为“ How Do Committees Invent”的论文，文中指出：</p>
<blockquote>
<p>Any organization that designs a system (defined more broadly here than just information systems) will inevitably produce a design whose structure is a copy of the organization’s communication structure.</p>
</blockquote>
<p>康威定律主要揭示了交付的架构和组织间的关系.<br>下面我们先看一下常见的组织结构和交付结果.</p>
<h1 id="组织的松-紧耦合"><a href="#组织的松-紧耦合" class="headerlink" title="组织的松/紧耦合"></a>组织的松/紧耦合</h1><hr>
<p>紧耦合组织, 指的是一起工作的员工在组织管理上的关系紧密，比如商业公司里开发同一个产品特性的组或团队。而松耦合组织, 比如常见的开源项目组织等.<br>研究发现, 组织的结构对交付的质量确实有深刻的影响。如果组织更加松耦合， 构建的系统更倾向于模块化， 耦合度也越低。</p>
<h1 id="小团队"><a href="#小团队" class="headerlink" title="小团队"></a>小团队</h1><hr>
<p>微软做过一个验证研究，来观察组织结构对交付的软件质量的影响，有兴趣的可以看一下这个结果：<a href="https://www.microsoft.com/en-us/research/publication/the-influence-of-organizational-structure-on-software-quality-an-empirical-case-study/" target="_blank" rel="external">The Influence of Organizational Structure On Software Quality: An Empirical Case Study</a>。<br>而在对技术要求更高的互联网公司，如 Amazon 提出的原则 <code>two pizza team rule</code>，即一个服务的设计、开发、测试和运维人员在一起吃饭，只需两个批萨就够了。Amazon 相信小团队会更加高效，而且对交付的服务更加负责。<br>Netflix 也是这样，小团队的组织方式很好的保证了他们的独立解耦和快速优化的架构，某种意义上讲，Netflix 为了想要的系统架构，而使用了相应的组织结构。</p>
<h1 id="服务的所有权-和-共享"><a href="#服务的所有权-和-共享" class="headerlink" title="服务的所有权 和 共享"></a>服务的所有权 和 共享</h1><hr>
<p>在不少公司， 存在不少按技术类型划分团队， 即一个服务可被不同团队的人任意修改。<br>这种情况存在的原因，可能是拆分服务的成本过高，人员不足，或为了避免交付瓶颈。<br>但这样做有什么弊端呢？ 这会降低团队对交付的关注、责任心和质量。<br>因此，如今很火的微服务会根据业务领域, 而不是技术进行建模。<br>如果负责某个微服务的团队与业务领域相匹配, 则它更容易保持对用户和业务的关注, 也更容易进行以特性为导向的开发.</p>
<p>如果真的不能避免服务共享， 可以采用内部开源的方式，进行共享服务。这就有了项目的守护者，不过要注意开源的时机, 需要等到项目比较稳定之后.</p>
<p>当然, 微服务是有成本的, 需要搭建基础设施. 小规模团队并不推荐使用, 因为架构和组织不太匹配, 除非系统和组织规模到一个点, 严重影响效率的时候, 微服务才能更好的发挥威力.</p>
<h1 id="人的问题"><a href="#人的问题" class="headerlink" title="人的问题"></a>人的问题</h1><hr>
<p>康威定律， 其实说的也是管理和人的问题, 毕竟代码是人写的, 组织结构、质量和文化自然会很大程度上影响交付. 在设计系统的时候， 应多考虑组织和系统架构的匹配问题，否则会遇到许多管理、架构和工程等方面的问题。<br>在&lt;&lt;软件系统架构: 使用视点和视角与利益相关者合作&gt;&gt;这本书中也提到了:</p>
<blockquote>
<p>系统架构的目标是解决利益相关者的关注点。</p>
</blockquote>
<p>康威定律也正是揭示了这种利益关系对最后交付的影响.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://martinfowler.com/bliki/MicroservicePremium.html" target="_blank" rel="external">MicroservicePremium</a><br>&lt;&lt;微服务设计&gt;&gt; - Sam.Newman<br><a href="http://www.infoq.com/cn/articles/every-architect-should-study-conway-law" target="_blank" rel="external">每个架构师都应该研究下康威定律 - InfoQ</a><br><a href="http://www.infoq.com/cn/minibooks/software-sys-architect" target="_blank" rel="external">软件系统架构：使用视点和视角与利益相关者合作</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【抑郁症】心境恶劣障碍 - 精神官能性忧郁症]]></title>
      <url>http://www.nikoai.pw/2017/03/03/books/depression/depression-Dysthymia/</url>
      <content type="html"><![CDATA[<h1 id="心境恶劣障碍-（精神官能性忧郁症）"><a href="#心境恶劣障碍-（精神官能性忧郁症）" class="headerlink" title="心境恶劣障碍 （精神官能性忧郁症）"></a>心境恶劣障碍 （精神官能性忧郁症）</h1><hr>
<p>心境恶劣障碍抑郁症, 是一种长期的慢性疾病.</p>
<p>一个诊断标准就是一天的大部分时间都有抑郁情绪, 并持续两年.</p>
<p>除此之外, 还至少有以下两种症状:</p>
<ul>
<li>精力差或疲惫</li>
<li>胃口不好或过度饱食</li>
<li>失眠或嗜睡</li>
<li>注意力不集中或难以做决定</li>
<li>低自尊</li>
<li>感到绝望</li>
</ul>
<h1 id="和重性抑郁症的区别"><a href="#和重性抑郁症的区别" class="headerlink" title="和重性抑郁症的区别"></a>和重性抑郁症的区别</h1><hr>
<p>和重性抑郁症的区别就是, 心境恶劣障碍是慢性的，程度相对重性抑郁症较轻，但是持续时间长，特征上多了一条低自尊，而且不受种族教育收入的影响。</p>
<h1 id="和疑病症的区别"><a href="#和疑病症的区别" class="headerlink" title="和疑病症的区别"></a>和疑病症的区别</h1><hr>
<p>有时心境恶劣障碍的人会被当做疑病症, 但却完全不同. 他们是长期忍受痛苦并自我牺牲的人, 不能正常的享受生活、对自己感到厌恶、睡眠不好、自卑感觉没有能力做任何事，而不是那种自私而神经过敏的人.</p>
<h1 id="发病率"><a href="#发病率" class="headerlink" title="发病率"></a>发病率</h1><hr>
<blockquote>
<p>慢性抑郁症“人群中的发病率约为3%，且与显著的机能障碍有关。至少四分之三患有临床上的身体疾病，或是另一种心理疾病，像焦虑症、药物成瘾或酒精成瘾。<br>《哈佛健康通讯》说：“慢性抑郁症患者家属之抑郁症早期发病率高达50%，“大多数患者不能明确指出抑郁开始的时间。</p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>《 UNDOING DEPRESSION: What therapy doesn’t teach you and medication can’t give you - Richard O’Connor 》<br><a href="https://zh.wikipedia.org/wiki/%E5%BF%83%E5%A2%83%E6%81%B6%E5%8A%A3%E9%9A%9C%E7%A2%8D" target="_blank" rel="external">心境恶劣障碍</a><br><a href="http://baike.baidu.com/item/%E7%96%91%E7%97%85%E7%97%87" target="_blank" rel="external">疑病症</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[war 的 docker 容器化部署]]></title>
      <url>http://www.nikoai.pw/2017/02/04/docker/deploy-war-to-tomcat-docker/</url>
      <content type="html"><![CDATA[<p>这篇博客记录如何将 war 包部署到 docker 的 web 容器中.</p>
<h1 id="拉取-tomcat-镜像"><a href="#拉取-tomcat-镜像" class="headerlink" title="拉取 tomcat 镜像"></a>拉取 tomcat 镜像</h1><hr>
<p>首先, 我们这里使用 tomcat 的容器来运行 war, 因此需要先拉取 tomcat 镜像:</p>
<pre><code>docker run -it --rm -p 8888:8080 tomcat:7.0.75-jre8
</code></pre><h1 id="编写-webapp-DockerFile"><a href="#编写-webapp-DockerFile" class="headerlink" title="编写 webapp DockerFile"></a>编写 webapp DockerFile</h1><hr>
<p>vim src/main/docker/Dockerfile</p>
<figure class="highlight docker"><table><tr><td class="code"><pre><div class="line"><span class="keyword">FROM</span> tomcat:<span class="number">7.0</span>.<span class="number">75</span>-jre<span class="number">8</span></div><div class="line">COPY javaweb.war /usr/local/tomcat/webapps/javaweb.war</div></pre></td></tr></table></figure>
<h1 id="配置-maven-的-docker-插件"><a href="#配置-maven-的-docker-插件" class="headerlink" title="配置 maven 的 docker 插件"></a>配置 maven 的 docker 插件</h1><hr>
<p>使用 docker 插件, 将生成 image 加入 maven task 中.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>nikoio<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    ...</div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>src/main/docker<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.war<span class="tag">&lt;/<span class="name">include</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="构建代码和镜像"><a href="#构建代码和镜像" class="headerlink" title="构建代码和镜像"></a>构建代码和镜像</h1><hr>
<pre><code>mvn clean package docker:build
</code></pre><h1 id="启动镜像"><a href="#启动镜像" class="headerlink" title="启动镜像"></a>启动镜像</h1><hr>
<p>查看构建成功的镜像:</p>
<pre><code>docker images
</code></pre><p>从镜像启动容器, (假设 image name 为 web):</p>
<pre><code>docker run -d -p 8888:8080 --name web-1.0 nikoio/docker-war-tomcat:1.0
</code></pre><h1 id="共享数据卷容器"><a href="#共享数据卷容器" class="headerlink" title="共享数据卷容器"></a>共享数据卷容器</h1><hr>
<p>由于我们的 tomcat 容器在运行中都会生成日志, 但如今若重新 build 了代码和镜像, 就是新的镜像了. 如果需要保留旧的日志等文件, 我们需要一个数据卷容器, 使得多个不同版本的 webapp 容器能够共用日志等文件.</p>
<p>首先, 我们先创建一个数据卷容器:</p>
<pre><code>docker run -d -v /usr/local/tomcat/logs --name tomcat_log tomcat:7.0.75-jre8 echo Data-only container for tomcat-7.0.75-jre8
</code></pre><p>或者</p>
<pre><code>docker create -v /usr/local/tomcat/logs --name tomcat_log_test tomcat:7.0.75-jre8 echo Data-only container for tomcat-7.0.75-jre8
</code></pre><p>web-1.0 基于刚才的 tomcat_log 数据卷容器启动.</p>
<pre><code>docker run -d --volumes-from tomcat_log --name web-1.0 nikoio/docker-war-tomcat:1.0
</code></pre><p>关闭 web-1.0 :</p>
<pre><code>docker stop web-1.0
</code></pre><p>启动 web-2.0 应用:</p>
<pre><code>docker run -d --volumes-from tomcat_log --name web-2.0 nikoio/docker-war-tomcat:2.0
</code></pre><p>此时, 可以进入 web-2.0 中, 可以查看到 web-1.0 的历史 tomcat 日志.</p>
<pre><code>docker exec -it web-2.0 /bin/bash
</code></pre><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://docs.docker.com/engine/reference/run/" target="_blank" rel="external">docker run</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ubuntu 分享移动硬盘 (samba)]]></title>
      <url>http://www.nikoai.pw/2017/01/15/linux/tools/others/ubuntu-mount-usb-disk-for-samba/</url>
      <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><hr>
<p>最近换电脑和手机比较频繁, 经常需要传东西和安装东西, 文件放在移动硬盘, 而需要这些文件可能被各种系统和终端使用.</p>
<h1 id="用特定-options-挂载-ntfs-移动硬盘"><a href="#用特定-options-挂载-ntfs-移动硬盘" class="headerlink" title="用特定 options 挂载 ntfs 移动硬盘"></a>用特定 options 挂载 ntfs 移动硬盘</h1><hr>
<p>平时我习惯用 samba 做共享, 但是 usb 插入移动硬盘(自动挂载), 所有文件默认是 rw 权限的, 而且不能修改. 因为这是在 mount 时设定的 (对 ntfs 来说) , 所以需要修改 mount options.</p>
<p>比如这个 options :</p>
<pre><code>sudo mount -t ntfs -o rw,auto,user,fmask=0022,dmask=0000 /dev/whatever /mnt/whatever
</code></pre><p>留意 fmask 和 dmask, 这样设置 /dev/whatever 挂载后的权限将会是 文件 <code>755</code> 和 目录 <code>777</code>, 这个很重要, 也是后面samba分享移动硬盘的前提 !</p>
<h1 id="samba-设置"><a href="#samba-设置" class="headerlink" title="samba 设置"></a>samba 设置</h1><hr>
<p>成功挂载 ntfs 移动硬盘后, 进行 samba 设置. 首先增加 samba 用户:</p>
<pre><code>sudo smbpasswd -a niko
</code></pre><p>上面输入的SMB码不要和系统登录密码一样 !</p>
<p>接着增加目录分享的配置,  <code>sudo vim /etc/samba/smb.conf</code>  :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[share_WD]</div><div class="line">path = /media/niko/niko_WD_A/share_folder_WD</div><div class="line">available = yes</div><div class="line">valid users = niko</div><div class="line">read only = no</div><div class="line">browsable = yes</div><div class="line">public = yes</div><div class="line">writable = yes</div></pre></td></tr></table></figure>
<p>保存后, <code>sudo /etc/init.d/smbd restart</code> 生效.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://techtalk.shieldsgroup.com/2014/05/es-file-explorer-cant-find-ubuntu-server/" target="_blank" rel="external">http://techtalk.shieldsgroup.com/2014/05/es-file-explorer-cant-find-ubuntu-server/</a><br><a href="http://forums.fedoraforum.org/showthread.php?t=268125" target="_blank" rel="external">http://forums.fedoraforum.org/showthread.php?t=268125</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[vmware 支持 linux kernel >= 4.2]]></title>
      <url>http://www.nikoai.pw/2016/12/30/linux/tools/vmware-with-kernel-4.2+/</url>
      <content type="html"><![CDATA[<p>最近升级了内核到 4.2 , 导致以前的 vmware 10 不能用了.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">before you can run vmware, several modules must be compiled and loaded into the running kernel.</div></pre></td></tr></table></figure>
<p>如上, 启动时要求重新编译和加载某些模块, 但是编译错误不成功, 查看提示的日志:</p>
<p>$ sudo tail /tmp/vmware-root/vmware-modconfig-9613.log</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">2016-12-28T22:28:57.500+08:00| vthread-3| I120: Extracting the vmnet source from &quot;/usr/lib/vmware/modules/source/vmnet.tar&quot;.</div><div class="line">2016-12-28T22:28:57.505+08:00| vthread-3| I120: Successfully extracted the vmnet source.</div><div class="line">2016-12-28T22:28:57.505+08:00| vthread-3| I120: Building module with command &quot;/usr/bin/make -j8 -C /tmp/modconfig-WP5c0z/vmnet-only auto-build HEADER_DIR=/lib/modules/4.2.0-040200rc8-generic/build/include CC=/usr/bin/gcc IS_GCC_3=no&quot;</div><div class="line">2016-12-28T22:28:58.535+08:00| vthread-3| W110: Failed to build vmnet.  Failed to execute the build command.</div></pre></td></tr></table></figure>
<p>可知, kernel 的变更影响了 vmnet 模块.</p>
<h1 id="方法-1-fail…"><a href="#方法-1-fail…" class="headerlink" title="方法 1: fail…"></a>方法 1: fail…</h1><hr>
<p>重新编译 vmnet 模块.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd /usr/lib/vmware/modules/source</div><div class="line">unpack vmnet.tar</div><div class="line">cd vmnet-only</div><div class="line">make</div><div class="line">cd ..</div><div class="line">unpack vmmon.tar</div><div class="line">cd vmmon-only</div><div class="line">make</div><div class="line">cd ..</div><div class="line">cp vmmon.o /lib/modules/`uname -r`/misc/vmmon.ko</div><div class="line">cp vmnet.o /lib/modules/`uname -r`/misc/vmnet.ko</div><div class="line">depmod -a</div><div class="line">/etc/init.d/vmware restart</div></pre></td></tr></table></figure>
<p>但是, 在编译 vmnet 时, 提示编译错误:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo make</div><div class="line">Using 2.6.x kernel build system.</div><div class="line">make -C /lib/modules/4.2.0-040200rc8-generic/build/include/.. SUBDIRS=$PWD SRCROOT=$PWD/. \</div><div class="line">	  MODULEBUILDDIR= modules</div><div class="line">make[1]: Entering directory `/usr/src/linux-headers-4.2.0-040200rc8-generic&apos;</div><div class="line">  CC [M]  /usr/lib/vmware/modules/source/vmnet-only/driver.o</div><div class="line">/usr/lib/vmware/modules/source/vmnet-only/driver.c: In function ‘VNetFileOpUnlockedIoctl’:</div><div class="line">/usr/lib/vmware/modules/source/vmnet-only/driver.c:1194:20: error: ‘struct file’ has no member named ‘f_dentry’</div><div class="line">    if (filp &amp;&amp; filp-&gt;f_dentry) &#123;</div><div class="line">                    ^</div><div class="line">/usr/lib/vmware/modules/source/vmnet-only/driver.c:1195:19: error: ‘struct file’ has no member named ‘f_dentry’</div><div class="line">       inode = filp-&gt;f_dentry-&gt;d_inode;</div><div class="line">                   ^</div><div class="line">make[2]: *** [/usr/lib/vmware/modules/source/vmnet-only/driver.o] Error 1</div><div class="line">make[1]: *** [_module_/usr/lib/vmware/modules/source/vmnet-only] Error 2</div><div class="line">make[1]: Leaving directory `/usr/src/linux-headers-4.2.0-040200rc8-generic&apos;</div><div class="line">make: *** [vmnet.ko] Error 2</div></pre></td></tr></table></figure>
<p>还是放弃这种做法, 不够优雅, 修改底层的东西以后会花很多时间处理手尾.</p>
<h1 id="方法2-使用新版的支持-kernel-gt-4-的-vmware-12"><a href="#方法2-使用新版的支持-kernel-gt-4-的-vmware-12" class="headerlink" title="方法2: 使用新版的支持 kernel &gt; 4 的 vmware 12"></a>方法2: 使用新版的支持 kernel &gt; 4 的 vmware 12</h1><hr>
<p>推荐这个方法, 首先先卸载 vmware 10.</p>
<p>查看已安装的 vmware 产品:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo vmware-installer -l</div><div class="line"></div><div class="line">(vmware-installer.py:6178): Gtk-WARNING **: Unable to locate theme engine in module_path: &quot;adwaita&quot;,</div><div class="line"></div><div class="line">(vmware-installer.py:6178): Gtk-WARNING **: Unable to locate theme engine in module_path: &quot;adwaita&quot;,</div><div class="line">/usr/share/themes/Adwaita/gtk-2.0/gtkrc:1137: error: unexpected identifier `direction&apos;, expected character `&#125;&apos;</div><div class="line">Gtk-Message: Failed to load module &quot;canberra-gtk-module&quot;: libcanberra-gtk-module.so: cannot open shared object file: No such file or directory</div><div class="line">Product Name         Product Version     </div><div class="line">==================== ====================</div><div class="line">vmware-workstation   10.0.6.2700073</div></pre></td></tr></table></figure>
<p>卸载 vmware-workstation :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo vmware-installer --uninstall-product vmware-workstation</div></pre></td></tr></table></figure>
<p>下载 <a href="http://www.vmware.com/products/workstation/workstation-evaluation.html" target="_blank" rel="external">vmware workstation 12.5</a> 并安装:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo bash ./VMware-Workstation-Full-12.5.2-4638234.x86_64.bundle</div></pre></td></tr></table></figure>
<p><strong>搞定.</strong></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://askubuntu.com/questions/131045/how-do-i-uninstall-vmware-workstation" target="_blank" rel="external">http://askubuntu.com/questions/131045/how-do-i-uninstall-vmware-workstation</a><br><a href="http://askubuntu.com/questions/724883/vmware-player-not-working-with-linux-kernel-4-2-5" target="_blank" rel="external">http://askubuntu.com/questions/724883/vmware-player-not-working-with-linux-kernel-4-2-5</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Intel Corporation Wireless 3165 - 网卡驱动]]></title>
      <url>http://www.nikoai.pw/2016/12/20/linux/drivers/ST-R1-intel-wireless-card-driver/</url>
      <content type="html"><![CDATA[<p>最近终于换了垂涎已久的蓝天14寸笔记本新模具，把台式机装有 ubuntu 的硬盘装上笔记本，发现无线网卡不能用, 当然要重新安装驱动, 这个不是问题.</p>
<h1 id="查看网卡信息"><a href="#查看网卡信息" class="headerlink" title="查看网卡信息"></a>查看网卡信息</h1><hr>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ sudo lspci</div><div class="line">[sudo] password <span class="keyword">for</span> niko:</div><div class="line"></div><div class="line">......</div><div class="line">04:00.0 Network controller: Intel Corporation Wireless 3165 (rev 81)</div><div class="line">......</div></pre></td></tr></table></figure>
<h1 id="根据网卡信息找驱动"><a href="#根据网卡信息找驱动" class="headerlink" title="根据网卡信息找驱动"></a>根据网卡信息找驱动</h1><hr>
<p>在<a href="http://www.intel.com/content/www/us/en/support/network-and-i-o/wireless-networking/000005511.html" target="_blank" rel="external">官网 - Linux* Support for Intel® Wireless Adapters</a>网页上，我们找到了该网卡的驱动信息:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Device	Kernels	Firmware</div><div class="line">Intel® Dual Band Wireless-AC 3165 (starting from firmware XX.XX.13.0 and kernel 4.1)	4.2	iwlwifi-7265-ucode-25.30.14.0.tgz</div></pre></td></tr></table></figure>
<p>可以看到, 需要是 4.2 的 Linux kernel 版本, 而我的系统通过 <code>uname -r</code> 发现内核版本仍然是 3.13 ， 故而不能使用。</p>
<h1 id="升级-kernel"><a href="#升级-kernel" class="headerlink" title="升级 kernel"></a>升级 kernel</h1><hr>
<p>因此我们先升级内核版本来支持该网卡驱动 (<a href="http://askubuntu.com/questions/657774/how-to-get-my-intel-wireless-3165-to-work" target="_blank" rel="external">参考</a>).</p>
<p>获取安装包:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> new_foo_folder</div><div class="line"></div><div class="line">wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.2-rc8-unstable/linux-image-4.2.0-040200rc8-generic_4.2.0-040200rc8.201508240030_amd64.deb http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.2-rc8-unstable/linux-headers-4.2.0-040200rc8_4.2.0-040200rc8.201508240030_all.deb http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.2-rc8-unstable/linux-headers-4.2.0-040200rc8-generic_4.2.0-040200rc8.201508240030_amd64.deb</div></pre></td></tr></table></figure>
<p>安装:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ll</div><div class="line">total 64156</div><div class="line">drwxrwxr-x 2 niko niko     4096 Dec 23 13:40 ./</div><div class="line">drwxrwxr-x 6 niko niko     4096 Dec 23 13:31 ../</div><div class="line">-rw-rw-r-- 1 niko niko  9591556 Aug 24  2015 linux-headers-4.2.0-040200rc8_4.2.0-040200rc8.201508240030_all.deb</div><div class="line">-rw-rw-r-- 1 niko niko   735336 Aug 24  2015 linux-headers-4.2.0-040200rc8-generic_4.2.0-040200rc8.201508240030_amd64.deb</div><div class="line">-rw-rw-r-- 1 niko niko 55355508 Aug 24  2015 linux-image-4.2.0-040200rc8-generic_4.2.0-040200rc8.201508240030_amd64.deb</div><div class="line"></div><div class="line"></div><div class="line">niko@niko-ub1404:~/dev/tools/sources/install/update-to-kernel-4-plus$ sudo dpkg -i *.deb</div><div class="line">[sudo] password for niko:</div><div class="line">Selecting previously unselected package linux-headers-4.2.0-040200rc8.</div><div class="line">(Reading database ... 326785 files and directories currently installed.)</div><div class="line">Preparing to unpack linux-headers-4.2.0-040200rc8_4.2.0-040200rc8.201508240030_all.deb ...</div><div class="line">Unpacking linux-headers-4.2.0-040200rc8 (4.2.0-040200rc8.201508240030) ...</div><div class="line">Selecting previously unselected package linux-headers-4.2.0-040200rc8-generic.</div><div class="line">Preparing to unpack linux-headers-4.2.0-040200rc8-generic_4.2.0-040200rc8.201508240030_amd64.deb ...</div><div class="line">Unpacking linux-headers-4.2.0-040200rc8-generic (4.2.0-040200rc8.201508240030) ...</div><div class="line">Selecting previously unselected package linux-image-4.2.0-040200rc8-generic.</div><div class="line">Preparing to unpack linux-image-4.2.0-040200rc8-generic_4.2.0-040200rc8.201508240030_amd64.deb ...</div><div class="line">Done.</div><div class="line">Unpacking linux-image-4.2.0-040200rc8-generic (4.2.0-040200rc8.201508240030) ...</div><div class="line">Setting up linux-headers-4.2.0-040200rc8 (4.2.0-040200rc8.201508240030) ...</div><div class="line">Setting up linux-headers-4.2.0-040200rc8-generic (4.2.0-040200rc8.201508240030) ...</div><div class="line">Examining /etc/kernel/header_postinst.d.</div><div class="line">run-parts: executing /etc/kernel/header_postinst.d/dkms 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">Setting up linux-image-4.2.0-040200rc8-generic (4.2.0-040200rc8.201508240030) ...</div><div class="line">Running depmod.</div><div class="line">update-initramfs: deferring update (hook will be called later)</div><div class="line">Examining /etc/kernel/postinst.d.</div><div class="line">run-parts: executing /etc/kernel/postinst.d/apt-auto-removal 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">run-parts: executing /etc/kernel/postinst.d/dkms 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">run-parts: executing /etc/kernel/postinst.d/initramfs-tools 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">update-initramfs: Generating /boot/initrd.img-4.2.0-040200rc8-generic</div><div class="line">run-parts: executing /etc/kernel/postinst.d/pm-utils 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">run-parts: executing /etc/kernel/postinst.d/update-notifier 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">run-parts: executing /etc/kernel/postinst.d/zz-update-grub 4.2.0-040200rc8-generic /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">Generating grub configuration file ...</div><div class="line">Warning: Setting GRUB_TIMEOUT to a non-zero value when GRUB_HIDDEN_TIMEOUT is set is no longer supported.</div><div class="line">Found linux image: /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">Found initrd image: /boot/initrd.img-4.2.0-040200rc8-generic</div><div class="line">Found linux image: /boot/vmlinuz-3.13.0-96-generic</div><div class="line">Found initrd image: /boot/initrd.img-3.13.0-96-generic</div><div class="line">Found linux image: /boot/vmlinuz-3.13.0-87-generic</div><div class="line">Found initrd image: /boot/initrd.img-3.13.0-87-generic</div><div class="line">Found linux image: /boot/vmlinuz-3.13.0-24-generic</div><div class="line">Found initrd image: /boot/initrd.img-3.13.0-24-generic</div><div class="line">Found memtest86+ image: /boot/memtest86+.elf</div><div class="line">Found memtest86+ image: /boot/memtest86+.bin</div><div class="line">done</div></pre></td></tr></table></figure>
<p>安装完成后, reboot , 查看内核版本:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ uname -r</div><div class="line">4.2.0-040200rc8-generic</div></pre></td></tr></table></figure>
<p>更新 grub:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo update-grub</div><div class="line">[sudo] password for niko:</div><div class="line">Generating grub configuration file ...</div><div class="line">Warning: Setting GRUB_TIMEOUT to a non-zero value when GRUB_HIDDEN_TIMEOUT is set is no longer supported.</div><div class="line">Found linux image: /boot/vmlinuz-4.2.0-040200rc8-generic</div><div class="line">Found initrd image: /boot/initrd.img-4.2.0-040200rc8-generic</div><div class="line">Found linux image: /boot/vmlinuz-3.13.0-96-generic</div><div class="line">Found initrd image: /boot/initrd.img-3.13.0-96-generic</div><div class="line">Found linux image: /boot/vmlinuz-3.13.0-87-generic</div><div class="line">Found initrd image: /boot/initrd.img-3.13.0-87-generic</div><div class="line">Found linux image: /boot/vmlinuz-3.13.0-24-generic</div><div class="line">Found initrd image: /boot/initrd.img-3.13.0-24-generic</div><div class="line">Found memtest86+ image: /boot/memtest86+.elf</div><div class="line">Found memtest86+ image: /boot/memtest86+.bin</div><div class="line">done</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo apt-get autoremove</div><div class="line">Reading package lists... Done</div><div class="line">Building dependency tree       </div><div class="line">Reading state information... Done</div><div class="line">The following packages will be REMOVED:</div><div class="line">  bbswitch-dkms dkms lib32gcc1 libc6-i386 libterm-readkey-perl libvdpau1</div><div class="line">  screen-resolution-extra</div><div class="line">0 upgraded, 0 newly installed, 7 to remove and 12 not upgraded.</div><div class="line">After this operation, 10.8 MB disk space will be freed.</div><div class="line">Do you want to continue? [Y/n] Y</div></pre></td></tr></table></figure>
<p>此时可以发现, 在右上角(gnome)的网络设置中可以选择 wifi 了, 通过 iwconfig 以及 ifconfig 都可以列出 intel 的无线网卡了.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://askubuntu.com/questions/657774/how-to-get-my-intel-wireless-3165-to-work" target="_blank" rel="external">http://askubuntu.com/questions/657774/how-to-get-my-intel-wireless-3165-to-work</a><br><a href="http://www.intel.com/content/www/us/en/support/network-and-i-o/wireless-networking/000005511.html" target="_blank" rel="external">http://www.intel.com/content/www/us/en/support/network-and-i-o/wireless-networking/000005511.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Raft 一致性算法精要简述和理解（二）]]></title>
      <url>http://www.nikoai.pw/2016/12/01/cs/algo/raft-alog-2/</url>
      <content type="html"><![CDATA[<h1 id="Cluster-membership-changes"><a href="#Cluster-membership-changes" class="headerlink" title="Cluster membership changes"></a>Cluster membership changes</h1><hr>
<p>在前一篇博客中，我们讨论的场景都是固定数目的 nodes ，但在实践中，集群的数目是会变化的，比如替换已经 crash 的机器、更换机器等等。为了更新配置而不用手工重启集群， Raft 把自动化配置更改加入到了算法中。</p>
<h1 id="不安全的因素"><a href="#不安全的因素" class="headerlink" title="不安全的因素"></a>不安全的因素</h1><hr>
<p>在切换配置时，可能的不安全问题如下图所示：</p>
<p><img src="/images/cs/algo/raft/raft-members-change-01.png" alt=""></p>
<p>当动态加入新的 nodes 时， 存在这样的时间点，使新的 leader 能够选举成功，从而到导致同时存在两个 leader 。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><hr>
<p>为了使修改配置能够安全，就必须保证切换时的选举安全。</p>
<p>raft 的方法是， 首先切换到称为 <code>joint consensus</code> 的过渡配置上，一旦这个 <code>joint consensus</code> 被提交成功了， 才切换到新的配置上去。<code>joint consensus</code> 结合新旧配置，这个过程中：</p>
<ul>
<li>Log entries 都会被复制到新和旧配置的 nodes 上</li>
<li>新和旧配置的 nodes 都可以成为 leader</li>
<li>选举和日志提交都需要新和旧的配置上获得 majority 的支持</li>
</ul>
<p><code>joint consensus</code> 允许独立的服务器在不同的时间切换配置而不会破坏安全性，不仅如此，它还允许集群继续服务客户端的请求。</p>
<p>集群配置是使用特殊的 log entries 来存储和沟通的。</p>
<p><img src="/images/cs/algo/raft/raft-members-change-02.png" alt=""></p>
<p>如上，当 leader 接收到 <code>Cold -&gt; Cnew</code> 的请求时，它将 <code>joint consensus</code> 的配置 <code>Cold+new</code> 保存在一个 log entry，并 replicate 到其他 nodes。每当一个 node 保存 log entry 到本地时，它将使用新的配置作为后面决定的依据（不管这个 entry 有没有被 commit，node 总是使用最新的配置）。</p>
<p>如果此时 leader crash 掉，那么新的 leader 使用的可能是 Cold 或者 <code>Cold+new</code>，这个取决于新 leader 有没有收到期前一个 leader 的 <code>Cold+new</code>。</p>
<p>无论如何，在这期间 Cnew 不能作出单方面的决定。</p>
<p>一旦 <code>Cold+new</code> 被提交成功，Cold 和 Cnew 都不能单方面做决定，<code>Leader Completeness</code> 特性保证包含 <code>Cold+new</code> 的 leader 才能赢得选举。</p>
<p>这时候，leader 可以安全的把创建 <code>Cnew</code> 的 log entry 并 replicate 给其他 nodes。<br>这些过程中，Cold 和 Cnew 都没有机会可以单方面作出决定。</p>
<p>不过我们还有三个要注意的问题：</p>
<ol>
<li><p>新加入的 nodes 还没有 log entries，他们可以要花一些时间来同步。为了提高可用性， Raft 规定这些新加入的 nodes 没有投票权，只有当日志跟上了其他 nodes， 才进行上面的配置修改流程。</p>
</li>
<li><p>如果 leader 不是新配置中的 node，那么在某段时间，leader 管理集群是不把自己算进去的，复制日志时的 majority 也不包括自己。当 <code>Cnew</code> 被提交了，leader 就可以领导人交接过渡了，此时新的 leader 必然在 Cnew 中。</p>
</li>
<li><p>不在 Cnew 中的 nodes 重复选举的问题。因为他们收不到新的 leader 的心跳，那么将会超时进入新的选举，使用新的 term value 发送 RequestVote RPCs，并导致现在的 leader step down，新的 leader 被选出来。这样大大降低了集群的可用性。为了避免这种情况，Raft 规定，当有 leader 存在时，如果 node 收到 <code>RequestVote RPC</code> 消息，不能更新自己的 term 和投票，这样，leader 如果能够发送 heartbeats 给其他 nodes（保持权威和影响力），它将不会被新的 term 罢黜。</p>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://ramcloud.stanford.edu/wiki/download/attachments/11370504/raft.pdf" target="_blank" rel="external">raft paper - In Search of an Understandable Consensus Algorithm - Diego Ongaro and John Ousterhout</a><br><a href="https://raft.github.io/raft.pdf" target="_blank" rel="external">online raft paper</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[vim 的颜色 scheme 修改]]></title>
      <url>http://www.nikoai.pw/2016/12/01/linux/tools/others/vim-dark-blue-problem-fix/</url>
      <content type="html"><![CDATA[<h1 id="让人眼瞎的-colorscheme-gt-lt"><a href="#让人眼瞎的-colorscheme-gt-lt" class="headerlink" title="让人眼瞎的 colorscheme %&gt;_&lt;%"></a>让人眼瞎的 colorscheme <code>%&gt;_&lt;%</code></h1><hr>
<p>今天换了电脑，vim 是新的，默认的 colorscheme 太难看，尤其是黑色背景下的蓝色注释，如下体会一下：</p>
<p><img src="/images/linux/tools/vim/vim-color-old-01.png" alt=""></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><hr>
<p>查看可选的替代 <code>colorscheme</code> （路径中的 vim80 对应的是我的版本，不同环境路径不同。） ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ll /usr/share/vim/vim80/colors/</div><div class="line"></div><div class="line">drwxr-xr-x  2 root root 4096 Oct 14 19:05 ./</div><div class="line">drwxr-xr-x 18 root root 4096 Oct 14 19:05 ../</div><div class="line">-rw-r--r--  1 root root 2476 Oct 14 19:25 blue.vim</div><div class="line">-rw-r--r--  1 root root 2990 Oct 14 19:25 darkblue.vim</div><div class="line">-rw-r--r--  1 root root  548 Oct 14 19:25 default.vim</div><div class="line">-rw-r--r--  1 root root 2522 Oct 14 19:25 delek.vim</div><div class="line">-rw-r--r--  1 root root 2812 Oct 14 19:25 desert.vim</div><div class="line">-rw-r--r--  1 root root 1666 Oct 14 19:25 elflord.vim</div><div class="line">-rw-r--r--  1 root root 2452 Oct 14 19:25 evening.vim</div><div class="line">-rw-r--r--  1 root root 1958 Oct 14 19:25 industry.vim</div><div class="line">-rw-r--r--  1 root root 3555 Oct 14 19:25 koehler.vim</div><div class="line">-rw-r--r--  1 root root 2460 Oct 14 19:25 morning.vim</div><div class="line">-rw-r--r--  1 root root 2006 Oct 14 19:25 murphy.vim</div><div class="line">-rw-r--r--  1 root root 1037 Oct 14 19:25 pablo.vim</div><div class="line">-rw-r--r--  1 root root 2673 Oct 14 19:25 peachpuff.vim</div><div class="line">-rw-r--r--  1 root root 2640 Oct 14 19:25 README.txt</div><div class="line">-rw-r--r--  1 root root 1393 Oct 14 19:25 ron.vim</div><div class="line">-rw-r--r--  1 root root 2720 Oct 14 19:25 shine.vim</div><div class="line">-rw-r--r--  1 root root 2445 Oct 14 19:25 slate.vim</div><div class="line">-rw-r--r--  1 root root 1629 Oct 14 19:25 torte.vim</div><div class="line">-rw-r--r--  1 root root 1840 Oct 14 19:25 zellner.vim</div></pre></td></tr></table></figure>
<p>写入 vim 配置， <code>vim ~/.vimrc</code> , 增加 colorscheme 设置，比如使用 <code>desert.vim</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">colorscheme desert</div></pre></td></tr></table></figure>
<p>如果只是想预览颜色看看，只需在 vim 中输入命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">:color desert</div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="/images/linux/tools/vim/vim-color-old-02.png" alt=""></p>
<p>终于舒服点了。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://unix.stackexchange.com/questions/88879/vim-better-colors-so-comments-arent-dark-blue" target="_blank" rel="external">http://unix.stackexchange.com/questions/88879/vim-better-colors-so-comments-arent-dark-blue</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Raft 一致性算法精要简述和理解（一）]]></title>
      <url>http://www.nikoai.pw/2016/11/30/cs/algo/raft-algo-1/</url>
      <content type="html"><![CDATA[<p>Raft 是一种一致性算法, 和 Paxos 的功能一样, 但相比 Paxos 容易理解很多. Raft 将一致性问题分解成了几个部分: Leader Election, Log Replication, Safety，Cluster membership changes. Raft 采用了一种更强的 leader 机制来减少要考虑的状态数量，支持集群成员可以动态改变.</p>
<h1 id="一些定义和前提"><a href="#一些定义和前提" class="headerlink" title="一些定义和前提"></a>一些定义和前提</h1><hr>
<p>在理解 Raft 算法之前，需要准备一些知识和定义，这里将会介绍。为了更快的理解，可以一边阅读 Raft 的内容，一边查阅这些规则和定义。</p>
<h2 id="node-状态"><a href="#node-状态" class="headerlink" title="node 状态"></a>node 状态</h2><hr>
<p><img src="/images/cs/algo/raft/raft-state-01.png" alt=""></p>
<h2 id="RPC-消息"><a href="#RPC-消息" class="headerlink" title="RPC 消息"></a>RPC 消息</h2><hr>
<p>下面是来自论文中的定义：</p>
<p><img src="/images/cs/algo/raft/RequestVote-RPC-01.png" alt="RequestVote RPC"></p>
<p><img src="/images/cs/algo/raft/AppendEntries-RPC-01.png" alt="AppendEntries RPC"></p>
<h2 id="node-要遵守的规则"><a href="#node-要遵守的规则" class="headerlink" title="node 要遵守的规则"></a>node 要遵守的规则</h2><hr>
<p><img src="/images/cs/algo/raft/raft-rules-for-nodes.png" alt=""></p>
<h2 id="raft-任何时候都要保证的特性："><a href="#raft-任何时候都要保证的特性：" class="headerlink" title="raft 任何时候都要保证的特性："></a>raft 任何时候都要保证的特性：</h2><hr>
<table>
<thead>
<tr>
<th>特性 （properties）</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Election Safety</td>
<td>特定 term 最多只会有一个 leader （<code>5.2 节</code>）</td>
</tr>
<tr>
<td>Leader Append-Only</td>
<td>leader 只会追加，绝不删除或者覆盖自己的日志（<code>5.3 节</code>）</td>
</tr>
<tr>
<td>Log Matching</td>
<td>若两个日志在某个 index 的 entry 上有相同的 term，那么这个日志从头到该 index 都是完全相同的 （<code>5.3 节</code>）</td>
</tr>
<tr>
<td>Leader Completeness Property</td>
<td>若一个 log entry 在某个 term 被提交成功了，那么后面任期的 leader 都会包含该 log entry（<code>5.4 节</code>）</td>
</tr>
<tr>
<td>State Machine Safety</td>
<td>如果一个 node 已经 apply 了一个某 index 的 log entry 到状态机，那么其他 node 不会提交一个不同的 log entry<code>（5.4.3 节）</code></td>
</tr>
</tbody>
</table>
<p>Raft 是如何保证这些特性的， 看完接下来的工作过程就可以理解了。</p>
<h1 id="Leader-Election"><a href="#Leader-Election" class="headerlink" title="Leader Election"></a>Leader Election</h1><hr>
<p>开始介绍 raft 一致性算法， 首先要先了解 Leader Election。Raft 定义了 node 的三种状态（身份）：leader，follower，candidate。</p>
<p><img src="/images/cs/algo/raft-state-change-01.png" alt=""></p>
<p>如上图， 所有的 node 都是以 follower 状态开始, Raft 使用两个 timeout 来控制选举.<br>第一个是 election timeout, 这个值是 follwer 变成 candidate 前等待的时间, 当 election timeout 到来时, follwer 将成为 candidate, 并开启一个新的选举 term.<br>假设有多个 node: NodeA、NodeB、NodeC，而 timeout 分别是 200ms、190ms、180ms。那么 NodeC 将首先 timeout, 自增 term value（初始 term 为 0），重置 election timeout，投票给自己：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Node C</div><div class="line">Term: 1</div><div class="line">Vote Count: 1</div></pre></td></tr></table></figure>
<p>接着发送 <code>RequestVote RPC</code> 消息给其他 nodes 来给自己投票，如果消息接收者还没有在这个选举 term 进行过投票， 则进行以下投票相关的判断和操作：</p>
<ul>
<li>首先判断 term 是否小于 currentTerm ，是则返回 false ；</li>
<li>若 votedFor 为空或为 candidateId，并且该 candidate 的日志和自己一样新，那就投票给他，并重置自己的 election timeout。</li>
</ul>
<p>只要某个 candidate 获得大部分的选票， 他将成为 leader， 接着 leader 开始发送 <code>AppendEntries RPC</code> 心跳消息给他的 follower, 不断维持自己的身份并阻止新的领导人产生。这个心跳发送也有一个超时时间，称为 <code>heartbeat timeout</code> .</p>
<p>对于 candidate 投票的结果， 有 3 种情况:</p>
<ol>
<li>自己成为 leader；</li>
<li>其他 candidate 成为 leader；<br>在 candidate 等待投票时， 他也可能收到其他 node 的 <code>AppendEntries RPC</code>（表示该 node 声明自己是 leader）：<br>如果这个 node 的 term value <code>大于等于</code>当前 candidate 的 term value， 那么 candidate 将承认该 node 的 leader 身份，并切换到 follower 状态。<br>若这个 node 的 term value <code>小于</code>当前 candidate 的 term value，那么 candidate 将拒绝承认这个 <code>AppendEntries RPC</code> ，继续保持自己的 candidate 身份。</li>
<li>多个 candidate 获得的选票不足以达到大多数（比如两个 candidate 获得同样数目的选票）， 此时选举无效，他们都会 timeout，然后将通过增加 term value 来开始新一轮的选举。然而，这种情况可能无限重复发生（称为 <code>split votes</code> ），一直选举失败无果。所以，我们需要有一些机制，防止这种情况。Raft 是采用随机 election timeout 来减少<code>split votes</code>发生的可能性，这个随机值是 150ms 到 300ms。</li>
</ol>
<h1 id="Log-Replication"><a href="#Log-Replication" class="headerlink" title="Log Replication"></a>Log Replication</h1><hr>
<p>一旦有一个 leader 被选举出来， 接着就需要去 replicate 所有的变更到所有的 nodes。这个是通过 <code>AppendEntries RPC</code> 消息（心跳）来完成。</p>
<p>若此时客户端发送一个变更修改到 leader，leader 会将变更发往他的 followers，当<code>大多数</code>的 follower 收到后，这个变更将被 leader commit，接着会发送一个 response 回客户端。</p>
<p>log replication 和 commit 状态如下图所示，不同颜色表示不同 term，每个 log entry 都有一个对应的 index。</p>
<p><img src="/images/cs/algo/raft-log-copy-01.png" alt=""></p>
<p>而真实的 leader 选举出来时的 cluster 情况可能是这样的：</p>
<p><img src="/images/cs/algo/raft-leader-comeout-cluster-statue-01.png" alt=""></p>
<p>如上，followers 可能缺少一些日志（如ab），可能有未提交的日志（如cd），也可能两种情况同时存在（如ef），这就存在一致性的问题了。</p>
<p>那么在 Raft 算法中，leader 如何处理这种不一致的情况呢？</p>
<blockquote>
<p>In Raft, the leader handles inconsistencies by forcing<br>the followers’ logs to duplicate its own. This means that<br>conflicting entries in follower logs will be overwritten<br>with entries from the leader’s log</p>
</blockquote>
<p>可知在 Raft 中，leader 强制 follower 复制 leader 的 logs，这意味着冲突的 log entries 将被 leader 覆盖。</p>
<h2 id="Network-Partitions-问题"><a href="#Network-Partitions-问题" class="headerlink" title="Network Partitions 问题"></a>Network Partitions 问题</h2><hr>
<p>当遇到 network partitions （网络割裂）（脑裂） 的一致性问题时， Raft 也可以正常工作：</p>
<p><img src="/images/cs/algo/raft-network-partitions-split-brain-02.png" alt=""></p>
<blockquote>
<p>图片来源：<a href="http://thesecretlivesofdata.com/raft/#replication" target="_blank" rel="external">http://thesecretlivesofdata.com/raft/#replication</a></p>
</blockquote>
<p>如上，当客户端（绿色）分别发送请求到两个分区时，下面的分区 leader log entry 不能提交，因为不能复制到大多数的 nodes, 而上面的分区 leader 可以提交日志.</p>
<p>网络恢复时，网络分区合并，NodeB 将碰到了更高的 term，进而降级为 follower，并回滚 uncommitted log entries ，接收 leader 的 log entries，最终达成一致。</p>
<h1 id="Safety"><a href="#Safety" class="headerlink" title="Safety"></a>Safety</h1><hr>
<p>前面介绍了选举过程，但其中还有一些问题。</p>
<h2 id="raft-如何保证领导人完全特性（Leader-Completeness-Property）"><a href="#raft-如何保证领导人完全特性（Leader-Completeness-Property）" class="headerlink" title="raft 如何保证领导人完全特性（Leader Completeness Property）"></a><strong>raft 如何保证领导人完全特性（Leader Completeness Property）</strong></h2><p>Raft 的关键措施：</p>
<ul>
<li>log entries 只有被复制到 majority of nodes，才能进行 commit；</li>
<li>follower 不会投票给 logs 比自己旧的 candidate</li>
</ul>
<p>即是 candidate 想要赢得选举，就必须得到这就保证了新的 majority of nodes 的支持，也意味这 candidate 需要包含了 all committed log entries，因此赢得选举的 leader 一定会有 committed log entries，这就保证了 <code>Leader Completeness Property</code>。</p>
<p>那么投票时 logs 的新旧如何对比？<br>通过比较它们最后一个 entries 的 index 和 term，若 term 不同，那么 later term 的 node 比较新；若 term 相同，那么 log 更长的 node 比较新。</p>
<h2 id="commit-之前-term-的-log"><a href="#commit-之前-term-的-log" class="headerlink" title="commit 之前 term 的 log"></a><strong>commit 之前 term 的 log</strong></h2><p>接着 <code>Log replication</code> 的部分，这里继续讨论更复杂的情况。</p>
<p><img src="/images/cs/algo/raft/raft-safety-commit-old-term-logs-01.png" alt=""></p>
<p>如上图，粗框的表示 leader，在（a）中，S1 为 leader，复制了 [index2，term2] 给 S2；<br>接着，在（b）中，S1 crash，S5 选举为 leader；</p>
<p>此时，S5会将 [index2，term3] 复制给其他 nodes，[index2，term2] 将被覆盖，如下：</p>
<p><img src="/images/cs/algo/raft/raft-safety-commit-old-term-logs-02.png" alt=""></p>
<p>不过，在（b）时，若 S5 crash，S1 恢复，那么 S1 将继续复制 [index2，term2]，然后提交，如下：</p>
<p><img src="/images/cs/algo/raft/raft-safety-commit-old-term-logs-03.png" alt=""></p>
<p>如果提交成功，如下：</p>
<p><img src="/images/cs/algo/raft/raft-safety-commit-old-term-logs-04.png" alt=""></p>
<p>那么，即便 S1 又 crash 掉，S5 也不能赢得选举了，因为 S5 不可能获得 majority 的票数。</p>
<h2 id="安全性证明"><a href="#安全性证明" class="headerlink" title="安全性证明"></a>安全性证明</h2><p>关于安全性证明，主要采用反证法，有兴趣的参考论文的 <code>5.4.3 Safety argument</code>。</p>
<h1 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h1><hr>
<p>今天太困了，明天还要上班，raft 还有一些内容，下一篇继续吧。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://ramcloud.stanford.edu/wiki/download/attachments/11370504/raft.pdf" target="_blank" rel="external">raft paper - In Search of an Understandable Consensus Algorithm - Diego Ongaro and John Ousterhout</a><br><a href="https://raft.github.io/raft.pdf" target="_blank" rel="external">online raft paper</a><br><a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="external">可视化演示</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring IoC 容器实现（1） - 初始化过程]]></title>
      <url>http://www.nikoai.pw/2016/11/20/java/spring/src/spring-ioc-init-01/</url>
      <content type="html"><![CDATA[<h1 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h1><hr>
<p>要了解 IOC 容器内部, 首先要了解 BeanFactory 和 ApplicationContext.</p>
<p>BeanFactory 是访问 spring bean 容器的根接口, ApplicationContext 则作为高级容器, 为应用提供配置/事件发布等功能.</p>
<p>如下图所示:</p>
<p><img src="/images/java/spring/ApplicationContext-hierarchy-01.png" alt=""></p>
<h1 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h1><hr>
<h2 id="XmlBeanFactory"><a href="#XmlBeanFactory" class="headerlink" title="XmlBeanFactory"></a><code>XmlBeanFactory</code></h2><p>说起 BeanFactory， 这里以它的实现之一 <code>XmlBeanFactory</code> 为例：</p>
<p>设计图:</p>
<p><img src="/images/java/spring/DefaultListableBeanFactory-hierarchy-01.png" alt=""></p>
<p>首先 XmlBeanFactory 继承了 <code>DefaultListableBeanFactory</code>，ListableBeanFactory 和 BeanDefinitionRegistry 的默认实现, 是功能完全的 bean factory, 后面会经常提到:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBeanFactory</span> <span class="keyword">extends</span> <span class="title">DefaultListableBeanFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Create a new XmlBeanFactory with the given resource,</div><div class="line">	 * which must be parsable using DOM.</div><div class="line">	 * <span class="doctag">@param</span> resource XML resource to load bean definitions from</div><div class="line">	 * <span class="doctag">@throws</span> BeansException in case of loading or parsing errors</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XmlBeanFactory</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">this</span>(resource, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Create a new XmlBeanFactory with the given input stream,</div><div class="line">	 * which must be parsable using DOM.</div><div class="line">	 * <span class="doctag">@param</span> resource XML resource to load bean definitions from</div><div class="line">	 * <span class="doctag">@param</span> parentBeanFactory parent bean factory</div><div class="line">	 * <span class="doctag">@throws</span> BeansException in case of loading or parsing errors</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XmlBeanFactory</span><span class="params">(Resource resource, BeanFactory parentBeanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">super</span>(parentBeanFactory);</div><div class="line">		<span class="keyword">this</span>.reader.loadBeanDefinitions(resource);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="编程的方式使用-IoC"><a href="#编程的方式使用-IoC" class="headerlink" title="编程的方式使用 IoC"></a>编程的方式使用 IoC</h2><hr>
<p>BeanFactory 是低级容器， 作为基本容器， 可以直接编程使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"beans.xml"</span>);</div><div class="line">DefaultListableBeanFactory factory = <span class="keyword">new</span> DefaultListableBeanFactory();</div><div class="line">XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(<span class="keyword">this</span>);</div><div class="line">reader.loadBeanDefinitions(resource);</div></pre></td></tr></table></figure>
<h1 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h1><hr>
<p>以 <code>FileSystemXmlApplicationContext</code>  为例:</p>
<p>因为继承了 <code>AbstractApplicationContext</code>  , <code>AbstractApplicationContext</code> 继承 <code>DefaultResourceLoader</code>, <code>DefaultResourceLoader</code> 是默认的Resource资源加载器, 实现 <code>ResourceLoader</code> 接口,  因此可以获得 Resource 定义的 BeanDefinition 的能力.</p>
<p>FileSystemXmlApplicationContext 继承:</p>
<p><img src="/images/java/spring/FileSystemXmlApplicationContext-hierarchy-01.png" alt=""></p>
<p>FileSystemXmlApplicationContext 更详细的类和接口关系:</p>
<p><img src="/images/java/spring/FileSystemXmlApplicationContext-hierarchy-00.png" alt=""></p>
<p>它的核心构造器 <code>FileSystemXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)</code> 中, <code>refresh()</code> 就是进行容器初始化的过程, 后面会提到里边的具体实现.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemXmlApplicationContext</span> <span class="keyword">extends</span> <span class="title">AbstractXmlApplicationContext</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(ApplicationContext parent)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(parent);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(String configLocation)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">this</span>(<span class="keyword">new</span> String[] &#123;configLocation&#125;, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Create a new FileSystemXmlApplicationContext, loading the definitions</div><div class="line">	 * from the given XML files and automatically refreshing the context.</div><div class="line">	 * <span class="doctag">@param</span> configLocations array of file paths</div><div class="line">	 * <span class="doctag">@throws</span> BeansException if context creation failed</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(String... configLocations)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">this</span>(configLocations, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(String[] configLocations, ApplicationContext parent)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">this</span>(configLocations, <span class="keyword">true</span>, parent);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(String[] configLocations, <span class="keyword">boolean</span> refresh)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">		<span class="keyword">this</span>(configLocations, refresh, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(String[] configLocations, <span class="keyword">boolean</span> refresh, ApplicationContext parent)</span></span></div><div class="line">			<span class="keyword">throws</span> BeansException &#123;</div><div class="line"></div><div class="line">		<span class="keyword">super</span>(parent);</div><div class="line">		setConfigLocations(configLocations);</div><div class="line">		<span class="keyword">if</span> (refresh) &#123;</div><div class="line">			refresh();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">			path = path.substring(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FileSystemResource(path);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来， 就继续以 FileSystemXmlApplicationContext 为例， 介绍容器初始化过程 ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">ApplicationContext context = <span class="keyword">new</span> FileSystemXmlApplicationContext</div><div class="line">            (<span class="string">"/path/beans.xml"</span>);</div><div class="line">context.getBean(<span class="string">"hello"</span>);</div></pre></td></tr></table></figure>
<h2 id="Resource-加载"><a href="#Resource-加载" class="headerlink" title="Resource 加载"></a>Resource 加载</h2><hr>
<p>用过spring的童鞋都知道, 首先我们会定义一些bean, 容器初始化当然也要首先读取这些bean的定义, 这些定义 spring 中对应的是 BeanDefinition 接口. spring 容器将会读取 Resource 配置加载 bean，因此首先要找到 Resource。</p>
<p>在上面 FileSystemXmlApplicationContext 的构造器中， 作为入口，首先 super() 执行父类的构造器，获取 ResourcePatternResolver ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public AbstractApplicationContext() &#123;</div><div class="line">		this.resourcePatternResolver = getResourcePatternResolver();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><code>ResourcePatternResolver</code> 可以将 configLocations 转换成相应的 Resources:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourcePatternResolver</span> <span class="keyword">extends</span> <span class="title">ResourceLoader</span> </span>&#123;</div><div class="line">	String CLASSPATH_ALL_URL_PREFIX = <span class="string">"classpath*:"</span>;</div><div class="line">	Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结合前面的 hierarchy 图来看, 因为 FileSystemXmlApplicationContext 实现了 <code>ResourceLoader</code> 和 <code>ResourcePatternResolver</code>, 因此有获取 Resource 的能力，这在后面加载 bean 定义的时候非常有用 :</p>
<p><code>ResourceLoader</code> 定义:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/** Pseudo URL prefix for loading from the class path: "classpath:" */</span></div><div class="line">	String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX;</div><div class="line"></div><div class="line">	<span class="function">Resource <span class="title">getResource</span><span class="params">(String location)</span></span>;</div><div class="line"></div><div class="line">	<span class="function">ClassLoader <span class="title">getClassLoader</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续看 hierarchy 图, 看 ResourceLoader 的第一个实现 <code>DefaultResourceLoader</code> 的 <code>getResource(String location)</code> 内容:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">(String location)</span> </span>&#123;</div><div class="line">	Assert.notNull(location, <span class="string">"Location must not be null"</span>);</div><div class="line">	<span class="keyword">if</span> (location.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">		<span class="keyword">return</span> getResourceByPath(location);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader());</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// Try to parse the location as a URL...</span></div><div class="line">			URL url = <span class="keyword">new</span> URL(location);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> UrlResource(url);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (MalformedURLException ex) &#123;</div><div class="line">			<span class="comment">// No URL -&gt; resolve as resource path.</span></div><div class="line">			<span class="keyword">return</span> getResourceByPath(location);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ClassPathContextResource(path, getClassLoader());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>org.springframework.context.support.FileSystemXmlApplicationContext</code> 作为子类, 覆盖了 <code>getResourceByPath(String path)</code>, 从而使 FileSystemResource 替代 ClassPathContextResource :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Resource <span class="title">getResourceByPath</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">		path = path.substring(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> FileSystemResource(path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><hr>
<p>能够获取到 Resource 之后, 我们就可以据此载入 BeanDefinition, 开始IoC容器的初始化, 继续看前面 AbstractApplicationContext 构造器中的<code>refresh()</code>, 里边的一连串方法就是初始化的过程 :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</div><div class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</div><div class="line">			<span class="comment">// Prepare this context for refreshing.</span></div><div class="line">			prepareRefresh();</div><div class="line"></div><div class="line">			<span class="comment">// Tell the subclass to refresh the internal bean factory.</span></div><div class="line">			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div><div class="line"></div><div class="line">			<span class="comment">// Prepare the bean factory for use in this context.</span></div><div class="line">			prepareBeanFactory(beanFactory);</div><div class="line"></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></div><div class="line">				postProcessBeanFactory(beanFactory);</div><div class="line"></div><div class="line">				<span class="comment">// Invoke factory processors registered as beans in the context.</span></div><div class="line">				invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line"></div><div class="line">				<span class="comment">// Register bean processors that intercept bean creation.</span></div><div class="line">				registerBeanPostProcessors(beanFactory);</div><div class="line"></div><div class="line">				<span class="comment">// Initialize message source for this context.</span></div><div class="line">				initMessageSource();</div><div class="line"></div><div class="line">				<span class="comment">// Initialize event multicaster for this context.</span></div><div class="line">				initApplicationEventMulticaster();</div><div class="line"></div><div class="line">				<span class="comment">// Initialize other special beans in specific context subclasses.</span></div><div class="line">				onRefresh();</div><div class="line"></div><div class="line">				<span class="comment">// Check for listener beans and register them.</span></div><div class="line">				registerListeners();</div><div class="line"></div><div class="line">				<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></div><div class="line">				finishBeanFactoryInitialization(beanFactory);</div><div class="line"></div><div class="line">				<span class="comment">// Last step: publish corresponding event.</span></div><div class="line">				finishRefresh();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</div><div class="line">					logger.warn(<span class="string">"Exception encountered during context initialization - "</span> +</div><div class="line">							<span class="string">"cancelling refresh attempt: "</span> + ex);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// Destroy already created singletons to avoid dangling resources.</span></div><div class="line">				destroyBeans();</div><div class="line"></div><div class="line">				<span class="comment">// Reset 'active' flag.</span></div><div class="line">				cancelRefresh(ex);</div><div class="line"></div><div class="line">				<span class="comment">// Propagate exception to caller.</span></div><div class="line">				<span class="keyword">throw</span> ex;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">finally</span> &#123;</div><div class="line">				<span class="comment">// Reset common introspection caches in Spring's core, since we</span></div><div class="line">				<span class="comment">// might not ever need metadata for singleton beans anymore...</span></div><div class="line">				resetCommonCaches();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>在上面的 <code>obtainFreshBeanFactory()</code> 中:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">	refreshBeanFactory();</div><div class="line">	ConfigurableListableBeanFactory beanFactory = getBeanFactory();</div><div class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">		logger.debug(<span class="string">"Bean factory for "</span> + getDisplayName() + <span class="string">": "</span> + beanFactory);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> beanFactory;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中, <code>refreshBeanFactory()</code>需要关注一下, 看一下实现 <code>AbstractRefreshableApplicationContext</code> 的 <code>refreshBeanFactory()</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">	<span class="keyword">if</span> (hasBeanFactory()) &#123;</div><div class="line">		destroyBeans();</div><div class="line">		closeBeanFactory();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		DefaultListableBeanFactory beanFactory = createBeanFactory();</div><div class="line">		beanFactory.setSerializationId(getId());</div><div class="line">		customizeBeanFactory(beanFactory);</div><div class="line">		loadBeanDefinitions(beanFactory);</div><div class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</div><div class="line">			<span class="keyword">this</span>.beanFactory = beanFactory;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>createBeanFactory()</code> 就是创建 <code>DefaultListableBeanFactory</code> 的地方 (这个类的作用和重要性在前面介绍过了) .</p>
<h2 id="载入-BeanDefinitions"><a href="#载入-BeanDefinitions" class="headerlink" title="载入 BeanDefinitions"></a>载入 BeanDefinitions</h2><hr>
<p>接着上面的 <code>loadBeanDefinitions()</code> 就是加载 BeanDefinition , 它是一个抽象方法, 我们首先看 <code>AbstractXmlApplicationContext</code> 的实现:</p>
<p><code>org.springframework.context.support.AbstractXmlApplicationContext#loadBeanDefinitions(org.springframework.beans.factory.support.DefaultListableBeanFactory)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</div><div class="line">	<span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></div><div class="line">	XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</div><div class="line"></div><div class="line">	<span class="comment">// Configure the bean definition reader with this context's</span></div><div class="line">	<span class="comment">// resource loading environment.</span></div><div class="line">	beanDefinitionReader.setEnvironment(<span class="keyword">this</span>.getEnvironment());</div><div class="line">	beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</div><div class="line">	beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</div><div class="line"></div><div class="line">	<span class="comment">// Allow a subclass to provide custom initialization of the reader,</span></div><div class="line">	<span class="comment">// then proceed with actually loading the bean definitions.</span></div><div class="line">	initBeanDefinitionReader(beanDefinitionReader);</div><div class="line">	loadBeanDefinitions(beanDefinitionReader);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</div><div class="line">	Resource[] configResources = getConfigResources();</div><div class="line">	<span class="keyword">if</span> (configResources != <span class="keyword">null</span>) &#123;</div><div class="line">		reader.loadBeanDefinitions(configResources);</div><div class="line">	&#125;</div><div class="line">	String[] configLocations = getConfigLocations();</div><div class="line">	<span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</div><div class="line">		reader.loadBeanDefinitions(configLocations);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的 <code>loadBeanDefinitions(DefaultListableBeanFactory beanFactory)</code> 中使用 <code>XmlBeanDefinitionReader</code>, 和前面我们介绍的编程式使用 IoC 是一样的.</p>
<p>值得注意的是, <code>beanDefinitionReader.setResourceLoader(this)</code>, 从 hierarchy 图中可知, <code>AbstractXmlApplicationContext</code> 继承了 <code>DefaultResourceLoader</code>, 所以 <code>this</code> 已经有获取 Resource 的能力.</p>
<p>由于上面的 Resource 是一个数组, 首先会调用 <code>AbstractBeanDefinitionReader</code> 的 <code>loadBeanDefinitions(Resource ...)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource... resources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">	Assert.notNull(resources, <span class="string">"Resource array must not be null"</span>);</div><div class="line">	<span class="keyword">int</span> counter = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (Resource resource : resources) &#123;</div><div class="line">		counter += loadBeanDefinitions(resource);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> counter;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后才是 <code>XmlBeanDefinitionReader</code> 的  <code>loadBeanDefinitions(Resource resource)</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">	<span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">	Assert.notNull(encodedResource, <span class="string">"EncodedResource must not be null"</span>);</div><div class="line">	<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">		logger.info(<span class="string">"Loading XML bean definitions from "</span> + encodedResource.getResource());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Set&lt;EncodedResource&gt; currentResources = <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.get();</div><div class="line">	<span class="keyword">if</span> (currentResources == <span class="keyword">null</span>) &#123;</div><div class="line">		currentResources = <span class="keyword">new</span> HashSet&lt;EncodedResource&gt;(<span class="number">4</span>);</div><div class="line">		<span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">				<span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		InputStream inputStream = encodedResource.getResource().getInputStream();</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</div><div class="line">			<span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</div><div class="line">				inputSource.setEncoding(encodedResource.getEncoding());</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">finally</span> &#123;</div><div class="line">			inputStream.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">				<span class="string">"IOException parsing XML document from "</span> + encodedResource.getResource(), ex);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">finally</span> &#123;</div><div class="line">		currentResources.remove(encodedResource);</div><div class="line">		<span class="keyword">if</span> (currentResources.isEmpty()) &#123;</div><div class="line">			<span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.remove();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中, <code>XmlBeanDefinitionReader.doLoadBeanDefinitions(inputSource, encodedResource.getResource());</code> 是重点, 它把 Resource 解析成 Document, 接着执行 registerBeanDefinitions() 的操作， 如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span></div><div class="line">		<span class="keyword">throws</span> BeanDefinitionStoreException &#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		Document doc = doLoadDocument(inputSource, resource);</div><div class="line">		<span class="keyword">return</span> registerBeanDefinitions(doc, resource);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> ex;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (SAXParseException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</div><div class="line">				<span class="string">"Line "</span> + ex.getLineNumber() + <span class="string">" in XML document from "</span> + resource + <span class="string">" is invalid"</span>, ex);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (SAXException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</div><div class="line">				<span class="string">"XML document from "</span> + resource + <span class="string">" is invalid"</span>, ex);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (ParserConfigurationException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</div><div class="line">				<span class="string">"Parser configuration exception parsing XML from "</span> + resource, ex);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</div><div class="line">				<span class="string">"IOException parsing XML document from "</span> + resource, ex);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</div><div class="line">				<span class="string">"Unexpected exception parsing XML document from "</span> + resource, ex);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="解析-BeanDefinition-xml"><a href="#解析-BeanDefinition-xml" class="headerlink" title="解析 BeanDefinition xml"></a>解析 BeanDefinition xml</h2><hr>
<p>接着上面的 <code>XmlBeanDefinitionReader.registerBeanDefinitions(doc, resource);</code> ，这里使用 BeanDefinitionDocumentReader 来解析并注册:</p>
<p><code>registerBeanDefinitions</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</div><div class="line">	BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</div><div class="line">	<span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</div><div class="line">	documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</div><div class="line">	<span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续， <code>BeanDefinitionDocumentReader.registerBeanDefinitions()</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>.readerContext = readerContext;</div><div class="line">	logger.debug(<span class="string">"Loading bean definitions"</span>);</div><div class="line">	Element root = doc.getDocumentElement();</div><div class="line">	doRegisterBeanDefinitions(root);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>开始解析和注册：</p>
<p><code>BeanDefinitionDocumentReader.doRegisterBeanDefinitions</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</div><div class="line">	<span class="comment">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span></div><div class="line">	<span class="comment">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></div><div class="line">	<span class="comment">// keep track of the current (parent) delegate, which may be null. Create</span></div><div class="line">	<span class="comment">// the new (child) delegate with a reference to the parent for fallback purposes,</span></div><div class="line">	<span class="comment">// then ultimately reset this.delegate back to its original (parent) reference.</span></div><div class="line">	<span class="comment">// this behavior emulates a stack of delegates without actually necessitating one.</span></div><div class="line">	BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</div><div class="line">	<span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;</div><div class="line">		String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</div><div class="line">		<span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</div><div class="line">			String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</div><div class="line">					profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</div><div class="line">			<span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	preProcessXml(root);</div><div class="line">	parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</div><div class="line">	postProcessXml(root);</div><div class="line"></div><div class="line">	<span class="keyword">this</span>.delegate = parent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先看 createDelegate() , 创建了 BeanDefinitionParserDelegate, 这个 Delegate 将会完成 XML bean definitions 的解析.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> BeanDefinitionParserDelegate <span class="title">createDelegate</span><span class="params">(</span></span></div><div class="line">		XmlReaderContext readerContext, Element root, BeanDefinitionParserDelegate parentDelegate) &#123;</div><div class="line"></div><div class="line">	BeanDefinitionParserDelegate delegate = <span class="keyword">new</span> BeanDefinitionParserDelegate(readerContext);</div><div class="line">	delegate.initDefaults(root, parentDelegate);</div><div class="line">	<span class="keyword">return</span> delegate;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续看 <code>BeanDefinitionDocumentReader.parseBeanDefinitions</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</div><div class="line">			NodeList nl = root.getChildNodes();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">				Node node = nl.item(i);</div><div class="line">				<span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</div><div class="line">					Element ele = (Element) node;</div><div class="line">					<span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</div><div class="line">						parseDefaultElement(ele, delegate);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">else</span> &#123;</div><div class="line">						delegate.parseCustomElement(ele);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			delegate.parseCustomElement(root);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>bean 在xml中的配置, 如 property / ref / value / scope 等属性都会在这个 BeanDefinitionDocumentReader 中解析 ( 在parse*()方法 ), 具体的xml解析过程太细节, 这里只关注主流程和关键的.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</div><div class="line">			importBeanDefinitionResource(ele);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</div><div class="line">			processAliasRegistration(ele);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</div><div class="line">			processBeanDefinition(ele, delegate);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</div><div class="line">			<span class="comment">// recurse</span></div><div class="line">			doRegisterBeanDefinitions(ele);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">		BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</div><div class="line">		<span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</div><div class="line">			bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// Register the final decorated instance.</span></div><div class="line">				BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</div><div class="line">				getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</div><div class="line">						bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Send registration event.</span></div><div class="line">			getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">......</div></pre></td></tr></table></figure>
<p>上面的 getReaderContext() 是 beanDefinitionReader, 还记得前面的 <code>AbstractXmlApplicationContext.loadBeanDefinitions()</code> 否:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">DefaultListableBeanFactory beanFactory</div><div class="line">...</div><div class="line">XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);</div></pre></td></tr></table></figure>
<p>XmlBeanDefinitionReader 的构造器是 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public XmlBeanDefinitionReader(BeanDefinitionRegistry registry) &#123;</div><div class="line">		super(registry);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>从前面的设计图亦可知道 DefaultListableBeanFactory 实现了 <code>org.springframework.beans.factory.support.BeanDefinitionRegistry</code> :</p>
<p><code>BeanDefinitionRegistry</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title">AliasRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></div><div class="line">			<span class="keyword">throws</span> BeanDefinitionStoreException;</div><div class="line">	......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="注册-BeanDefinition"><a href="#注册-BeanDefinition" class="headerlink" title="注册 BeanDefinition"></a>注册 BeanDefinition</h2><hr>
<p>接着上面的 <code>BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry())</code> 完成注册工作 :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(</span></span></div><div class="line">			BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</div><div class="line">			<span class="keyword">throws</span> BeanDefinitionStoreException &#123;</div><div class="line"></div><div class="line">		<span class="comment">// Register bean definition under primary name.</span></div><div class="line">		String beanName = definitionHolder.getBeanName();</div><div class="line">		registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</div><div class="line"></div><div class="line">		<span class="comment">// Register aliases for bean name, if any.</span></div><div class="line">		String[] aliases = definitionHolder.getAliases();</div><div class="line">		<span class="keyword">if</span> (aliases != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">for</span> (String alias : aliases) &#123;</div><div class="line">				registry.registerAlias(beanName, alias);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>在 <code>DefaultListableBeanFactory</code> 中, 有一个 <code>ConcurrentHashMap</code> 来持有 BeanDefinition, 如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/** Map of bean definition objects, keyed by bean name */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, BeanDefinition&gt;(<span class="number">256</span>);</div></pre></td></tr></table></figure>
<p>主要看 <code>registry.registerBeanDefinition()</code> 的具体实现 -&gt; <code>org.springframework.beans.factory.support.DefaultListableBeanFactory#registerBeanDefinition</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></div><div class="line">			<span class="keyword">throws</span> BeanDefinitionStoreException &#123;</div><div class="line"></div><div class="line">		Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</div><div class="line">		Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				((AbstractBeanDefinition) beanDefinition).validate();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">						<span class="string">"Validation of bean definition failed"</span>, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		BeanDefinition oldBeanDefinition;</div><div class="line"></div><div class="line">		oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</div><div class="line">		<span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">						<span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName +</div><div class="line">						<span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</div><div class="line">				<span class="comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span></div><div class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</div><div class="line">					<span class="keyword">this</span>.logger.warn(<span class="string">"Overriding user-defined bean definition for bean '"</span> + beanName +</div><div class="line">							<span class="string">"' with a framework-generated bean definition: replacing ["</span> +</div><div class="line">							oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(oldBeanDefinition)) &#123;</div><div class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</div><div class="line">					<span class="keyword">this</span>.logger.info(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</div><div class="line">							<span class="string">"' with a different definition: replacing ["</span> + oldBeanDefinition +</div><div class="line">							<span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</div><div class="line">					<span class="keyword">this</span>.logger.debug(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</div><div class="line">							<span class="string">"' with an equivalent definition: replacing ["</span> + oldBeanDefinition +</div><div class="line">							<span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</div><div class="line">				<span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></div><div class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanDefinitionMap) &#123;</div><div class="line">					<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">					List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</div><div class="line">					updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</div><div class="line">					updatedDefinitions.add(beanName);</div><div class="line">					<span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</div><div class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</div><div class="line">						Set&lt;String&gt; updatedSingletons = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(<span class="keyword">this</span>.manualSingletonNames);</div><div class="line">						updatedSingletons.remove(beanName);</div><div class="line">						<span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// Still in startup registration phase</span></div><div class="line">				<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">				<span class="keyword">this</span>.beanDefinitionNames.add(beanName);</div><div class="line">				<span class="keyword">this</span>.manualSingletonNames.remove(beanName);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</div><div class="line">			resetBeanDefinition(beanName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>至此, 已经完成了初始化操作, 建立了 beanDefinitionMap 等内部映射. 下一博客将讨论 IOC 容器如何完成 bean 的依赖注入.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JVM 常用的 GC 收集器]]></title>
      <url>http://www.nikoai.pw/2016/11/19/java/jvm/jvm_gc_collectors/</url>
      <content type="html"><![CDATA[<p>这篇博客, 主要介绍 jvm 常见的 gc 收集器及其搭配. gc收集器, 是 gc 算法和策略的实现, 主要的 gc 算法已经在之前简单提到过（<a href="/2015/10/01/java/jvm/jvm_gc_algo_introduce/">传送门</a>） , 今天也会涉及到大部分. 接下来, 我们就看看有哪些常见的 gc 收集器.</p>
<h1 id="年轻代收集器"><a href="#年轻代收集器" class="headerlink" title="年轻代收集器"></a>年轻代收集器</h1><hr>
<h2 id="Serial-复制收集器"><a href="#Serial-复制收集器" class="headerlink" title="Serial 复制收集器 :"></a>Serial 复制收集器 :</h2><hr>
<p>使用<code>-XX:+UseSerialGC</code>来启用, 穿行复制收集器, 单线程, 复制存活对象从<code>Eden-&gt;Survivor</code>和<code>Survivor-&gt;Survivor</code>, 并决定什么时候复制到老年代中.</p>
<h2 id="ParNew-收集器"><a href="#ParNew-收集器" class="headerlink" title="ParNew 收集器"></a>ParNew 收集器</h2><hr>
<p>使用<code>-XX:+UseParNewGC</code>来启用, ParNew 是 Serial 复制收集器的多线程版, 内部有一个回调可以让老年代收集器来处理它收集到的对象, 因此 ParNew 可以和 CMS 收集器配合工作.</p>
<h2 id="PS-Scavenge-收集器"><a href="#PS-Scavenge-收集器" class="headerlink" title="PS Scavenge 收集器"></a>PS Scavenge 收集器</h2><hr>
<p>使用<code>-XX:+UseParallelGC</code>来启用, 并行收集器, 也是使用复制算法的收集器, 不过它号称是<code>吞吐量优先</code>的收集器, 并提供了两个参数控制吞吐量:</p>
<p><code>-XX:MaxGCPauseMillis</code><br>控制最大垃圾回收时间</p>
<p><code>-XX:GCTimeRatio</code><br>吞吐量大小</p>
<p>还有一个参数 <code>-XX:+UseAdaptiveSizePolicy</code><br>打开之后可以不用设置新生代大小以及Eden和Survivor的比例, jvm会根据当前收集到的监控信息, 动态调整这些参数以提供最合适的停顿时间和最大的吞吐量, 这也称为 GC的<code>自适应</code>调节策略 ( <code>GC Ergonomics</code> ), 这也是和ParNew的一大区别.</p>
<h2 id="G1-Young-收集器"><a href="#G1-Young-收集器" class="headerlink" title="G1 Young 收集器"></a>G1 Young 收集器</h2><hr>
<p>使用<code>-XX:+UseG1GC</code>来启用, 使用<code>Garbage First</code>算法把堆分割成许多更小的空间 ( Region ) , 不过仍然保留了 Eden 和 Survivor 的划分方法, 并在GC时优先回收<code>价值</code>最大的 Region, 因此称为 <code>Garbage First</code>.</p>
<h1 id="老年代收集器"><a href="#老年代收集器" class="headerlink" title="老年代收集器"></a>老年代收集器</h1><hr>
<h2 id="Serial-Old-Old-MarkSweepCompact-收集器"><a href="#Serial-Old-Old-MarkSweepCompact-收集器" class="headerlink" title="Serial Old (Old MarkSweepCompact) 收集器"></a>Serial Old (Old MarkSweepCompact) 收集器</h2><hr>
<p>使用<code>-XX:+UseSerialGC</code>来启用, 实现<code>MarkSweepCompact</code>标记整理算法.</p>
<h2 id="PS-MarkSweep-收集器"><a href="#PS-MarkSweep-收集器" class="headerlink" title="PS MarkSweep 收集器"></a>PS MarkSweep 收集器</h2><hr>
<p>使用<code>-XX:+UseParallelOldGC</code>来启用, <code>MarkSweepCompact</code> 的多线程版.</p>
<h2 id="ConcurrentMarkSweep-CMS-收集器"><a href="#ConcurrentMarkSweep-CMS-收集器" class="headerlink" title="ConcurrentMarkSweep (CMS) 收集器"></a>ConcurrentMarkSweep (CMS) 收集器</h2><hr>
<p>使用<code>-XX:+UseConcMarkSweepGC</code>来启用, CMS 的目标是让更多的GC在后台跑而不用<code>stop-the-world</code>, 在<code>concurrent mode</code>失败时, 退化到 Serial Old 收集器.<br>不知有没有注意到, CMS 的名称是 <code>Concurrent</code>, 而不是 <code>Parallel</code>. Concurrent 是并发, 用户线程和GC线程是同时执行的, 但 Parallel 是用户线程等待而多条GC线程在工作.</p>
<h2 id="G1-Mixed-Generation-收集器"><a href="#G1-Mixed-Generation-收集器" class="headerlink" title="G1 Mixed Generation 收集器"></a>G1 Mixed Generation 收集器</h2><hr>
<p>使用<code>-XX:+UseG1GC</code>来启用.</p>
<h1 id="收集器搭配组合"><a href="#收集器搭配组合" class="headerlink" title="收集器搭配组合"></a>收集器搭配组合</h1><hr>
<p>下表列出了大部分的收集器组合:</p>
<table>
<thead>
<tr>
<th>参数选项</th>
<th>对应的收集器组合</th>
</tr>
</thead>
<tbody>
<tr>
<td>-XX:+UseSerialGC</td>
<td>young serial and old serial MarkSweepCompact ， 适合客户端使用， 单线程节省开销</td>
</tr>
<tr>
<td>-XX:+UseG1GC</td>
<td>young G1 Young and old G1 Mixed</td>
</tr>
<tr>
<td>-XX:+UseParallelGC -XX:+UseParallelOldGC -XX:-UseAdaptiveSizePolicy</td>
<td>young PS Scavenge old PS MarkSweep, 没有自适应调节， 适合吞吐量优先/CPU敏感的场合， tomcat 默认使用的</td>
</tr>
<tr>
<td>-XX:+UseParallelGC -XX:+UseParallelOldGC -XX:+UseAdaptiveSizePolicy</td>
<td>young PS Scavenge old PS MarkSweep, 自适应调节</td>
</tr>
<tr>
<td>-XX:+UseConcMarkSweepGC -XX:+UseParNewGC</td>
<td>young ParNew old ConcurrentMarkSweep** ， GC 时间有限</td>
</tr>
<tr>
<td>-XX:+UseParNewGC (deprecated in Java 8 and removed in Java 9 )</td>
<td>young ParNew old serial MarkSweepCompact</td>
</tr>
<tr>
<td>-XX:+UseConcMarkSweepGC -XX:-UseParNewGC (deprecated in Java 8 and removed in Java 9)</td>
<td>young Serial old ConcurrentMarkSweep**</td>
</tr>
</tbody>
</table>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://www.fasterj.com/articles/oraclecollectors1.shtml" target="_blank" rel="external">Oracle JVM Garbage Collectors Available From JDK 1.7.0_04 And After</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[redis key 的过期机制]]></title>
      <url>http://www.nikoai.pw/2016/11/17/server/redis/redis_expire_mechanism/</url>
      <content type="html"><![CDATA[<p>今天有人问了我一个问题：redis 的 key 过期是怎么实现的。我用redis做了几个功能，竟然没有思考这个问题，该死。作为一个敏而好学的好童鞋，立马google和查文档。</p>
<h1 id="redis-key-的过期机制"><a href="#redis-key-的过期机制" class="headerlink" title="redis key 的过期机制"></a>redis key 的过期机制</h1><hr>
<p>翻了下文档：</p>
<blockquote>
<p>Redis keys are expired in two ways: a passive way, and an active way.</p>
</blockquote>
<p>redis keys 过期有两种方式: passive 和 active.</p>
<h1 id="active"><a href="#active" class="headerlink" title="active"></a>active</h1><hr>
<p>active, 主动的方式:</p>
<p>当某个客户端尝试访问这个key时, 若这个key被发现timeout了, 那么就删除, 否则正常访问.</p>
<p><a href="http://blog.dolphin-game.com/post/65.html" target="_blank" rel="external">这篇博文</a> 摘出了源码, 如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">expireIfNeeded</span><span class="params">(redisDb *db, robj *key)</span> </span>&#123;</div><div class="line">    mstime_t when = getExpire(db,key);</div><div class="line">    mstime_t now;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (when &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* No expire for this key */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Don't expire anything while loading. It will be done later. */</span></div><div class="line">    <span class="keyword">if</span> (server.loading) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* If we are in the context of a Lua script, we claim that time is</span></div><div class="line">     * blocked to when the Lua script started. This way a key can expire</div><div class="line">     * only the first time it is accessed and not in the middle of the</div><div class="line">     * script execution, making propagation to slaves / AOF consistent.</div><div class="line">     * See issue #1525 on Github for more information. */</div><div class="line">    now = server.lua_caller ? server.lua_time_start : mstime();</div><div class="line"></div><div class="line">    <span class="comment">/* If we are running in the context of a slave, return ASAP:</span></div><div class="line">     * the slave key expiration is controlled by the master that will</div><div class="line">     * send us synthesized DEL operations for expired keys.</div><div class="line">     *</div><div class="line">     * Still we try to return the right information to the caller,</div><div class="line">     * that is, 0 if we think the key should be still valid, 1 if</div><div class="line">     * we think the key is expired at this time. */</div><div class="line">    <span class="comment">/*如果我们正在slaves上执行读写命令，就直接返回，</span></div><div class="line">     *因为slaves上的过期是由master来发送删除命令同步给slaves删除的，</div><div class="line">     *slaves不会自主删除*/</div><div class="line">    <span class="keyword">if</span> (server.masterhost != NULL) <span class="keyword">return</span> now &gt; when;</div><div class="line">    <span class="comment">/*只是回了一个判断键是否过期的值，0表示没有过期，1表示过期</span></div><div class="line">     *但是并没有做其他与键值过期相关的操作*/</div><div class="line"></div><div class="line">    <span class="comment">/* Return when this key has not expired */</span></div><div class="line">    <span class="comment">/*如果没有过期，就返回当前键*/</span></div><div class="line">    <span class="keyword">if</span> (now &lt;= when) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Delete the key */</span></div><div class="line">    <span class="comment">/*增加过期键个数*/</span></div><div class="line">    server.stat_expiredkeys++;</div><div class="line">    <span class="comment">/*传播键过期的消息*/</span></div><div class="line">    propagateExpire(db,key);</div><div class="line">    notifyKeyspaceEvent(REDIS_NOTIFY_EXPIRED,<span class="string">"expired"</span>,key,db-&gt;id);</div><div class="line">    <span class="comment">/*删除过期键*/</span></div><div class="line">    <span class="keyword">return</span> dbDelete(db,key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="passive"><a href="#passive" class="headerlink" title="passive"></a>passive</h1><hr>
<p>passive, 被动的方式:</p>
<p>redis 每秒会执行10次以下操作 (相关源码在<code>server.c</code>的<code>databasesCron()</code>中) :</p>
<ol>
<li>测试20个随机keys.</li>
<li>删除找到的过期keys.</li>
<li>如果清除的keys超过25%, 那么认为当前数据库的过期keys是比较多的, 会继续抽样清除操作, 从第一步来过.</li>
</ol>
<p>passive 和 active 方式是同时工作.</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><hr>
<p>虽然没看文档的这部分, 但其实一开始我直觉是: 莫非设置了定时器 ? 但想想也不合适，这样消耗太大了。出于性能的考虑，隐然觉得redis应该会有定时清理的功能，而且联想到之前的做的一个支付订单的功能和这个机制有点类似：首先有一个定时扫描来禁用过期的支付订单，当想继续支付前（使用该支付订单），需要检查这个支付订单有没有过期，没有过期才让继续支付。</p>
<p>这个问题，我竟懵逼了。如果问题换成让我设计这个机制, 或许能回答出来。  <code>%&gt;_&lt;%</code></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://redis.io/commands/expire" target="_blank" rel="external">EXPIRE – Redis</a><br><a href="https://github.com/antirez/redis/blob/unstable/src/server.c" target="_blank" rel="external">源码</a><br><a href="http://stackoverflow.com/questions/36172745/how-does-redis-expire-keys" target="_blank" rel="external">How does redis expire keys? - Stack Overflow</a><br><a href="http://blog.dolphin-game.com/post/65.html" target="_blank" rel="external">http://blog.dolphin-game.com/post/65.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用 xscreensaver 作为 gnome 的锁屏画面]]></title>
      <url>http://www.nikoai.pw/2016/11/10/linux/tools/gnome/xscreensaver-awesome/</url>
      <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><hr>
<p>因为 gnome3 已经废弃了旧的 gnome-screensaver, 所以可发现屏保默认是一个空的黑屏.</p>
<h1 id="不错的屏保项目-XScreenSaver"><a href="#不错的屏保项目-XScreenSaver" class="headerlink" title="不错的屏保项目 - XScreenSaver"></a>不错的屏保项目 - <code>XScreenSaver</code></h1><hr>
<p>我们可以使用 XScreenSaver 作为我们的屏保管理.</p>
<p>安装:</p>
<p>sudo apt-get install xscreensaver xscreensaver-gl-extra xscreensaver-data-extra</p>
<p>删除旧的:</p>
<p>sudo apt-get remove gnome-screensaver</p>
<p>此时在 dash 搜索 xscreensaver 可以搜到程序, 或者使用在命令行使用 <code>xscreensaver-demo</code> 启动屏保的设置.</p>
<p>在 dash 搜索 <code>startup applications</code>, 把 <code>xscreensaver -nosplash</code> 作为新的启动程序加入.</p>
<p>如果需要按键 <code>ctrl + alt + L</code> 锁屏功能, 需要加个链接:</p>
<p>sudo ln -s /usr/bin/xscreensaver-command /usr/bin/gnome-screensaver-command</p>
<p>然后登出或者重启生效.</p>
<p>最后, 上一下我比较喜欢的屏保:</p>
<p><img src="/images/linux/tools/xscreensaver-01.png" alt=""></p>
<h1 id="问题-不能-ctrl-alt-L-锁屏"><a href="#问题-不能-ctrl-alt-L-锁屏" class="headerlink" title="问题: 不能 ctrl + alt + L 锁屏"></a>问题: 不能 <code>ctrl + alt + L</code> 锁屏</h1><hr>
<p>cmd 是 <code>/usr/bin/gnome-screensaver-command -lock</code> 和 <code>/usr/bin/xscreensaver-command -lock</code><br>lrwxrwxrwx 1 root root 29 Nov 26 10:08 /usr/bin/gnome-screensaver-command -&gt; /usr/bin/xscreensaver-command*<br>只能 keyboard设置里, 禁用掉原先的锁屏keymap, 再添加新的keymap.<br>/usr/bin/xscreensaver-command -lock</p>
<h1 id="问题-xscreensaver-command-already-locked"><a href="#问题-xscreensaver-command-already-locked" class="headerlink" title="问题: xscreensaver-command: already locked"></a>问题: xscreensaver-command: already locked</h1><hr>
<p>$ /usr/bin/xscreensaver-command -lock<br>xscreensaver-command: already locked.</p>
<p>niko@niko-ub1404:~$ gnome-screensaver-command –exit &amp;&amp; xscreensaver &amp;<br>[1] 26881<br>niko@niko-ub1404:~$ gnome-screensaver-command: exiting.</p>
<h1 id="不错的主题推荐"><a href="#不错的主题推荐" class="headerlink" title="不错的主题推荐"></a>不错的主题推荐</h1><hr>
<p>XMatrix (记得自定义选择编码)<br>BoxFit<br>CubicGrid<br>DecayScreen<br>Epicycle<br>Euler2D<br>FluidBall<br>GLText<br>Intermomentary<br>Julia<br>Maze<br>pong<br>Rocks<br>Sonar<br>Wormhole<br>XJack</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://askubuntu.com/questions/64086/how-can-i-change-or-install-screensavers" target="_blank" rel="external">http://askubuntu.com/questions/64086/how-can-i-change-or-install-screensavers</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hexo 取消TOC的自动折叠]]></title>
      <url>http://www.nikoai.pw/2016/11/08/others/hexo/hexo_cancel_collapsing/</url>
      <content type="html"><![CDATA[<p>因为有bug, 今天更新了<code>hexo-theme-next</code>, 升级到 5.0.1 版本, 发现 TOC 文章目录老是会自动折叠, 翻了下文档, 没有找到相关设置, 算了反正是js和css, 自己动手还快一点.</p>
<h1 id="找到隐藏的css样式"><a href="#找到隐藏的css样式" class="headerlink" title="找到隐藏的css样式"></a>找到隐藏的css样式</h1><hr>
<p>打开chrome的F12调试模式, 查看被隐藏的node, 如下:</p>
<p><img src="/images/others/hexo/hexo-toc-modify-01.png" alt=""></p>
<p>如上图所示, 子列表<code>&lt;ol class=&quot;nav-child&quot;&gt;</code>被隐藏了, class <code>nav-child</code> 如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.post-toc .nav .nav-child &#123;</div><div class="line">    display: none;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="修改css样式"><a href="#修改css样式" class="headerlink" title="修改css样式"></a>修改css样式</h1><hr>
<p>既然已经找到被隐藏使用的class, 那么接下来只要注释掉即可 (文件位置是<code>.../themes/hexo-theme-next-5.0.1/source/css/_common/components/sidebar/sidebar-toc.styl</code>) :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.post-toc .nav .nav-child &#123;</div><div class="line">    /*display: none;*/</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启 hexo server, 发现可以TOC全部展开了:</p>
<p><img src="/images/others/hexo/hexo-toc-modify-02.png" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[为 hexo 增加置顶功能]]></title>
      <url>http://www.nikoai.pw/2016/11/08/others/hexo/hexo_add_top-function/</url>
      <content type="html"><![CDATA[<link rel="icon" href="http://niko2014.github.io/favicon.ico">

<p>hexo blog 没有提供置顶的功能, 但hexo作为一个优秀的开源项目, 代码架构和组织还是很清晰的, 有问题可以直接阅读或修改代码, 下面就通过修改代码来为hexo增加置顶功能.</p>
<h1 id="修改index页的生成代码-generator-js"><a href="#修改index页的生成代码-generator-js" class="headerlink" title="修改index页的生成代码 generator.js"></a>修改index页的生成代码 <code>generator.js</code></h1><p>vim $SITE_HOME/node_modules/hexo-generator-index/lib/generator.js</p>
<p>增加以下排序代码:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">posts.data = posts.data.sort(function(a, b) &#123;</div><div class="line">    if(a.top &amp;&amp; b.top) &#123; // 两篇文章top都有定义</div><div class="line">        if(a.top == b.top) return b.date - a.date; // 若top值一样则按照文章日期降序排</div><div class="line">        else return b.top - a.top; // 否则按照top值降序排</div><div class="line">    &#125;</div><div class="line">    else if(a.top &amp;&amp; !b.top) &#123; // 以下是只有一篇文章top有定义，那么将有top的排在前面（这里用异或操作居然不行233）</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line">    else if(!a.top &amp;&amp; b.top) &#123;</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    else return b.date - a.date; // 都没定义按照文章日期降序排</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>修改后的最终文件内容:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&apos;use strict&apos;;</div><div class="line"></div><div class="line">var pagination = require(&apos;hexo-pagination&apos;);</div><div class="line"></div><div class="line">module.exports = function(locals)&#123;</div><div class="line">  var config = this.config;</div><div class="line">  var posts = locals.posts.sort(&apos;-date&apos;);</div><div class="line">  var paginationDir = config.pagination_dir || &apos;page&apos;;</div><div class="line"></div><div class="line">    // niko</div><div class="line">    posts.data = posts.data.sort(function(a, b) &#123;</div><div class="line">            if(a.top &amp;&amp; b.top) &#123; // 两篇文章top都有定义</div><div class="line">                        if(a.top == b.top) return b.date - a.date; // 若top值一样则按照文章日期降序排</div><div class="line">                        else return b.top - a.top; // 否则按照top值降序排</div><div class="line">                    &#125;</div><div class="line">            else if(a.top &amp;&amp; !b.top) &#123; // 以下是只有一篇文章top有定义，那么将有top的排在前面（这里用异或操作居然不行233）</div><div class="line">                        return -1;</div><div class="line">                    &#125;</div><div class="line">            else if(!a.top &amp;&amp; b.top) &#123;</div><div class="line">                        return 1;</div><div class="line">                    &#125;</div><div class="line">            else return b.date - a.date; // 都没定义按照文章日期降序排</div><div class="line">    &#125;);</div><div class="line">    // niko</div><div class="line"></div><div class="line">  return pagination(&apos;&apos;, posts, &#123;</div><div class="line">    perPage: config.index_generator.per_page,</div><div class="line">    layout: [&apos;index&apos;, &apos;archive&apos;],</div><div class="line">    format: paginationDir + &apos;/%d/&apos;,</div><div class="line">    data: &#123;</div><div class="line">      __index: true</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h1 id="测试置顶"><a href="#测试置顶" class="headerlink" title="测试置顶"></a>测试置顶</h1><p>找一篇你想置顶的博客, 在front-matter增加<code>top: 1</code>, top的value越大, 排在越前面, 如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">title: JVM 常用GC算法简介</div><div class="line">date: 2015-10-01 00:00:00</div><div class="line">tags:</div><div class="line">- jvm</div><div class="line">- java</div><div class="line">categories:</div><div class="line">- java</div><div class="line">top: 1</div></pre></td></tr></table></figure>
<p>okay, 启动你的 hexo server, 就可以看到置顶博客了:</p>
<p><img src="/images/others/hexo/hexo-next-top-01.png" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://haozhe.site/2016/09/17/hexo%E5%8D%9A%E5%AE%A2%E8%AE%BE%E7%BD%AE%E7%BD%AE%E9%A1%B6/" target="_blank" rel="external">http://haozhe.site/2016/09/17/hexo%E5%8D%9A%E5%AE%A2%E8%AE%BE%E7%BD%AE%E7%BD%AE%E9%A1%B6/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用 rsync deploy hexo 博客]]></title>
      <url>http://www.nikoai.pw/2016/11/08/others/hexo/hexo_rsync_deploy/</url>
      <content type="html"><![CDATA[<p>hexo 支持多种部署方式, 如 git repos/rsync/Heroku/FTPSync等, 如果博客使用 github pages 托管, 那么用 git repos 的方式部署最方便了, 如果是自己的vps, rsync是一种不错的方式.</p>
<h1 id="使用-hexo-deployer-rsync"><a href="#使用-hexo-deployer-rsync" class="headerlink" title="使用 hexo-deployer-rsync"></a>使用 hexo-deployer-rsync</h1><hr>
<p>配置, <code>vim $SITE_HOME/_config.yml</code> :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">deploy:</div><div class="line">  type: rsync</div><div class="line">  host: &lt;host&gt;</div><div class="line">  user: &lt;user&gt;</div><div class="line">  root: &lt;root&gt;</div><div class="line">  port: [port]</div><div class="line">  delete: [true|false]</div><div class="line">  verbose: [true|false]</div><div class="line">  ignore_errors: [true|false]</div></pre></td></tr></table></figure>
<p>执行 <code>hexo generate</code> 和 <code>hexo deploy</code> :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">......</div><div class="line"></div><div class="line">[ &apos;--delete&apos;,</div><div class="line">  &apos;-v&apos;,</div><div class="line">  &apos;-az&apos;,</div><div class="line">  &apos;/home/niko/mount/hsb_ssd_1/niko/dev/code/git_repos/HexoBlog/hexo-hello/public/&apos;,</div><div class="line">  &apos;-e ssh&apos;,</div><div class="line">  &apos;--port=22222&apos;,</div><div class="line">  &apos;root@104.224.xxx.xxx:www.nikoai.pw/&apos; ]</div><div class="line">ssh: connect to host 104.224.xxx.xxx port 22: Connection refused</div><div class="line">rsync: connection unexpectedly closed (0 bytes received so far) [sender]</div><div class="line">rsync error: unexplained error (code 255) at io.c(226) [sender=3.1.0]</div><div class="line">FATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html</div><div class="line">Error: ssh: connect to host 104.224.xxx.xxx port 22: Connection refused</div><div class="line">rsync: connection unexpectedly closed (0 bytes received so far) [sender]</div><div class="line">rsync error: unexplained error (code 255) at io.c(226) [sender=3.1.0]</div><div class="line">FATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html</div><div class="line">Error: ssh: connect to host 104.224.xxx.xxx port 22: Connection refused</div><div class="line">rsync: connection unexpectedly closed (0 bytes received so far) [sender]</div><div class="line">rsync error: unexplained error (code 255) at io.c(226) [sender=3.1.0]</div><div class="line"></div><div class="line">    at ChildProcess.&lt;anonymous&gt; (/home/niko/mount/hsb_ssd_1/niko/dev/code/git_repos/HexoBlog/hexo-hello/node_modules/hexo-util/lib/spaw</div><div class="line">n.js:37:17)</div><div class="line">    at emitTwo (events.js:100:13)</div><div class="line">    at ChildProcess.emit (events.js:185:7)</div><div class="line">    at maybeClose (internal/child_process.js:850:16)</div><div class="line">    at Socket.&lt;anonymous&gt; (internal/child_process.js:323:11)</div><div class="line">    at emitOne (events.js:90:13)</div><div class="line">    at Socket.emit (events.js:182:7)</div><div class="line">    at Pipe._onclose (net.js:484:12)</div><div class="line">FATAL ssh: connect to host 104.224.xxx.xxx port 22: Connection refused</div><div class="line">rsync: connection unexpectedly closed (0 bytes received so far) [sender]</div><div class="line">rsync error: unexplained error (code 255) at io.c(226) [sender=3.1.0]</div><div class="line"></div><div class="line">Error: ssh: connect to host 104.224.xxx.xxx port 22: Connection refused</div><div class="line">rsync: connection unexpectedly closed (0 bytes received so far) [sender]</div><div class="line">rsync error: unexplained error (code 255) at io.c(226) [sender=3.1.0]</div><div class="line"></div><div class="line">at ChildProcess.&lt;anonymous&gt; (/home/niko/mount/hsb_ssd_1/niko/dev/code/git_repos/HexoBlog/hexo-hello/node_modules/hexo-util/lib/spaw</div><div class="line">n.js:37:17)</div><div class="line">    at emitTwo (events.js:100:13)</div><div class="line">    at ChildProcess.emit (events.js:185:7)</div><div class="line">    at maybeClose (internal/child_process.js:850:16)</div><div class="line">    at Socket.&lt;anonymous&gt; (internal/child_process.js:323:11)</div><div class="line">    at emitOne (events.js:90:13)</div><div class="line">    at Socket.emit (events.js:182:7)</div><div class="line">    at Pipe._onclose (net.js:484:12)</div></pre></td></tr></table></figure>
<p>明明配置了非<code>22</code>的ssh端口, 但执行deploy时仍然连接22端口, 看了下代码 <code>node_modules/hexo-deployer-rsync/lib/deployer.js</code>,  :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&apos;use strict&apos;;</div><div class="line"></div><div class="line">var chalk = require(&apos;chalk&apos;);</div><div class="line">var spawn = require(&apos;hexo-util/lib/spawn&apos;);</div><div class="line"></div><div class="line">module.exports = function(args) &#123;</div><div class="line">  if (!args.host || !args.user || !args.root) &#123;</div><div class="line">    var help = &apos;&apos;;</div><div class="line"></div><div class="line">    help += &apos;You should configure deployment settings in _config.yml first!\n\n&apos;;</div><div class="line">    help += &apos;Example:\n&apos;;</div><div class="line">    help += &apos;  deploy:\n&apos;;</div><div class="line">    help += &apos;    type: rsync\n&apos;;</div><div class="line">    help += &apos;    host: &lt;host&gt;\n&apos;;</div><div class="line">    help += &apos;    user: &lt;user&gt;\n&apos;;</div><div class="line">    help += &apos;    root: &lt;root&gt;\n&apos;;</div><div class="line">    help += &apos;    port: [port] # Default is 22\n&apos;;</div><div class="line">    help += &apos;    delete: [true|false] # Default is true\n&apos;;</div><div class="line">    help += &apos;    args: &lt;rsync args&gt;\n&apos;;</div><div class="line">    help += &apos;    verbose: [true|false] # Default is true\n&apos;;</div><div class="line">    help += &apos;    ignore_errors: [true|false] # Default is false\n\n&apos;;</div><div class="line">    help += &apos;For more help, you can check the docs: &apos; + chalk.underline(&apos;http://hexo.io/docs/deployment.html&apos;);</div><div class="line"></div><div class="line">    console.log(help);</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  console.log(&quot;niko debug:&quot;);</div><div class="line">  console.log(args);</div><div class="line"></div><div class="line">  if (!args.hasOwnProperty(&apos;port&apos;)) args.port = 22;</div><div class="line">  if (!args.hasOwnProperty(&apos;delete&apos;)) args.delete = true;</div><div class="line">  if (!args.hasOwnProperty(&apos;verbose&apos;)) args.verbose = true;</div><div class="line">  if (!args.hasOwnProperty(&apos;ignore_errors&apos;)) args.ignore_errors = false;</div><div class="line"></div><div class="line">  var params = [</div><div class="line">    &apos;-az&apos;,</div><div class="line">    this.public_dir,</div><div class="line">    &apos;-e ssh&apos;,</div><div class="line">    args.user + &apos;@&apos; + args.host + &apos;:&apos; + args.root</div><div class="line">  ];</div><div class="line"></div><div class="line">  if (args.port &amp;&amp; args.port &gt; 0 &amp;&amp; args.port &lt; 65536) &#123;</div><div class="line">    params.splice(params.length - 1, 0, &apos;--port=&apos; + args.port);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (args.verbose) params.unshift(&apos;-v&apos;);</div><div class="line">  if (args.ignore_errors) params.unshift(&apos;--ignore-errors&apos;);</div><div class="line">  if (args.delete) params.unshift(&apos;--delete&apos;);</div><div class="line">  if (args.args) params.unshift(args.args);</div><div class="line"></div><div class="line">  console.log(params);</div><div class="line"></div><div class="line">  return spawn(&apos;rsync&apos;, params, &#123;verbose: true&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>好像发现了问题, 从上面代码可知, deployer 也是 <code>spawn</code> <code>rsync</code> 来进行发布的, hexo 配置里的参数和值会转换成rsync的. 但是指定port的代码有点问题, 需要做以下修改:</p>
<p>把</p>
<pre><code>&apos;-e ssh&apos;,
</code></pre><p>改成</p>
<pre><code>&quot;-e &apos;ssh -p &quot; + args.port + &quot;&apos;&quot;,
</code></pre><h1 id="写成一个sh脚本"><a href="#写成一个sh脚本" class="headerlink" title="写成一个sh脚本"></a>写成一个sh脚本</h1><hr>
<p>上面的操作略为麻烦, 不用hexo的插件, 也可以写成一个shell文件, 下次直接执行即可:</p>
<p>vim deploy_to_vps.sh</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">rsync -rvz -e &apos;ssh -p 22222&apos; --progress -a ./public user@host:/data/hexo-blog</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://stackoverflow.com/questions/4549945/is-it-possible-to-specify-a-different-ssh-port-when-using-rsync" target="_blank" rel="external">http://stackoverflow.com/questions/4549945/is-it-possible-to-specify-a-different-ssh-port-when-using-rsync</a><br><a href="https://hexo.io/zh-cn/docs/deployment.html" target="_blank" rel="external">https://hexo.io/zh-cn/docs/deployment.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[canal 搭配 zookeeper 实现 HA]]></title>
      <url>http://www.nikoai.pw/2016/11/07/java/opsrc/canal/canal_zookeeper_ha/</url>
      <content type="html"><![CDATA[<p>canal 作为数据平台的一个重要环节, 若存在单点故障, 对整体后端的影响是非常大的. 实践和经验告诉我们, 关键重要的服务都要进行failover, 以保证系统的可用性. 下面就来介绍一下 canal 搭配 zookeeper 的 HA 方案.</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><hr>
<p>下载并解压<code>canal.deployer-1.0.22.tar.gz</code></p>
<p>改名为<code>canal.deployer-1.0.22-master</code>, 作为第一个提供服务的 canal server</p>
<p>再复制一份为<code>canal.deployer-1.0.22-standby</code>, 作为 canal master <code>failover</code> 的备援机.</p>
<h2 id="canal-master-设置"><a href="#canal-master-设置" class="headerlink" title="canal master 设置"></a>canal master 设置</h2><p>vim canal.deployer-1.0.22_master/conf/canal.properties</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">canal.zkServers=127.0.0.1:2181</div><div class="line">canal.instance.global.spring.xml = classpath:spring/default-instance.xml</div></pre></td></tr></table></figure>
<p>vim canal.deployer-1.0.22_master/conf/example/instance.properties</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">canal.instance.mysql.slaveId = 1234</div><div class="line">canal.instance.master.journal.name = mysql-bin.000117</div><div class="line">canal.instance.master.position = 154</div></pre></td></tr></table></figure>
<h2 id="canal-standby-配置"><a href="#canal-standby-配置" class="headerlink" title="canal standby 配置"></a>canal standby 配置</h2><p>vim canal.deployer-1.0.22_standby/conf/canal.properties</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">canal.id=2</div><div class="line">canal.zkServers=127.0.0.1:2181</div><div class="line">canal.port= 11112</div><div class="line">canal.instance.global.spring.xml = classpath:spring/default-instance.xml</div></pre></td></tr></table></figure>
<p>vim canal.deployer-1.0.22_standby/conf/example/instance.properties</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">canal.instance.mysql.slaveId = 1235</div><div class="line">canal.instance.master.journal.name = mysql-bin.000117</div><div class="line">canal.instance.master.position = 154</div></pre></td></tr></table></figure>
<h1 id="启动-zookeeper"><a href="#启动-zookeeper" class="headerlink" title="启动 zookeeper"></a>启动 zookeeper</h1><p><code>bin/zkServer.sh start</code>, 具体配置略过.</p>
<h1 id="启动-canal"><a href="#启动-canal" class="headerlink" title="启动 canal"></a>启动 canal</h1><h2 id="启动-canal-master"><a href="#启动-canal-master" class="headerlink" title="启动 canal master"></a>启动 canal master</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ bin/startup.sh</div><div class="line">$ cat logs/example/example.log</div><div class="line"></div><div class="line">2016-11-06 23:11:00.218 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</div><div class="line">2016-11-06 23:11:00.221 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</div><div class="line">2016-11-06 23:11:00.266 [main] WARN  org.springframework.beans.TypeConverterDelegate - PropertyEditor [com.sun.beans.editors.EnumEditor] found through deprecated global PropertyEditorManager fallback - consider using a more isolated form of registration, e.g. on the BeanWrapper/BeanFactory!</div><div class="line">2016-11-06 23:11:00.333 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance for 1-example</div><div class="line">2016-11-06 23:11:00.344 [main] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</div><div class="line">2016-11-06 23:11:00.359 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.otter.canal.parse.inbound.mysql.MysqlEventParser - prepare to find start position mysql-bin.000001:1684:</div></pre></td></tr></table></figure>
<p>查看example下的日志, 可知canal正在提供服务.</p>
<h2 id="启动-canal-standby"><a href="#启动-canal-standby" class="headerlink" title="启动 canal standby"></a>启动 canal standby</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ bin/startup.sh</div><div class="line">$ cat logs/canal/canal.log</div><div class="line"></div><div class="line">2016-11-06 23:13:22.311 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## start the canal server.</div><div class="line">log4j:WARN No appenders could be found for logger (org.I0Itec.zkclient.ZkEventThread).</div><div class="line">log4j:WARN Please initialize the log4j system properly.</div><div class="line">2016-11-06 23:13:22.442 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - ## start the canal server[192.168.59.1:11112]</div><div class="line">2016-11-06 23:13:22.569 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## the canal server is running now ......</div></pre></td></tr></table></figure>
<p>启动后, 发现并没有example的log, 因为当前只有 canal master 在提供服务：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ll logs/</div><div class="line">total 12</div><div class="line">drwxrwxrwx 3 niko niko 4096 Nov  6 23:13 ./</div><div class="line">drwxrwxrwx 6 niko niko 4096 Nov  6 10:44 ../</div><div class="line">drwxrwxr-x 2 niko niko 4096 Nov  6 23:13 canal/</div></pre></td></tr></table></figure>
<h1 id="查看zookeeper中的running节点"><a href="#查看zookeeper中的running节点" class="headerlink" title="查看zookeeper中的running节点"></a>查看zookeeper中的running节点</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) ] get /otter/canal/destinations/example/running</div><div class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;192.168.156.1:11111&quot;,&quot;cid&quot;:1&#125;</div></pre></td></tr></table></figure>
<p>此时<code>cid</code>为1, master canal 正在 serving.</p>
<h1 id="client-消费数据"><a href="#client-消费数据" class="headerlink" title="client 消费数据"></a>client 消费数据</h1><p>canal client <a href="https://github.com/alibaba/canal/blob/master/example/src/main/java/com/alibaba/otter/canal/example/ClusterCanalClientTest.java" target="_blank" rel="external">代码</a>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">CanalConnector connector = CanalConnectors.newClusterConnector(&quot;127.0.0.1:2181&quot;, destination, &quot;&quot;, &quot;&quot;);</div><div class="line">......</div></pre></td></tr></table></figure>
<p>连接 canal server 后, 从日志可以看到更改的数据 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:java.library.path=.::/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:java.io.tmpdir=/tmp</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:java.compiler=&lt;NA&gt;</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:os.name=Linux</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:os.arch=amd64</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:os.version=3.13.0-96-generic</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:user.name=niko</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:user.home=/home/niko</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Client environment:user.dir=/home/niko/mount/hsb_ssd_1/niko/dev/code/git_repos/java/MavenProj/OpenSources/canal/official/example</div><div class="line">2016-11-07 09:02:12.527 [main] INFO  org.apache.zookeeper.ZooKeeper - Initiating client connection, connectString=127.0.0.1:2181 sessionTimeout=90000 watcher=com.alibaba.otter.canal.common.zookeeper.ZkClientx@351d00c0</div><div class="line">2016-11-07 09:02:12.557 [main-SendThread(a.niko:2181)] INFO  org.apache.zookeeper.ClientCnxn - Opening socket connection to server a.niko/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">2016-11-07 09:02:12.709 [main-SendThread(a.niko:2181)] INFO  org.apache.zookeeper.ClientCnxn - Socket connection established to a.niko/127.0.0.1:2181, initiating session</div><div class="line">2016-11-07 09:02:12.732 [main-SendThread(a.niko:2181)] INFO  org.apache.zookeeper.ClientCnxn - Session establishment complete on server a.niko/127.0.0.1:2181, sessionid = 0x1583c459dd40002, negotiated timeout = 40000</div><div class="line"></div><div class="line">****************************************************</div><div class="line">* Batch Id: [1] ,count : [3] , memsize : [219] , Time : 2016-11-07 09:02:40</div><div class="line">* Start : [mysql-bin.000117:219:1478480560000(2016-11-07 09:02:40)]</div><div class="line">* End : [mysql-bin.000117:473:1478480560000(2016-11-07 09:02:40)]</div><div class="line">****************************************************</div><div class="line"></div><div class="line">================&gt; binlog[mysql-bin.000117:219] , executeTime : 1478480560000 , delay : 788ms</div><div class="line"> BEGIN ----&gt; Thread id: 8</div><div class="line">----------------&gt; binlog[mysql-bin.000117:365] , name[foo,city] , eventType : UPDATE , executeTime : 1478480560000 , delay : 791ms</div><div class="line">id : 1    type=int(11)</div><div class="line">province_id : 1    type=int(11)</div><div class="line">name : 北京市3    type=varchar(50)    update=true</div><div class="line">----------------</div><div class="line"> END ----&gt; transaction id: 28</div><div class="line">================&gt; binlog[mysql-bin.000117:473] , executeTime : 1478480560000 , delay : 8353ms</div></pre></td></tr></table></figure>
<p>连接后, 在zookeeper可以看到 client 的信息:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 0] get /otter/canal/destinations/example/1001/running</div><div class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;192.168.156.1:41823&quot;,&quot;clientId&quot;:1001&#125;</div><div class="line">cZxid = 0xb2</div><div class="line">ctime = Mon Nov 07 09:02:13 HKT 2016</div><div class="line">mZxid = 0xb3</div><div class="line">mtime = Mon Nov 07 09:02:13 HKT 2016</div><div class="line">pZxid = 0xb2</div><div class="line">cversion = 0</div><div class="line">dataVersion = 1</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x1583c459dd40002</div><div class="line">dataLength = 63</div><div class="line">numChildren = 0</div></pre></td></tr></table></figure>
<p>数据消费成功后，canal server 会在zookeeper中记录下当前最后一次消费成功的 binlog 位置, 以便下次重启client时，可从这个位点继续进行消费.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 1] get /otter/canal/destinations/example/1001/cursor</div><div class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.otter.canal.protocol.position.LogPosition&quot;,&quot;identity&quot;:&#123;&quot;slaveId&quot;:-1,&quot;sourceAddress&quot;:&#123;&quot;address&quot;:&quot;127.0.0.1&quot;,&quot;port&quot;:3306&#125;&#125;,&quot;postion&quot;:&#123;&quot;included&quot;:false,&quot;journalName&quot;:&quot;mysql-bin.000117&quot;,&quot;position&quot;:473,&quot;timestamp&quot;:1478480560000&#125;&#125;</div></pre></td></tr></table></figure>
<h1 id="master-canal-宕机测试"><a href="#master-canal-宕机测试" class="headerlink" title="master canal 宕机测试"></a>master canal 宕机测试</h1><p>停掉 canal master :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ bin/stop.sh</div><div class="line">niko-ub1404: stopping canal 7662 ...</div><div class="line">Oook! cost:1</div></pre></td></tr></table></figure>
<p>停掉canal server后, 可以看到 client的log发生变化 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">......</div><div class="line">================&gt; binlog[mysql-bin.000117:473] , executeTime : 1478480560000 , delay : 8353ms</div><div class="line">2016-11-07 09:13:14.485 [Thread-2] WARN  c.alibaba.otter.canal.client.impl.ClusterCanalConnector - something goes wrong when getWithoutAck data from server:null</div><div class="line">com.alibaba.otter.canal.protocol.exception.CanalClientException: java.io.IOException: Connection reset by peer</div><div class="line">	at com.alibaba.otter.canal.client.impl.SimpleCanalConnector.getWithoutAck(SimpleCanalConnector.java:281)</div><div class="line">	at com.alibaba.otter.canal.client.impl.SimpleCanalConnector.getWithoutAck(SimpleCanalConnector.java:252)</div><div class="line">	at com.alibaba.otter.canal.client.impl.ClusterCanalConnector.getWithoutAck(ClusterCanalConnector.java:180)</div><div class="line">	at com.alibaba.otter.canal.example.AbstractCanalClientTest.process(AbstractCanalClientTest.java:113)</div><div class="line">	at com.alibaba.otter.canal.example.AbstractCanalClientTest$2.run(AbstractCanalClientTest.java:80)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: java.io.IOException: Connection reset by peer</div><div class="line">	at sun.nio.ch.FileDispatcherImpl.read0(Native Method)</div><div class="line">	at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)</div><div class="line">	at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)</div><div class="line">	at sun.nio.ch.IOUtil.read(IOUtil.java:197)</div><div class="line">	at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:380)</div><div class="line">	at com.alibaba.otter.canal.client.impl.SimpleCanalConnector.read(SimpleCanalConnector.java:376)</div><div class="line">	at com.alibaba.otter.canal.client.impl.SimpleCanalConnector.readNextPacket(SimpleCanalConnector.java:366)</div><div class="line">	at com.alibaba.otter.canal.client.impl.SimpleCanalConnector.receiveMessages(SimpleCanalConnector.java:286)</div><div class="line">	at com.alibaba.otter.canal.client.impl.SimpleCanalConnector.getWithoutAck(SimpleCanalConnector.java:279)</div><div class="line">	... 5 more</div><div class="line"></div><div class="line">2016-11-07 09:13:20.001 [Thread-2] INFO  c.alibaba.otter.canal.client.impl.ClusterCanalConnector - restart the connector for next round retry.</div><div class="line"></div><div class="line">****************************************************</div><div class="line">* Batch Id: [1] ,count : [1] , memsize : [31] , Time : 2016-11-07 09:13:20</div><div class="line">* Start : [mysql-bin.000117:473:1478480560000(2016-11-07 09:02:40)]</div><div class="line">* End : [mysql-bin.000117:473:1478480560000(2016-11-07 09:02:40)]</div><div class="line">****************************************************</div><div class="line">----------------</div><div class="line"> END ----&gt; transaction id: 28</div><div class="line">================&gt; binlog[mysql-bin.000117:473] , executeTime : 1478480560000 , delay : 640062ms</div></pre></td></tr></table></figure>
<p>随着 canal server 的切换, client 会从zookeeper获取最新的 canal server 地址, 并与之建立连接, 继续消费数据.</p>
<p>接下来再查看当前running节点 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 3] get /otter/canal/destinations/example/running</div><div class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;192.168.156.1:11112&quot;,&quot;cid&quot;:2&#125;</div><div class="line">cZxid = 0xbc</div><div class="line">ctime = Mon Nov 07 09:13:19 HKT 2016</div><div class="line">mZxid = 0xbc</div><div class="line">mtime = Mon Nov 07 09:13:19 HKT 2016</div><div class="line">pZxid = 0xbc</div><div class="line">cversion = 0</div><div class="line">dataVersion = 0</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x1583c459dd40001</div><div class="line">dataLength = 55</div><div class="line">numChildren = 0</div></pre></td></tr></table></figure>
<p>可以看到<code>cid</code>是<code>2</code>, canal standby 正在提供服务, zookeeper 这里切换完成.</p>
<p>这时候再修改数据库数据, 测试验证 canal standby 是否能够正常工作:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">================&gt; binlog[mysql-bin.000117:473] , executeTime : 1478480560000 , delay : 640062ms</div><div class="line"></div><div class="line">****************************************************</div><div class="line">* Batch Id: [2] ,count : [3] , memsize : [219] , Time : 2016-11-07 09:21:52</div><div class="line">* Start : [mysql-bin.000117:569:1478481712000(2016-11-07 09:21:52)]</div><div class="line">* End : [mysql-bin.000117:823:1478481712000(2016-11-07 09:21:52)]</div><div class="line">****************************************************</div><div class="line"></div><div class="line">================&gt; binlog[mysql-bin.000117:569] , executeTime : 1478481712000 , delay : 634ms</div><div class="line"> BEGIN ----&gt; Thread id: 8</div><div class="line">----------------&gt; binlog[mysql-bin.000117:715] , name[foo,city] , eventType : UPDATE , executeTime : 1478481712000 , delay : 634ms</div><div class="line">id : 1    type=int(11)</div><div class="line">province_id : 1    type=int(11)</div><div class="line">name : 北京市4    type=varchar(50)    update=true</div><div class="line">----------------</div><div class="line"> END ----&gt; transaction id: 41</div><div class="line">================&gt; binlog[mysql-bin.000117:823] , executeTime : 1478481712000 , delay : 634ms</div></pre></td></tr></table></figure>
<p>可以看到, canal standby 推送了数据变更给 client, 此时再查看logs/example也会发现有日志出来了:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">canal.deployer-1.0.22-SNAPSHOT_standby$ cat logs/example/example.log</div><div class="line">2016-11-07 09:13:19.772 [pool-1-thread-1] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</div><div class="line">2016-11-07 09:13:19.776 [pool-1-thread-1] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</div><div class="line">2016-11-07 09:13:19.819 [pool-1-thread-1] WARN  org.springframework.beans.TypeConverterDelegate - PropertyEditor [com.sun.beans.editors.EnumEditor] found through deprecated global PropertyEditorManager fallback - consider using a more isolated form of registration, e.g. on the BeanWrapper/BeanFactory!</div><div class="line">2016-11-07 09:13:19.907 [pool-1-thread-1] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance for 1-example</div><div class="line">2016-11-07 09:13:19.921 [pool-1-thread-1] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</div><div class="line">2016-11-07 09:13:19.980 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.otter.canal.parse.inbound.mysql.MysqlEventParser - prepare to find start position just last position</div></pre></td></tr></table></figure>
<p>可知新的canal实例已经被启动并接管服务了.</p>
<h1 id="异常场景"><a href="#异常场景" class="headerlink" title="异常场景"></a>异常场景</h1><p>当然, 有一些异常场景我们要注意一下:</p>
<h2 id="释放时间"><a href="#释放时间" class="headerlink" title="释放时间"></a>释放时间</h2><p>如果canal server的jvm异常crash，running节点(EPHEMERAL type) 的释放是在对应的zookeeper session失效后，</p>
<p><a href="https://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkSessions" target="_blank" rel="external"></a></p>
<h2 id="canal-server-网络中断"><a href="#canal-server-网络中断" class="headerlink" title="canal server 网络中断"></a>canal server 网络中断</h2><p>如果 canal server 所在的网络断了, zookeeper将会认为session失效, 进而释放running节点, 而canal server的jvm其实并没有退出.</p>
<p>为了避免瞬间runing失效导致的instance重新分布，canal 有一个策略：</p>
<blockquote>
<p>canal server在收到running节点释放后，延迟一段时间抢占running，原本running节点的拥有者可以不需要等待延迟，优先取得running节点，可以保证假死状态下尽可能不无谓的释放资源。 目前延迟时间的默认值为5秒，即running节点针对假死状态的保护期为5秒.</p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://github.com/alibaba/canal/wiki/AdminGuide" target="_blank" rel="external">https://github.com/alibaba/canal/wiki/AdminGuide</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[git 推错分支的处理]]></title>
      <url>http://www.nikoai.pw/2016/11/02/git/git-wrong-push/</url>
      <content type="html"><![CDATA[<p>人的状态总有低落的时候, 平时很谨慎的人也有可能出错, 在git使用时, 经常会有合并了错误分支并推送的情况. 这种情况如何处理呢 ?</p>
<h1 id="reset-毁尸灭迹法"><a href="#reset-毁尸灭迹法" class="headerlink" title="reset 毁尸灭迹法"></a>reset 毁尸灭迹法</h1><hr>
<p>使用<code>git reset</code>来抹除刚才的stupid操作, 强制推送后不让别人”发现”. 但是前提是那个分支还没其他人推代码上去, 不然还是会被发现, 而且会把别人的commit删掉, 所以请谨慎使用 (适合分支只有一个人用的情况) :</p>
<p>实操:<br>假设有以下的commit :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">commit 116aac11f0ee0a155837f0d6a68931fe405a6ed4</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:37:57 2016 +0800</div><div class="line"></div><div class="line">    wrong commit.</div><div class="line"></div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<p>然后被推送到 remote server:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git push --set-upstream origin niko_blog_test</div><div class="line">Counting objects: 28, done.</div><div class="line">Delta compression using up to 4 threads.</div><div class="line">Compressing objects: 100% (6/6), done.</div><div class="line">Writing objects: 100% (8/8), 674 bytes | 0 bytes/s, done.</div><div class="line">Total 8 (delta 3), reused 0 (delta 0)</div><div class="line">To gogs@192.168.7.92:foo-org/foo.git</div><div class="line"> * [new branch]      niko_blog_test -&gt; niko_blog_test</div><div class="line">Branch niko_blog_test set up to track remote branch niko_blog_test from origin.</div></pre></td></tr></table></figure>
<p>推送后查看服务器的 git commit log:</p>
<p><img src="/images/git/git-remote-wrong-commit-01.png" alt=""></p>
<p>然后到了我们的主题, 清除掉remote上面的错误 commit <code>116aac11f0ee0a155837f0d6a68931fe405a6ed4</code>, 如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git reset --hard f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">$ git push -f</div><div class="line">Total 0 (delta 0), reused 0 (delta 0)</div><div class="line">To gogs@192.168.7.92:foo-org/foo.git</div><div class="line"> + 116aac1...f000b1a niko_blog_test -&gt; niko_blog_test (forced update)</div></pre></td></tr></table></figure>
<p>这时再查看服务器上的commit log, 可以发现<code>116aac11f0ee0a155837f0d6a68931fe405a6ed4</code>的commit已经被删除了:</p>
<p><img src="/images/git/git-remote-wrong-commit-02.png" alt=""></p>
<h2 id="一个高级用法-删除最后一个commit"><a href="#一个高级用法-删除最后一个commit" class="headerlink" title="一个高级用法: 删除最后一个commit"></a>一个高级用法: 删除最后一个commit</h2><hr>
<p>假设有一个在<code>mathnet</code>的remote的分支master, 当前指向<code>dd61ab32</code>的commit, 可以这样做:</p>
<pre><code>$ git push mathnet +dd61ab32^:master
</code></pre><p>其中, <code>x^</code>表示<code>the parent of x</code><br><code>+</code>表示<code>a forced non-fastforward push</code></p>
<p>不过, 我还是喜欢前一个做法, 更适用一点.</p>
<h1 id="revert-警示后人法"><a href="#revert-警示后人法" class="headerlink" title="revert 警示后人法"></a>revert 警示后人法</h1><hr>
<p>使用 <code>git revert</code> 建立新的commit来回滚, 假设现在服务器和本地的 <code>git log</code>是:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">commit ceaa73fd804aefc406f6384c9c0fffaedafbcb79</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:39 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-02.</div><div class="line"></div><div class="line">commit 42a87088af08b54cf09be122e39e4d85c0f450ec</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:11 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-01.</div><div class="line"></div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<p>其中<code>ceaa73fd804aefc406f6384c9c0fffaedafbcb79</code>是要revert的错误commit.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git revert ceaa73fd804aefc406f6384c9c0fffaedafbcb79</div></pre></td></tr></table></figure>
<p>此时的gitlog :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">commit 4b9fe2c1ad02640fa63cfb18df409086b7681caf</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 17:13:38 2016 +0800</div><div class="line"></div><div class="line">    Revert &quot;Add: txt-02.&quot;</div><div class="line"></div><div class="line">    This reverts commit ceaa73fd804aefc406f6384c9c0fffaedafbcb79.</div><div class="line"></div><div class="line">commit ceaa73fd804aefc406f6384c9c0fffaedafbcb79</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:39 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-02.</div><div class="line"></div><div class="line">commit 42a87088af08b54cf09be122e39e4d85c0f450ec</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:11 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-01.</div><div class="line"></div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<p>可见, 多了一个commit, 文本修改如下 ( 正确reverted ) , 此时再推上remote server即可.</p>
<p><img src="/images/git/git-wrong-push-01.png" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://christoph.ruegg.name/blog/git-howto-revert-a-commit-already-pushed-to-a-remote-reposit.html" target="_blank" rel="external">http://christoph.ruegg.name/blog/git-howto-revert-a-commit-already-pushed-to-a-remote-reposit.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[git cherry-pick 使用]]></title>
      <url>http://www.nikoai.pw/2016/11/02/git/git-cherry-pick/</url>
      <content type="html"><![CDATA[<p>工作中, 我们经常会需要从其他分支获取一些重要的修改, 但只是部分commit, 不能用merge, 这时<code>cherry-pick</code>就派上用场了.<br><code>cherry-pick</code>可以把其他分支的某些commit合并到当前分支, 具体使用和注意事项请看下面的实操.</p>
<h1 id="cherry-pick-实操"><a href="#cherry-pick-实操" class="headerlink" title="cherry-pick 实操"></a>cherry-pick 实操</h1><hr>
<p>假设有一个分支<code>origin/niko_blog_test</code>, 他的<code>git log</code>如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">commit ceaa73fd804aefc406f6384c9c0fffaedafbcb79</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:39 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-02.</div><div class="line"></div><div class="line">commit 42a87088af08b54cf09be122e39e4d85c0f450ec</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:11 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-01.</div><div class="line"></div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<p><strong>基于<code>f000b1ac4bf9dbd57d107895f349f448a3af05cc</code>的commit建立分支<code>niko_blog_test-2</code>:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">git checkout -b niko_blog_test-2 f000b1ac4bf9dbd57d107895f349f448a3af05cc</div></pre></td></tr></table></figure>
<p>查看git log:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<h2 id="开始cherry-pick"><a href="#开始cherry-pick" class="headerlink" title="开始cherry-pick"></a>开始cherry-pick</h2><hr>
<p>我们要把<code>niko_blog_test</code>的两个最新commit, pick到<code>niko_blog_test-2</code>中, 操作如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git cherry-pick ceaa73f 42a8708</div><div class="line">error: could not apply ceaa73f... Add: txt-02.</div><div class="line">hint: after resolving the conflicts, mark the corrected paths</div><div class="line">hint: with &apos;git add &lt;paths&gt;&apos; or &apos;git rm &lt;paths&gt;&apos;</div><div class="line">hint: and commit the result with &apos;git commit&apos;</div></pre></td></tr></table></figure>
<p>提示冲突, 进行合并:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git mergetool</div></pre></td></tr></table></figure>
<p>此时状态:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git st</div><div class="line">On branch niko_blog_test-2</div><div class="line">You are currently cherry-picking commit ceaa73f.</div><div class="line">  (all conflicts fixed: run &quot;git cherry-pick --continue&quot;)</div><div class="line">  (use &quot;git cherry-pick --abort&quot; to cancel the cherry-pick operation)</div><div class="line"></div><div class="line">Changes to be committed:</div><div class="line"></div><div class="line">        modified:   README.txt</div></pre></td></tr></table></figure>
<p>进行commit操作.</p>
<p>然后继续记性cherry-pick:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git cherry-pick --continue</div><div class="line">error: could not apply 42a8708... Add: txt-01.</div><div class="line">hint: after resolving the conflicts, mark the corrected paths</div><div class="line">hint: with &apos;git add &lt;paths&gt;&apos; or &apos;git rm &lt;paths&gt;&apos;</div><div class="line">hint: and commit the result with &apos;git commit&apos;</div></pre></td></tr></table></figure>
<p>又提示冲突, 这里要手动解决了.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git mergetool</div></pre></td></tr></table></figure>
<p><img src="/images/git/git-cherry-pick-01.png" alt=""></p>
<p>冲突解决后, 此时状态:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git st</div><div class="line">On branch niko_blog_test-2</div><div class="line">You are currently cherry-picking commit 42a8708.</div><div class="line">  (all conflicts fixed: run &quot;git cherry-pick --continue&quot;)</div><div class="line">  (use &quot;git cherry-pick --abort&quot; to cancel the cherry-pick operation)</div><div class="line"></div><div class="line">Changes to be committed:</div><div class="line"></div><div class="line">        modified:   README.txt</div></pre></td></tr></table></figure>
<p>进行commit操作.</p>
<p>再<code>git cherry-pick --continue</code>会打印空内容, 表示cherry-pick结束.</p>
<p>此时再查看log:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">commit e68a53fef3229c6536b44781d2cb8322aa4202e1</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:11 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-01.</div><div class="line"></div><div class="line">    cherry-picking commit 42a8708.</div><div class="line"></div><div class="line">    Conflicts:</div><div class="line">        hsb-common/README.txt</div><div class="line"></div><div class="line">commit 9d7a471f646742da9b68e663fee41be62a0e17b7</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:39 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-02.</div><div class="line"></div><div class="line">    cherry-picking commit ceaa73f.</div><div class="line"></div><div class="line">    Conflicts:</div><div class="line">        hsb-common/README.txt</div><div class="line"></div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<p>可以看到<code>f000b1ac4bf9dbd57d107895f349f448a3af05cc</code>之后多了两个commit, README.txt的内容也过来了.</p>
<p>其实, 上面的操作之所以很曲折, 是因为顺序错了, 哇哈哈哈 !!!只要按commit时间顺序来, 就不会有这么多的冲突问题, 如下所示.</p>
<h1 id="cherry-pick-实操-按时间顺序"><a href="#cherry-pick-实操-按时间顺序" class="headerlink" title="cherry-pick 实操 - 按时间顺序"></a>cherry-pick 实操 - 按时间顺序</h1><hr>
<p>重来的话, 我们reset到<code>f000b1ac4bf9dbd57d107895f349f448a3af05cc</code>版本:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git reset --hard f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">HEAD is now at f000b1a hello</div><div class="line"></div><div class="line">$ git log</div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<h2 id="开始cherry-pick-1"><a href="#开始cherry-pick-1" class="headerlink" title="开始cherry-pick"></a>开始cherry-pick</h2><hr>
<p>这次, 我们按照正确的顺序来:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git cherry-pick 42a8708 ceaa73f</div><div class="line">[niko_blog_test-2 fdae77f] Add: txt-01.</div><div class="line"> 1 file changed, 2 insertions(+), 1 deletion(-)</div><div class="line">[niko_blog_test-2 3e02126] Add: txt-02.</div><div class="line"> 1 file changed, 2 insertions(+), 1 deletion(-)</div></pre></td></tr></table></figure>
<p>因为不会冲突, 直接用分支<code>niko_blog_test</code>的commit log, 如 git log 所示:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git log</div><div class="line">commit 3e02126c34fd3909b34228368ffb98c400b436c9</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:39 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-02.</div><div class="line"></div><div class="line">commit fdae77ffb6583fc44a82ab36cb26f005f335bacb</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 14:54:11 2016 +0800</div><div class="line"></div><div class="line">    Add: txt-01.</div><div class="line"></div><div class="line">commit f000b1ac4bf9dbd57d107895f349f448a3af05cc</div><div class="line">Author: niko &lt;329872193@qq.com&gt;</div><div class="line">Date:   Wed Nov 2 10:27:47 2016 +0800</div><div class="line"></div><div class="line">    hello</div></pre></td></tr></table></figure>
<p>顺序对了, 是不是简单很多啦? 所以一定要注意顺序的问题. 嘻嘻……</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://git-scm.com/docs/git-cherry-pick" target="_blank" rel="external">git-cherry-pick</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Python `__new__` 和 `__init__` 的区别]]></title>
      <url>http://www.nikoai.pw/2016/10/17/python/basic/python_init_new_diff/</url>
      <content type="html"><![CDATA[<p>这两个东西看起来很相似, 但有什么区别呢 ?</p>
<h1 id="init-不能返回实例-new-可以"><a href="#init-不能返回实例-new-可以" class="headerlink" title="__init__ 不能返回实例, __new__ 可以"></a><code>__init__</code> 不能返回实例, <code>__new__</code> 可以</h1><hr>
<p>return cls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"__init__ invoked."</span></div><div class="line">        <span class="keyword">return</span> self</div><div class="line"></div><div class="line">hello = Hello()</div></pre></td></tr></table></figure>
<p>错误结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">__init__ invoked.</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;./class_hello.py&quot;, line 12, in &lt;module&gt;</div><div class="line">    hello = Hello()</div><div class="line">TypeError: __init__() should return None, not &apos;Hello&apos;</div></pre></td></tr></table></figure>
<h1 id="new-会先被调用"><a href="#new-会先被调用" class="headerlink" title="__new__ 会先被调用"></a><code>__new__</code> 会先被调用</h1><hr>
<p>代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"__new__ invoked."</span></div><div class="line">        <span class="keyword">return</span> super(Hello, cls).__new__(cls)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"__init__ invoked."</span></div><div class="line"></div><div class="line">hello = Hello()</div></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">python ./class_hello.py</div><div class="line">__new__ invoked.</div><div class="line">__init__ invoked.</div></pre></td></tr></table></figure>
<p>这种结果是因为 <code>__new__</code> 是控制实例生成的过程, 而 <code>__init__</code> 是对已经生成的实例进行初始化的过程.<br><code>__new__</code> 方法像是一个类方法，而 <code>__init__</code> 像是个实例方法.</p>
<h1 id="如果不是返回实例-init-不会被调用"><a href="#如果不是返回实例-init-不会被调用" class="headerlink" title="如果不是返回实例, __init__ 不会被调用"></a>如果不是返回实例, <code>__init__</code> 不会被调用</h1><hr>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"__new__ invoked."</span></div><div class="line">        <span class="keyword">return</span> cls</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"__init__ invoked."</span></div><div class="line"></div><div class="line">hello = Hello()</div></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">python ./class_hello.py</div><div class="line">__new__ invoked.</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://stackoverflow.com/questions/674304/pythons-use-of-new-and-init" target="_blank" rel="external">http://stackoverflow.com/questions/674304/pythons-use-of-new-and-init</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[update-alternatives 修改默认命令链接]]></title>
      <url>http://www.nikoai.pw/2016/09/10/linux/tools/update-alternatives-01/</url>
      <content type="html"><![CDATA[<p><code>update-alternatives</code>, 是用来维护命令链接的工具， 具体有什么用、怎么用以及它的工作方式等内容，就通过接下来的示例说明。</p>
<h1 id="以-java-命令为例子"><a href="#以-java-命令为例子" class="headerlink" title="以 java 命令为例子"></a>以 java 命令为例子</h1><hr>
<p>查看当前 java 命令使用的是哪个版本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ll /usr/bin/java</div><div class="line">lrwxrwxrwx 1 root root 22 Sep 10 13:14 /usr/bin/java -&gt; /etc/alternatives/java*</div><div class="line"></div><div class="line">$ ll /etc/alternatives/java</div><div class="line">lrwxrwxrwx 1 root root 46 Sep 10 13:14 /etc/alternatives/java -&gt; /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java*</div></pre></td></tr></table></figure>
<p>从上可知， 使用的是 java-7-openjdk-amd64。</p>
<h1 id="display-amp-query"><a href="#display-amp-query" class="headerlink" title="--display &amp; --query"></a><code>--display</code> &amp; <code>--query</code></h1><hr>
<p>同时， 我们可以用 update-alternatives 查看当前的 java 对应的是哪个 bin。</p>
<p>–display 查看当前使用的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ update-alternatives --display java</div><div class="line">java - auto mode</div><div class="line">  link currently points to /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java - priority 1071</div><div class="line">  slave java.1.gz: /usr/lib/jvm/java-7-openjdk-amd64/jre/man/man1/java.1.gz</div><div class="line">Current &apos;best&apos; version is &apos;/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java&apos;.</div></pre></td></tr></table></figure>
<p>–query 显示更多的 alternatives ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">niko@ubuntu14:~$ update-alternatives --query java</div><div class="line">Name: java</div><div class="line">Link: /usr/bin/java</div><div class="line">Slaves:</div><div class="line"> java.1.gz /usr/share/man/man1/java.1.gz</div><div class="line">Status: auto</div><div class="line">Best: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">Value: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line"></div><div class="line">Alternative: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">Priority: 1071</div><div class="line">Slaves:</div><div class="line"> java.1.gz /usr/lib/jvm/java-7-openjdk-amd64/jre/man/man1/java.1.gz</div></pre></td></tr></table></figure>
<h1 id="install"><a href="#install" class="headerlink" title="--install"></a><code>--install</code></h1><hr>
<p>使用 –install 可以新增我们的 jdk 8 java 命令 ，使用方法是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">update-alternatives --install needs &lt;link&gt; &lt;name&gt; &lt;path&gt; &lt;priority&gt;</div></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo update-alternatives --install &quot;/usr/bin/java&quot; &quot;java&quot; &quot;/usr/local/java/jdk1.8.0_66/bin/java&quot; 3</div></pre></td></tr></table></figure>
<p>查看 install 结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ update-alternatives --query java</div><div class="line">Name: java</div><div class="line">Link: /usr/bin/java</div><div class="line">Slaves:</div><div class="line"> java.1.gz /usr/share/man/man1/java.1.gz</div><div class="line">Status: auto</div><div class="line">Best: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">Value: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line"></div><div class="line">Alternative: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">Priority: 1071</div><div class="line">Slaves:</div><div class="line"> java.1.gz /usr/lib/jvm/java-7-openjdk-amd64/jre/man/man1/java.1.gz</div><div class="line"></div><div class="line">Alternative: /usr/local/java/jdk1.8.0_66/bin/java</div><div class="line">Priority: 3</div><div class="line">Slaves:</div><div class="line"></div><div class="line"></div><div class="line">$ sudo update-alternatives --display java</div><div class="line">java - manual mode</div><div class="line">  link currently points to /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java - priority 5</div><div class="line">/usr/local/java/jdk1.8.0_66/bin/java - priority 3</div><div class="line">Current &apos;best&apos; version is &apos;/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java&apos;.</div></pre></td></tr></table></figure>
<p>如上可知， java 还是 7 的版本。</p>
<h1 id="config"><a href="#config" class="headerlink" title="--config"></a><code>--config</code></h1><hr>
<p>此时， 需要用 <code>--config</code> 设置想要的 alternative ：</p>
<p>sudo update-alternatives –config java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo update-alternatives --config java</div><div class="line">There are 2 choices for the alternative java (providing /usr/bin/java).</div><div class="line"></div><div class="line">  Selection    Path                                            Priority   Status</div><div class="line">------------------------------------------------------------</div><div class="line">* 0            /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java   1071      auto mode</div><div class="line">  1            /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java   1071      manual mode</div><div class="line">  2            /usr/local/java/jdk1.8.0_66/bin/java             3         manual mode</div><div class="line"></div><div class="line">Press enter to keep the current choice[*], or type selection number: 2</div><div class="line">update-alternatives: using /usr/local/java/jdk1.8.0_66/bin/java to provide /usr/bin/java (java) in manual mode</div></pre></td></tr></table></figure>
<p>如上， 可以选择想要的 alternatives，下面测试是否确实切换成功：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ java -version</div><div class="line">java version &quot;1.8.0_66&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_66-b17)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.66-b17, mixed mode)</div></pre></td></tr></table></figure>
<p>再看链接， 发现也已经被修改了， 如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ll /usr/bin/java</div><div class="line">lrwxrwxrwx 1 root root 22 Sep 10 13:14 /usr/bin/java -&gt; /etc/alternatives/java*</div><div class="line">niko@ubuntu14:~$ ll /etc/alternatives/java</div><div class="line">lrwxrwxrwx 1 root root 36 Dec  7 01:09 /etc/alternatives/java -&gt; /usr/local/java/jdk1.8.0_66/bin/java*</div></pre></td></tr></table></figure>
<p>如上， 更新成功了，使用 java 命令默认使用 Java 8 了。</p>
<h1 id="remove"><a href="#remove" class="headerlink" title="--remove"></a><code>--remove</code></h1><hr>
<p>上面查看 java 时， 觉得第一行和第二行重复了，可以删掉不想要的 alternatives， 用法：</p>
<p>sudo update-alternatives –remove name path</p>
<p>具体例子， 如下移除成功：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo update-alternatives --remove java /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">$ update-alternatives --query java</div><div class="line">Name: java</div><div class="line">Link: /usr/bin/java</div><div class="line">Status: manual</div><div class="line">Best: /usr/local/java/jdk1.8.0_66/bin/java</div><div class="line">Value: /usr/local/java/jdk1.8.0_66/bin/java</div><div class="line"></div><div class="line">Alternative: /usr/local/java/jdk1.8.0_66/bin/java</div><div class="line">Priority: 3</div></pre></td></tr></table></figure>
<h1 id="set"><a href="#set" class="headerlink" title="--set"></a><code>--set</code></h1><hr>
<p>除了 –config ， 还可以更直接使用 –set 进行设置（不过必须先 –install ）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 查看当前的选择</span></div><div class="line">niko@ubuntu14:~$ sudo update-alternatives --query java</div><div class="line">Name: java</div><div class="line">Link: /usr/bin/java</div><div class="line">Status: manual</div><div class="line">Best: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">Value: /usr/<span class="built_in">local</span>/java/jdk1.8.0_66/bin/java</div><div class="line"></div><div class="line">Alternative: /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">Priority: 5</div><div class="line"></div><div class="line">Alternative: /usr/<span class="built_in">local</span>/java/jdk1.8.0_66/bin/java</div><div class="line">Priority: 3</div><div class="line"></div><div class="line"><span class="comment"># 查看可知当前使用的是 jdk 8</span></div><div class="line">$ sudo update-alternatives --display java</div><div class="line">java - manual mode</div><div class="line">  link currently points to /usr/<span class="built_in">local</span>/java/jdk1.8.0_66/bin/java</div><div class="line">/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java - priority 5</div><div class="line">/usr/<span class="built_in">local</span>/java/jdk1.8.0_66/bin/java - priority 3</div><div class="line">Current <span class="string">'best'</span> version is <span class="string">'/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java'</span>.</div><div class="line"></div><div class="line"><span class="comment"># 设置使用 jdk7</span></div><div class="line">$ sudo update-alternatives --set java /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java to provide /usr/bin/java (java) <span class="keyword">in</span> manual mode</div><div class="line"></div><div class="line"><span class="comment"># 显示使用 jdk7 了， 设置成功</span></div><div class="line">$ update-alternatives --display java</div><div class="line">java - manual mode</div><div class="line">  link currently points to /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java</div><div class="line">/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java - priority 5</div><div class="line">/usr/<span class="built_in">local</span>/java/jdk1.8.0_66/bin/java - priority 3</div><div class="line">Current <span class="string">'best'</span> version is <span class="string">'/usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java'</span>.</div><div class="line"></div><div class="line"><span class="comment"># 1.7</span></div><div class="line">$ java -version</div><div class="line">java version <span class="string">"1.7.0_111"</span></div><div class="line">OpenJDK Runtime Environment (IcedTea 2.6.7) (7u111-2.6.7-0ubuntu0.14.04.3)</div><div class="line">OpenJDK 64-Bit Server VM (build 24.111-b01, mixed mode)</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.thomas-krenn.com/en/wiki/Manual_Installation_of_Oracle_Java_JRE_6_or_SE_7_in_Ubuntu" target="_blank" rel="external">https://www.thomas-krenn.com/en/wiki/Manual_Installation_of_Oracle_Java_JRE_6_or_SE_7_in_Ubuntu</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【不务正业】MuseScore - 搞音乐必备工具]]></title>
      <url>http://www.nikoai.pw/2016/09/08/linux/tools/others/musescore-update/</url>
      <content type="html"><![CDATA[<h1 id="MuseScore"><a href="#MuseScore" class="headerlink" title="MuseScore"></a>MuseScore</h1><hr>
<p>MuseScore 是一款跨平台的乐谱编辑软件， 是一个所见即所得的编辑器， 支持乐谱编辑/播放/导入/导出等各种操作， 功能非常强大。</p>
<h1 id="更新到新版本"><a href="#更新到新版本" class="headerlink" title="更新到新版本"></a>更新到新版本</h1><hr>
<p>今天突然想练练小提琴, 之前都是直接在MuseScore查看五线谱, 今天的网络出了问题, 之前下的几个五线谱用ubuntu的客户端打开, 提示版本太老了, ubuntu software center 的包太老了. 需要更新一下。</p>
<p>下面安装或升级到 <code>version 2.0.3</code> ：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># To add the PPA if you don't already have it:</span></div><div class="line">sudo add-apt-repository ppa:mscore-ubuntu/mscore-stable</div><div class="line"></div><div class="line"><span class="comment"># To install or upgrade MuseScore:</span></div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install musescore</div></pre></td></tr></table></figure>
<h1 id="使用界面"><a href="#使用界面" class="headerlink" title="使用界面"></a>使用界面</h1><hr>
<p>更新完后， 从网站上下载 <code>*.mscz</code> 音谱文件， 然后在本地用 MuseScore 打开， 可以进行编辑、试听等操作， 赶紧装一个吧（ MuseScore 网站的资源也是很丰富哦 ）！</p>
<p><img src="/images/linux/tools/MuseScore-gui-01.png" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://musescore.org/apt" target="_blank" rel="external">MuseScore 2 for Ubuntu 14.04 and above</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[微服务简介 (笔记)]]></title>
      <url>http://www.nikoai.pw/2016/08/20/cs/design/microservice/microservice-introduction/</url>
      <content type="html"><![CDATA[<p>微服务, 顾名思义， 是一些小而自治的服务.</p>
<h1 id="小"><a href="#小" class="headerlink" title="小"></a>小</h1><hr>
<p>随着新功能的开发, 代码会越来越大, 为了系统的稳定和可维护, 在单块应用中, 常常会进行模块化等拆分过程， 分而治之, 然而这些模块的界限很难确定.<br>而划分模块时， 比较常用的是<code>单一责任原则</code>, 其中 Robert C. Martin 对 <a href="http://programmer.97things.oreilly.com/wiki/index.php/The_Single_Responsibility_Principle" target="_blank" rel="external">Single Responsibility Principle</a> 有这样的论述: <strong>把因相同原因的而变化的东西聚合在一起, 而把因不同原因而变化的东西分离开来</strong>. 如果将这个原则应用到分布式系统的服务划分, 同样的原理, 让一个服务拆分到足够小, 使其专注其边界内的事, 就能够避免很多代码库或单块应用过大衍生的问题.</p>
<h1 id="自治"><a href="#自治" class="headerlink" title="自治"></a>自治</h1><hr>
<p>自治性, 其实是跟耦合相关联的. 也即是说, 如果一个服务和客户端耦合过多, 客户端相当于过多参与服务内部的流程, 影响了服务的自治性.<br>而服务是通过 API 进行通信, 那么 API 的设计就要选择与具体技术不相关的 API 实现方式, 避免耦合.<br>如何判断一个服务有没有很好的解耦, 可以思考一个问题, 我这个服务能不能很方便的修改和部署, 而不影响其他所有服务.</p>
<h1 id="微服务有什么好处"><a href="#微服务有什么好处" class="headerlink" title="微服务有什么好处?"></a>微服务有什么好处?</h1><hr>
<p>那么， 微服务能给我们带来什么好处呢 ？</p>
<p><code>技术异构性</code></p>
<p>首先， 前面介绍自治性时提到， 我们要选择与具体技术不相关的 API 实现方式， 因此， 微服务可以让我们为不同部分的业务和功能选择最合适的技术.</p>
<p><code>弹性</code></p>
<p>在单块应用中, 某项功能故障很可能导致整体的不可用. 但微服务可以很好的处理服务故障和降级的问题.</p>
<p><code>拓展</code></p>
<p>一个大型单块应用只能作为一个整体拓展, 而微服务可以很容易的对某些部分进行拓展.</p>
<p><code>简化部署</code></p>
<p>单块应用需要整体部署, 就算修改了一行代码, 这也导致单块应用的发布周期是比较长的.</p>
<p><code>组织结构</code></p>
<p>小而专注的服务, 可以让对应的团队同样小而专注, 使工作和交付更加高效.</p>
<p><code>可组合性</code></p>
<p>微服务架构可以更好的重用已有服务, 并组合这些服务可以实现不同的应用.</p>
<p><code>对可替代性的优化</code></p>
<p>有时候想要重新实现或替换某个服务, 比起单块应用来说, 可操作和安全性更强.</p>
<h1 id="其他分解技术"><a href="#其他分解技术" class="headerlink" title="其他分解技术"></a>其他分解技术</h1><hr>
<p>前面提到了很多单块应用的缺点, 有童鞋可能会问, 其实单块应用也有相应的技术去分解系统. 比如共享库 / 模块等.</p>
<h2 id="共享库"><a href="#共享库" class="headerlink" title="共享库"></a>共享库</h2><p>首先说一下 <code>共享库</code>. 一个服务可以做成一个共享库来提供功能, 但是这种方式有一些缺点.<br>首先, 无法选择异构技术;<br>其次, 会失去对系统某部分进行独立拓展的能力.<br>还有一点, 如果对某个库进行了更新, 那么可能要重新部署依赖这个库的系统(除了动态链接库), 更严重的是无法保证架构的安全性和弹性.</p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>Java 中有一种叫 OSGi 的模块技术, 可以在不停止进程的情况下, 对模块进行更新. 但它的复杂性要远大于带来的好处, 而且依然会限制我们使用新技术和进行独立拓展的能力. 不可否认， 在单块进程中创建隔离性很好的模块是有可能的， 但是很难做到，因为模块很容易和代码耦合在一起。</p>
<h1 id="没有免费的午餐"><a href="#没有免费的午餐" class="headerlink" title="没有免费的午餐"></a>没有免费的午餐</h1><hr>
<p>说了这么多微服务的优点, 当然天下没有免费的午餐, 当选择了微服务, 你还需要面对许多分布式下的问题( CAP / 事务等). 而且微服务是否适合你, 还需要结合业务场景、团队结构等各种因素综合考虑。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>&lt;&lt; 微服务设计 - Sam.Newman &gt;&gt;</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[git 把代码推送到另外一个仓库]]></title>
      <url>http://www.nikoai.pw/2016/07/25/git/git-push-to-other-repos/</url>
      <content type="html"><![CDATA[<p>工作中, 我们会遇到这样的场景, 从 github 上拉了一些项目代码下来, 修改到一半需要回家了, 但不想 push 上 github, 也不想用硬盘拷贝, 这时可以先 push 到私有仓库中, 回家继续修改之后, 再推送到 github 仓库中.</p>
<h1 id="把-github-仓库的代码推送到另外一个仓库（OSC）"><a href="#把-github-仓库的代码推送到另外一个仓库（OSC）" class="headerlink" title="把 github 仓库的代码推送到另外一个仓库（OSC）"></a>把 github 仓库的代码推送到另外一个仓库（OSC）</h1><hr>
<p>假设现在我从 github 上 clone 了 dubbo 的仓库下来, 然后我改了东西, 现在我要推送到 osc 开源中国的私有 git 仓库中, 以下是完整操作:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 把origin改名为github, 方便识别</span></div><div class="line">$ git remote rename origin github</div><div class="line">$ git remote -v</div><div class="line">github	git@github.com:alibaba/dubbo.git (fetch)</div><div class="line">github	git@github.com:alibaba/dubbo.git (push)</div><div class="line"></div><div class="line"><span class="comment"># 增加osc的remote</span></div><div class="line">$ git remote add osc git@git.oschina.net:niko2014/<span class="built_in">test</span>-push-another-repo.git</div><div class="line">$ git remote -v</div><div class="line">github	git@github.com:alibaba/dubbo.git (fetch)</div><div class="line">github	git@github.com:alibaba/dubbo.git (push)</div><div class="line">osc	git@git.oschina.net:niko2014/<span class="built_in">test</span>-push-another-repo.git (fetch)</div><div class="line">osc	git@git.oschina.net:niko2014/<span class="built_in">test</span>-push-another-repo.git (push)</div><div class="line"></div><div class="line"><span class="comment"># 先在 osc 创建一个空的 repo</span></div><div class="line">$ git push osc master</div><div class="line">Counting objects: 37880, done.</div><div class="line">Delta compression using up to 4 threads.</div><div class="line">Compressing objects: 100% (13163/13163), done.</div><div class="line">Writing objects: 100% (37880/37880), 5.61 MiB | 1.73 MiB/s, done.</div><div class="line">Total 37880 (delta 12824), reused 37879 (delta 12823)</div><div class="line">remote: Resolving deltas: 100% (12824/12824), done.</div><div class="line">To git@git.oschina.net:niko2014/<span class="built_in">test</span>-push-another-repo.git</div><div class="line"> * [new branch]      master -&gt; master</div><div class="line"></div><div class="line"><span class="comment"># 现在你可以在多个 repo 之间各种 pull push 了</span></div><div class="line">$ git push osc master</div><div class="line">$ git push github master</div><div class="line">$ git pull osc master</div><div class="line">$ git pull github master</div></pre></td></tr></table></figure>
<p>有了多个 remote , 不仅可以完成 github -&gt; osc , 还可以将 osc -&gt; github .</p>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><hr>
<h2 id="推送分支和远程-tag-名相同-refspec-matches-more-than-one"><a href="#推送分支和远程-tag-名相同-refspec-matches-more-than-one" class="headerlink" title="推送分支和远程 tag 名相同 - refspec matches more than one."></a>推送分支和远程 tag 名相同 - refspec matches more than one.</h2><hr>
<p>错误:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git push --set-upstream osc dubbo-2.4.11</div><div class="line">error: src refspec dubbo-2.4.11 matches more than one.</div><div class="line">error: failed to push some refs to &apos;git@git.oschina.net:niko2014/dubbo_n.git&apos;</div></pre></td></tr></table></figure>
<p>解决:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ git push  osc  HEAD:dubbo-2.4.11</div><div class="line">Counting objects: 2696, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (1105/1105), done.</div><div class="line">Writing objects: 100% (2280/2280), 233.51 KiB | 0 bytes/s, done.</div><div class="line">Total 2280 (delta 861), reused 2165 (delta 754)</div><div class="line">To git@git.oschina.net:niko2014/dubbo_n.git</div><div class="line"> * [new branch]      HEAD -&gt; dubbo-2.4.11</div><div class="line"></div><div class="line"><span class="comment"># 或者使用</span></div><div class="line"><span class="comment"># git push origin refs/heads/xxx:refs/heads/xxx</span></div></pre></td></tr></table></figure>
<p>不过, 最好不要用相同的 tag 和 branch 名字.</p>
<p>参考: <a href="http://stackoverflow.com/questions/9378760/git-push-local-branch-with-same-name-as-remote-tag" target="_blank" rel="external">http://stackoverflow.com/questions/9378760/git-push-local-branch-with-same-name-as-remote-tag</a></p>
<h2 id="tag-和-branch-重名问题"><a href="#tag-和-branch-重名问题" class="headerlink" title="tag 和 branch 重名问题"></a>tag 和 branch 重名问题</h2><hr>
<p>相同的 tag 和 branch 名字容易出现各种问题, 不推荐使用. 比如推送分支 <code>dubbo-2.4.11</code> 时的提示 :</p>
<blockquote>
<p>refname ‘dubbo-2.4.11’ is ambiguous</p>
</blockquote>
<h3 id="解决方法一-改-branch"><a href="#解决方法一-改-branch" class="headerlink" title="解决方法一: 改 branch"></a>解决方法一: 改 branch</h3><p>改变分支名, 删掉旧的分支.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 新的分支名</span></div><div class="line">git checkout -b dubbo-2.4.11-branch</div><div class="line"><span class="comment"># Delete the specified branch. This is a “safe” operation in that Git prevents you from deleting the branch if it has unmerged changes.</span></div><div class="line">git branch <span class="_">-d</span> dubbo-2.4.11</div><div class="line"><span class="comment"># 或者</span></div><div class="line"><span class="comment"># Force delete the specified branch, even if it has unmerged changes. This is the command to use if you want to permanently throw away all of the commits associated with a particular line of development.</span></div><div class="line">git branch -D dubbo-2.4.11</div></pre></td></tr></table></figure>
<h3 id="解决方法二-改-tag"><a href="#解决方法二-改-tag" class="headerlink" title="解决方法二: 改 tag"></a>解决方法二: 改 tag</h3><p>使用 <code>git tag [tag] [commit]</code> 先重命名保存原来的 tag , 然后删掉.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 将 dubbo-2.4.11 的 commit 使用 tag 为 dubbo-2.4.11-tag</span></div><div class="line">git tag  dubbo-2.4.11-tag  dubbo-2.4.11</div><div class="line"><span class="comment"># 删除原来的 dubbo-2.4.11 的 tag</span></div><div class="line">git tag <span class="_">-d</span> xxx</div></pre></td></tr></table></figure>
<p>参考: <a href="http://stackoverflow.com/questions/12224773/git-refname-master-is-ambiguous" target="_blank" rel="external">http://stackoverflow.com/questions/12224773/git-refname-master-is-ambiguous</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://stackoverflow.com/questions/5181845/git-push-existing-repo-to-a-new-and-different-remote-repo-server" target="_blank" rel="external">http://stackoverflow.com/questions/5181845/git-push-existing-repo-to-a-new-and-different-remote-repo-server</a><br><a href="https://www.atlassian.com/git/tutorials/using-branches/git-branch" target="_blank" rel="external">https://www.atlassian.com/git/tutorials/using-branches/git-branch</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[跨域之CORS简介]]></title>
      <url>http://www.nikoai.pw/2016/07/02/cs/protocol/CORS_nginx/</url>
      <content type="html"><![CDATA[<p>最近由于申请到了新的服务器域名,  需要慢慢把一些服务和应用的旧域名逐渐迁到新的域名来,  迁移工作涉及到前端以及后台API,  更多可能是一些运维设置和跨域的问题,  接下来要老生常谈一下CORS, 就当复习吧..</p>
<h1 id="Cross-Origin-Resource-Sharing-CORS"><a href="#Cross-Origin-Resource-Sharing-CORS" class="headerlink" title="Cross-Origin Resource Sharing (CORS)"></a>Cross-Origin Resource Sharing (CORS)</h1><hr>
<p>Cross-Origin Resource Sharing (CORS), 是浏览器跨源服务器进行资源共享的一个标准, 是解决跨越访问的方法之一.</p>
<p>那什么是跨域呢?</p>
<p>举个例子, 如果你的网页处于<code>a.niko</code>域名下, 若使用ajax访问<code>b.niko</code>下的资源, 就会有跨域的问题. 如果<code>b.niko</code>不允许<code>a.niko</code>的资源请求, 那么这个请求将会失败.</p>
<h1 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h1><p>首先建立nginx实验环境, 来模拟跨域的问题, 编辑nginx的配置, 建立两个server :</p>
<p><code>a.niko</code> 服务器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen 80 ;</div><div class="line">        server_name  a.niko ;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">                proxy_pass http://127.0.0.1:3000;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>b.niko</code> 服务器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen 80 ;</div><div class="line">        server_name b.niko ;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">                proxy_pass http://127.0.0.1:8080;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然<code>/etc/hosts</code>记得加入这两个域名.</p>
<p>接着打开<code>a.niko</code>的页面, 页面中的js会使用ajax请求<code>b.niko</code>的某一资源, 这时浏览器会提示不允许跨域请求, 如下:</p>
<p><img src="/images/cs/protocol/cors-fail-001.png" alt=""></p>
<h1 id="使用CORS解决跨域"><a href="#使用CORS解决跨域" class="headerlink" title="使用CORS解决跨域"></a>使用CORS解决跨域</h1><p>如果要解决这个问题, 只需要在服务器的响应头加一个header: <code>Access-Control-Allow-Origin</code>.</p>
<p>在nginx中是这样设置:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen 80 ;</div><div class="line">        server_name b.niko ;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">                proxy_pass http://127.0.0.1:8080;</div><div class="line">                add_header &apos;Access-Control-Allow-Origin&apos; &apos;http://a.niko&apos;;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中的值填写Origin域名, <code>*</code>号表示所有.</p>
<p>然后刷新页面, 查看跨域请求的结果:</p>
<p><img src="/images/cs/protocol/cors-success-001.png" alt=""></p>
<p>如上, 跨域请求成功, 可以看<code>Origin</code>和<code>Access-Control-Allow-Origin</code> header.</p>
<h1 id="为什么POST前有一个OPTIONS请求"><a href="#为什么POST前有一个OPTIONS请求" class="headerlink" title="为什么POST前有一个OPTIONS请求"></a>为什么POST前有一个OPTIONS请求</h1><p>这次改为POST方法试一下, 使用<code>ajax-POST</code>请求<code>b.niko</code>的资源, 观察请求:</p>
<p><img src="/images/cs/protocol/cors-post-options-001.png" alt=""></p>
<p>你会看到第一个发出去的是<code>OPTIONS</code>方法的请求, 而不是<code>POST</code>.</p>
<p>为什么呢?</p>
<p>这个<code>OPTIONS</code>请求其实叫做是<code>CORS preflight request</code>， 作用是在真正的请求发往服务器前， 向服务器确认是否有权限去做这个请求。</p>
<p>根据CORS的规范， <code>Content-Type</code>非<code>application/x-www-form-urlencoded, multipart/form-data, or text/plain</code> 的POST请求会进行<code>preflight</code>.</p>
<p>下面的链接会有更详细的介绍哪些请求会进行preflight:<br><a href="http://www.html5rocks.com/en/tutorials/cors/" target="_blank" rel="external">Types of CORS requests</a></p>
<p>如果需要对这个<code>OPTIONS</code>请求进行特殊处理, nginx设置如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">location / &#123;</div><div class="line">     if ($request_method = &apos;OPTIONS&apos;) &#123;</div><div class="line">        add_header &apos;Access-Control-Allow-Origin&apos; &apos;*&apos;;</div><div class="line">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET, POST, OPTIONS&apos;;</div><div class="line">        #</div><div class="line">        # Custom headers and headers various browsers *should* be OK with but aren&apos;t</div><div class="line">        #</div><div class="line">        add_header &apos;Access-Control-Allow-Headers&apos; &apos;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&apos;;</div><div class="line">        #</div><div class="line">        # Tell client that this pre-flight info is valid for 20 days</div><div class="line">        #</div><div class="line">        add_header &apos;Access-Control-Max-Age&apos; 1728000;</div><div class="line">        add_header &apos;Content-Type&apos; &apos;text/plain charset=UTF-8&apos;;</div><div class="line">        add_header &apos;Content-Length&apos; 0;</div><div class="line">        return 200;</div><div class="line">     &#125;</div><div class="line">     ...</div><div class="line">     ...</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>如上， response的header除了<code>Access-Control-Allow-Origin</code>, 还有其他跨域相关的header（<code>Access-Control-Allow-Origin</code> / <code>Access-Control-Allow-Methods</code> / <code>Access-Control-Allow-Headers</code>等等）, 用以告诉客户端请求跨域访问时的条件和规则, 相关说明可查阅<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">CORS规范文档</a>。</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>我们都知道， 上面的场景是属于能够控制跨域服务器的情况， 因此可以通过CORS解决跨域问题。<br>否则， 只能通过JSONP和代理等其他方式来实现, 有兴趣的童鞋可以了解一下, 这里不再赘述.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS</a><br><a href="http://www.html5rocks.com/en/tutorials/cors/" target="_blank" rel="external">http://www.html5rocks.com/en/tutorials/cors/</a><br><a href="http://www.itnose.net/detail/6501161.html" target="_blank" rel="external">http://www.itnose.net/detail/6501161.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[卸载删除已安装的 `.deb` 包]]></title>
      <url>http://www.nikoai.pw/2016/07/01/linux/manage/remove-deb/</url>
      <content type="html"><![CDATA[<p>下面以删除<code>xmind</code>deb包为例, 简述移除过程:</p>
<h1 id="查询你要删除的包信息"><a href="#查询你要删除的包信息" class="headerlink" title="查询你要删除的包信息:"></a>查询你要删除的包信息:</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ dpkg -l | grep xmind</div><div class="line">ii  xmind                                                 3.6.51                                              amd64        Professional &amp; Powerful Mind Mapping Software</div></pre></td></tr></table></figure>
<p><code>ii</code> 表示<code>installed ok installed</code>.</p>
<h1 id="r-移除"><a href="#r-移除" class="headerlink" title="-r 移除"></a><code>-r</code> 移除</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ dpkg -r xmind</div><div class="line">dpkg: error: requested operation requires superuser privilege</div><div class="line">niko@ubuntu14:/usr/lib/xmind$ sudo dpkg -r xmind</div><div class="line">(Reading database ... 178948 files and directories currently installed.)</div><div class="line">Removing xmind (3.6.51) ...</div><div class="line">Processing triggers for shared-mime-info (1.2-0ubuntu3) ...</div><div class="line">Processing triggers for man-db (2.6.7.1-1) ...</div><div class="line">Processing triggers for fontconfig (2.11.0-0ubuntu4) ...</div><div class="line">Processing triggers for gnome-menus (3.10.1-0ubuntu2) ...</div><div class="line">Processing triggers for desktop-file-utils (0.22-1ubuntu1) ...</div><div class="line">Processing triggers for bamfdaemon (0.5.1+14.04.20140409-0ubuntu1) ...</div><div class="line">Rebuilding /usr/share/applications/bamf-2.index...</div><div class="line">Processing triggers for mime-support (3.54ubuntu1) ...</div></pre></td></tr></table></figure>
<p>再次查询</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ dpkg -l | grep xmind</div><div class="line">rc  xmind                                                 3.6.51                                              amd64        Professional &amp; Powerful Mind Mapping Software</div></pre></td></tr></table></figure>
<p>为什么删除了仍然可以查询到呢?</p>
<p>我们留意到<code>ii</code>已经变成了<code>rc</code>, 表示<code>removed ok config-files</code>,<br>即<code>-r</code>没有移除配置文件, 已安装的包状态是存在<code>/var/lib/dpkg/status</code>中.</p>
<p>比如, 可以查看一下<code>xmind</code>的信息:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Package: xmind</div><div class="line">Status: deinstall ok config-files</div><div class="line">Priority: optional</div><div class="line">Section: non-free/editors</div><div class="line">Installed-Size: 148888</div><div class="line">Maintainer: XMind Ltd. &lt;dev@xmind.net&gt;</div><div class="line">Architecture: amd64</div><div class="line">Version: 3.6.51</div><div class="line">Config-Version: 3.6.51</div><div class="line">Depends: default-jre (&gt;= 2:1.7-0) | java7-runtime | java8-runtime, libgtk2.0-0 (&gt;= 2.8.0), libwebkitgtk-1.0-0, lame, libc6 (&gt;= 2.7), libglib2.0-0 (&gt;= 2.12.0)</div><div class="line">Conffiles:</div><div class="line"> /etc/XMind.ini 3553ecb1eb8875b4be37733ce8f29839</div><div class="line">Description: Professional &amp; Powerful Mind Mapping Software</div><div class="line"> XMind, is an open source brainstorming and mind mapping software tool</div><div class="line"> developed by XMind Ltd. It helps people to capture ideas, organize to</div><div class="line"> various charts, and share them for collaboration. Supporting mind maps,</div><div class="line"> fishbone diagrams, tree diagrams, org-charts, logic charts, and even</div><div class="line"> matrix. Often used for knowledge management, meeting minutes, task</div><div class="line"> management, and GTD. XMind is compatible with Freemind/Mindmanager.</div><div class="line"> XMind is dual licensed under 2 open source licenses: the Eclipse Public</div><div class="line"> License v1.0 (EPL) and the GNU Lesser General Public License v3 (LGPL).</div><div class="line"> XMind Plus/Pro is released under the terms of the XMIND PROPRIETARY LICENSE</div><div class="line"> AGREEMENT, which is available at http://www.xmind.net/license/xpla/ .</div></pre></td></tr></table></figure>
<p>状态是<code>Status: deinstall ok config-files</code>.</p>
<h1 id="P-purge"><a href="#P-purge" class="headerlink" title="-P purge"></a><code>-P</code> purge</h1><p>如果要完全移除<code>xmind</code>程序和配置, 可使用<code>-P</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo dpkg -P xmind</div><div class="line">[sudo] password for niko:</div><div class="line">(Reading database ... 175311 files and directories currently installed.)</div><div class="line">Removing xmind (3.6.51) ...</div><div class="line">Purging configuration files for xmind (3.6.51) ...</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[稳定匹配问题 (2) - 匈牙利算法]]></title>
      <url>http://www.nikoai.pw/2016/06/03/cs/algo/hungary-algo/</url>
      <content type="html"><![CDATA[<p>上一篇博客 <a href="/2016/06/02/cs/algo/Gale-Shapley_Stability/">稳定匹配问题 - Gale &amp; Shapley</a> 我们介绍了稳定匹配的问题和<code>Gale-Shapley</code>算法, 这次我们尝试用二分图和匈牙利算法来解决问题.</p>
<h1 id="二分图相关概念"><a href="#二分图相关概念" class="headerlink" title="二分图相关概念"></a>二分图相关概念</h1><hr>
<p>首先了解一下二分图的相关概念, 假设有一个图G(V, E), V为顶点集合, 分为X和Y, 分别代表男人和女人, E为边集合, 边的两端分别在X和Y集合中.<br>我们规定G的子图Gs的边集合任意两条都不是同一顶点, 则Gs是一个匹配. 如图所示:</p>
<p><img src="/images/cs/algo/bin-graph-01.png" alt=""></p>
<p>如果加上黑色边表示男女互相喜欢, 如下:</p>
<p><img src="/images/cs/algo/bin-graph-02.png" alt=""></p>
<p>绿色边表示配对的结果, 称为匹配边, 其他称为非匹配边.<br>当匹配边最多时, 则称为该图的最大匹配.<br>接着介绍匈牙利算法.</p>
<h1 id="匈牙利算法"><a href="#匈牙利算法" class="headerlink" title="匈牙利算法"></a>匈牙利算法</h1><hr>
<p>接着是了解匈牙利算法, 在此之前, 我们先要知道几个概念:</p>
<p><code>增广路</code>（augmenting path）:<br>从一个未匹配的点出发, 通过<code>交替路</code>(依次经过非匹配边、匹配边、非匹配边…依次交替的路径), 若途径其他未匹配点, 那么称为该交替路为增广路.<br>增广路有一个重要特点：非匹配边比匹配边多一条。所以取反(把增广路中的匹配边和非匹配边的身份交换)之后, 匹配边就比非匹配边多一条, 如此不断寻找增广路, 知道找不到增广路径时, 算法就结束了, 得到的就是最大匹配. 匈牙利算法就是这么做的.</p>
<h1 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h1><hr>
<p>实现主要用到两个类: <code>MatchRecord</code>和<code>HungaryAlgorithm</code>.</p>
<p><code>MatchRecord</code> 作为匹配过程的辅助记录, 比如边和点的关系/增广路等等, 如注释:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MatchRecord</span> </span>&#123;</div><div class="line">    <span class="comment">// 男生/女生的人数</span></div><div class="line">    <span class="keyword">int</span> count;</div><div class="line">    <span class="comment">// 表示边 (用x和y坐标定位), 数值1表示两点存在边连接</span></div><div class="line">    <span class="keyword">int</span> edge[][];</div><div class="line">    <span class="comment">// 是否在当前增广路</span></div><div class="line">    <span class="keyword">boolean</span> onPath[];</div><div class="line">    <span class="comment">// 已找到的增广路</span></div><div class="line">    <span class="keyword">int</span> augmentPath[];</div><div class="line">    <span class="comment">// 最大匹配的结果数</span></div><div class="line">    <span class="keyword">int</span> maxMatch = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MatchRecord</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.count = count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnPath</span><span class="params">(<span class="keyword">boolean</span>[] onPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.onPath = onPath;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEdge</span><span class="params">(<span class="keyword">int</span>[][] edge)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.edge = edge;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] getAugmentPath() &#123;</div><div class="line">        <span class="keyword">return</span> augmentPath;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAugmentPath</span><span class="params">(<span class="keyword">int</span>[] augmentPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.augmentPath = augmentPath;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxMatch</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> maxMatch;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getEdge</span><span class="params">(<span class="keyword">int</span> xi, <span class="keyword">int</span> yi)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.edge[xi][yi];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">notOnPath</span><span class="params">(<span class="keyword">int</span> yi)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ! onPath[yi];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnPath</span><span class="params">(<span class="keyword">int</span> yi, <span class="keyword">boolean</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.onPath[yi] = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAugmentPath</span><span class="params">(<span class="keyword">int</span> yi)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.augmentPath[yi];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAugmentPath</span><span class="params">(<span class="keyword">int</span> yi, <span class="keyword">int</span> xi)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.augmentPath[yi] = xi;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span>[] aug = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="keyword">this</span>.getCount()];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; aug.length; idx++) &#123;</div><div class="line">            aug[idx] = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.setOnPath(<span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="keyword">this</span>.getCount()]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maxMatchInc</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.maxMatch++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>HungaryAlgorithm</code>, 主要是执行匹配过程, 通过深度搜索来查找匹配:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungaryAlgorithm</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        MatchRecord rec = init();</div><div class="line">        <span class="keyword">int</span> count = rec.getCount();</div><div class="line">        HungaryAlgorithm hungary = <span class="keyword">new</span> HungaryAlgorithm();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xi = <span class="number">0</span>; xi &lt; count; xi++) &#123;</div><div class="line">            <span class="keyword">if</span> (hungary.findAugmentPath(rec, xi)) &#123;</div><div class="line">                rec.maxMatchInc();</div><div class="line">            &#125;</div><div class="line">            rec.reset();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> found = rec.getMaxMatch() == count;</div><div class="line">        <span class="keyword">if</span> (found) &#123;</div><div class="line">            print(rec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// TODO 设置测试数据</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MatchRecord <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">3</span>;</div><div class="line">        <span class="keyword">int</span>[][] edge = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;</div><div class="line">                &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</div><div class="line">                &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</div><div class="line">                &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>&#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">int</span>[] augment = <span class="keyword">new</span> <span class="keyword">int</span>[count];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; augment.length; idx++) &#123;</div><div class="line">            augment[idx] = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//</span></div><div class="line">        MatchRecord rec = <span class="keyword">new</span> MatchRecord(count);</div><div class="line">        rec.setEdge(edge);</div><div class="line">        rec.setOnPath(<span class="keyword">new</span> <span class="keyword">boolean</span>[count]);</div><div class="line">        rec.setAugmentPath(augment);</div><div class="line">        <span class="keyword">return</span> rec;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">findAugmentPath</span><span class="params">(MatchRecord matchRecord, <span class="keyword">int</span> xi)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> yi = <span class="number">0</span>; yi &lt; matchRecord.getCount(); yi++) &#123;</div><div class="line">            <span class="keyword">if</span> (matchRecord.getEdge(xi, yi) == <span class="number">1</span> &amp;&amp; matchRecord.notOnPath(yi)) &#123;</div><div class="line">                matchRecord.setOnPath(yi, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">if</span> (matchRecord.getAugmentPath(yi) == -<span class="number">1</span></div><div class="line">                        || findAugmentPath(matchRecord, matchRecord.getAugmentPath(yi))) &#123;</div><div class="line">                    matchRecord.setAugmentPath(yi, xi);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(MatchRecord rec)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span>[] aug = rec.getAugmentPath();</div><div class="line">        System.out.println(<span class="string">"匹配结果: "</span>);</div><div class="line">        System.out.println(<span class="string">"y  --  x"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> yi : aug) &#123;</div><div class="line">            System.out.println(<span class="string">""</span> + yi + <span class="string">" &lt;--&gt; "</span> + aug[yi]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终输出结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">匹配结果:</div><div class="line">y  --  x</div><div class="line">0 &lt;--&gt; 0</div><div class="line">2 &lt;--&gt; 1</div><div class="line">1 &lt;--&gt; 2</div></pre></td></tr></table></figure>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>以上就是匈牙利算法, 不过上面我们解决的仍是无权匹配的问题, 下篇博客我们将讨论有权匹配的问题和相关算法.</p>
<div style="display: none;"><br>最大匹配数：最大匹配的匹配边的数目<br>最小点覆盖数：选取最少的点，使任意一条边至少有一个端点被选择<br>最大独立数：选取最多的点，使任意所选两点均不相连<br>最小路径覆盖数：对于一个 DAG（有向无环图），选取最少条路径，使得每个顶点属于且仅属于一条路径。路径长可以为 0（即单个点）。<br>定理1：最大匹配数 = 最小点覆盖数（这是 Konig 定理）<br>定理2：最大匹配数 = 最大独立数<br>定理3：最小路径覆盖数 = 顶点数 - 最大匹配数<br></div>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://zh.wikipedia.org/wiki/%E5%8C%88%E7%89%99%E5%88%A9%E7%AE%97%E6%B3%95" target="_blank" rel="external">匈牙利算法</a><br><a href="https://zh.wikipedia.org/wiki/%E5%8C%B9%E9%85%8D_(%E5%9B%BE%E8%AE%BA" target="_blank" rel="external">图论(匹配</a>)<br><a href="https://www.renfei.org/blog/bipartite-matching.html" target="_blank" rel="external">https://www.renfei.org/blog/bipartite-matching.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[稳定匹配问题 (1) - Gale & Shapley]]></title>
      <url>http://www.nikoai.pw/2016/06/02/cs/algo/Gale-Shapley_Stability/</url>
      <content type="html"><![CDATA[<h1 id="稳定匹配"><a href="#稳定匹配" class="headerlink" title="稳定匹配"></a>稳定匹配</h1><hr>
<p>在1962年Gale和Shapley发表了一篇论文: <a href="http://cramton.umd.edu/market-design/gale-shapley-college-admissions.pdf" target="_blank" rel="external">College Admissions and the Stability of Marriage</a>，首次提出了<a href="https://zh.wikipedia.org/wiki/%E7%A9%A9%E5%AE%9A%E5%A9%9A%E5%A7%BB%E5%95%8F%E9%A1%8C" target="_blank" rel="external">婚姻匹配问题(维基百科)</a>, 使婚姻和大学招生成为稳定匹配的典型例子.</p>
<h1 id="什么是稳定匹配"><a href="#什么是稳定匹配" class="headerlink" title="什么是稳定匹配"></a>什么是稳定匹配</h1><hr>
<p>以婚姻匹配为例, 假设在当前匹配结果中存在两对(m1, v1)和(m2, v2), 在喜好排名中, m1更喜欢w2, m2也更喜欢w1, 这时我们可以称当前匹配是不稳定的.</p>
<h1 id="如何实现稳定匹配呢"><a href="#如何实现稳定匹配呢" class="headerlink" title="如何实现稳定匹配呢 ?"></a>如何实现稳定匹配呢 ?</h1><hr>
<p>要找到一种稳定匹配, 可使用<code>Gale-Shapley</code>提出的算法( 用反证法证明其有效性 ), 但有个前提是让男生主动求婚, 主要过程如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">function stableMatching &#123;</div><div class="line">    Initialize all m ∈ M and w ∈ W to free</div><div class="line">    while ∃ free man m who still has a woman w to propose to &#123;</div><div class="line">       w = first woman on m’s list to whom m has not yet proposed</div><div class="line">       if w is free</div><div class="line">         (m, w) become engaged</div><div class="line">       else some pair (m&apos;, w) already exists</div><div class="line">         if w prefers m to m&apos;</div><div class="line">            m&apos; becomes free</div><div class="line">           (m, w) become engaged</div><div class="line">         else</div><div class="line">           (m&apos;, w) remain engaged</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h1><hr>
<p><code>Person.java</code>, 用来表示male或female.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer SINGLE = -<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Integer id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> Integer nextAskId = <span class="number">0</span>;</div><div class="line">    <span class="comment">// 当前伴侣id</span></div><div class="line">    <span class="keyword">private</span> Integer currentPartnerId = SINGLE;</div><div class="line">    <span class="comment">// 伴侣id在心中的排名</span></div><div class="line">    <span class="keyword">private</span> Map&lt;Integer, Integer&gt; partnerIdToRank = <span class="keyword">new</span> LinkedHashMap&lt;Integer, Integer&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">addRank</span><span class="params">(Integer personId, Integer rank)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.partnerIdToRank.put(personId, rank);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getRankOf</span><span class="params">(Integer partnerId)</span> </span>&#123;</div><div class="line">        Integer rank = <span class="keyword">this</span>.partnerIdToRank.get(partnerId);</div><div class="line">        <span class="keyword">return</span> rank == <span class="keyword">null</span> ? Integer.MAX_VALUE : rank;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//======================================================================</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getNextPerfectId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> nextAskId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">setNextAskId</span><span class="params">(Integer nextAskId)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.nextAskId = nextAskId;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCurrentPartnerId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> currentPartnerId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">setCurrentPartnerId</span><span class="params">(Integer currentPartnerId)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.currentPartnerId = currentPartnerId;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>GaleShapley.java</code>, 主要是算法过程:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GaleShapley</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        List&lt;Person&gt; males = <span class="keyword">new</span> LinkedList&lt;Person&gt;();</div><div class="line">        males.add(<span class="keyword">new</span> Person().setId(<span class="number">0</span>).setName(<span class="string">"Mr.A"</span>).addRank(<span class="number">1</span>, <span class="number">1</span>).addRank(<span class="number">2</span>, <span class="number">2</span>).addRank(<span class="number">0</span>, <span class="number">3</span>));</div><div class="line">        males.add(<span class="keyword">new</span> Person().setId(<span class="number">1</span>).setName(<span class="string">"Mr.B"</span>).addRank(<span class="number">1</span>, <span class="number">1</span>).addRank(<span class="number">0</span>, <span class="number">2</span>));</div><div class="line">        males.add(<span class="keyword">new</span> Person().setId(<span class="number">2</span>).setName(<span class="string">"Mr.C"</span>).addRank(<span class="number">0</span>, <span class="number">1</span>).addRank(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">        males.add(<span class="keyword">new</span> Person().setId(<span class="number">3</span>).setName(<span class="string">"Mr.D"</span>).addRank(<span class="number">3</span>, <span class="number">1</span>).addRank(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line"></div><div class="line">        List&lt;Person&gt; females = <span class="keyword">new</span> LinkedList&lt;Person&gt;();</div><div class="line">        females.add(<span class="keyword">new</span> Person().setId(<span class="number">0</span>).setName(<span class="string">"Miss.A"</span>).addRank(<span class="number">1</span>, <span class="number">1</span>).addRank(<span class="number">2</span>, <span class="number">2</span>));</div><div class="line">        females.add(<span class="keyword">new</span> Person().setId(<span class="number">1</span>).setName(<span class="string">"Miss.B"</span>).addRank(<span class="number">0</span>, <span class="number">1</span>).addRank(<span class="number">1</span>, <span class="number">2</span>).addRank(<span class="number">2</span>, <span class="number">3</span>));</div><div class="line">        females.add(<span class="keyword">new</span> Person().setId(<span class="number">2</span>).setName(<span class="string">"Miss.C"</span>).addRank(<span class="number">3</span>, <span class="number">1</span>).addRank(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">        females.add(<span class="keyword">new</span> Person().setId(<span class="number">3</span>).setName(<span class="string">"Miss.D"</span>).addRank(<span class="number">1</span>, <span class="number">1</span>).addRank(<span class="number">2</span>, <span class="number">2</span>));</div><div class="line"></div><div class="line">        <span class="keyword">new</span> GaleShapley().stableMatch(males, females);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stableMatch</span><span class="params">(List&lt;Person&gt; males, List&lt;Person&gt; females)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (males == <span class="keyword">null</span> || females == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (males.size() != females.size()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        Person freeMale = getFreeMale(males);</div><div class="line">        <span class="keyword">while</span> (freeMale != <span class="keyword">null</span>) &#123;</div><div class="line">            Integer femaleId = freeMale.getNextPerfectId();</div><div class="line">            Person female = females.get(femaleId);</div><div class="line">            <span class="keyword">if</span> (isSingle(female)) &#123;</div><div class="line">                <span class="comment">// 还是单身</span></div><div class="line">                freeMale.setCurrentPartnerId(female.getId());</div><div class="line">                female.setCurrentPartnerId(freeMale.getId());</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 选择更好的</span></div><div class="line">                Integer curMaleId = female.getCurrentPartnerId();</div><div class="line">                Integer curMalePartnerRank = female.getRankOf(curMaleId);</div><div class="line">                Integer freeMaleRank = female.getRankOf(freeMale.getId());</div><div class="line">                <span class="keyword">if</span> (freeMaleRank &lt; curMalePartnerRank) &#123;</div><div class="line">                    males.get(curMaleId).setCurrentPartnerId(Person.SINGLE);</div><div class="line">                    freeMale.setCurrentPartnerId(female.getId());</div><div class="line">                    female.setCurrentPartnerId(freeMale.getId());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            freeMale.setNextAskId(freeMale.getNextPerfectId() + <span class="number">1</span>);</div><div class="line">            <span class="comment">// 继续为 freeMale 找对象</span></div><div class="line">            freeMale = getFreeMale(males);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        print(males, females);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(List&lt;Person&gt; males, List&lt;Person&gt; females)</span> </span>&#123;</div><div class="line">        males.forEach(m -&gt; &#123;</div><div class="line">            Person female = females.get(m.getCurrentPartnerId());</div><div class="line">            <span class="keyword">if</span> (female != <span class="keyword">null</span>) &#123;</div><div class="line">                System.out.println(m.getName() + <span class="string">"  &lt;--&gt;  "</span> + female.getName());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                System.out.println(m.getName() + <span class="string">"  still  SINGLE"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Person <span class="title">getFreeMale</span><span class="params">(List&lt;Person&gt; males)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Person male : males) &#123;</div><div class="line">            <span class="keyword">if</span> (isSingle(male)) &#123;</div><div class="line">                <span class="keyword">return</span> male;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSingle</span><span class="params">(Person p)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Person.SINGLE.equals(p.getCurrentPartnerId());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行main()中的用例, 得出结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Mr.A  &lt;--&gt;  Miss.B</div><div class="line">Mr.B  &lt;--&gt;  Miss.A</div><div class="line">Mr.C  &lt;--&gt;  Miss.D</div><div class="line">Mr.D  &lt;--&gt;  Miss.C</div></pre></td></tr></table></figure>
<h1 id="有多少稳定匹配结果"><a href="#有多少稳定匹配结果" class="headerlink" title="有多少稳定匹配结果"></a>有多少稳定匹配结果</h1><hr>
<p>上面讨论的前提是男士主动求婚, 而且是先有一个队伍顺序, 如果改变一下这些条件, <code>Gale-Shapley</code>算法可能得到的是另外一种稳定匹配结果.<br>那么, 如何获得所有的稳定匹配结果呢 ?</p>
<h1 id="使用穷举法"><a href="#使用穷举法" class="headerlink" title="使用穷举法"></a>使用穷举法</h1><p>我们需要对每个male进行穷举, 覆盖所有的male求婚顺序, 这样的问题用递归很方便.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">allStableMatch</span><span class="params">(Integer maleId, List&lt;Person&gt; males, List&lt;Person&gt; females)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (maleId.intValue()  == males.size()) &#123;</div><div class="line">        <span class="keyword">if</span> (isStableMatch(males, females)) &#123;</div><div class="line">            print(males, females);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    Person male = males.get(maleId);</div><div class="line">    <span class="comment">// 试所有女的favor舞伴</span></div><div class="line">    male.getPartnerIdToRank().entrySet().forEach((favor) -&gt; &#123;</div><div class="line">        Person female = females.get(favor.getKey());</div><div class="line">        <span class="keyword">if</span> (isSingle(female) &amp;&amp; female.like(maleId)) &#123;</div><div class="line">            male.setCurrentPartnerId(female.getId());</div><div class="line">            female.setCurrentPartnerId(male.getId());</div><div class="line">            allStableMatch(maleId + <span class="number">1</span>, males, females);</div><div class="line">            male.setCurrentPartnerId(Person.SINGLE);</div><div class="line">            female.setCurrentPartnerId(Person.SINGLE);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试用例 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">public static void main(String[] args) &#123;</div><div class="line">    List&lt;Person&gt; males = new LinkedList&lt;Person&gt;();</div><div class="line">    males.add(new Person().setId(0).setName(&quot;Mr.A&quot;).addRank(0).addRank(2).addRank(1));</div><div class="line">    males.add(new Person().setId(1).setName(&quot;Mr.B&quot;).addRank(1).addRank(2).addRank(0));</div><div class="line">    males.add(new Person().setId(2).setName(&quot;Mr.C&quot;).addRank(0).addRank(1).addRank(2));</div><div class="line"></div><div class="line">    List&lt;Person&gt; females = new LinkedList&lt;Person&gt;();</div><div class="line">    females.add(new Person().setId(0).setName(&quot;Miss.A&quot;).addRank(2).addRank(0).addRank(1));</div><div class="line">    females.add(new Person().setId(1).setName(&quot;Miss.B&quot;).addRank(0).addRank(2).addRank(1));</div><div class="line">    females.add(new Person().setId(2).setName(&quot;Miss.C&quot;).addRank(1).addRank(0).addRank(2));</div><div class="line"></div><div class="line">    new GaleShapleyAllCompose().allStableMatch(0, males, females);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终可以找出两个匹配结果, 如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">Mr.A  &lt;--&gt;  Miss.C</div><div class="line">Mr.B  &lt;--&gt;  Miss.B</div><div class="line">Mr.C  &lt;--&gt;  Miss.A</div><div class="line"></div><div class="line"></div><div class="line">Mr.A  &lt;--&gt;  Miss.B</div><div class="line">Mr.B  &lt;--&gt;  Miss.C</div><div class="line">Mr.C  &lt;--&gt;  Miss.A</div></pre></td></tr></table></figure>
<h1 id="二分图和匈牙利算法"><a href="#二分图和匈牙利算法" class="headerlink" title="二分图和匈牙利算法"></a>二分图和匈牙利算法</h1><p>其实这个问题还可以用二部图和匈牙利算法来处理, 详细内容请看下一篇博客.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://cramton.umd.edu/market-design/gale-shapley-college-admissions.pdf" target="_blank" rel="external">College Admissions and the Stability of Marriage</a><br><a href="https://en.wikipedia.org/wiki/Stable_marriage_problem" target="_blank" rel="external">https://en.wikipedia.org/wiki/Stable_marriage_problem</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【设计】elasticsearch - 处理关系型数据]]></title>
      <url>http://www.nikoai.pw/2016/06/02/search/es/es-relations/</url>
      <content type="html"><![CDATA[<p>不同于关系型数据库， 我们使用es， 一般出于性能、弹性、近实时搜索、大数据量的分析等目的。<br>然而， 在构建es数据模型时， 免不了会涉及到关系型数据的问题。关系型的数据在实际应用中广泛存在， 关系型数据库对此比较在行， 比如ACID支持、join查询等。es并不擅长这些，es的使用场景， 不是作为关系型数据库而存在的。</p>
<p>当然， 反过来关系型数据库也有不足的地方，比如比较弱的全文搜索、昂贵的join搜索开销、聚合分析等，这些却是es的专业领域。</p>
<p>es和大部分NoSQL数据库一样， 把数据视为平的, 不能够rollback到index之前的状态。但平的数据模型有他的好处， 比如无锁的快速索引、搜索、大数据量的节点间拓展等， 都非常符合es的使用场景。</p>
<h1 id="处理关系型数据"><a href="#处理关系型数据" class="headerlink" title="处理关系型数据"></a>处理关系型数据</h1><hr>
<p>但是， 并不是说关系型不重要，因为即使是在es中，当然无可避免要管理关系型的数据，一般来说，es 主要通过以下的方式或技巧管理：</p>
<ul>
<li>应用端join</li>
<li>反规范化</li>
<li>嵌套对象</li>
<li>parent/child 关联</li>
</ul>
<p>常见的最终解决方案也来自于这些方法及其混合的使用，接下来分别介绍这些方式：</p>
<h1 id="应用端join"><a href="#应用端join" class="headerlink" title="应用端join"></a>应用端join</h1><hr>
<p>我们可以模拟数据库的join， 把操作移到了客户端进行。</p>
<p>比如有以下数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">PUT /my_index/user/1</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;:     &quot;John Smith&quot;,</div><div class="line">  &quot;email&quot;:    &quot;john@smith.com&quot;,</div><div class="line">  &quot;dob&quot;:      &quot;1970/10/24&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PUT /my_index/blogpost/2</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:    &quot;Relationships&quot;,</div><div class="line">  &quot;body&quot;:     &quot;It&apos;s complicated...&quot;,</div><div class="line">  &quot;user&quot;:     1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果要找用户名为“John”的博客，首先获取user.id：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET /my_index/user/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;name&quot;: &quot;John&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时获取到user.id后，再去查询这个user的blogposts：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET /my_index/blogpost/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;terms&quot;: &#123; &quot;user&quot;: [1] &#125;  </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以发现，这里的数据仍旧是规范化的，只不过要在客户端进行join，因此搜索需要进行额外的请求。<br>而且，上面的例子有个问题，由于现实中叫做“John”的user有很多，所以第二次请求的搜索和结果可能很大。<br>因此这种方法适合于第一个entity比较少的情况，最好修改变动比较少。</p>
<h1 id="反规范化"><a href="#反规范化" class="headerlink" title="反规范化"></a>反规范化</h1><hr>
<p>如果要获得更好的性能，正如es所追求的，可以在索引的时候反模式化你的数据，使用冗余数据来避免join。</p>
<p>接着上面的例子，我们可以把name写入到blogpost的document中：</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line"></div><div class="line">PUT /my_index/blogpost/2</div><div class="line">&#123;</div><div class="line">  "title":    "Relationships",</div><div class="line">  "body":     "It's complicated...",</div><div class="line">  "user":     &#123;</div><div class="line">    "id":       1,</div><div class="line">    "name":     "John Smith"</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时查询就可以用一个请求了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET /my_index/blogpost/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;title&quot;:     &quot;relationships&quot; &#125;&#125;,</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;user.name&quot;: &quot;John&quot;          &#125;&#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种方式最大的好处就是速度，因为避免了昂贵开销的join操作。</p>
<p>当然，这种方式也有缺点，一个是index的size会相对大一点，这是当然的，因为你冗余了数据。这个倒不是大问题，因为写到硬盘的数据都是高速压缩的，而且es的易拓展的。</p>
<p>另一个要关注的问题是，当修改时，冗余数据也需要更新。比如你改了user.name，那么blogpost中的user.name也需要更新。这个业务场景还好，因为一个用户的博客数很少超过几千篇的，使用这些这些批量更新的接口（<a href="https://www.elastic.co/guide/en/elasticsearch/guide/1.x/scan-scroll.html" target="_blank" rel="external">scan-scroll</a>和<a href="https://www.elastic.co/guide/en/elasticsearch/guide/1.x/bulk.html" target="_blank" rel="external">bulk</a>）也不需要一秒。</p>
<h1 id="嵌套对象"><a href="#嵌套对象" class="headerlink" title="嵌套对象"></a>嵌套对象</h1><hr>
<p>因为一个document的创建更改删除都是原子操作，那么把紧密的实体关联写入到同一个document也是有好处的。<br>前面我们提到，blogpost中可以冗余一个<code>user</code>的对象，这个<code>user</code>类型其实属于<code>object</code>（和这一节介绍的不一样），它的实现其实是<code>user.id</code>作为一个key，由key-value对的列表组成document来保存，那如果一个数组作为一个field是怎样索引的呢 ？</p>
<p>假如一个blopost可以有多个comments：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">PUT /my_index/blogpost/1</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;: &quot;Nest eggs&quot;,</div><div class="line">  &quot;body&quot;:  &quot;Making your money work...&quot;,</div><div class="line">  &quot;tags&quot;:  [ &quot;cash&quot;, &quot;shares&quot; ],</div><div class="line">  &quot;comments&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;name&quot;:    &quot;John Smith&quot;,</div><div class="line">      &quot;comment&quot;: &quot;Great article&quot;,</div><div class="line">      &quot;age&quot;:     28,</div><div class="line">      &quot;stars&quot;:   4,</div><div class="line">      &quot;date&quot;:    &quot;2014-09-01&quot;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;name&quot;:    &quot;Alice White&quot;,</div><div class="line">      &quot;comment&quot;: &quot;More like this please&quot;,</div><div class="line">      &quot;age&quot;:     31,</div><div class="line">      &quot;stars&quot;:   5,</div><div class="line">      &quot;date&quot;:    &quot;2014-10-22&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为没有不指定<code>comments</code>的类型， 它将会是<code>object</code>类型，索引里大概是这样的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;title&quot;:            [ eggs, nest ],</div><div class="line">  &quot;body&quot;:             [ making, money, work, your ],</div><div class="line">  &quot;tags&quot;:             [ cash, shares ],</div><div class="line">  &quot;comments.name&quot;:    [ alice, john, smith, white ],</div><div class="line">  &quot;comments.comment&quot;: [ article, great, like, more, please, this ],</div><div class="line">  &quot;comments.age&quot;:     [ 28, 31 ],</div><div class="line">  &quot;comments.stars&quot;:   [ 4, 5 ],</div><div class="line">  &quot;comments.date&quot;:    [ 2014-09-01, 2014-10-22 ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们搜索某个comments.name的值时，就无法查询到对应哪个comments了，比如<code>Alice White</code>和<code>31</code>的关联就丢失了。所以我们需要使用一个叫<code>nested</code>的类型，来代替<code>object</code>作为comments的field type，具体操作可参考——<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/nested-mapping.html" target="_blank" rel="external">Nested Object Mapping</a>。</p>
<p>使用<code>nested</code>类型之后，每一个nestd的对象都会被索引成一个<code>hidden separate document</code>，类似这样：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;comments.name&quot;:    [ john, smith ],</div><div class="line">  &quot;comments.comment&quot;: [ article, great ],</div><div class="line">  &quot;comments.age&quot;:     [ 28 ],</div><div class="line">  &quot;comments.stars&quot;:   [ 4 ],</div><div class="line">  &quot;comments.date&quot;:    [ 2014-09-01 ]</div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  &quot;comments.name&quot;:    [ alice, white ],</div><div class="line">  &quot;comments.comment&quot;: [ like, more, please, this ],</div><div class="line">  &quot;comments.age&quot;:     [ 31 ],</div><div class="line">  &quot;comments.stars&quot;:   [ 5 ],</div><div class="line">  &quot;comments.date&quot;:    [ 2014-10-22 ]</div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:            [ eggs, nest ],</div><div class="line">  &quot;body&quot;:             [ making, money, work, your ],</div><div class="line">  &quot;tags&quot;:             [ cash, shares ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然把nested object分开索引了，fields还保持了他们间的联系，可以进行inner object不能做的comment查询。不仅如此，nested document和root document的join非常快，接近同一个document中的速度。<br>这些额外的nested document是隐藏的，不能够直接访问，修改增加删除都需要重新索引整个document。</p>
<h1 id="parent-child-relationships"><a href="#parent-child-relationships" class="headerlink" title="parent-child relationships"></a>parent-child relationships</h1><hr>
<p>nested objects, 所有实体在同一document中（json 角度看），但使用 parent-child 的 parent 和 children 是分开的 documents.</p>
<p>parent-child 对比 nested objects 的好处：</p>
<ul>
<li>parent document可以被update而无需重新索引children</li>
<li>Child documents 可以被 added, changed, or deleted，而不会影响parent和其他children。</li>
<li>Child documents 可以在搜索结果中被返回</li>
</ul>
<p>由于es维护了一个映射：哪些 parents 关联了哪些 children，也多亏了这个映射，使查询时的 joins 速度是比较快的，但是也有一个限制：parent document 及其 children 必须在同一个shard中。</p>
<p>这个 parent-child 的映射被保存在<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/docvalues.html" target="_blank" rel="external">Doc Values</a>（documents到terms的映射）中, 当fully hot in memory时可以快速地执行，当太大时将写回磁盘。</p>
<p>不过因为 Parent-child 使用了 global ordinals 来加速 joins，不管使用了 in-memory cache 或者 on-disk doc values, 当索引改变时 global ordinals 需要重新构建。shard的parents越多，rebuild所花的时间就越多。刷新后的第一次 parent-child query or aggregation之后，会触发global ordinals构建，这时可能触发一个比较明显的延时，可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/preload-fielddata.html#eager-global-ordinals" target="_blank" rel="external">eager_global_ordinals</a>来优化查询时间，把开销转移到 refresh time。</p>
<p>因此 parent-children 比较适合这种场景，parent 有许多 children， 而不是很多 parents 和很少children。</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><hr>
<p>上面只是介绍了几种处理关系型数据的方式及优缺点，具体还是要结合实际的应用场景，来选择最适合的方式。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/parent-child-performance.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/parent-child-performance.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/relations.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/relations.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/guide/1.x/relations.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/1.x/relations.html</a><br>preload-fielddata - <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/preload-fielddata.html#global-ordinals" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/preload-fielddata.html#global-ordinals</a><br>Doc Values - <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/docvalues.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/docvalues.html</a><br>Inner Objects - <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/complex-core-fields.html#inner-objects" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/complex-core-fields.html#inner-objects</a><br>Complex Core Field Types - <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/complex-core-fields.html#object-arrays" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/complex-core-fields.html#object-arrays</a><br>Nested datatype - <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html</a><br>Doc Values Intro - <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/docvalues-intro.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/docvalues-intro.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用`dropbox`服务]]></title>
      <url>http://www.nikoai.pw/2016/05/20/linux/install/dropbox-install/</url>
      <content type="html"><![CDATA[<p>随着国内的网盘相继关闭, 我常用的快盘也要停止服务了, 只好换dropbox了, 因为平时全流量走代理, 墙的问题倒不是很大, 就是只有2G的免费空间, 不够再买空间, 毕竟免费往往是昂贵的.</p>
<h1 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h1><p>首先在<a href="https://www.dropbox.com/install-linux" target="_blank" rel="external">官网</a>下载ubuntu安装包<code>dropbox_2015.10.28_amd64.deb</code>, 安装完成之后, 需要启动dropbox :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">proxychains dropbox start</div><div class="line">ProxyChains-3.1 (http://proxychains.sf.net)</div><div class="line">Starting Dropbox...</div><div class="line">The Dropbox daemon is not installed!</div><div class="line">Run &quot;dropbox start -i&quot; to install the daemon</div></pre></td></tr></table></figure>
<p>如上, 提示需要安装daemon程序, 继续按着指引做:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dropbox start -i</div></pre></td></tr></table></figure>
<p>如果没有翻墙, 可能遇到这样的错误:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Trouble connecting to Dropbox servers. Maybe your internet connection is down, or you need to set your http_proxy environment variable.</div></pre></td></tr></table></figure>
<p>为了继续下载, 本地搭建一个翻墙的http代理, 并export到环境变量:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">export https_proxy=http://127.0.0.1:8123</div></pre></td></tr></table></figure>
<p>然后重新<code>dropbox start -i</code>:</p>
<p><img src="/images/linux/tools/dropbox/dropbox-downloading.png" alt=""></p>
<h1 id="安装完之后-可以使用dropbox-proxy设置数据同步的代理"><a href="#安装完之后-可以使用dropbox-proxy设置数据同步的代理" class="headerlink" title="安装完之后, 可以使用dropbox proxy设置数据同步的代理:"></a>安装完之后, 可以使用<code>dropbox proxy</code>设置数据同步的代理:</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ dropbox help proxy</div><div class="line"></div><div class="line">dropbox proxy MODE [TYPE] [HOST] [PORT] [USERNAME] [PASSWORD]</div><div class="line"></div><div class="line">Set proxy settings for Dropbox.</div><div class="line"></div><div class="line">MODE - one of &quot;none&quot;, &quot;auto&quot;, &quot;manual&quot;</div><div class="line">TYPE - one of &quot;http&quot;, &quot;socks4&quot;, &quot;socks5&quot; (only valid with &quot;manual&quot; mode)</div><div class="line">HOST - proxy hostname (only valid with &quot;manual&quot; mode)</div><div class="line">PORT - proxy port (only valid with &quot;manual&quot; mode)</div><div class="line">USERNAME - (optional) proxy username (only valid with &quot;manual&quot; mode)</div><div class="line">PASSWORD - (optional) proxy password (only valid with &quot;manual&quot; mode)</div></pre></td></tr></table></figure>
<h1 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h1><p>启动后, 输入账号密码进行登录:</p>
<p><img src="/home/niko/mount/hsb_ssd_1/niko/dev/code/git_repos/HexoBlog/hexo-hello/source/images/linux/tools/dropbox/dropbox-login.png" alt=""></p>
<p>由于dropbox采用和nautilus整合的方式, 只要我们在文件管理器修改了同步文件夹(默认是<code>/home/username/Dropbox</code>)的数据, dropbox会自动同步到云端.</p>
<h1 id="问题-gnome下icon有时候不显示"><a href="#问题-gnome下icon有时候不显示" class="headerlink" title="问题: gnome下icon有时候不显示"></a>问题: gnome下icon有时候不显示</h1><p>最简单粗暴的方式, 重启一下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ dropbox stop</div><div class="line">Dropbox daemon stopped.</div><div class="line">niko@niko-ub1404:~$ dropbox start</div><div class="line">Starting Dropbox...Done!</div></pre></td></tr></table></figure>
<p>至于bug, 可能跟这个<a href="https://github.com/rgcjonas/gnome-shell-extension-appindicator/issues/40" target="_blank" rel="external">issue</a>有关.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://askubuntu.com/questions/201727/how-can-i-make-dropbox-display-an-icon-in-gnome-shell" target="_blank" rel="external">How can I make dropbox display an icon in Gnome Shell?</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[canal quick start]]></title>
      <url>http://www.nikoai.pw/2016/05/12/java/opsrc/canal/canal_quick_start/</url>
      <content type="html"><![CDATA[<p>canal, 是阿里巴巴出品的基于MySQL的数据增量日志解析, 提供数据订阅和消费的工具.<br>原理是实现MySQL的dump协议, 作为一个slave客户端, 向master发送dump请求. master收到请求后会传送相应的数据, 接着 canal 接收并解析binlog. 使用canal可以完成很多重要的业务功能, 比如变更通知/缓存更新/索引同步等等. 事不宜迟, 先体验一下.</p>
<h1 id="下载并安装"><a href="#下载并安装" class="headerlink" title="下载并安装"></a>下载并安装</h1><hr>
<p>mysql, version: 5.7.9, 安装略.<br><a href="https://github.com/alibaba/canal" target="_blank" rel="external">canal, version: v1.0.22</a></p>
<h1 id="mysql-部分的配置"><a href="#mysql-部分的配置" class="headerlink" title="mysql 部分的配置"></a>mysql 部分的配置</h1><hr>
<h2 id="启用-bin-log"><a href="#启用-bin-log" class="headerlink" title="启用 bin log"></a>启用 bin log</h2><p>sudo vim /etc/mysql/my.cnf</p>
<p>在[mysqld]的配置节下， 插入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">log-bin=mysql-bin</div><div class="line">binlog-format=ROW</div><div class="line">server-id=1        #配置mysql replaction需要定义，不能和canal的slaveId重复</div></pre></td></tr></table></figure>
<h2 id="检查是否开启"><a href="#检查是否开启" class="headerlink" title="检查是否开启"></a>检查是否开启</h2><p>show variables like ‘log_%’;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">log_bin	ON</div><div class="line">log_bin_basename	/var/lib/mysql/mysql-bin</div><div class="line">log_bin_index	/var/lib/mysql/mysql-bin.index</div><div class="line">log_bin_trust_function_creators	OFF</div><div class="line">log_bin_use_v1_row_events	OFF</div><div class="line">log_error	/var/log/mysqld.log</div><div class="line">log_output	FILE</div><div class="line">log_queries_not_using_indexes	OFF</div><div class="line">log_slave_updates	OFF</div><div class="line">log_slow_admin_statements	OFF</div><div class="line">log_slow_slave_statements	OFF</div><div class="line">log_throttle_queries_not_using_indexes	0</div><div class="line">log_warnings	1</div></pre></td></tr></table></figure>
<h2 id="查询确认当前binlog模式"><a href="#查询确认当前binlog模式" class="headerlink" title="查询确认当前binlog模式:"></a>查询确认当前binlog模式:</h2><pre><code>SQL查询:
show variables like &apos;binlog_format&apos;;
</code></pre><h1 id="canal-部分的配置"><a href="#canal-部分的配置" class="headerlink" title="canal 部分的配置"></a>canal 部分的配置</h1><hr>
<p>接下来是canal安装配置.</p>
<h2 id="canal-的MySQL权限"><a href="#canal-的MySQL权限" class="headerlink" title="canal 的MySQL权限"></a>canal 的MySQL权限</h2><p>canal的原理是模拟自己为mysql slave，所以这里一定需要作为 mysql slave 的相关权限.</p>
<p>创建canal用户及授权:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">CREATE USER canal IDENTIFIED BY &apos;canal&apos;;</div><div class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &apos;canal&apos;@&apos;%&apos;;</div><div class="line">FLUSH PRIVILEGES;</div><div class="line">-- GRANT ALL PRIVILEGES ON *.* TO &apos;canal&apos;@&apos;%&apos; ;</div></pre></td></tr></table></figure>
<h2 id="构建-amp-配置-canal"><a href="#构建-amp-配置-canal" class="headerlink" title="构建 &amp; 配置 canal"></a>构建 &amp; 配置 canal</h2><pre><code>git clone git@github.com:alibaba/canal.git
cd canal
mvn clean install -Dmaven.test.skip=true -Denv=release
mkdir /tmp/canal
tar zxvf target/canal.deployer-1.0.22-SNAPSHOT.tar.gz -C /tmp/canal
</code></pre><p>编辑<code>instance.properties</code> :</p>
<pre><code>cd /tmp/canal/
vi conf/example/instance.properties
</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">#################################################</div><div class="line">## mysql serverId</div><div class="line">canal.instance.mysql.slaveId = 1234</div><div class="line"></div><div class="line"># position info</div><div class="line">canal.instance.master.address = 127.0.0.1:3306</div><div class="line">canal.instance.master.journal.name =</div><div class="line">canal.instance.master.position =</div><div class="line">canal.instance.master.timestamp =</div><div class="line"></div><div class="line">#canal.instance.standby.address =</div><div class="line">#canal.instance.standby.journal.name =</div><div class="line">#canal.instance.standby.position =</div><div class="line">#canal.instance.standby.timestamp =</div><div class="line"></div><div class="line"># username/password</div><div class="line">canal.instance.dbUsername = canal</div><div class="line">canal.instance.dbPassword = canal</div><div class="line">canal.instance.defaultDatabaseName =</div><div class="line">canal.instance.connectionCharset = UTF-8</div><div class="line"></div><div class="line"># table regex</div><div class="line">canal.instance.filter.regex = .*\\..*</div><div class="line"># table black regex</div><div class="line">canal.instance.filter.black.regex =</div><div class="line"></div><div class="line">#################################################</div></pre></td></tr></table></figure>
<p>怎么来填写这个配置, 首先先要查询master状态 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+-------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+------------------+----------+--------------+------------------+-------------------+</div><div class="line">| mysql-bin.000002 |      154 |              |                  |                   |</div><div class="line">+------------------+----------+--------------+------------------+-------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>如上, 把 <code>mysql-bin.000002</code>填入<code>canal.instance.master.journal.name</code>,<br><code>154</code> 填入<code>canal.instance.master.position</code>, 即是:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">...</div><div class="line">canal.instance.master.journal.name = mysql-bin.000002</div><div class="line">canal.instance.master.position = 154</div><div class="line">....</div></pre></td></tr></table></figure>
<h2 id="启动-canal-server"><a href="#启动-canal-server" class="headerlink" title="启动 canal server"></a>启动 canal server</h2><pre><code>vim conf/canal.properties
</code></pre><p>暂时使用默认配置</p>
<pre><code>sh bin/startup.sh
</code></pre><p>启动日志:<br>tail -f logs/canal/canal.log</p>
<p>具体instance的日志：<br>tail -f logs/example/example.log</p>
<p>sh bin/stop.sh</p>
<h1 id="mysqlbinlog-测试"><a href="#mysqlbinlog-测试" class="headerlink" title="mysqlbinlog 测试"></a>mysqlbinlog 测试</h1><p>使用 <a href="http://dev.mysql.com/doc/refman/5.7/en/mysqlbinlog.html" target="_blank" rel="external">mysqlbinlog</a> 可以查看binlog, 例如:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mysqlbinlog -h127.0.0.1 -P33306 -ucanal -pcanal --read-from-remote-server -v --start-position=296 -d dbroute_01 mysql-bin.000003</div></pre></td></tr></table></figure>
<div style="display: none;"><br>mysqlbinlog -h192.168.7.90 -P3306 -ucanal -pcanal –read-from-remote-server -v –start-position=877194 -d dbroute_01 mysql-bin.000001<br></div>



<h1 id="使用-canal-client-订阅数据"><a href="#使用-canal-client-订阅数据" class="headerlink" title="使用 canal client 订阅数据"></a>使用 canal client 订阅数据</h1><p>canal 客户端的代码程序太长, 这里就不贴了, 在github项目的example包下<a href="https://github.com/alibaba/canal/blob/master/example/src/main/java/com/alibaba/otter/canal/example/SimpleCanalClientTest.java" target="_blank" rel="external">SimpleCanalClientTest.java</a></p>
<p>因为是使用<code>ROW</code>的binlog, 可以观察到变更的行和列, 而且哪些列更新了都可以获取, 日志示例:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">================&gt; binlog[mysql-bin.000001:65595295] , executeTime :  , delay : 1039ms</div><div class="line"> BEGIN ----&gt; Thread id: 131608</div><div class="line">----------------&gt; binlog[mysql-bin.000001:65595441] , name[test,city] , eventType : UPDATE , executeTime :  , delay : 1040ms</div><div class="line">id : 56    type=int(11)</div><div class="line">province_id : 5    type=int(11)</div><div class="line">name : 包头市    type=varchar(50)    update=true</div><div class="line">code : 229    type=varchar(50)</div><div class="line">----------------</div><div class="line"> END ----&gt; transaction id: 269626487</div><div class="line">================&gt; binlog[mysql-bin.000001:65595556] , executeTime :  , delay : 1040ms</div></pre></td></tr></table></figure>
<p>使用上面的example, 可以快速入门 canal API, 实现很多重要的业务功能.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://github.com/alibaba/canal/wiki/QuickStart" target="_blank" rel="external">https://github.com/alibaba/canal/wiki/QuickStart</a><br><a href="http://www.ilanni.com/?p=7816" target="_blank" rel="external">http://www.ilanni.com/?p=7816</a><br><a href="http://m.blog.csdn.net/article/details?id=50824271" target="_blank" rel="external">http://m.blog.csdn.net/article/details?id=50824271</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[为 spring boot 程序创建 service]]></title>
      <url>http://www.nikoai.pw/2016/05/10/linux/tools/app-as-service-upstart/</url>
      <content type="html"><![CDATA[<h1 id="把应用做成一个service"><a href="#把应用做成一个service" class="headerlink" title="把应用做成一个service"></a>把应用做成一个service</h1><p>我们经常会自己用Java或Python等写一些程序，例如我会写一些个人管理的 spring boot 小程序（日记/事务/笔记管理等），但是每次都要手动去启动和关闭，好麻烦。<br>为了方便管理，可以考虑制作成一个service。步骤如下：</p>
<h2 id="创建-upstart-配置文件"><a href="#创建-upstart-配置文件" class="headerlink" title="创建 upstart 配置文件"></a>创建 upstart 配置文件</h2><p>首先用<code>mvn package</code>打包成jar类型的spring-boot程序， 然后 <code>sudo vim /etc/init/hellosb.conf</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">start on filesystem</div><div class="line">exec /usr/bin/java -jar /path_to/program.jar</div></pre></td></tr></table></figure>
<p>多行的话使用<code>script</code>标记：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># myprogram.conf</div><div class="line">start on filesystem</div><div class="line">script</div><div class="line">    /usr/bin/java -jar /path_to/program</div><div class="line">    echo &quot;Another command&quot;</div><div class="line">end script</div></pre></td></tr></table></figure>
<h2 id="service-启动"><a href="#service-启动" class="headerlink" title="service 启动"></a>service 启动</h2><pre><code>sudo ln -s /etc/init/myprogram.conf /etc/init.d/myprogram
</code></pre><p>建立链接后，使用service就可以用自动补全功能了：</p>
<pre><code>sudo service myprogram start
</code></pre><p>上面只是一个简单的启动功能，upstart的配置文件远比这强大，可以做更细节的处理（下图是job的状态变迁图）。</p>
<p><img src="http://www.ibm.com/developerworks/cn/linux/1407_liuming_init2/image003.jpg" alt="job 状态变迁"></p>
<h1 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h1><p>若想要深入了解，可以查看官方文档和学习一下其他程序（nginx等）的upstart脚本：<a href="http://upstart.ubuntu.com/cookbook/" target="_blank" rel="external">Upstart Intro, Cookbook and Best Practises</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://upstart.ubuntu.com/cookbook/" target="_blank" rel="external">http://upstart.ubuntu.com/cookbook/</a><br><a href="http://askubuntu.com/questions/351879/how-to-create-a-service-on-ubuntu-upstart" target="_blank" rel="external">http://askubuntu.com/questions/351879/how-to-create-a-service-on-ubuntu-upstart</a><br><a href="http://upstart.ubuntu.com/getting-started.html" target="_blank" rel="external">http://upstart.ubuntu.com/getting-started.html</a><br><a href="http://askubuntu.com/questions/299371/correct-way-to-install-a-custom-upstart-service" target="_blank" rel="external">http://askubuntu.com/questions/299371/correct-way-to-install-a-custom-upstart-service</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【api】elasticsearch - 部分更新文档]]></title>
      <url>http://www.nikoai.pw/2016/05/08/search/es/es-partial-update/</url>
      <content type="html"><![CDATA[<h1 id="document-的部分更新"><a href="#document-的部分更新" class="headerlink" title="document 的部分更新"></a>document 的部分更新</h1><p>对于solr和elasticsearch， 一般来说我们可能会先获取document， 再更新某个field， 然后reindex这个document。因为document是不可变的， 不能够修改， 只能被替换。</p>
<p>但其实很久之前我觉得， 这个操作对于客户端来说， 如果不考虑version的话， 为何不在服务器完成， 提供一个部分更新的api， 让用户根据场景合理使用api， 比之前的做法可以节省一个请求。</p>
<p>所以说， elasticsearch还是很人性化的， 它提供了这个api， 不过在其内部来说， api实现还是遵循了<code>retrieve-change-reindex</code>的步骤, 操作在shard中完成。</p>
<h1 id="更新的安全问题"><a href="#更新的安全问题" class="headerlink" title="更新的安全问题"></a>更新的安全问题</h1><p>那么如果有多个客户端同时更新， 那么并发安全的问题es如何处理呢？<br>前面提到了， es内部是<code>retrieve-change-reindex</code>的步骤， 在<code>retrieve</code>阶段， es会获取当前的<code>_version</code>， 并在后面的<code>reindex</code>阶段使用。<br>如果其他进程修改了document， <code>_version</code>将会和update request中的不同， 从而更新将会失败。</p>
<p>这个类似乐观锁的策略， 如果需要重试的话， 可以使用<code>retry_on_conflict</code>设置重试次数，比如：</p>
<p><code>.../_update?retry_on_conflict=5</code></p>
<p>不过， 这个重试使用的场景在计数器上用的较多， 因为这个更新的顺序是不那么重要的。</p>
<h1 id="REST-api"><a href="#REST-api" class="headerlink" title="REST api"></a>REST api</h1><p>言归正传， 接下来，介绍以下api的使用吧。</p>
<p>假设有个<code>blog</code>的document， 其中有个field叫做<code>tags</code>， 如果要部分更新这个<code>tags</code>：</p>
<p>最简单的方式是使用<code>doc</code>参数， 和已有document合并， 已有的field会被覆盖， 新的field将会新增到document， REST api 如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">POST /website/blog/1/_update</div><div class="line">&#123;</div><div class="line">   "doc" : &#123;</div><div class="line">      "tags" : [ "testing" ],</div><div class="line">      "views": 0</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果成功， 会收到这样的response：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">   <span class="attr">"_index"</span> :   <span class="string">"website"</span>,</div><div class="line">   <span class="attr">"_id"</span> :      <span class="string">"1"</span>,</div><div class="line">   <span class="attr">"_type"</span> :    <span class="string">"blog"</span>,</div><div class="line">   <span class="attr">"_version"</span> : <span class="number">3</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再获取一次这个文档， 检查一下是否真的只更新了<code>tags</code>这个field：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">   <span class="attr">"_index"</span>:    <span class="string">"website"</span>,</div><div class="line">   <span class="attr">"_type"</span>:     <span class="string">"blog"</span>,</div><div class="line">   <span class="attr">"_id"</span>:       <span class="string">"1"</span>,</div><div class="line">   <span class="attr">"_version"</span>:  <span class="number">3</span>,</div><div class="line">   <span class="attr">"found"</span>:     <span class="literal">true</span>,</div><div class="line">   <span class="attr">"_source"</span>: &#123;</div><div class="line">      <span class="attr">"title"</span>:  <span class="string">"My first blog entry"</span>,</div><div class="line">      <span class="attr">"text"</span>:   <span class="string">"Starting to get the hang of this..."</span>,</div><div class="line">      <span class="attr">"tags"</span>: [ <span class="string">"testing"</span> ],</div><div class="line">      <span class="attr">"views"</span>:  <span class="number">0</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="java-api"><a href="#java-api" class="headerlink" title="java api"></a>java api</h1><p>如果使用 java api 的话：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">UpdateRequest updateRequest = new UpdateRequest(&quot;website&quot;, &quot;blog&quot;, &quot;1&quot;)</div><div class="line">        .doc(XContentFactory.jsonBuilder()</div><div class="line">            .startObject()</div><div class="line">                .field(&quot;tags&quot;, new String[]&#123;&quot;testing&quot;&#125;)</div><div class="line">            .endObject());</div><div class="line">client.update(updateRequest).get();</div></pre></td></tr></table></figure>
<h1 id="spring-data-elasticsearch-api"><a href="#spring-data-elasticsearch-api" class="headerlink" title="spring data elasticsearch api"></a>spring data elasticsearch api</h1><p>如果使用spring-data-elasticsearch的<code>ElasticsearchTemplate</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line">UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest();</div><div class="line">updateRequest</div><div class="line">        .doc(XContentFactory.jsonBuilder()</div><div class="line">                .startObject()</div><div class="line">                .field(field, value)</div><div class="line">                .endObject());</div><div class="line">UpdateQuery updateQuery = <span class="keyword">new</span> UpdateQueryBuilder()</div><div class="line">        <span class="comment">//.withIndexName(indexName).withType(objectType)</span></div><div class="line">        .withClass(clz)</div><div class="line">        .withId(String.valueOf(id))</div><div class="line">        .withUpdateRequest(updateRequest)</div><div class="line">        .build();</div><div class="line">elasticsearchTemplate.update(updateQuery);</div><div class="line">elasticsearchTemplate.refresh(indexName, <span class="keyword">true</span>);</div></pre></td></tr></table></figure>
<p>使用这个api时可能会有这样的疑惑， UpdateQuery中有指定indexName和objectType， 但是<code>@Document</code>的Class中也有声明， 那么使用哪个呢？</p>
<p>我们可以看看<code>elasticsearchTemplate.update(updateQuery)</code>的源码:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">   @Override</div><div class="line">public UpdateResponse update(UpdateQuery query) &#123;</div><div class="line">	return this.prepareUpdate(query).execute().actionGet();</div><div class="line">&#125;</div><div class="line"></div><div class="line">   private UpdateRequestBuilder prepareUpdate(UpdateQuery query) &#123;</div><div class="line">   		String indexName = isNotBlank(query.getIndexName()) ? query.getIndexName() : getPersistentEntityFor(query.getClazz()).getIndexName();</div><div class="line">   		String type = isNotBlank(query.getType()) ? query.getType() : getPersistentEntityFor(query.getClazz()).getIndexType();</div><div class="line">   		Assert.notNull(indexName, &quot;No index defined for Query&quot;);</div><div class="line">   		Assert.notNull(type, &quot;No type define for Query&quot;);</div><div class="line">   		Assert.notNull(query.getId(), &quot;No Id define for Query&quot;);</div><div class="line">   		Assert.notNull(query.getUpdateRequest(), &quot;No IndexRequest define for Query&quot;);</div><div class="line">   		UpdateRequestBuilder updateRequestBuilder = client.prepareUpdate(indexName, type, query.getId());</div><div class="line"></div><div class="line">   		...</div><div class="line">   	&#125;</div></pre></td></tr></table></figure>
<p>由上可知， <code>query.getIndexName()</code>和<code>query.getIndexName()</code>会被优先使用， 如果未指定， 会从document的Class注解中获取。<br>如果为了提高性能, 能写上也好, 不过最好统一管理这两个名称, 方便以后修改变更.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/partial-updates.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/partial-updates.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/1.7/java-update-api-merge-docs.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/java-api/1.7/java-update-api-merge-docs.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[elasticsearch - 运行集群]]></title>
      <url>http://www.nikoai.pw/2016/05/08/search/es/elastic-cluster-get-started/</url>
      <content type="html"><![CDATA[<p>在生产环境中, 为了保证es的可用性, 需要一个failover的方案, es默认就支持集群模式, 下面就来试用一下 es 集群模式.</p>
<h1 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h1><hr>
<p>首先要有三个 es 实例, 放在不同机器上, 假设三台机器分别叫node1/node2/node3, 分别修改各个 node 的 config/elasticsearch.yml, 设置如下:</p>
<p>node1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 集群名称 每个node的应该一致</div><div class="line">cluster.name: niko-elasticsearch</div><div class="line"># node名称</div><div class="line">node.name: niko-node1</div><div class="line">#</div><div class="line">discovery.zen.ping.unicast.hosts: [&quot;10.2.10.209:9300&quot;, &quot;10.2.10.210:9300&quot;, &quot;10.2.10.211:9300&quot;]</div></pre></td></tr></table></figure>
<p>node2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 集群名称 每个node的应该一致</div><div class="line">cluster.name: niko-elasticsearch</div><div class="line"># node名称</div><div class="line">node.name: niko-node2</div><div class="line">#</div><div class="line">discovery.zen.ping.unicast.hosts: [&quot;10.2.10.209:9300&quot;, &quot;10.2.10.210:9300&quot;, &quot;10.2.10.211:9300&quot;]</div></pre></td></tr></table></figure>
<p>node3:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 集群名称 每个node的应该一致</div><div class="line">cluster.name: niko-elasticsearch</div><div class="line"># node名称</div><div class="line">node.name: niko-node3</div><div class="line">#</div><div class="line">discovery.zen.ping.unicast.hosts: [&quot;10.2.10.209:9300&quot;, &quot;10.2.10.210:9300&quot;, &quot;10.2.10.211:9300&quot;]</div></pre></td></tr></table></figure>
<h1 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h1><hr>
<h2 id="启动node1"><a href="#启动node1" class="headerlink" title="启动node1"></a>启动node1</h2><hr>
<figure class="highlight plain"><figcaption><span>bin/elasticsearch</span></figcaption><table><tr><td class="code"><pre><div class="line">[2016-05-08 21:55:12,053][INFO ][node                     ] [niko-node1] version[1.7.5], pid[2632], build[00f95f4/2016-02-02T09:55:30Z]</div><div class="line">[2016-05-08 21:55:12,054][INFO ][node                     ] [niko-node1] initializing ...</div><div class="line">[2016-05-08 21:55:12,164][INFO ][plugins                  ] [niko-node1] loaded [], sites []</div><div class="line">[2016-05-08 21:55:12,210][INFO ][env                      ] [niko-node1] using [1] data paths, mounts [[/ (/dev/sda1)]], net usable_space [86.8gb], net total_space [96.3gb], types [ext4]</div><div class="line">[2016-05-08 21:55:16,339][INFO ][node                     ] [niko-node1] initialized</div><div class="line">[2016-05-08 21:55:16,339][INFO ][node                     ] [niko-node1] starting ...</div><div class="line">[2016-05-08 21:55:16,567][INFO ][transport                ] [niko-node1] bound_address &#123;inet[/0:0:0:0:0:0:0:0:9300]&#125;, publish_address &#123;inet[/10.2.10.209:9300]&#125;</div><div class="line">[2016-05-08 21:55:16,644][INFO ][discovery                ] [niko-node1] niko-elasticsearch/iZzjAHGURxW3orWute-PtQ</div><div class="line">[2016-05-08 21:55:20,463][INFO ][cluster.service          ] [niko-node1] new_master [niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]], reason: zen-disco-join (elected_as_master)</div><div class="line">[2016-05-08 21:55:20,506][INFO ][http                     ] [niko-node1] bound_address &#123;inet[/0:0:0:0:0:0:0:0:9200]&#125;, publish_address &#123;inet[/10.2.10.209:9200]&#125;</div><div class="line">[2016-05-08 21:55:20,506][INFO ][node                     ] [niko-node1] started</div><div class="line">[2016-05-08 21:55:20,516][INFO ][gateway                  ] [niko-node1] recovered [0] indices into cluster_state</div></pre></td></tr></table></figure>
<h2 id="启动node2"><a href="#启动node2" class="headerlink" title="启动node2"></a>启动node2</h2><hr>
<p>log of node2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ bin/elasticsearch</div><div class="line">[2016-05-08 21:55:32,314][INFO ][node                     ] [niko-node2] version[1.7.5], pid[2409], build[00f95f4/2016-02-02T09:55:30Z]</div><div class="line">[2016-05-08 21:55:32,320][INFO ][node                     ] [niko-node2] initializing ...</div><div class="line">[2016-05-08 21:55:32,486][INFO ][plugins                  ] [niko-node2] loaded [], sites []</div><div class="line">[2016-05-08 21:55:32,542][INFO ][env                      ] [niko-node2] using [1] data paths, mounts [[/ (/dev/sda1)]], net usable_space [86.8gb], net total_space [96.3gb], types [ext4]</div><div class="line">[2016-05-08 21:55:36,886][INFO ][node                     ] [niko-node2] initialized</div><div class="line">[2016-05-08 21:55:36,887][INFO ][node                     ] [niko-node2] starting ...</div><div class="line">[2016-05-08 21:55:37,119][INFO ][transport                ] [niko-node2] bound_address &#123;inet[/0:0:0:0:0:0:0:0:9300]&#125;, publish_address &#123;inet[/10.2.10.210:9300]&#125;</div><div class="line">[2016-05-08 21:55:37,141][INFO ][discovery                ] [niko-node2] niko-elasticsearch/7Fc97mnTTZGEWiLZgm4WmA</div><div class="line">[2016-05-08 21:55:40,239][INFO ][cluster.service          ] [niko-node2] detected_master [niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]], added &#123;[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]],&#125;, reason: zen-disco-receive(from master [[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]]])</div><div class="line">[2016-05-08 21:55:40,290][INFO ][http                     ] [niko-node2] bound_address &#123;inet[/0:0:0:0:0:0:0:0:9200]&#125;, publish_address &#123;inet[/10.2.10.210:9200]&#125;</div><div class="line">[2016-05-08 21:55:40,293][INFO ][node                     ] [niko-node2] started</div></pre></td></tr></table></figure>
<p>log of node1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[2016-05-08 21:55:40,144][INFO ][cluster.service          ] [niko-node1] added &#123;[niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]],&#125;, reason: zen-disco-receive(join from node[[niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]]])</div></pre></td></tr></table></figure>
<h2 id="启动node3"><a href="#启动node3" class="headerlink" title="启动node3:"></a>启动node3:</h2><hr>
<p>log of node3:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ bin/elasticsearch</div><div class="line">[2016-05-08 21:57:31,672][INFO ][node                     ] [niko-node3] version[1.7.5], pid[2431], build[00f95f4/2016-02-02T09:55:30Z]</div><div class="line">[2016-05-08 21:57:31,676][INFO ][node                     ] [niko-node3] initializing ...</div><div class="line">[2016-05-08 21:57:31,857][INFO ][plugins                  ] [niko-node3] loaded [], sites []</div><div class="line">[2016-05-08 21:57:31,912][INFO ][env                      ] [niko-node3] using [1] data paths, mounts [[/ (/dev/sda1)]], net usable_space [86.8gb], net total_space [96.3gb], types [ext4]</div><div class="line">[2016-05-08 21:57:36,632][INFO ][node                     ] [niko-node3] initialized</div><div class="line">[2016-05-08 21:57:36,633][INFO ][node                     ] [niko-node3] starting ...</div><div class="line">[2016-05-08 21:57:36,843][INFO ][transport                ] [niko-node3] bound_address &#123;inet[/0:0:0:0:0:0:0:0:9300]&#125;, publish_address &#123;inet[/10.2.10.211:9300]&#125;</div><div class="line">[2016-05-08 21:57:36,913][INFO ][discovery                ] [niko-node3] niko-elasticsearch/UzK8fUZJRs-mrOWKJnxHBQ</div><div class="line">[2016-05-08 21:57:40,062][INFO ][cluster.service          ] [niko-node3] detected_master [niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]], added &#123;[niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]],[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]],&#125;, reason: zen-disco-receive(from master [[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]]])</div><div class="line">[2016-05-08 21:57:40,109][INFO ][http                     ] [niko-node3] bound_address &#123;inet[/0:0:0:0:0:0:0:0:9200]&#125;, publish_address &#123;inet[/10.2.10.211:9200]&#125;</div><div class="line">[2016-05-08 21:57:40,110][INFO ][node                     ] [niko-node3] started</div></pre></td></tr></table></figure>
<p>log of node1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[2016-05-08 21:57:40,004][INFO ][cluster.service          ] [niko-node1] added &#123;[niko-node3][UzK8fUZJRs-mrOWKJnxHBQ][ubuntu][inet[/10.2.10.211:9300]],&#125;, reason: zen-disco-receive(join from node[[niko-node3][UzK8fUZJRs-mrOWKJnxHBQ][ubuntu][inet[/10.2.10.211:9300]]])</div></pre></td></tr></table></figure>
<p>log of node2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[2016-05-08 21:57:40,081][INFO ][cluster.service          ] [niko-node2] added &#123;[niko-node3][UzK8fUZJRs-mrOWKJnxHBQ][ubuntu][inet[/10.2.10.211:9300]],&#125;, reason: zen-disco-receive(from master [[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]]])</div></pre></td></tr></table></figure>
<h1 id="查看集群"><a href="#查看集群" class="headerlink" title="查看集群"></a>查看集群</h1><hr>
<p><code>curl http://10.2.10.209:9200/_nodes/process?pretty</code> :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;cluster_name&quot; : &quot;niko-elasticsearch&quot;,</div><div class="line">  &quot;nodes&quot; : &#123;</div><div class="line">    &quot;iZzjAHGURxW3orWute-PtQ&quot; : &#123;</div><div class="line">      &quot;name&quot; : &quot;niko-node1&quot;,</div><div class="line">      &quot;transport_address&quot; : &quot;inet[/10.2.10.209:9300]&quot;,</div><div class="line">      &quot;host&quot; : &quot;ubuntu&quot;,</div><div class="line">      &quot;ip&quot; : &quot;127.0.1.1&quot;,</div><div class="line">      &quot;version&quot; : &quot;1.7.5&quot;,</div><div class="line">      &quot;build&quot; : &quot;00f95f4&quot;,</div><div class="line">      &quot;http_address&quot; : &quot;inet[/10.2.10.209:9200]&quot;,</div><div class="line">      &quot;process&quot; : &#123;</div><div class="line">        &quot;refresh_interval_in_millis&quot; : 1000,</div><div class="line">        &quot;id&quot; : 2632,</div><div class="line">        &quot;max_file_descriptors&quot; : 65536,</div><div class="line">        &quot;mlockall&quot; : false</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;7Fc97mnTTZGEWiLZgm4WmA&quot; : &#123;</div><div class="line">      &quot;name&quot; : &quot;niko-node2&quot;,</div><div class="line">      &quot;transport_address&quot; : &quot;inet[/10.2.10.210:9300]&quot;,</div><div class="line">      &quot;host&quot; : &quot;ubuntu&quot;,</div><div class="line">      &quot;ip&quot; : &quot;127.0.1.1&quot;,</div><div class="line">      &quot;version&quot; : &quot;1.7.5&quot;,</div><div class="line">      &quot;build&quot; : &quot;00f95f4&quot;,</div><div class="line">      &quot;http_address&quot; : &quot;inet[/10.2.10.210:9200]&quot;,</div><div class="line">      &quot;process&quot; : &#123;</div><div class="line">        &quot;refresh_interval_in_millis&quot; : 1000,</div><div class="line">        &quot;id&quot; : 2409,</div><div class="line">        &quot;max_file_descriptors&quot; : 65536,</div><div class="line">        &quot;mlockall&quot; : false</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;UzK8fUZJRs-mrOWKJnxHBQ&quot; : &#123;</div><div class="line">      &quot;name&quot; : &quot;niko-node3&quot;,</div><div class="line">      &quot;transport_address&quot; : &quot;inet[/10.2.10.211:9300]&quot;,</div><div class="line">      &quot;host&quot; : &quot;ubuntu&quot;,</div><div class="line">      &quot;ip&quot; : &quot;127.0.1.1&quot;,</div><div class="line">      &quot;version&quot; : &quot;1.7.5&quot;,</div><div class="line">      &quot;build&quot; : &quot;00f95f4&quot;,</div><div class="line">      &quot;http_address&quot; : &quot;inet[/10.2.10.211:9200]&quot;,</div><div class="line">      &quot;process&quot; : &#123;</div><div class="line">        &quot;refresh_interval_in_millis&quot; : 1000,</div><div class="line">        &quot;id&quot; : 2431,</div><div class="line">        &quot;max_file_descriptors&quot; : 65536,</div><div class="line">        &quot;mlockall&quot; : false</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="宕机测试-node1"><a href="#宕机测试-node1" class="headerlink" title="宕机测试 (node1)"></a>宕机测试 (node1)</h1><hr>
<p>由上可知, 集群的 masetr 是 niko-node1, 现在关闭它, 然后查看其他 node 的变化:</p>
<p>log of node2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[2016-05-08 22:04:55,748][INFO ][discovery.zen            ] [niko-node2] master_left [[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]]], reason [shut_down]</div><div class="line">[2016-05-08 22:04:55,750][WARN ][discovery.zen            ] [niko-node2] master left (reason = shut_down), current nodes: &#123;[niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]],[niko-node3][UzK8fUZJRs-mrOWKJnxHBQ][ubuntu][inet[/10.2.10.211:9300]],&#125;</div><div class="line">[2016-05-08 22:04:55,752][INFO ][cluster.service          ] [niko-node2] removed &#123;[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]],&#125;, reason: zen-disco-master_failed ([niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]])</div><div class="line">[2016-05-08 22:04:58,791][INFO ][cluster.service          ] [niko-node2] new_master [niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]], reason: zen-disco-join (elected_as_master)</div></pre></td></tr></table></figure>
<p>log of node3:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[2016-05-08 22:04:55,721][INFO ][discovery.zen            ] [niko-node3] master_left [[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]]], reason [shut_down]</div><div class="line">[2016-05-08 22:04:55,726][WARN ][discovery.zen            ] [niko-node3] master left (reason = shut_down), current nodes: &#123;[niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]],[niko-node3][UzK8fUZJRs-mrOWKJnxHBQ][ubuntu][inet[/10.2.10.211:9300]],&#125;</div><div class="line">[2016-05-08 22:04:55,727][INFO ][cluster.service          ] [niko-node3] removed &#123;[niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]],&#125;, reason: zen-disco-master_failed ([niko-node1][iZzjAHGURxW3orWute-PtQ][ubuntu][inet[/10.2.10.209:9300]])</div><div class="line">[2016-05-08 22:04:58,789][INFO ][cluster.service          ] [niko-node3] detected_master [niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]], reason: zen-disco-receive(from master [[niko-node2][7Fc97mnTTZGEWiLZgm4WmA][ubuntu][inet[/10.2.10.210:9300]]])</div></pre></td></tr></table></figure>
<p>从上可知, node2 被选举为新的 master.</p>
<h1 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h1><hr>
<p>接着上面, 因为集群中只有两个 node 了, 这时如果这两个 node 之间的连接中断, 那么它们都会认为对方已经 down 了, 然后选举自己为 master, 从而导致有两个 master, 带来了数据不一致的问题.</p>
<p>为了解决这个问题, 需要修改一个设置:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># Set to ensure a node sees N other master eligible nodes to be considered</div><div class="line"># operational within the cluster. This should be set to a quorum/majority of</div><div class="line"># the master-eligible nodes in the cluster.</div><div class="line">#</div><div class="line">#discovery.zen.minimum_master_nodes: 1</div></pre></td></tr></table></figure>
<p>设置为最小需要2个:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">discovery.zen.minimum_master_nodes: 2</div></pre></td></tr></table></figure>
<h1 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h1><hr>
<p>至于集群的工作原理将会在接下来的博客中介绍 ~~ </p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-production-elasticsearch-cluster-on-ubuntu-14-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-production-elasticsearch-cluster-on-ubuntu-14-04</a><br><a href="http://www.wklken.me/posts/2016/06/29/deploy-es.html" target="_blank" rel="external">http://www.wklken.me/posts/2016/06/29/deploy-es.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[elasticsearch - 分片的概念]]></title>
      <url>http://www.nikoai.pw/2016/05/07/search/es/es-shard-%E5%88%86%E7%89%87/</url>
      <content type="html"><![CDATA[<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><hr>
<p>要理解分片是什么, 首先要理解其他的一些相关概念和关系.</p>
<h1 id="Cluster-集群"><a href="#Cluster-集群" class="headerlink" title="Cluster (集群)"></a>Cluster (集群)</h1><p>集群是一个或以上的 node 的集合, 集群有一个唯一的名称作为id (默认是elasticsearch), 一个只有通过集群名称才能加入. 所以, 要避免在不同环境使用相同的集群名称, 否则 node 可能会加入错的集群.</p>
<h1 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h1><p>node 是一个独立的服务器( es 实例 ), 作为集群的一部分, 进行数据保存/参与集群的索引和搜索过程. 和集群一样, 一个 node 有自己的id. 默认是分配了一个 Universally Unique IDentifier (UUID) 作为 name, 你也可以自定义名称. node 可以通过集群名称配置加入特定的集群, 如果在网络中启动一些nodes, 他们可以互相发现, 并自动组成和加入一个集群, 默认名称是elasticsearch.</p>
<h1 id="index"><a href="#index" class="headerlink" title="index"></a>index</h1><p>一个 index 索引是相似属性的文档的集合.</p>
<h1 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h1><p>一个index中, 可以定义一个以上的type. type 是index的一个逻辑目录/分区, 我们可以储存不同的文档类型到同一个 index 并拥有不同的文档类型.</p>
<h1 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h1><p>文档是被索引的单元, 是es世界的实体. 说到底, es的使用场景最后都是关于搜索文档.</p>
<h1 id="Shards-amp-Replicas"><a href="#Shards-amp-Replicas" class="headerlink" title="Shards &amp; Replicas"></a>Shards &amp; Replicas</h1><hr>
<p>一个index可能会存储大量数据, 可能超过一个node的硬件限制. 为了解决这个问题, es 把index分割成多了多个块, 称为 shard (分片). 当你创建一个index时, 可以定义分片的数量.</p>
<p>分片有两个重要作用:</p>
<ul>
<li>允许你水平分割/拓展的你的容量</li>
<li>允许你分发和并行化操作, 跨越多个shard(可能在不同node上), 因此可以提升性能和吞吐量.</li>
</ul>
<p>shard 的分发机制和 document 是如何聚合回搜索请求完全由es管理, 并且是对用户透明的.<br>在分布式环境下, 故障转移机制以防某个 shard 或者 node 下线或者消失. 出于这个目的, es 允许你有一个或多个索引shard 的副本, 也称为 replica shards 或者 replicas.</p>
<p>Replication 有两个很重要的原因:</p>
<ul>
<li>提供高可用以防某个shard/node失效. 因此, replica 是不会分配到和复制源 original/primary shard 相同的node上.</li>
<li>它允许拓展搜索的容量和吞吐量, 因为搜索可以并行的在所有replicas中并行.</li>
</ul>
<p>总之, 每一个index可以被分割到多个shard, 一个index能被冗余多次, 一旦被复制, 每一个index将有主分片和复制分片, 每一个index被创建时, 可以制定shards和replicas, index创建后, 可以随时动态改变复制数, 但不能改变分片数. 集群中的最大节点数 <code>Max number of nodes</code> = <code>Number of shards * (number of replicas +1)</code>, 即主分片数 * (1 + 副本数). 默认的, 每个index 被分配了5个主分片和1个备份, 如果集群有两个node, 那么index将会有5个主分片和另外5个冗余分片, 一共10个分片.</p>
<blockquote>
<p>每个shard都是一个lucene index. 每个lucene index将都有一个最大数目的文档, 根据 <code>LUCENE-5843</code> , 这个限制数是 2,147,483,519 (= Integer.MAX_VALUE - 128) 个文档, 可以通过 <code>_cat/shards api</code> 监控这个数目.</p>
</blockquote>
<h1 id="分片和路由"><a href="#分片和路由" class="headerlink" title="分片和路由"></a>分片和路由</h1><hr>
<p>另一篇博客将介绍路由相关内容.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html</a><br><a href="http://udn.yyuap.com/doc/mastering-elasticsearch/chapter-4/41_README.html" target="_blank" rel="external">http://udn.yyuap.com/doc/mastering-elasticsearch/chapter-4/41_README.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ThreadLocalRandom - 为多线程而生]]></title>
      <url>http://www.nikoai.pw/2016/05/06/java/se/ThreadLocalRandom/</url>
      <content type="html"><![CDATA[<p>今天要说的 <code>ThreadLocalRandom</code> 是Java7引入的随机数生成器, 在此之前我们生成随机数都是使用</p>
<ol>
<li>创建<code>java.util.Random</code>实例</li>
<li>使用Math.random(), 其实内部也是创建了一个<code>java.util.Random</code></li>
</ol>
<p>使用Random没有问题, 其seed使用AtomicLong来存储, 在多线程下也是线程安全的.<br>但是, 如果在多线程下使用Random, 会导致多线程的竞争开销, 也会降低Random的随机性, 于是便有了<code>ThreadLocalRandom</code>.</p>
<h1 id="ThreadLocalRandom"><a href="#ThreadLocalRandom" class="headerlink" title="ThreadLocalRandom"></a><code>ThreadLocalRandom</code></h1><hr>
<p>那么, 对于前面的问题, <code>ThreadLocalRandom</code>对这些做了哪些工作呢 ?</p>
<p>假设使用以下代码获取随机数 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">int randomInt = ThreadLocalRandom.current().nextInt();</div></pre></td></tr></table></figure>
<h2 id="ThreadLocalRandom-current"><a href="#ThreadLocalRandom-current" class="headerlink" title="ThreadLocalRandom.current():"></a><code>ThreadLocalRandom.current()</code>:</h2><hr>
<p>我们来看一下<code>ThreadLocalRandom</code>的内部实现:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public static ThreadLocalRandom current() &#123;</div><div class="line">    if (UNSAFE.getInt(Thread.currentThread(), PROBE) == 0)</div><div class="line">        localInit();</div><div class="line">    return instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static final void localInit() &#123;</div><div class="line">    int p = probeGenerator.addAndGet(PROBE_INCREMENT);</div><div class="line">    int probe = (p == 0) ? 1 : p; // skip 0</div><div class="line">    long seed = mix64(seeder.getAndAdd(SEEDER_INCREMENT));</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    UNSAFE.putLong(t, SEED, seed);</div><div class="line">    UNSAFE.putInt(t, PROBE, probe);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中, <code>SEED</code>和<code>PROBE</code>可以参考下面定义:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Class&lt;?&gt; tk = Thread.class;</div><div class="line">SEED = UNSAFE.objectFieldOffset</div><div class="line">    (tk.getDeclaredField(&quot;threadLocalRandomSeed&quot;));</div><div class="line">PROBE = UNSAFE.objectFieldOffset</div><div class="line">    (tk.getDeclaredField(&quot;threadLocalRandomProbe&quot;));</div><div class="line">SECONDARY = UNSAFE.objectFieldOffset</div><div class="line">    (tk.getDeclaredField(&quot;threadLocalRandomSecondarySeed&quot;));</div></pre></td></tr></table></figure>
<p><code>Thread.java</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@sun.misc.Contended(&quot;tlr&quot;)</div><div class="line">int threadLocalRandomProbe;</div></pre></td></tr></table></figure>
<p><code>UNSAFE.getInt(Thread.currentThread(), PROBE)</code>就是获取<code>Thread</code>对象中offset偏移地址对应的field <code>threadLocalRandomProbe</code>的值, <code>threadLocalRandomProbe</code> 是<code>nonzero if threadLocalRandomSeed initialized</code>.<br>所以, 如果<code>PROBE</code>值为零, 将进行localInit(), 当前Thread对象的threadLocalRandomSeed 和 threadLocalRandomProbe将会被赋值. (<code>@sun.misc.Contended(&quot;tlr&quot;)</code>是为了解决伪共享的问题, 将另起一篇博客介绍)</p>
<h2 id="nextInt"><a href="#nextInt" class="headerlink" title="nextInt()"></a><code>nextInt()</code></h2><hr>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public int nextInt() &#123;</div><div class="line">    return mix32(nextSeed());</div><div class="line">&#125;</div><div class="line"></div><div class="line">final long nextSeed() &#123;</div><div class="line">    Thread t; long r; // read and update per-thread seed</div><div class="line">    UNSAFE.putLong(t = Thread.currentThread(), SEED,</div><div class="line">                   r = UNSAFE.getLong(t, SEED) + GAMMA);</div><div class="line">    return r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>注意:</code><br><code>SEED</code>是field的偏移量<br><code>GAMMA</code>是seed的increment<br>这里会更新当前Thread的SEED, 最终mix32()生成int随机数.</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><hr>
<p>从上可知<code>ThreadLocalRandom</code>的工作方式, 它为每个线程分配了一个SEED(被Thread对象持有), 故而减少了多线程下的竞争开销, 也使随机性更加好.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://www.jdon.com/concurrent/concurrent-random.html" target="_blank" rel="external">http://www.jdon.com/concurrent/concurrent-random.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【书：拖延心理学】（12） 作战武器 - 明确目标和可行性的计划]]></title>
      <url>http://www.nikoai.pw/2016/05/05/books/procrastination/procrastination-12/</url>
      <content type="html"><![CDATA[<h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><p><img src="/images/books/tech-less/procrastination-12-01.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Levenshtein 距离]]></title>
      <url>http://www.nikoai.pw/2016/05/04/cs/algo/Levenshtein_edit_distance/</url>
      <content type="html"><![CDATA[<h1 id="Levenshtein-距离"><a href="#Levenshtein-距离" class="headerlink" title="Levenshtein 距离"></a>Levenshtein 距离</h1><p>什么是<code>Levenshtein</code>距离?<br><code>Levenshtein距离</code>是由俄罗斯科学家弗拉基米尔·莱文斯坦在1965年提出这个概念。</p>
<blockquote>
<p>Levenshtein距离(莱文斯坦距离), 是编辑距离（edit distance）的一种。<br>指两个字串之间，由一个转成另一个所需的最少编辑操作次数。许可的编辑操作包括将一个字符替换成另一个字符，插入一个字符，删除一个字符。</p>
</blockquote>
<p>比如将kitten一字转成sitting, 有三步：</p>
<p>sitten （k→s）<br>sittin （e→i）<br>sitting （→g）</p>
<h1 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h1><ul>
<li>相似度检测</li>
<li>拼写检查</li>
<li>文本搜索 (Lucene/Solr)</li>
<li>NLP</li>
<li>等等</li>
</ul>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><hr>
<p>如果用朴素的递归方法实现, 需要O(3^n)的时间复杂度, 明显我们要进行一些优化, 动态规划是比较常用的方法.</p>
<p>假设字符串target有1~m个字符, 字符串str1有1~n个:</p>
<h2 id="定义最优子问题"><a href="#定义最优子问题" class="headerlink" title="定义最优子问题"></a>定义最优子问题</h2><p>通过插入/删除/替换操作, 把str1转换为target字符串.<br>要想找到最短编辑距离, 即是<code>str1[1~i]</code>转换成<code>target[1~j]</code>所需要的最少编辑次数</p>
<h2 id="确定状态转换方程"><a href="#确定状态转换方程" class="headerlink" title="确定状态转换方程"></a>确定状态转换方程</h2><p>我们将<code>str1[1~i]</code>转换成<code>target[1~j]</code>所需要的最少编辑次数, 定义为状态d[i, j].</p>
<h2 id="确定决策并写出状态转移方程"><a href="#确定决策并写出状态转移方程" class="headerlink" title="确定决策并写出状态转移方程"></a>确定决策并写出状态转移方程</h2><p>当target[j]等于str1[i]<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">d[i, j] = d[i, j] + 0;</div></pre></td></tr></table></figure></p>
<p>当target[j]不等于str1[i]<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">d[i, j] = min(</div><div class="line">    d[i, j-1] + 1,</div><div class="line">    d[i-1, j] + 1,</div><div class="line">    d[i-1, j-1] + 1</div><div class="line">    )</div></pre></td></tr></table></figure></p>
<h2 id="寻找边界条件"><a href="#寻找边界条件" class="headerlink" title="寻找边界条件"></a>寻找边界条件</h2><p>当target是空字符串时, d[i, 0] = str1的长度<br>当str1是空字符串时, d[0, j] = target的长度</p>
<p>经过这几步, 就可以开始写代码实现了. 以下给出的是状态递推DP算法, 除此以外, 仍可以使用带记忆的递归算法.</p>
<h1 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h1><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">getEditDistance</span><span class="params">(<span class="keyword">char</span>[] target, <span class="keyword">char</span>[] str1)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span>[][] distance = <span class="keyword">new</span> <span class="keyword">int</span>[str1.length + <span class="number">1</span>][target.length + <span class="number">1</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= str1.length; i++) &#123;</div><div class="line">        distance[i][<span class="number">0</span>] = i;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= target.length; j++) &#123;</div><div class="line">        distance[<span class="number">0</span>][j] = j;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= target.length; j++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= str1.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (str1[i - <span class="number">1</span>] == target[j - <span class="number">1</span> ]) &#123;</div><div class="line">                distance[i][j] = distance[i - <span class="number">1</span>][j - <span class="number">1</span>];</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">int</span> distanceInsert = distance[i][j - <span class="number">1</span>] + <span class="number">1</span>;</div><div class="line">                <span class="keyword">int</span> distanceDelete = distance[i - <span class="number">1</span>][j] + <span class="number">1</span>;</div><div class="line">                <span class="keyword">int</span> distanceEdit = distance[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span>;</div><div class="line">                distance[i][j] = Math.min(</div><div class="line">                        Math.min(distanceInsert, distanceDelete),</div><div class="line">                        distanceEdit);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> distance[str1.length][target.length];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以<code>snowy</code>和<code>sunny</code>字符串做测试, 计算过程如下:</p>
<p><img src="/images/cs/dp_edit_distance_01.png" alt=""></p>
<p>有三个值的, 分别是<code>insert</code>/<code>delete</code>/<code>edit</code>的计算距离, 最后得出最短编辑距离是<code>3</code>.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://zh.wikipedia.org/wiki/%E8%90%8A%E6%96%87%E6%96%AF%E5%9D%A6%E8%B7%9D%E9%9B%A2" target="_blank" rel="external">莱文斯坦距离</a><br>[算法的乐趣 - C3 动态规划]</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[tmux cheatsheet]]></title>
      <url>http://www.nikoai.pw/2016/05/03/linux/tools/tmux/</url>
      <content type="html"><![CDATA[<p><code>tmux</code>是一个终端的terminal <code>multiplexer</code>, 用来切换多个terminal, 和之前博客提到的<code>terminator</code>比较, 可以发现, tmux更适合在纯文字终端中使用(比如ssh登录远程服务器), 还具有session等强大的功能特性.</p>
<p><img src="/images/linux/tmux_preview-01.png" alt=""></p>
<h1 id="进入-tmux-命令模式"><a href="#进入-tmux-命令模式" class="headerlink" title="进入 tmux 命令模式"></a>进入 tmux 命令模式</h1><hr>
<p>要进行 tmux 的操作, 需要先按下 <code>PREFIX</code> 命令, 默认是 <code>ctrl + b</code>.</p>
<h1 id="tmux-session"><a href="#tmux-session" class="headerlink" title="tmux session"></a><code>tmux</code> session</h1><hr>
<p>使用tmux, 需要打开一个session, 只要这个session没有被关闭, 下次可以重新使用(attach). 比如远程连接断开, 下次再连上服务器时, 原先tmux打开的环境都仍保留着.</p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tmux new -s myname</code></td>
<td>start new session</td>
</tr>
<tr>
<td><code>tmux ls</code></td>
<td>list sessions</td>
</tr>
<tr>
<td><code>tmux a</code></td>
<td>attach</td>
</tr>
<tr>
<td><code>tmux a -t myname</code></td>
<td>attach to named</td>
</tr>
<tr>
<td><code>ctrl + b, d</code></td>
<td><strong>detach</strong></td>
</tr>
<tr>
<td><code>ctrl + b, D</code></td>
<td><strong>detach 其他 client的 tmux 连接</strong></td>
</tr>
<tr>
<td><code>ctrl + b, 输入 $</code></td>
<td>命名当前session</td>
</tr>
</tbody>
</table>
<h2 id="切换session"><a href="#切换session" class="headerlink" title="切换session"></a>切换session</h2><p>如果在tmux中, 想要切换到其他session, 可以这样:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ctrl + b</div><div class="line">s</div><div class="line"># 这时会出现session列表, 使用方向键和Enter进行选择即可</div></pre></td></tr></table></figure>
<h1 id="新建一个session"><a href="#新建一个session" class="headerlink" title="新建一个session"></a>新建一个session</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ctrl + b</div><div class="line">:new</div></pre></td></tr></table></figure>
<h1 id="kill-掉-session"><a href="#kill-掉-session" class="headerlink" title="kill 掉 session"></a>kill 掉 session</h1><p>tmux kill-session -t name</p>
<h1 id="pane"><a href="#pane" class="headerlink" title="pane"></a>pane</h1><hr>
<p>以下命令都需要先按下 PREFIX :</p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>%</td>
<td>垂直分割</td>
</tr>
<tr>
<td>“</td>
<td>水平分割</td>
</tr>
<tr>
<td>o</td>
<td>panes切换:</td>
</tr>
<tr>
<td>按住 PREFIX + o</td>
<td>旋转 layout</td>
</tr>
<tr>
<td>x</td>
<td>关闭当前pane</td>
</tr>
<tr>
<td>q</td>
<td>显示 pane number , 显示的时候可以按下对应的 pane 号码, 从而 focus 到某个 pane</td>
</tr>
<tr>
<td>空格</td>
<td>切换不同的layout</td>
</tr>
<tr>
<td><code>[</code></td>
<td>翻页</td>
</tr>
<tr>
<td>{</td>
<td>移动当前 pane 到左边</td>
</tr>
<tr>
<td>}</td>
<td>移动当前 pane 到右边</td>
</tr>
<tr>
<td>z</td>
<td>toggle pane zoom, 把当前 pane 最大化</td>
</tr>
<tr>
<td>方向键</td>
<td>选择 pane, 有时间限制</td>
</tr>
</tbody>
</table>
<h2 id="选择某个-pane"><a href="#选择某个-pane" class="headerlink" title="选择某个 pane"></a>选择某个 pane</h2><p>未测试:<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ctrl + b</div><div class="line">:bind-key / display-panes \; select-pane -t :.</div></pre></td></tr></table></figure></p>
<h2 id="pane-layout"><a href="#pane-layout" class="headerlink" title="pane layout"></a>pane layout</h2><p><a href="https://unix.stackexchange.com/questions/32986/how-do-i-equally-balance-tmux1-split-panes" target="_blank" rel="external">https://unix.stackexchange.com/questions/32986/how-do-i-equally-balance-tmux1-split-panes</a></p>
<p>等分:<br>select-layout even-vertical<br>select-layout even-horizontal</p>
<h1 id="window"><a href="#window" class="headerlink" title="window"></a>window</h1><hr>
<p>以下命令都需要先按下<code>ctrl + b</code>:</p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>c</td>
<td>新建窗口</td>
</tr>
<tr>
<td>n</td>
<td>切换下一个窗口</td>
</tr>
<tr>
<td>p</td>
<td>切换前一个窗口</td>
</tr>
<tr>
<td>Shift+7</td>
<td>关闭当前窗口</td>
</tr>
<tr>
<td>,</td>
<td>命名窗口</td>
</tr>
<tr>
<td>.</td>
<td>移动窗口 (使用序号)</td>
</tr>
<tr>
<td>:swap-window</td>
<td>交换窗口,  <code>-s 3 -t 1</code>, 或者<code>-t 0</code>使用当前窗口</td>
</tr>
<tr>
<td>w</td>
<td>list window</td>
</tr>
<tr>
<td>&amp;</td>
<td>kill window</td>
</tr>
<tr>
<td>page-up</td>
<td>进入滚动模式, 按<code>esc</code>退出滚动</td>
</tr>
</tbody>
</table>
<h2 id="window-排序"><a href="#window-排序" class="headerlink" title="window 排序"></a>window 排序</h2><p><a href="https://superuser.com/questions/343572/how-do-i-reorder-tmux-windows" target="_blank" rel="external">https://superuser.com/questions/343572/how-do-i-reorder-tmux-windows</a></p>
<p>Pressing Ctrl+Shift+Left (will move the current window to the left. Similarly right. No need to use the modifier (C-b).<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">bind-key -n S-Left swap-window -t -1</div><div class="line">bind-key -n S-Right swap-window -t +1</div></pre></td></tr></table></figure></p>
<p><code>-n</code> 表示不用 PREFIX .</p>
<p>somebody use:</p>
<p>bind-key -n C-H swap-window -t -1</p>
<h2 id="window-移到到其他-session"><a href="#window-移到到其他-session" class="headerlink" title="window 移到到其他 session"></a>window 移到到其他 session</h2><p><a href="https://stackoverflow.com/questions/3094946/move-window-between-tmux-clients" target="_blank" rel="external">https://stackoverflow.com/questions/3094946/move-window-between-tmux-clients</a></p>
<p>So, supposing you have an ‘chat’ session with an ‘irc’ window and want to move it to the ‘other_session’ session you can do (in the tmux prompt):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">move-window -s chat:irc -t other_session</div><div class="line">move-window -s 1 -t other_session</div></pre></td></tr></table></figure>
<h1 id="window-pane间操作"><a href="#window-pane间操作" class="headerlink" title="window/pane间操作"></a>window/pane间操作</h1><hr>
<p>以下命令都需要先按下<code>ctrl + b</code>:</p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>:joinp -s :2</td>
<td>移动窗口2作为当前窗口的一个新pane</td>
</tr>
<tr>
<td>:joinp -t :1</td>
<td>移动当前pane作为窗口1的一个新pane</td>
</tr>
</tbody>
</table>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><hr>
<p>以下命令都需要先按下 PREFIX :</p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>t</td>
<td>显示时间</td>
</tr>
<tr>
<td>?</td>
<td>list shortcut</td>
</tr>
<tr>
<td>:</td>
<td>prompt</td>
</tr>
</tbody>
</table>
<p><a href="https://gist.github.com/spicycode/1229612" target="_blank" rel="external">https://gist.github.com/spicycode/1229612</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://gist.github.com/icyleaf/667ddfc0646b21f5f53379688bf7f669" target="_blank" rel="external">tmux shortcuts &amp; cheatsheet</a><br><a href="https://gist.github.com/andreyvit/2921703" target="_blank" rel="external">https://gist.github.com/andreyvit/2921703</a><br><a href="https://gist.github.com/henrik/1967800" target="_blank" rel="external">https://gist.github.com/henrik/1967800</a><br><a href="https://gist.github.com/MohamedAlaa/2961058" target="_blank" rel="external">https://gist.github.com/MohamedAlaa/2961058</a><br><a href="https://github.com/gpakosz/.tmux/blob/master/.tmux.conf" target="_blank" rel="external">https://github.com/gpakosz/.tmux/blob/master/.tmux.conf</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[deploy spring-boot as war file]]></title>
      <url>http://www.nikoai.pw/2016/05/02/java/spring/spring-boot/spring-boot-deploy-war/</url>
      <content type="html"><![CDATA[<p>spring-boot 非常方便, 用来验证程序非常快速. 但如果基于spring-boot写了一个应用, 怎么部署呢 ?</p>
<p>spring-boot 打包有两种, 一种继续使用jar, 使用内置的web容器; 另一种使用war, 部署到已有的web容器中.</p>
<p>下面介绍war方式部署:</p>
<h1 id="pom-xml-修改"><a href="#pom-xml-修改" class="headerlink" title="pom.xml 修改"></a>pom.xml 修改</h1><hr>
<p>首先把打包类型修改为: <code>&lt;packaging&gt;war&lt;/packaging&gt;</code></p>
<p>接着修改<code>spring-boot-starter-tomcat</code>为<code>provided</code>的scope, 避免打包到war中:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;</div><div class="line">        &lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">    &lt;!-- ... --&gt;</div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
<ul>
<li><strong>注意:</strong></li>
</ul>
<p><code>boot-start</code>版本要高于<code>1.3</code>, 否则使用tomcat启动会出现异常.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.3.1.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h1 id="部署到-Servlet-3-0-规范的容器"><a href="#部署到-Servlet-3-0-规范的容器" class="headerlink" title="部署到 Servlet 3.0 规范的容器"></a>部署到 Servlet 3.0 规范的容器</h1><hr>
<p>如果你的web容器支持<code>Servlet 3.0</code>规范, 可以使用以下的方法:</p>
<p>首先继承<code>SpringBootServletInitializer</code>, 并覆写<code>configure</code>方法, 不需要<code>web.xml</code>.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Configuration</div><div class="line">@EnableAutoConfiguration</div><div class="line">@ComponentScan</div><div class="line">public class Application extends SpringBootServletInitializer &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected SpringApplicationBuilder configure(SpringApplicationBuilder application) &#123;</div><div class="line">        // Customize the application or call application.sources(...) to add sources</div><div class="line">        // Since our example is itself a @Configuration class we actually don&apos;t</div><div class="line">        // need to override this method.</div><div class="line">        return application.sources(SampleControllerAndApp.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="部署到旧的容器-Servlet-2-5"><a href="#部署到旧的容器-Servlet-2-5" class="headerlink" title="部署到旧的容器 (Servlet 2.5)"></a>部署到旧的容器 (Servlet 2.5)</h1><p>如果你的容器不支持servlet 3.0规范怎么办 ? 下面是一个解决方法:</p>
<ul>
<li><p>1<br>增加一个<code>org.springframework.boot:spring-boot-legacy</code>依赖</p>
</li>
<li><p>2<br>创建<code>web.xml</code>, 用以声明<code>context listener</code>, 这个listener是<code>org.springframework.boot.legacy.context.web.SpringBootContextLoaderListener</code>, 是在<code>spring-boot</code>下特别使用的, 其他配置和正常spring应用一样. <code>web.xml</code> 如下:</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;web-app version=&quot;2.5&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;</div><div class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">    xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;&gt;</div><div class="line"></div><div class="line">    &lt;context-param&gt;</div><div class="line">        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</div><div class="line">        &lt;param-value&gt;demo.Application&lt;/param-value&gt;</div><div class="line">    &lt;/context-param&gt;</div><div class="line"></div><div class="line">    &lt;listener&gt;</div><div class="line">        &lt;listener-class&gt;org.springframework.boot.legacy.context.web.SpringBootContextLoaderListener&lt;/listener-class&gt;</div><div class="line">    &lt;/listener&gt;</div><div class="line"></div><div class="line">    &lt;filter&gt;</div><div class="line">        &lt;filter-name&gt;metricFilter&lt;/filter-name&gt;</div><div class="line">        &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;</div><div class="line">    &lt;/filter&gt;</div><div class="line"></div><div class="line">    &lt;filter-mapping&gt;</div><div class="line">        &lt;filter-name&gt;metricFilter&lt;/filter-name&gt;</div><div class="line">        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">    &lt;/filter-mapping&gt;</div><div class="line"></div><div class="line">    &lt;servlet&gt;</div><div class="line">        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;</div><div class="line">        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</div><div class="line">        &lt;init-param&gt;</div><div class="line">            &lt;param-name&gt;contextAttribute&lt;/param-name&gt;</div><div class="line">            &lt;param-value&gt;org.springframework.web.context.WebApplicationContext.ROOT&lt;/param-value&gt;</div><div class="line">        &lt;/init-param&gt;</div><div class="line">        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</div><div class="line">    &lt;/servlet&gt;</div><div class="line"></div><div class="line">    &lt;servlet-mapping&gt;</div><div class="line">        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;</div><div class="line">        &lt;url-pattern&gt;/&lt;/url-pattern&gt;</div><div class="line">    &lt;/servlet-mapping&gt;</div><div class="line"></div><div class="line">&lt;/web-app&gt;</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-create-a-deployable-war-file" target="_blank" rel="external">howto-create-a-deployable-war-file</a><br><a href="http://docs.spring.io/spring-boot/docs/current/maven-plugin/" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/current/maven-plugin/</a><br><a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#build-tool-plugins-maven-packaging" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#build-tool-plugins-maven-packaging</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[我的workspace管理之道]]></title>
      <url>http://www.nikoai.pw/2016/05/01/linux/practice/my_workspace_management/</url>
      <content type="html"><![CDATA[<p>最近我又调整了我的workspace 分类, 我一直觉得这个分类方法效率特别高, 几乎每认识一个新的工程师就安利他用, 今天”斗胆”写篇博客分享一下.</p>
<p>workspace, 是指linux的的工作区, 自从我使用了workspace, 工作效率倍增, 开小差的情况也少了很多.</p>
<p>为什么这么说呢? 因为我的每个workspace都固定放了不同的工具, 而且不超过2个(保证同一个workspace我可以使用<code>alt+tab</code>快速切换), 这样我不用费时费力去找我要的窗口.</p>
<p>这样分好类后再加上无敌科学的快捷键, 持之以恒形成条件反射, 外人看来那操作简直碉堡.</p>
<p>事不宜迟, 赶紧看一下是这个小技巧.</p>
<h1 id="设置快捷键"><a href="#设置快捷键" class="headerlink" title="设置快捷键"></a>设置快捷键</h1><hr>
<p>首先我们需要设置用到的快捷键:</p>
<p>在<code>System Settings</code>的<code>Keyboard</code>中, 可以设置workspace 1-4 的快捷切换键.</p>
<p>我习惯使用<code>ctrl + 1234</code>, 缺点就是每天感觉在打魔兽, 懂行的一定知道为什么选择这个键.</p>
<p>如果想用4个以上的workspace点算啊?</p>
<p>莫担心, 比如我使用的是gnome, 可以这样:</p>
<pre><code>$ dconf read /org/gnome/desktop/wm/keybindings/switch-to-workspace-4
[&apos;&lt;Primary&gt;4&apos;]
</code></pre><p>读出值是: <code>&#39;&lt;Primary&gt;4&#39;</code></p>
<p>同样的, 我们把workspace 5的键值写入相应的workspace:</p>
<pre><code>dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-5 &quot;[&apos;&lt;Primary&gt;5&apos;]&quot;
</code></pre><p>同理, 其他workspace也是这样设置, 为了造福网友, 这里还是贴一下:</p>
<pre><code>dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-5 &quot;[&apos;&lt;Primary&gt;5&apos;]&quot;
dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-6 &quot;[&apos;&lt;Primary&gt;6&apos;]&quot;
dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-7 &quot;[&apos;&lt;Primary&gt;7&apos;]&quot;
dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-8 &quot;[&apos;&lt;Primary&gt;8&apos;]&quot;
dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-9 &quot;[&apos;&lt;Primary&gt;9&apos;]&quot;
dconf write /org/gnome/desktop/wm/keybindings/switch-to-workspace-10 &quot;[&apos;&lt;Primary&gt;0&apos;]&quot;
</code></pre><p>当然还有移动窗口（把当前窗口移动到某个工作区）的快捷键设置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-1  &quot;[&apos;&lt;Alt&gt;1&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-2  &quot;[&apos;&lt;Alt&gt;2&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-3  &quot;[&apos;&lt;Alt&gt;3&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-4  &quot;[&apos;&lt;Alt&gt;4&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-5  &quot;[&apos;&lt;Alt&gt;5&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-6  &quot;[&apos;&lt;Alt&gt;6&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-7  &quot;[&apos;&lt;Alt&gt;7&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-8  &quot;[&apos;&lt;Alt&gt;8&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-9  &quot;[&apos;&lt;Alt&gt;9&apos;]&quot;</div><div class="line">dconf write /org/gnome/desktop/wm/keybindings/move-to-workspace-0  &quot;[&apos;&lt;Alt&gt;0&apos;]&quot;</div></pre></td></tr></table></figure>
<h1 id="工作区分类"><a href="#工作区分类" class="headerlink" title="工作区分类"></a>工作区分类</h1><hr>
<p>接下来是工作区的分类, 主要关注每个工作区放置什么工具. 有了这些分类, 切换工具几乎不用时间思考和寻找了.<br>以下是我常用的分类:</p>
<table>
<thead>
<tr>
<th>workspace</th>
<th>放置的工具</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>terminator 控制台 &amp; file manger</td>
</tr>
<tr>
<td>-</td>
<td>PDF reader</td>
</tr>
<tr>
<td>2</td>
<td>IDE</td>
</tr>
<tr>
<td>3</td>
<td>博客/笔记工具</td>
</tr>
<tr>
<td>-</td>
<td>思维导图工具</td>
</tr>
<tr>
<td>4</td>
<td>chrome (工作用)</td>
</tr>
<tr>
<td>5</td>
<td>虚拟机</td>
</tr>
<tr>
<td>6</td>
<td>空</td>
</tr>
<tr>
<td>7</td>
<td>scrum 任务面板</td>
</tr>
<tr>
<td>-</td>
<td>WPS sheet</td>
</tr>
<tr>
<td>8</td>
<td>原型文档</td>
</tr>
<tr>
<td>9</td>
<td>IDE 2</td>
</tr>
<tr>
<td>0</td>
<td>音乐播放器</td>
</tr>
<tr>
<td>-</td>
<td>chrome 2</td>
</tr>
</tbody>
</table>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><hr>
<p>需要强调的是, 这个分类是根据个人的实际使用需求来定制的, 制订了一个分类后, 在实际使用的时候, 如果有不适或者更好的, 可以随时调整, 或者说不断迭代吧.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://askubuntu.com/questions/332264/13-04-more-than-four-workspace-shortcuts-in-gnome-flashback-no-effects" target="_blank" rel="external">http://askubuntu.com/questions/332264/13-04-more-than-four-workspace-shortcuts-in-gnome-flashback-no-effects</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[用tensorflow训练识别手写数字的CNN模型]]></title>
      <url>http://www.nikoai.pw/2016/04/29/dtai/tensorflow/tensorflow_mnist_expert_create_model/</url>
      <content type="html"><![CDATA[<h1 id="tensorflow"><a href="#tensorflow" class="headerlink" title="tensorflow"></a>tensorflow</h1><p>tensorflow 是google出品的一个基于图计算开源机器学习库, 作为一个谷粉, 怎么可以不玩一下. tensorflow宣称具有高弹性、可移植性、对科研和生产应用友好、自动分化、最大化性能、多语言支持等特性。说那么多， 如果不试试， 怎么知道呢。Talk is cheap, 接下来就以识别手写数字的例子来体验一下tensorflow.</p>
<h1 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h1><p>数据集采用<code>MNIST 手写图片数据集</code>的图片，可以从<a href="http://yann.lecun.com/exdb/mnist/" target="_blank" rel="external">这个网站</a>下载, 或者使用这个<a href="https://github.com/tensorflow/tensorflow/blob/r0.9/tensorflow/examples/tutorials/mnist/input_data.py" target="_blank" rel="external">python脚本</a>来获取数据:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">from tensorflow.examples.tutorials.mnist import input_data</div><div class="line">mnist = input_data.read_data_sets(&quot;MNIST_data/&quot;, one_hot=True)</div></pre></td></tr></table></figure>
<p>这个数据集有三部分, 55000个训练数据+10000个测试数据+5000个验证数据.</p>
<p>每个数据包含了手写图片和对应的label, 每个是28*28像素的, 用数组保存, 可以把这个矩阵转换为一个<code>28x28=784</code>大小的vector.</p>
<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><p>有了数据集, 就可以导入和开始初始化主要参数:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mnist = input_data.read_data_sets(&quot;MNIST_data/&quot;, one_hot=True)</div><div class="line">model_filepath = &quot;model2.ckpt&quot;</div><div class="line">sess = tf.InteractiveSession()</div><div class="line"></div><div class="line">x = tf.placeholder(tf.float32, [None, 784])</div><div class="line">y_ = tf.placeholder(tf.float32, [None, 10])</div><div class="line"></div><div class="line">W = tf.Variable(tf.zeros([784, 10]))</div><div class="line">b = tf.Variable(tf.zeros([10]))</div></pre></td></tr></table></figure>
<p>Variable和placeholder的区别是, Variable需要初始化值, 而placeholder则不需要, 你可以在运行时通过<code>Session.run</code>中的<code>feed_dict</code>来指定值.</p>
<p>上面y的计算描述如下图:</p>
<p><img src="/images/dtai/tensorflow/mnist_beginer_cal-01.png" alt=""></p>
<p>写成矩阵计算就是:</p>
<p><img src="/images/dtai/tensorflow/mnist_beginer_cal-02.png" alt=""></p>
<h1 id="构建多层卷积网络"><a href="#构建多层卷积网络" class="headerlink" title="构建多层卷积网络"></a>构建多层卷积网络</h1><p>要构建CNN(这里假设你已经了解CNN的相关内容), 我们会创建很多权重和偏置参数, 一般我们应该用小噪声的权重去初始化, 为了<code>symmetry breaking</code>和避免<code>0 gradients</code>. 因为我们使用的是<code>ReLu</code>激活函数, 用较小的正值bias来初始化可以有效地避免<code>dead neurons</code>. 这部分会被反复使用到, 因此需要写成一个function.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">def weight_variable(shape):</div><div class="line">    initial = tf.truncated_normal(shape, stddev=0.1)</div><div class="line">    return tf.Variable(initial)</div><div class="line"></div><div class="line">def bias_variable(shape):</div><div class="line">    initial = tf.constant(0.1, shape=shape)</div><div class="line">    return tf.Variable(initial)</div></pre></td></tr></table></figure>
<h1 id="构建第一卷积层"><a href="#构建第一卷积层" class="headerlink" title="构建第一卷积层"></a>构建第一卷积层</h1><p>使用刚才介绍的初始化function,</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">W_conv1 = weight_variable([5, 5, 1, 32])</div><div class="line">b_conv1 = bias_variable([32])</div><div class="line">x_image = tf.reshape(x, [-1, 28, 28, 1])</div></pre></td></tr></table></figure>
<p>上面的<code>[5, 5, 1, 32]</code>，表示weight的形状, 第一和第二参数表示使用<code>5*5</code>的patch，第三个参数表示有一个输入通道（因为是灰度图片），第四个参数表示32个输出通道。同时, 我们有一个相应的偏置向量来对应每个输出通道.</p>
<p>为了使用这一卷积层, 我们需要把图片输入reshape成四维的tensor: <code>[-1,28,28,1]</code>.<br><code>-1</code>表示flat, 第二三维表示图片大小, 第四维表示颜色通道.</p>
<h2 id="卷积和池化-采样"><a href="#卷积和池化-采样" class="headerlink" title="卷积和池化(采样)"></a>卷积和池化(采样)</h2><p>接下来, 设置卷积的步长为1和<code>SAME</code>的padding方式, 池化采用2*2的大小. 这个也是可以复用的, 因此封装成一个function.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">def conv2d(x, W):</div><div class="line">  return tf.nn.conv2d(x, W, strides=[1, 1, 1, 1], padding=&apos;SAME&apos;)</div><div class="line"></div><div class="line">def max_pool_2x2(x):</div><div class="line">  return tf.nn.max_pool(x, ksize=[1, 2, 2, 1],</div><div class="line">                        strides=[1, 2, 2, 1], padding=&apos;SAME&apos;)</div></pre></td></tr></table></figure>
<p>使用上面定义的卷积(使用relu激活)和池化函数计算:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">h_conv1 = tf.nn.relu(conv2d(x_image, W_conv1) + b_conv1)</div><div class="line">h_pool1 = max_pool_2x2(h_conv1)</div></pre></td></tr></table></figure>
<h1 id="第二卷积层"><a href="#第二卷积层" class="headerlink" title="第二卷积层"></a>第二卷积层</h1><p>此时, 输入是第一卷积池化层的计算结果. 因此weight的输入channel变成了32, 输出设置为64, 同样的bias向量大小也相应设置为64.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">W_conv2 = weight_variable([5, 5, 32, 64])</div><div class="line">b_conv2 = bias_variable([64])</div><div class="line"></div><div class="line">h_conv2 = tf.nn.relu(conv2d(h_pool1, W_conv2) + b_conv2)</div><div class="line">h_pool2 = max_pool_2x2(h_conv2)</div></pre></td></tr></table></figure>
<h1 id="全连接"><a href="#全连接" class="headerlink" title="全连接"></a>全连接</h1><p>经过前面的处理, 此时的图片size已经减到7*7, 可以使用全连接来处理整个输入了. 这里我们选择1024个神经元:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">W_fc1 = weight_variable([7 * 7 * 64, 1024])</div><div class="line">b_fc1 = bias_variable([1024])</div><div class="line">h_pool2_flat = tf.reshape(h_pool2, [-1, 7 * 7 * 64])</div><div class="line">h_fc1 = tf.nn.relu(tf.matmul(h_pool2_flat, W_fc1) + b_fc1)</div></pre></td></tr></table></figure>
<h1 id="dropout"><a href="#dropout" class="headerlink" title="dropout"></a>dropout</h1><p>这个操作主要减少一些过拟合, 使用的方法是<a href="https://www.cs.toronto.edu/~hinton/absps/JMLRdropout.pdf" target="_blank" rel="external">dropout</a>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">keep_prob = tf.placeholder(tf.float32)</div><div class="line">h_fc1_drop = tf.nn.dropout(h_fc1, keep_prob)</div></pre></td></tr></table></figure>
<h1 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">W_fc2 = weight_variable([1024, 10])</div><div class="line">b_fc2 = bias_variable([10])</div></pre></td></tr></table></figure>
<p>使用 <code>softmax</code> 回归分类, 计算分类结果:</p>
<pre><code>y_conv = tf.nn.softmax(tf.matmul(h_fc1_drop, W_fc2) + b_fc2)
</code></pre><h1 id="评估模型的方法"><a href="#评估模型的方法" class="headerlink" title="评估模型的方法"></a>评估模型的方法</h1><p>获取到预测值后, 我们需要了解预测值和真实结果的差距, 定义我们的cost function:</p>
<pre><code>cross_entropy = -tf.reduce_sum(y_ * tf.log(y_conv))
</code></pre><h1 id="训练模型"><a href="#训练模型" class="headerlink" title="训练模型"></a>训练模型</h1><p>因此, 要达到我们预期的效果, 训练模型需要把<code>cross_entropy</code>减少到最小, 这里采用<code>AdamOptimizer</code>(更多Optimizer请戳<a href="https://www.tensorflow.org/versions/r0.9/api_docs/python/train.html#optimizers" target="_blank" rel="external">这里</a>):</p>
<pre><code>train_step = tf.train.AdamOptimizer(1e-4).minimize(cross_entropy)
for i in range(20000):
    batch = mnist.train.next_batch(50)
    train_step.run(feed_dict={x: batch[0], y_: batch[1])    
</code></pre><h1 id="保存模型"><a href="#保存模型" class="headerlink" title="保存模型"></a>保存模型</h1><p>训练结束后, 可以把结果保存成模型文件, 供以后识别图片使用.</p>
<pre><code>save_path = saver.save(sess, model_filepath)
</code></pre><h1 id="查看训练结果"><a href="#查看训练结果" class="headerlink" title="查看训练结果"></a>查看训练结果</h1><p>由于我们需要看当前训练的情况, 要加上一些debug的输出(比如精准度等), 于是将代码修改一下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cross_entropy = tf.reduce_mean(-tf.reduce_sum(y_ * tf.log(y_conv), reduction_indices=[1]))</div><div class="line">train_step = tf.train.AdamOptimizer(1e-4).minimize(cross_entropy)</div><div class="line">correct_prediction = tf.equal(tf.argmax(y_conv,1), tf.argmax(y_,1))</div><div class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line">sess.run(tf.initialize_all_variables())</div><div class="line"></div><div class="line">for i in range(20000):</div><div class="line">  batch = mnist.train.next_batch(50)</div><div class="line">  if i%100 == 0:</div><div class="line">    train_accuracy = accuracy.eval(feed_dict=&#123;</div><div class="line">        x:batch[0], y_: batch[1], keep_prob: 1.0&#125;)</div><div class="line">    print(&quot;step %d, training accuracy %g&quot;%(i, train_accuracy))</div><div class="line">  train_step.run(feed_dict=&#123;x: batch[0], y_: batch[1], keep_prob: 0.5&#125;)</div><div class="line"></div><div class="line">print(&quot;test accuracy %g&quot;%accuracy.eval(feed_dict=&#123;</div><div class="line">    x: mnist.test.images, y_: mnist.test.labels, keep_prob: 1.0&#125;))</div></pre></td></tr></table></figure>
<p>运行这个python脚本, 从输出可以看出, 随着step的增加, 训练的精准度在不断提升然后稳定, 最终使用测试集的精确度达到了99.21%, 如下</p>
<p><img src="/images/dtai/tensorflow/tensorflow-mnist-train-result-01.png" alt=""></p>
<p><img src="/images/dtai/tensorflow/tensorflow-mnist-train-result-02.png" alt=""></p>
<p>至于如何使用训练出来的模型去识别图片, 以及如何可视化训练过程, 将在接下来的两篇博客中介绍.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.tensorflow.org/versions/r0.8/tutorials/mnist/pros/index.html#deep-mnist-for-experts" target="_blank" rel="external">Deep MNIST for Experts</a><br><a href="http://blog.csdn.net/heyongluoyao8/article/details/49429629" target="_blank" rel="external">机器学习中防止过拟合的处理方法</a><br><a href="http://www.jianshu.com/p/05c4f1621c7e" target="_blank" rel="external">http://www.jianshu.com/p/05c4f1621c7e</a><br><a href="http://blog.csdn.net/zouxy09/article/details/49080029" target="_blank" rel="external">http://blog.csdn.net/zouxy09/article/details/49080029</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用 ELK（elasticsearch/logstash/kibana）分析 nginx 日志]]></title>
      <url>http://www.nikoai.pw/2016/04/28/dtai/data/ELK__Elasticsearch_Logstash_Kibana/</url>
      <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>作为一个后台开发，我们经常会用到日志，为了debug或验证一些问题，这时候只是需要在console找到某几行日志。<br>但是如果要有一个可视化的全局视图，还是需要借助一些工具，ELK就是常用的一套工具集。</p>
<h2 id="版本兼容"><a href="#版本兼容" class="headerlink" title="版本兼容"></a>版本兼容</h2><p>以下版本亲测兼容：</p>
<ul>
<li><p>Logstash 2.3.1</p>
</li>
<li><p>Elasticsearch 2.3.x</p>
</li>
<li><p>Kibana 4.5.0</p>
</li>
</ul>
<blockquote>
<p>Compatible with Elasticsearch 2.3.x. Kibana can also be installed from our repositories using apt or yum. See Repositories in the Guide.</p>
</blockquote>
<h1 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h1><hr>
<p>主要作用：负责日志检索和分析。</p>
<pre><code>tar xvf elasticsearch-2.3.2.tar.gz -C /foo/path
bin/elasticsearch
</code></pre><p>默认端口是:</p>
<h1 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h1><hr>
<p>主要作用：负责日志的收集，处理和储存。</p>
<p>使用：</p>
<pre><code>tar zxvf logstash-2.3.1.tar.gz
bin/logstash -e &apos;input { stdin { } } output { stdout {} }&apos;
`-e`代表直接从命令行输入配置文件, input选择了标准输入, output选择了标准输出。
</code></pre><p>我们要做的是把nginx日志输出存储到Elasticsearch，使用 <code>-f</code> 指定配置：</p>
<pre><code>bin/logstash -f logstash-nginx.conf
</code></pre><p><code>logstash-nginx.conf</code> 是我们需要编写的配置文件，用以指定nginx日志的位置和格式，以及es的接口位置。</p>
<h2 id="编写-logstash-nginx-conf"><a href="#编写-logstash-nginx-conf" class="headerlink" title="编写 logstash-nginx.conf"></a>编写 logstash-nginx.conf</h2><p>更多关于 <code>logstash 配置文件</code> 的编写， 请参考<a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" target="_blank" rel="external">官方文档</a></p>
<p>假设nginx的日志格式为:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div></pre></td></tr></table></figure>
<p>新建 <code>logstash-nginx.conf</code> 文件，写入:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#</div><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; [ &quot;/home/niko/mount/hsb_D/niko/temp_trash/logs/foo.com.access_20160617.log&quot; ]</div><div class="line">        type =&gt; &quot;nginx-access&quot;</div><div class="line">        start_position =&gt; &quot;beginning&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#</div><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        match =&gt; &#123;&quot;message&quot; =&gt; &quot;%&#123;IPORHOST:source_ip&#125; - %&#123;USERNAME:remote_user&#125; \[%&#123;HTTPDATE:timestamp&#125;\] %&#123;QS:request&#125; %&#123;INT:status&#125; %&#123;INT:body_bytes_sent&#125; %&#123;QS:http_referer&#125; %&#123;QS:http_user_agent&#125;&quot;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#</div><div class="line">output &#123;</div><div class="line">    elasticsearch &#123; hosts =&gt; [&quot;localhost:9200&quot;] &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动后，等logstash处理完日志文件并写入es，可以查看es的索引:</p>
<p><a href="http://localhost:9200/_cat/indices" target="_blank" rel="external">http://localhost:9200/_cat/indices</a></p>
<p>可以看到以下内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">yellow open .kibana             1 1 1 0  3.1kb  3.1kb</div><div class="line">yellow open logstash-2016.04.28 5 1 4 0 12.3kb 12.3kb</div></pre></td></tr></table></figure>
<p>grok 使用请看<a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html" target="_blank" rel="external"> grok 插件文档 </a>。</p>
<p>以上grok解析nginx日志文件到es的配置，当然还可以从其他输入源（不止文件）获取数据，输出到不同位置（redis等其他中间件）。</p>
<h1 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h1><hr>
<p>主要作用：负责日志的可视化。</p>
<ul>
<li><p>使用：</p>
<p>  tar xf kibana-4.5.0-linux-x64.tar.gz -C /foo/path<br>  bin/kibana</p>
</li>
<li><p>visit <a href="localhost:5601" target="_blank" rel="external">localhost:5601</a></p>
</li>
<li><p>配置index pattern:</p>
</li>
<li><p>点击<code>Settings</code>,  在<code>Indices</code>tab, 创建一个<code>index pattern</code>，选择<code>logstash-*</code></p>
</li>
<li><p>点击<code>visualization</code>, <code>Create a new visualization</code> 这里选择<code>Line Chart</code>类型图</p>
</li>
<li><p>然后选择X和Y坐标，Y有常见的聚合属性，X是nginx日志行的几个字段，完成后点击生成， 如下：</p>
</li>
</ul>
<p><img src="/images/dtai/kibana_01.png" alt=""></p>
<p>以上只是一个示例，kibana 的功能远强大于此，根据自己的需求去定制可视化吧。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>【1】<a href="https://github.com/elastic/examples/tree/master/ELK_NGINX" target="_blank" rel="external">https://github.com/elastic/examples/tree/master/ELK_NGINX</a><br>【2】<a href="http://www.icyfire.me/2014/11/13/logstash-es-kibana.html" target="_blank" rel="external">http://www.icyfire.me/2014/11/13/logstash-es-kibana.html</a><br>【3】<a href="http://www.wklken.me/posts/2015/04/26/elk-for-nginx-log.html" target="_blank" rel="external">http://www.wklken.me/posts/2015/04/26/elk-for-nginx-log.html</a><br>【4】<a href="http://www.wklken.me/posts/2015/05/08/elk-data-collect.html" target="_blank" rel="external">http://www.wklken.me/posts/2015/05/08/elk-data-collect.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring runtime 更新 bean]]></title>
      <url>http://www.nikoai.pw/2016/04/23/java/spring/spring-runtime-update-bean/</url>
      <content type="html"><![CDATA[<p>前一篇博客我们提到， 如果bean是prototype或者刷新重新create后， 读取还是旧的properties， 所以从根本来说, 我们需要更新BeanDefinition，如此才能保证在重新初始化Bean的时候使用最新的配置。</p>
<h1 id="运行时动态注册-bean-到-spring-容器"><a href="#运行时动态注册-bean-到-spring-容器" class="headerlink" title="运行时动态注册 bean 到 spring 容器"></a>运行时动态注册 bean 到 spring 容器</h1><hr>
<p>使用主要通过<code>BeanDefinitionBuilder</code>构建BeanDefinition,  然后通过<code>DefaultListableBeanFactory.registerBeanDefinition</code>注册到容器中:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(SomeClass.class);</div><div class="line">builder.addPropertyReference(<span class="string">"propertyName"</span>, <span class="string">"someBean"</span>);  <span class="comment">// add dependency to other bean</span></div><div class="line">builder.addPropertyValue(<span class="string">"propertyName"</span>, someValue);      <span class="comment">// set property value</span></div><div class="line">DefaultListableBeanFactory factory = (DefaultListableBeanFactory) context.getBeanFactory();</div><div class="line">factory.registerBeanDefinition(<span class="string">"beanName"</span>, builder.getBeanDefinition());</div></pre></td></tr></table></figure>
<p><code>registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</code> 的内部逻辑如下, 主要是验证BeanDefinition和清除缓存：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">   <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></div><div class="line">		<span class="keyword">throws</span> BeanDefinitionStoreException &#123;</div><div class="line"></div><div class="line">	Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</div><div class="line">	Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">	BeanDefinition oldBeanDefinition;</div><div class="line"></div><div class="line">       <span class="comment">// beanDefinitionMap</span></div><div class="line">	oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.get(beanName);</div><div class="line">	<span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// 是否允许 BeanDefinition 的 Overriding</span></div><div class="line">		<span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">					<span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName +</div><div class="line">					<span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>);</div><div class="line">		&#125;</div><div class="line">		...</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">this</span>.beanDefinitionNames.add(beanName);</div><div class="line">		<span class="keyword">this</span>.manualSingletonNames.remove(beanName);</div><div class="line">		<span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (oldBeanDefinition != <span class="keyword">null</span> || containsSingleton(beanName)) &#123;</div><div class="line">           <span class="comment">// 这里重置该 bean 的所有 definition caches, 包括派生于此bean的</span></div><div class="line">		resetBeanDefinition(beanName);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="更新依赖这个动态-Bean-的-Bean"><a href="#更新依赖这个动态-Bean-的-Bean" class="headerlink" title="更新依赖这个动态 Bean 的 Bean"></a>更新依赖这个动态 Bean 的 Bean</h1><hr>
<p>注册之后, 如果使用singleton模式的话, 由于singleton实例和缓存并没有改变, 所以要进行更新DynamicBean.</p>
<h2 id="方法1-destroySingleton"><a href="#方法1-destroySingleton" class="headerlink" title="方法1: destroySingleton"></a>方法1: destroySingleton</h2><hr>
<p>这个方法简单粗暴, 使用 <code>destroyXXX</code> 可以销毁旧的Bean :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">factory.destroySingleton(&quot;calculation&quot;);</div><div class="line">factory.destroyBean();</div><div class="line">factory.destroyXXX();</div></pre></td></tr></table></figure>
<p>例如 <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#destroySingleton</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroySingleton</span><span class="params">(String beanName)</span> </span>&#123;</div><div class="line">	<span class="comment">// Remove a registered singleton of the given name, if any.</span></div><div class="line">	removeSingleton(beanName);</div><div class="line"></div><div class="line">	<span class="comment">// Destroy the corresponding DisposableBean instance.</span></div><div class="line">	DisposableBean disposableBean;</div><div class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.disposableBeans) &#123;</div><div class="line">		disposableBean = (DisposableBean) <span class="keyword">this</span>.disposableBeans.remove(beanName);</div><div class="line">	&#125;</div><div class="line">	destroyBean(beanName, disposableBean);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">destroyBean</span><span class="params">(String beanName, DisposableBean bean)</span> </span>&#123;</div><div class="line">	<span class="comment">// Trigger destruction of dependent beans first...</span></div><div class="line">	Set&lt;String&gt; dependencies = <span class="keyword">this</span>.dependentBeanMap.remove(beanName);</div><div class="line">	<span class="keyword">if</span> (dependencies != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">			logger.debug(<span class="string">"Retrieved dependent beans for bean '"</span> + beanName + <span class="string">"': "</span> + dependencies);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (String dependentBeanName : dependencies) &#123;</div><div class="line">			destroySingleton(dependentBeanName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Actually destroy the bean now...</span></div><div class="line">	<span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			bean.destroy();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">			logger.error(<span class="string">"Destroy method on bean with name '"</span> + beanName + <span class="string">"' threw an exception"</span>, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Trigger destruction of contained beans...</span></div><div class="line">	Set&lt;String&gt; containedBeans = <span class="keyword">this</span>.containedBeanMap.remove(beanName);</div><div class="line">	<span class="keyword">if</span> (containedBeans != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (String containedBeanName : containedBeans) &#123;</div><div class="line">			destroySingleton(containedBeanName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Remove destroyed bean from other beans' dependencies.</span></div><div class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>.dependentBeanMap) &#123;</div><div class="line">		<span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String, Set&lt;String&gt;&gt;&gt; it = <span class="keyword">this</span>.dependentBeanMap.entrySet().iterator(); it.hasNext();) &#123;</div><div class="line">			Map.Entry&lt;String, Set&lt;String&gt;&gt; entry = it.next();</div><div class="line">			Set&lt;String&gt; dependenciesToClean = entry.getValue();</div><div class="line">			dependenciesToClean.remove(beanName);</div><div class="line">			<span class="keyword">if</span> (dependenciesToClean.isEmpty()) &#123;</div><div class="line">				it.remove();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Remove destroyed bean's prepared dependency information.</span></div><div class="line">	<span class="keyword">this</span>.dependenciesForBeanMap.remove(beanName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上, 内部的<code>singletonObjects singletonFactories earlySingletonObjects registeredSingletons containedBeans containedBeanMap</code>等记录会清除掉这个Bean.</p>
<p>当下次需要这个Bean的时候, 如下面 <code>org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</code> 代码所示, 如果没有缓存, 就会重新创建这个Bean.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(</span></span></div><div class="line">			<span class="keyword">final</span> String name, <span class="keyword">final</span> Class&lt;T&gt; requiredType, <span class="keyword">final</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</div><div class="line">			<span class="keyword">throws</span> BeansException &#123;</div><div class="line"></div><div class="line">		<span class="keyword">final</span> String beanName = transformedBeanName(name);</div><div class="line">		Object bean;</div><div class="line"></div><div class="line">		<span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></div><div class="line">		Object sharedInstance = getSingleton(beanName);</div><div class="line">		<span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				<span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</div><div class="line">					logger.debug(<span class="string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +</div><div class="line">							<span class="string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line">					logger.debug(<span class="string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// Fail if we're already creating this bean instance:</span></div><div class="line">			<span class="comment">// We're assumably within a circular reference.</span></div><div class="line">			<span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Check if bean definition exists in this factory.</span></div><div class="line">			BeanFactory parentBeanFactory = getParentBeanFactory();</div><div class="line">			<span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</div><div class="line">				<span class="comment">// Not found -&gt; check parent.</span></div><div class="line">				String nameToLookup = originalBeanName(name);</div><div class="line">				<span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// Delegation to parent with explicit args.</span></div><div class="line">					<span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// No args -&gt; delegate to standard getBean method.</span></div><div class="line">					<span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (!typeCheckOnly) &#123;</div><div class="line">				markBeanAsCreated(beanName);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</div><div class="line">				checkMergedBeanDefinition(mbd, beanName, args);</div><div class="line"></div><div class="line">				<span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></div><div class="line">				String[] dependsOn = mbd.getDependsOn();</div><div class="line">				<span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="keyword">for</span> (String dependsOnBean : dependsOn) &#123;</div><div class="line">						<span class="keyword">if</span> (isDependent(beanName, dependsOnBean)) &#123;</div><div class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">									<span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dependsOnBean + <span class="string">"'"</span>);</div><div class="line">						&#125;</div><div class="line">						registerDependentBean(dependsOnBean, beanName);</div><div class="line">						getBean(dependsOnBean);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="comment">// Create bean instance.</span></div><div class="line">				<span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">					sharedInstance = getSingleton(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">						<span class="meta">@Override</span></div><div class="line">						<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">							<span class="keyword">try</span> &#123;</div><div class="line">								<span class="keyword">return</span> createBean(beanName, mbd, args);</div><div class="line">							&#125;</div><div class="line">							<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">								<span class="comment">// Explicitly remove instance from singleton cache: It might have been put there</span></div><div class="line">								<span class="comment">// eagerly by the creation process, to allow for circular reference resolution.</span></div><div class="line">								<span class="comment">// Also remove any beans that received a temporary reference to the bean.</span></div><div class="line">								destroySingleton(beanName);</div><div class="line">								<span class="keyword">throw</span> ex;</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">					bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</div><div class="line">					<span class="comment">// It's a prototype -&gt; create a new instance.</span></div><div class="line">					Object prototypeInstance = <span class="keyword">null</span>;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						beforePrototypeCreation(beanName);</div><div class="line">						prototypeInstance = createBean(beanName, mbd, args);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">finally</span> &#123;</div><div class="line">						afterPrototypeCreation(beanName);</div><div class="line">					&#125;</div><div class="line">					bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line">					String scopeName = mbd.getScope();</div><div class="line">					<span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.get(scopeName);</div><div class="line">					<span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</div><div class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No Scope registered for scope '"</span> + scopeName + <span class="string">"'"</span>);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						Object scopedInstance = scope.get(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">							<span class="meta">@Override</span></div><div class="line">							<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">								beforePrototypeCreation(beanName);</div><div class="line">								<span class="keyword">try</span> &#123;</div><div class="line">									<span class="keyword">return</span> createBean(beanName, mbd, args);</div><div class="line">								&#125;</div><div class="line">								<span class="keyword">finally</span> &#123;</div><div class="line">									afterPrototypeCreation(beanName);</div><div class="line">								&#125;</div><div class="line">							&#125;</div><div class="line">						&#125;);</div><div class="line">						bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">catch</span> (IllegalStateException ex) &#123;</div><div class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</div><div class="line">								<span class="string">"Scope '"</span> + scopeName + <span class="string">"' is not active for the current thread; "</span> +</div><div class="line">								<span class="string">"consider defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,</div><div class="line">								ex);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">				cleanupAfterBeanCreationFailure(beanName);</div><div class="line">				<span class="keyword">throw</span> ex;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Check if required type matches the type of the actual bean instance.</span></div><div class="line">		<span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (TypeMismatchException ex) &#123;</div><div class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">					logger.debug(<span class="string">"Failed to convert bean '"</span> + name + <span class="string">"' to required type ["</span> +</div><div class="line">							ClassUtils.getQualifiedName(requiredType) + <span class="string">"]"</span>, ex);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> (T) bean;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>从上可知, 因为已经destroy了DynamicBean, 所以<code>Object sharedInstance = getSingleton(beanName)</code> 是null的, 所以需要重新缓存DynamicBean, <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</code> 被调用, 这样我们的修改就被刷新了.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> Object[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// Instantiate the bean.</span></div><div class="line">		BeanWrapper instanceWrapper = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">			instanceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</div><div class="line">			instanceWrapper = createBeanInstance(beanName, mbd, args);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> Object bean = (instanceWrapper != <span class="keyword">null</span> ? instanceWrapper.getWrappedInstance() : <span class="keyword">null</span>);</div><div class="line">		Class&lt;?&gt; beanType = (instanceWrapper != <span class="keyword">null</span> ? instanceWrapper.getWrappedClass() : <span class="keyword">null</span>);</div><div class="line"></div><div class="line">		<span class="comment">// Allow post-processors to modify the merged bean definition.</span></div><div class="line">		<span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</div><div class="line">			<span class="keyword">if</span> (!mbd.postProcessed) &#123;</div><div class="line">				applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</div><div class="line">				mbd.postProcessed = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></div><div class="line">		<span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></div><div class="line">		<span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</div><div class="line">				isSingletonCurrentlyInCreation(beanName));</div><div class="line">		<span class="keyword">if</span> (earlySingletonExposure) &#123;</div><div class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"Eagerly caching bean '"</span> + beanName +</div><div class="line">						<span class="string">"' to allow for resolving potential circular references"</span>);</div><div class="line">			&#125;</div><div class="line">			addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">					<span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Initialize the bean instance.</span></div><div class="line">		Object exposedObject = bean;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			populateBean(beanName, mbd, instanceWrapper);</div><div class="line">			<span class="keyword">if</span> (exposedObject != <span class="keyword">null</span>) &#123;</div><div class="line">				exposedObject = initializeBean(beanName, exposedObject, mbd);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">			<span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</div><div class="line">				<span class="keyword">throw</span> (BeanCreationException) ex;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="string">"Initialization of bean failed"</span>, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (earlySingletonExposure) &#123;</div><div class="line">			Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</div><div class="line">			<span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (exposedObject == bean) &#123;</div><div class="line">					exposedObject = earlySingletonReference;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</div><div class="line">					String[] dependentBeans = getDependentBeans(beanName);</div><div class="line">					Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(dependentBeans.length);</div><div class="line">					<span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</div><div class="line">						<span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</div><div class="line">							actualDependentBeans.add(dependentBean);</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</div><div class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</div><div class="line">								<span class="string">"Bean with name '"</span> + beanName + <span class="string">"' has been injected into other beans ["</span> +</div><div class="line">								StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</div><div class="line">								<span class="string">"] in its raw version as part of a circular reference, but has eventually been "</span> +</div><div class="line">								<span class="string">"wrapped. This means that said other beans do not use the final version of the "</span> +</div><div class="line">								<span class="string">"bean. This is often the result of over-eager type matching - consider using "</span> +</div><div class="line">								<span class="string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Register bean as disposable.</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			registerDisposableBeanIfNecessary(beanName, bean, mbd);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="string">"Invalid destruction signature"</span>, ex);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> exposedObject;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h2 id="方法2-WrapBean"><a href="#方法2-WrapBean" class="headerlink" title="方法2: WrapBean"></a>方法2: WrapBean</h2><hr>
<ul>
<li>一个比较好的策略是定义一个 WrapBean 包一下这个可能在runtime被动态更新的 DynamicBean, 大概如下:</li>
</ul>
<div style="display: none;"><br></div>



<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WrapBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span></div><div class="line">    DynamicBean dynamicBean;</div><div class="line"></div><div class="line">    <span class="comment">// get set...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样的话, 动态修改后只需要更新这个WrapBean的dynamicBean, 而且对系统的影响相对较小.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://stackoverflow.com/questions/15328904/dynamically-declare-beans-at-runtime-in-spring" target="_blank" rel="external">http://stackoverflow.com/questions/15328904/dynamically-declare-beans-at-runtime-in-spring</a><br><a href="http://stackoverflow.com/questions/12800769/replace-spring-bean-in-one-context-with-mock-version-from-another-context" target="_blank" rel="external">http://stackoverflow.com/questions/12800769/replace-spring-bean-in-one-context-with-mock-version-from-another-context</a><br><a href="http://stackoverflow.com/questions/11606504/registering-beansprototype-at-runtime-in-spring" target="_blank" rel="external">http://stackoverflow.com/questions/11606504/registering-beansprototype-at-runtime-in-spring</a><br><a href="http://stackoverflow.com/questions/8711560/dynamic-creation-of-beans-in-spring" target="_blank" rel="external">http://stackoverflow.com/questions/8711560/dynamic-creation-of-beans-in-spring</a><br><a href="http://shayanth.blogspot.com/2009/10/dynamic-bean-creation-in-spring.html" target="_blank" rel="external">http://shayanth.blogspot.com/2009/10/dynamic-bean-creation-in-spring.html</a><br><a href="http://stackoverflow.com/questions/4540713/add-bean-programatically-to-spring-web-app-context" target="_blank" rel="external">http://stackoverflow.com/questions/4540713/add-bean-programatically-to-spring-web-app-context</a><br><a href="http://stackoverflow.com/questions/27998502/java-spring-recreate-specific-bean" target="_blank" rel="external">http://stackoverflow.com/questions/27998502/java-spring-recreate-specific-bean</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring runtime 修改 bean 属性]]></title>
      <url>http://www.nikoai.pw/2016/04/22/java/spring/spring-runtime-modify-bean-attrs/</url>
      <content type="html"><![CDATA[<p>一般来说, 一个Bean的属性定义都在在启动之前配置好了. 比如一个<code>ProxyClient</code>的Bean, 他的依赖服务URL在启动前就会设置好的. 然而有些场景就是, 这个<code>ProxyClient</code>的属性需要在运行时改变, 比如依赖服务crash掉了, 需要寻找新的替代服务, URL属性当然也要更新. 那么如何在runtime修改spring的Bean属性呢 ?</p>
<h1 id="访问-ApplicationContext"><a href="#访问-ApplicationContext" class="headerlink" title="访问 ApplicationContext"></a>访问 ApplicationContext</h1><hr>
<p>要修改某个Bean, 首先就要先获取这个Bean, 也即是首先要从应用的上下文<code>ApplicationContext</code>找到这个Bean. <a href="https://spring.io/understanding/application-context" target="_blank" rel="external"><code>ApplicationContext</code></a> 有几种获取方式, 下面使用的是自动注入的方法.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// 注入到你的类中</div><div class="line">@Autowired</div><div class="line">private ApplicationContext applicationContext;</div></pre></td></tr></table></figure>
<h1 id="获取和修改-Bean"><a href="#获取和修改-Bean" class="headerlink" title="获取和修改 Bean"></a>获取和修改 Bean</h1><p>有了<code>ApplicationContext</code>, 我们就可以通过<code>getBean(String name)</code>来获取我们想要的Bean. 假设有一个Bean定义如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;bean id=&quot;calculationBean&quot;</div><div class="line">          class=&quot;org.springframework.remoting.caucho.HessianProxyFactoryBean&quot;&gt;</div><div class="line">        &lt;property name=&quot;serviceUrl&quot;</div><div class="line">                  value=&quot;http://localhost:8080/calculation.http_wrong&quot;&gt;&lt;/property&gt;</div><div class="line">        &lt;property name=&quot;serviceInterface&quot; value=&quot;org.niko.opsrc.zk.znode.hessian.ifs.Calculation&quot;&gt;&lt;/property&gt;</div><div class="line">    &lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>如上, 这个Bean的class声明是<code>HessianProxyFactoryBean</code>,</p>
<p>applicationContext.getBean(“calculationBean”)</p>
<p>获取的只是<code>class com.sun.proxy.$ProxyXX</code>对象</p>
<p>要获取到 FactoryBean (HessianProxyFactoryBean), 应该使用<code>&amp;</code>获取, 然后调用FactoryBean的各种set方法即可.即:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HessianProxyFactoryBean factoryBean = (HessianProxyFactoryBean) applicationContext.getBean(&quot;&amp;calculationBean&quot;);</div><div class="line">factoryBean.setServiceUrl(newUrl);</div></pre></td></tr></table></figure>
<p>注意, 这是Bean属于singleton的情况, 而且并不安全， prototype类型和其他场景需要用另一种方式来实现， 下一篇博客继续。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://stackoverflow.com/questions/15328904/dynamically-declare-beans-at-runtime-in-spring" target="_blank" rel="external">http://stackoverflow.com/questions/15328904/dynamically-declare-beans-at-runtime-in-spring</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[dubbo - getting started]]></title>
      <url>http://www.nikoai.pw/2016/04/15/java/dubbo/dubbo_get_started/</url>
      <content type="html"><![CDATA[<p>dubbo 是阿里出品的服务框架, 好奇的童鞋肯定很想立马试用下 , 以下是 getting started 过程.</p>
<h1 id="构建核心模块"><a href="#构建核心模块" class="headerlink" title="构建核心模块"></a>构建核心模块</h1><hr>
<p>git clone git@github.com:alibaba/dubbo.git</p>
<p>这里选择使用 <code>dubbo-2.4.11</code> 版本:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd ~/dubbo</div><div class="line">mvn clean install -Dmaven.test.skip</div><div class="line">cd dubbo/target</div><div class="line">ls</div></pre></td></tr></table></figure>
<p>但是, dubbo 项目活跃度没那么高了, 许多依赖都不能下载, 需要一个个手工寻找并安装.</p>
<p>比如 <a href="https://github.com/alibaba/opensesame" target="_blank" rel="external">opensesame</a> , 这个是super POM, dubbo 依赖于这个POM, 可以手工 install.</p>
<blockquote>
<p>因为<code>code.alibabatech.com</code>站点停止服务了, 更多相关的issue和说明请戳这里:<br><a href="https://github.com/alibaba/dubbo/issues/22" target="_blank" rel="external">https://github.com/alibaba/dubbo/issues/22</a><br><a href="http://www.jianshu.com/p/0dde591f21d0/comments/45870" target="_blank" rel="external">http://www.jianshu.com/p/0dde591f21d0/comments/45870</a></p>
</blockquote>
<h1 id="构建-demo-模块"><a href="#构建-demo-模块" class="headerlink" title="构建 demo 模块"></a>构建 demo 模块</h1><hr>
<p>构建demo :</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /dubbo/dubbo-demo</div><div class="line">mvn clean install -Dmaven.test.skip</div></pre></td></tr></table></figure>
<p>坑爹啊, 我的使用的是tag-2.4.11, 但是这个demo的parent版本仍旧是2.4.10, 社区的童鞋太粗心了 ?<br>这是个小问题, 把版本改回来就行了, 三个模块, 手改也行, 如果要装逼, 有 maven 插件可以帮你.</p>
<p>接下来会使用一些 provider 和 comsumer 的 demo 服务进行测试, 这里先使用 <code>multicast</code> 的服务发现方式, 即 <code>dubbo.properties</code> 中使用以下配置:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dubbo.registry.address=multicast://224.5.6.7:1234</div></pre></td></tr></table></figure>
<h2 id="dubbo-demo-provider"><a href="#dubbo-demo-provider" class="headerlink" title="dubbo-demo-provider"></a>dubbo-demo-provider</h2><hr>
<p>build 成功后, 启动 dubbo-demo-provider:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> dubbo-demo-provider/target/</div><div class="line">tar xf dubbo-demo-provider-2.4.11-assembly.tar.gz</div><div class="line"></div><div class="line"><span class="built_in">cd</span> dubbo-demo-provider-2.4.11/</div><div class="line">$ bin/start.sh</div><div class="line">Starting the demo-provider .....OK!</div><div class="line">PID: 15780</div><div class="line">STDOUT: logs/stdout.log</div></pre></td></tr></table></figure>
<h2 id="dubbo-demo-consumer"><a href="#dubbo-demo-consumer" class="headerlink" title="dubbo-demo-consumer"></a>dubbo-demo-consumer</h2><hr>
<p>启动 dubbo-demo-consumer:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> dubbo-demo-consumer/target/</div><div class="line">tar xf dubbo-demo-consumer-2.4.11-assembly.tar.gz</div><div class="line"></div><div class="line">$ bin/start.sh</div><div class="line">Starting the demo-consumer ....OK!</div><div class="line">PID: 15958</div><div class="line">STDOUT: logs/stdout.log</div></pre></td></tr></table></figure>
<p>启动之后, 可以看到成功的 <code>response form provider</code> 日志:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[10:32:20] Hello world0, response form provider: 192.168.156.1:20880</div><div class="line">[10:32:22] Hello world1, response form provider: 192.168.156.1:20880</div><div class="line">[10:32:24] Hello world2, response form provider: 192.168.156.1:20880</div><div class="line">[10:32:26] Hello world3, response form provider: 192.168.156.1:20880</div><div class="line">[10:32:28] Hello world4, response form provider: 192.168.156.1:20880</div><div class="line">[10:32:30] Hello world5, response form provider: 192.168.156.1:20880</div></pre></td></tr></table></figure>
<p>dubbo-demo-provider 也收到了 consumer 的请求:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[10:30:40] Dubbo service server started!</div><div class="line">[10:32:18] Hello world0, request from consumer: /192.168.156.1:38019</div><div class="line">[10:32:20] Hello world0, request from consumer: /192.168.156.1:38019</div><div class="line">[10:32:22] Hello world1, request from consumer: /192.168.156.1:38019</div><div class="line">[10:32:24] Hello world2, request from consumer: /192.168.156.1:38019</div><div class="line">[10:32:26] Hello world3, request from consumer: /192.168.156.1:38019</div><div class="line">[10:32:28] Hello world4, request from consumer: /192.168.156.1:38019</div><div class="line">[10:32:30] Hello world5, request from consumer: /192.168.156.1:38019</div></pre></td></tr></table></figure>
<h2 id="dubbo-monitor-simple"><a href="#dubbo-monitor-simple" class="headerlink" title="dubbo-monitor-simple"></a>dubbo-monitor-simple</h2><hr>
<p>构建和启动 dubbo-monitor-simple ( 这个模块还是有相同的问题, 需要更新 parent 版本到 2.4.11 ) :</p>
<p>构建前修改 jetty 端口, <code>vim src/main/assembly/conf/dubbo.properties</code>, 因为会跟后面的 dubbo-admin 端口重复 (运行在多台机器的话不需要) :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dubbo.jetty.port=8090</div></pre></td></tr></table></figure>
<p>构建启动:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> <span class="variable">$DUBBO_HOME</span></div><div class="line"><span class="built_in">cd</span> dubbo-simple</div><div class="line">mvn clean install -Dmaven.test.skip</div><div class="line"><span class="built_in">cd</span> dubbo-monitor-simple/target/</div><div class="line"></div><div class="line">tar xf dubbo-monitor-simple-2.4.11-assembly.tar.gz</div><div class="line"><span class="built_in">cd</span> dubbo-monitor-simple-2.4.11/</div><div class="line">$ bin/start.sh</div><div class="line">Starting the simple-monitor .....OK!</div><div class="line">PID: 16313</div><div class="line">STDOUT: logs/stdout.log</div></pre></td></tr></table></figure>
<p>然后访问<code>http://localhost:8090/</code>.</p>
<h2 id="启动-dubbo-admin"><a href="#启动-dubbo-admin" class="headerlink" title="启动 dubbo-admin"></a>启动 dubbo-admin</h2><hr>
<p>构建并启动:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> <span class="variable">$DUBBO_HOME</span>/dubbo-admin</div><div class="line">mvn clean package</div><div class="line">mvn jetty:run</div></pre></td></tr></table></figure>
<p>启动时, 发现如下错误 (完整的异常stack在后面附录) :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Error creating bean with name &apos;server&apos;: Error setting property values; nested exception is org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos;</div><div class="line">is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?</div></pre></td></tr></table></figure>
<p>解决方法参考这里的issue和博客:<br><a href="https://github.com/alibaba/dubbo/issues/50" target="_blank" rel="external">https://github.com/alibaba/dubbo/issues/50</a><br><a href="http://www.cnblogs.com/BensonHe/p/4135768.html" target="_blank" rel="external">http://www.cnblogs.com/BensonHe/p/4135768.html</a></p>
<blockquote>
<p>下面引用 <code>issues/50</code> 中 用户 stirp 的分享:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">stirp commented on May 19, 2015</div><div class="line">我使用的是JDK 1.8.0_05, dubbo-admin版本是2.5.4-SNAPSHOT，也遇到了一样的问题。解决方案如@ddatsh ：</div><div class="line"></div><div class="line">1、webx的依赖改为3.1.6版；</div><div class="line"></div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;com.alibaba.citrus&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;citrus-webx-all&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;3.1.6&lt;/version&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">2、添加velocity的依赖，我用了1.7；</div><div class="line"></div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;org.apache.velocity&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;velocity&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;1.7&lt;/version&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">3、对依赖项dubbo添加exclusion，避免引入旧spring</div><div class="line"></div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;dubbo&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;$&#123;project.parent.version&#125;&lt;/version&gt;</div><div class="line">        &lt;exclusions&gt;</div><div class="line">            &lt;exclusion&gt;</div><div class="line">                &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;spring&lt;/artifactId&gt;</div><div class="line">            &lt;/exclusion&gt;</div><div class="line">        &lt;/exclusions&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">4、webx已有spring 3以上的依赖，因此注释掉dubbo-admin里面的spring依赖</div><div class="line"></div><div class="line">    &lt;!--&lt;dependency&gt;--&gt;</div><div class="line">        &lt;!--&lt;groupId&gt;org.springframework&lt;/groupId&gt;--&gt;</div><div class="line">        &lt;!--&lt;artifactId&gt;spring&lt;/artifactId&gt;--&gt;</div><div class="line">    &lt;!--&lt;/dependency&gt;--&gt;</div><div class="line">确定war包解压后lib目录没有spring 3 以下的依赖就行。然后运行正常了。</div></pre></td></tr></table></figure>
<p>okay, 构建成功后重新运行 webapp, 发现 8080 已经被 dubbo-monitor-simple 使用了, 先停掉 dubbo-monitor-simple.</p>
<p>然后访问<code>http://localhost:8080/</code>, 默认账号/密码: <code>root/root</code></p>
<p>登录之后, 可以看到管理界面, dubbo 的功能还是很强大的 :</p>
<p><img src="/images/java/dubbo/dubbo-admin-01.png" alt=""></p>
<p>具体功能就不介绍了, 最好自己进去实际使用一下, 后面博客也会具体涉及到.</p>
<h1 id="停止运行"><a href="#停止运行" class="headerlink" title="停止运行"></a>停止运行</h1><hr>
<p>每个模块在bin目录下都有 start.sh 、 stop.sh、restart.sh 等脚本, 不过脚本中有一些问题, 比如执行 stop.sh 时, 不能停止服务, 提示没有找到 PID.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ERROR: The demo-provider does not started!</div></pre></td></tr></table></figure>
<p>其实这个服务是在运行的, 查一下进程确实存在:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ps -ef | grep     demo-provider</div><div class="line"></div><div class="line">niko      9646  2636  0 00:30 pts/35   00:00:16 java -Djava.awt.headless=true -Djava.net.preferIPv4Stack=true -server -Xmx2g -Xms2g -Xmn256m -XX:PermSize=128m -Xss256k</div></pre></td></tr></table></figure>
<p>只能debug一下脚本，<code>vim stop.sh</code>，发现有一行:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">PIDS=`ps -f | grep java | grep &quot;$CONF_DIR&quot; |awk &apos;&#123;print $2&#125;&apos;`</div></pre></td></tr></table></figure>
<p>通过debug发现, 在脚本运行的时候, <code>ps -f | grep java | grep &quot;$CONF_DIR&quot; |awk &#39;{print $2}&#39;</code>并没有获取到PIDS, 只要换成 <code>ps -ef</code>就可以获取到PIDS了.</p>
<blockquote>
<p>注意： 这个脚本在 dubbo-container-api 模块，修改后需要重新 install。</p>
</blockquote>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><hr>
<p>可以发现, dubbo get started 起来不容易, 还是有许多问题要处理的, 但 dubbo 确实是一个优秀的服务框架, 不要灰心, 大家多交流分享一些问题和解决方法, 毕竟开源社区的力量是很强大的.</p>
<h1 id="附录-admin-启动错误"><a href="#附录-admin-启动错误" class="headerlink" title="附录: admin 启动错误:"></a>附录: admin 启动错误:</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[ERROR] Failed startup of context org.mortbay.jetty.plugin.Jetty6PluginWebAppContext@489543a6&#123;/,/home/niko/dev/git_repos/github/dubbo/dubbo-admin/src/main/webapp&#125;</div><div class="line">org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;uriBrokerService&apos;: Cannot create inner bean &apos;(inner bean)&apos; of type [com.alibaba.citrus.service.uribroker.impl.URIBrokerServiceImpl$URIBrokerInfo] while setting bean property &apos;brokers&apos; with key [0]; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;(inner bean)#25&apos;: Cannot create inner bean &apos;server&apos; of type [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker] while setting constructor argument; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;server&apos;: Error setting property values; nested exception is org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos; is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:230)</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:122)</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveManagedList(BeanDefinitionValueResolver.java:287)</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:126)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1245)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1010)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:472)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)</div><div class="line">	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)</div><div class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:264)</div><div class="line">	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:222)</div><div class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:261)</div><div class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:185)</div><div class="line">	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:164)</div><div class="line">	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:429)</div><div class="line">	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:728)</div><div class="line">	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:380)</div><div class="line">	at org.springframework.web.context.ContextLoader.createWebApplicationContext(ContextLoader.java:255)</div><div class="line">	at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:199)</div><div class="line">	at com.alibaba.citrus.webx.context.WebxComponentsLoader.initWebApplicationContext(WebxComponentsLoader.java:117)</div><div class="line">	at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:45)</div><div class="line">	at org.mortbay.jetty.handler.ContextHandler.startContext(ContextHandler.java:549)</div><div class="line">	at org.mortbay.jetty.servlet.Context.startContext(Context.java:136)</div><div class="line">	at org.mortbay.jetty.webapp.WebAppContext.startContext(WebAppContext.java:1282)</div><div class="line">	at org.mortbay.jetty.handler.ContextHandler.doStart(ContextHandler.java:518)</div><div class="line">	at org.mortbay.jetty.webapp.WebAppContext.doStart(WebAppContext.java:499)</div><div class="line">	at org.mortbay.jetty.plugin.Jetty6PluginWebAppContext.doStart(Jetty6PluginWebAppContext.java:115)</div><div class="line">	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">	at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)</div><div class="line">	at org.mortbay.jetty.handler.ContextHandlerCollection.doStart(ContextHandlerCollection.java:156)</div><div class="line">	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">	at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)</div><div class="line">	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">	at org.mortbay.jetty.handler.HandlerWrapper.doStart(HandlerWrapper.java:130)</div><div class="line">	at org.mortbay.jetty.Server.doStart(Server.java:224)</div><div class="line">	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">	at org.mortbay.jetty.plugin.Jetty6PluginServer.start(Jetty6PluginServer.java:132)</div><div class="line">	at org.mortbay.jetty.plugin.AbstractJettyMojo.startJetty(AbstractJettyMojo.java:454)</div><div class="line">	at org.mortbay.jetty.plugin.AbstractJettyMojo.execute(AbstractJettyMojo.java:396)</div><div class="line">	at org.mortbay.jetty.plugin.AbstractJettyRunMojo.execute(AbstractJettyRunMojo.java:210)</div><div class="line">	at org.mortbay.jetty.plugin.Jetty6RunMojo.execute(Jetty6RunMojo.java:184)</div><div class="line">	at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo(DefaultBuildPluginManager.java:134)</div><div class="line">	at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:207)</div><div class="line">	at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:153)</div><div class="line">	at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:145)</div><div class="line">	at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:116)</div><div class="line">	at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:80)</div><div class="line">	at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build(SingleThreadedBuilder.java:51)</div><div class="line">	at org.apache.maven.lifecycle.internal.LifecycleStarter.execute(LifecycleStarter.java:128)</div><div class="line">	at org.apache.maven.DefaultMaven.doExecute(DefaultMaven.java:307)</div><div class="line">	at org.apache.maven.DefaultMaven.doExecute(DefaultMaven.java:193)</div><div class="line">	at org.apache.maven.DefaultMaven.execute(DefaultMaven.java:106)</div><div class="line">	at org.apache.maven.cli.MavenCli.execute(MavenCli.java:863)</div><div class="line">	at org.apache.maven.cli.MavenCli.doMain(MavenCli.java:288)</div><div class="line">	at org.apache.maven.cli.MavenCli.main(MavenCli.java:199)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:497)</div><div class="line">	at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced(Launcher.java:289)</div><div class="line">	at org.codehaus.plexus.classworlds.launcher.Launcher.launch(Launcher.java:229)</div><div class="line">	at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode(Launcher.java:415)</div><div class="line">	at org.codehaus.plexus.classworlds.launcher.Launcher.main(Launcher.java:356)</div><div class="line">Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;(inner bean)#25&apos;: Cannot create inner bean &apos;server&apos; of type [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker] while setting constructor argument; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;server&apos;: Error setting property values; nested exception is org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos; is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:230)</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:117)</div><div class="line">	at org.springframework.beans.factory.support.ConstructorResolver.resolveConstructorArguments(ConstructorResolver.java:479)</div><div class="line">	at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:162)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:925)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:835)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:440)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)</div><div class="line">	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:219)</div><div class="line">	... 63 more</div><div class="line">Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;server&apos;: Error setting property values; nested exception is org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos; is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1279)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1010)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:472)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)</div><div class="line">	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)</div><div class="line">	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:219)</div><div class="line">	... 73 more</div><div class="line">Caused by: org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos; is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?</div><div class="line">	at org.springframework.beans.BeanWrapperImpl.setPropertyValue(BeanWrapperImpl.java:801)</div><div class="line">	at org.springframework.beans.BeanWrapperImpl.setPropertyValue(BeanWrapperImpl.java:651)</div><div class="line">	at org.springframework.beans.AbstractPropertyAccessor.setPropertyValues(AbstractPropertyAccessor.java:78)</div><div class="line">	at org.springframework.beans.AbstractPropertyAccessor.setPropertyValues(AbstractPropertyAccessor.java:59)</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1276)</div><div class="line">	... 79 more</div><div class="line"></div><div class="line">    [ERROR] Nested in org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;uriBrokerService&apos;: Cannot create inner bean &apos;(inner bean)&apos; of type [com.alibaba.citrus.service.uribroker.impl.URIBrokerServiceImpl$URIBrokerInfo] while setting bean property &apos;brokers&apos; with key [0]; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;(inner bean)#25&apos;: Cannot create inner bean &apos;server&apos; of type [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker] while setting constructor argument; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;server&apos;: Error setting property values; nested exception is org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos; is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?:</div><div class="line">    org.springframework.beans.NotWritablePropertyException: Invalid property &apos;URIType&apos; of bean class [com.alibaba.citrus.service.uribroker.uri.GenericURIBroker]: Bean property &apos;URIType&apos; is not writable or has an invalid setter method. Does the parameter type of the setter match the return type of the getter?</div><div class="line">    	at org.springframework.beans.BeanWrapperImpl.setPropertyValue(BeanWrapperImpl.java:801)</div><div class="line">    	at org.springframework.beans.BeanWrapperImpl.setPropertyValue(BeanWrapperImpl.java:651)</div><div class="line">    	at org.springframework.beans.AbstractPropertyAccessor.setPropertyValues(AbstractPropertyAccessor.java:78)</div><div class="line">    	at org.springframework.beans.AbstractPropertyAccessor.setPropertyValues(AbstractPropertyAccessor.java:59)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1276)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1010)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:472)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)</div><div class="line">    	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)</div><div class="line">    	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:219)</div><div class="line">    	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:117)</div><div class="line">    	at org.springframework.beans.factory.support.ConstructorResolver.resolveConstructorArguments(ConstructorResolver.java:479)</div><div class="line">    	at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:162)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:925)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:835)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:440)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)</div><div class="line">    	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)</div><div class="line">    	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:219)</div><div class="line">    	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:122)</div><div class="line">    	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveManagedList(BeanDefinitionValueResolver.java:287)</div><div class="line">    	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:126)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1245)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1010)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:472)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory$1.run(AbstractAutowireCapableBeanFactory.java:409)</div><div class="line">    	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:380)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:264)</div><div class="line">    	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:222)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:261)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:185)</div><div class="line">    	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:164)</div><div class="line">    	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:429)</div><div class="line">    	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:728)</div><div class="line">    	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:380)</div><div class="line">    	at org.springframework.web.context.ContextLoader.createWebApplicationContext(ContextLoader.java:255)</div><div class="line">    	at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:199)</div><div class="line">    	at com.alibaba.citrus.webx.context.WebxComponentsLoader.initWebApplicationContext(WebxComponentsLoader.java:117)</div><div class="line">    	at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:45)</div><div class="line">    	at org.mortbay.jetty.handler.ContextHandler.startContext(ContextHandler.java:549)</div><div class="line">    	at org.mortbay.jetty.servlet.Context.startContext(Context.java:136)</div><div class="line">    	at org.mortbay.jetty.webapp.WebAppContext.startContext(WebAppContext.java:1282)</div><div class="line">    	at org.mortbay.jetty.handler.ContextHandler.doStart(ContextHandler.java:518)</div><div class="line">    	at org.mortbay.jetty.webapp.WebAppContext.doStart(WebAppContext.java:499)</div><div class="line">    	at org.mortbay.jetty.plugin.Jetty6PluginWebAppContext.doStart(Jetty6PluginWebAppContext.java:115)</div><div class="line">    	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">    	at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)</div><div class="line">    	at org.mortbay.jetty.handler.ContextHandlerCollection.doStart(ContextHandlerCollection.java:156)</div><div class="line">    	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">    	at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)</div><div class="line">    	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">    	at org.mortbay.jetty.handler.HandlerWrapper.doStart(HandlerWrapper.java:130)</div><div class="line">    	at org.mortbay.jetty.Server.doStart(Server.java:224)</div><div class="line">    	at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)</div><div class="line">    	at org.mortbay.jetty.plugin.Jetty6PluginServer.start(Jetty6PluginServer.java:132)</div><div class="line">    	at org.mortbay.jetty.plugin.AbstractJettyMojo.startJetty(AbstractJettyMojo.java:454)</div><div class="line">    	at org.mortbay.jetty.plugin.AbstractJettyMojo.execute(AbstractJettyMojo.java:396)</div><div class="line">    	at org.mortbay.jetty.plugin.AbstractJettyRunMojo.execute(AbstractJettyRunMojo.java:210)</div><div class="line">    	at org.mortbay.jetty.plugin.Jetty6RunMojo.execute(Jetty6RunMojo.java:184)</div><div class="line">    	at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo(DefaultBuildPluginManager.java:134)</div><div class="line">    	at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:207)</div><div class="line">    	at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:153)</div><div class="line">    	at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:145)</div><div class="line">    	at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:116)</div><div class="line">    	at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:80)</div><div class="line">    	at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build(SingleThreadedBuilder.java:51)</div><div class="line">    	at org.apache.maven.lifecycle.internal.LifecycleStarter.execute(LifecycleStarter.java:128)</div><div class="line">    	at org.apache.maven.DefaultMaven.doExecute(DefaultMaven.java:307)</div><div class="line">    	at org.apache.maven.DefaultMaven.doExecute(DefaultMaven.java:193)</div><div class="line">    	at org.apache.maven.DefaultMaven.execute(DefaultMaven.java:106)</div><div class="line">    	at org.apache.maven.cli.MavenCli.execute(MavenCli.java:863)</div><div class="line">    	at org.apache.maven.cli.MavenCli.doMain(MavenCli.java:288)</div><div class="line">    	at org.apache.maven.cli.MavenCli.main(MavenCli.java:199)</div><div class="line">    	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">    	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</div><div class="line">    	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">    	at java.lang.reflect.Method.invoke(Method.java:497)</div><div class="line">    	at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced(Launcher.java:289)</div><div class="line">    	at org.codehaus.plexus.classworlds.launcher.Launcher.launch(Launcher.java:229)</div><div class="line">    	at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode(Launcher.java:415)</div><div class="line">    	at org.codehaus.plexus.classworlds.launcher.Launcher.main(Launcher.java:356)</div><div class="line">    [INFO] Started SelectChannelConnector@0.0.0.0:8080</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://dubbo.io/User+Guide-zh.htm" target="_blank" rel="external">http://dubbo.io/User+Guide-zh.htm</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java的volatile浅解]]></title>
      <url>http://www.nikoai.pw/2016/04/07/java/concurrent/java_volatile/</url>
      <content type="html"><![CDATA[<p>java的volatile经常见到, 可惜不少程序员都不太了解其用法及工作原理. 很多东西如果不懂其实现原理和机制, 就使用的话, 少不了会埋下许多炸弹, 有时候可能造成严重损失.</p>
<p>因此, 接下来就简单介绍一下volatile的作用和实现原理:</p>
<h1 id="线程内存模型"><a href="#线程内存模型" class="headerlink" title="线程内存模型"></a>线程内存模型</h1><hr>
<p>为什么要说这个呢? 理解Java的线程内存模型有助于我们更好地理解volatile的工作方式.<br>若想了解, 可查看<a href="/2016/04/06/java/concurrent/java_thread_memory_model/">另一篇博客</a></p>
<h1 id="volatile-作用"><a href="#volatile-作用" class="headerlink" title="volatile 作用"></a>volatile 作用</h1><hr>
<h2 id="1-可见性"><a href="#1-可见性" class="headerlink" title="1. 可见性"></a>1. 可见性</h2><p>我们为什么使用volatile, 相信大部分人都是为了可见性, 保证变量对所有线程的可见性. 比如一条线程修改了变量值, 其他线程可以马上得知.</p>
<p>某些情况来说, volatile可以避免一致性问题, 因为在使用前都会刷新, 但是在比如自增操作的情况下, 就会有并发一致性的问题.</p>
<p>我们都知道<code>i++</code>, 转成字节码是有4个指令:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">getstatic</div><div class="line">iconst_1</div><div class="line">iadd</div><div class="line">putstatic</div></pre></td></tr></table></figure>
<p>在<code>getstatic</code>时, volatile保证了此时的i值是最新的; 但是接下来到<code>pustatic</code>同步回主内存的这个期间, 可能有其他线程更新的i值, 导致数据不一致.</p>
<p>需要注意, 这些字节码指令也不一定是原子操作(<code>-XX:+PrintAssembly</code>可查看汇编指令). 因此, volatile只能保证可见性, 而非一致性. 有些场景我们还是需要用锁来保证原子性(或者使用CAS).</p>
<h3 id="其他方法实现可见性"><a href="#其他方法实现可见性" class="headerlink" title="其他方法实现可见性:"></a>其他方法实现可见性:</h3><p>除了volatile, 还有两个关键字能实现可见性: <code>synchronized</code>和<code>final</code>.<br>synchronized: 在unlock前, 会把数据同步回主内存(store + write).<br>final: 构造器初始化完成后, 变量的值就固定了.</p>
<h2 id="2-禁止指令重排序优化"><a href="#2-禁止指令重排序优化" class="headerlink" title="2. 禁止指令重排序优化"></a>2. 禁止指令重排序优化</h2><blockquote>
<p>大多数现代微处理器都会采用将指令乱序执行的方法（out-of-order execution，简称OoOE或OOE）,在条件允许的情况下，直接运行当前有能力立即执行的后续指令，避开获取下一条指令所需数据时造成的等待, 这样可以大大提高执行效率。JIT编译器也会做指令重排序操作4，即生成的机器指令与字节码指令顺序不一致。</p>
</blockquote>
<p>具体可以看下面的两个例子:</p>
<h3 id="例子1-提前执行"><a href="#例子1-提前执行" class="headerlink" title="例子1: 提前执行"></a>例子1: 提前执行</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// 初始化</div><div class="line">volatile boolean initialized = false;</div><div class="line">...</div><div class="line">doInit();</div><div class="line">initialized = true;</div><div class="line"></div><div class="line">// 线程2</div><div class="line">while (!initialized) &#123;</div><div class="line">    sleep();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中的<code>initialized</code>用了volatile修饰, 若非如此, <code>initialized = true</code>可能被提前执行. 因为机器级别的重排序优化, 把该代码的汇编指令提前执行了, 使用volatile就可以避免这种情况的发生.</p>
<h3 id="例子2-双重检查"><a href="#例子2-双重检查" class="headerlink" title="例子2: 双重检查"></a>例子2: 双重检查</h3><p>相信看过GOF的<code>&lt;设计模式&gt;</code>的同学, 应该记得单例模式那部分有提到双重检查延迟初始化的代码, 大概是这样的:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public class VolatileSingleton &#123;</div><div class="line">    private volatile static VolatileSingleton instance;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        VolatileSingleton.getInstance();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static VolatileSingleton getInstance() &#123;</div><div class="line">        if (instance == null) &#123;</div><div class="line">            synchronized (VolatileSingleton.class) &#123;</div><div class="line">                if (instance == null) &#123;</div><div class="line">                    instance = new VolatileSingleton();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>instance</code>用了<code>volatile</code>修饰, 为什么呢? 我们看一下打印出来的汇编代码 :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">0x00007f512d108fae: mov    0x20(%rsp),%rsi</div><div class="line">0x00007f512d108fb3: mov    %rsi,%r10</div><div class="line">0x00007f512d108fb6: shr    $0x3,%r10</div><div class="line">0x00007f512d108fba: mov    %r10d,0x68(%rax)</div><div class="line">0x00007f512d108fbe: shr    $0x9,%rax</div><div class="line">0x00007f512d108fc2: mov    $0x7f513f242000,%rsi</div><div class="line">0x00007f512d108fcc: movb   $0x0,(%rax,%rsi,1)</div><div class="line">0x00007f512d108fd0: lock addl $0x0,(%rsp)     ;*putstatic instance</div><div class="line">                                              ; - org.niko.xxx.VolatileSingleton::getInstance@24 (line 18)</div></pre></td></tr></table></figure>
<p>其中<code>lock addl $0x0,(%rsp)</code>操作(如果去掉<code>volatile</code>的话, 将不会有这一句), 把rsp的内容加0, 这个相当于什么都没做, 这个有什么作用呢? 其实这个和lock搭配, 相当于一个<code>内存屏障</code>, 他会把前面的修改内容同步到内存, 同时通知到缓存子系统.<br>(那为什么不用<code>nop</code>呢? 因为lock不允许和nop搭配使用) lock操作会把高速缓存写入内存, 并促发其他CPU或内存去invalidate自己的cache.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://en.wikipedia.org/wiki/Memory_barrier" target="_blank" rel="external">https://en.wikipedia.org/wiki/Memory_barrier</a><br><a href="http://tech.meituan.com/java-memory-reordering.html" target="_blank" rel="external">http://tech.meituan.com/java-memory-reordering.html</a><br>周志明 - [深入理解Java虚拟机.JVM高级特性与最佳实践]</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java thread 内存模型]]></title>
      <url>http://www.nikoai.pw/2016/04/06/java/concurrent/java_thread_memory_model/</url>
      <content type="html"><![CDATA[<p>java 线程内存模型, 是由虚拟机规范定义, 旨在屏蔽不同平台硬件和操作系统的差异, 使Java程序在不同平台表现出相同的并发行为和结果, 进行无歧义的内存并发访问操作, 同时让虚拟机也能利用不同硬件和平台的特性去表现更好的性能. (与此相关的规范是: <a href="https://jcp.org/aboutJava/communityprocess/final/jsr133/index.html" target="_blank" rel="external">JSR-133</a>)</p>
<h1 id="主内存和工作内存"><a href="#主内存和工作内存" class="headerlink" title="主内存和工作内存"></a>主内存和工作内存</h1><hr>
<p>首先要先介绍主内存和工作内存, 这两者到底是什么呢? 周志明的书<code>&lt;深入理解Java虚拟机&gt;</code>中有一幅图, 描述两者的关系:</p>
<p><img src="/images/java/main_working_memory.png" alt=""></p>
<p>如果要快速地理解他们之间的关系, 可以类比CPU/高速缓存/内存的关系(对应线程/工作内存/主内存).</p>
<p>映射到底层来看, 主内存在物理硬件内存中, 工作内存可能会存在于寄存器或高速缓存.</p>
<h1 id="线程操作术语和框架"><a href="#线程操作术语和框架" class="headerlink" title="线程操作术语和框架"></a>线程操作术语和框架</h1><hr>
<p>以下操作都是原子的:</p>
<ul>
<li><code>lock</code></li>
</ul>
<p>锁定一个变量为某个线程独占</p>
<ul>
<li><code>unlock</code></li>
</ul>
<p>释放已lock的变量</p>
<ul>
<li><code>read</code></li>
</ul>
<p>从主内存读取variable到工作内存</p>
<ul>
<li><code>load</code></li>
</ul>
<p>把read到的variable放入工作内存的变量副本</p>
<ul>
<li><code>use</code></li>
</ul>
<p>把工作内存的变量传递给执行引擎</p>
<ul>
<li><code>assign</code></li>
</ul>
<p>执行引擎通过此操作值赋给工作内存的变量</p>
<ul>
<li><code>store</code></li>
</ul>
<p>把工作内存的一个变量值送到主内存中</p>
<ul>
<li><code>write</code></li>
</ul>
<p>把store送到主内存的值写到主内存变量中</p>
<p>以上八个操作更详细的介绍可以从这个<a href="https://docs.oracle.com/javase/specs/jvms/se6/html/Threads.doc.html" target="_blank" rel="external">JVM Specs 文档</a>中查阅.</p>
<h1 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h1><hr>
<p>有了以上8种基本操作, 可以观察到, 这些操作的一些pattern组合是有意义的, 一些是不合法无意义的. 因此我们还需要一些规则来限定这些操作的顺序和组合, 如下:</p>
<h2 id="变量规则"><a href="#变量规则" class="headerlink" title="变量规则"></a>变量规则</h2><ul>
<li>不允许丢失最近的<code>assign</code>, 必须把工作内存的变化同步回主内存</li>
<li>不允许线程没有发生<code>assign</code>就把内容同步回主内存.</li>
<li>新线程创建时工作内存是空的, 而且需从主内存获取(即use/store前必须已经assign/load)</li>
<li>read+load和store+write是成对按顺序出现的, 从主内存read了, 工作内存就必须接受; store了主内存, 主内存就必须write</li>
</ul>
<h2 id="lock-规则"><a href="#lock-规则" class="headerlink" title="lock 规则"></a>lock 规则</h2><ul>
<li>同一时刻只能有一个线程进行lock操作, 但同一线程可以lock多次, 同时unlock也需要执行相同的次数.</li>
<li>不允许lock未被lock的以及被其他线程lock住的变量</li>
</ul>
<h2 id="lock和变量互动规则"><a href="#lock和变量互动规则" class="headerlink" title="lock和变量互动规则"></a>lock和变量互动规则</h2><ul>
<li>unlock时, 必须把内容同步会主内存</li>
<li>当lock某个变量时, 会清空工作内存中的该变量的值, 当执行引擎使用到该变量时, 从主内存进行load或assign.</li>
</ul>
<h1 id="先行发生原则"><a href="#先行发生原则" class="headerlink" title="先行发生原则"></a>先行发生原则</h1><hr>
<p>观察上面这些规则的设计, 可以发现是比较严谨繁琐的. 但写代码时, 我们判断是否<code>线程安全</code>的方法用的是<code>先行发生(happens-before)原则</code>. 如果程序不在该规则及其推导中, 那么就不是线程安全的. 以下是<a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html#jls-17.4.5" target="_blank" rel="external">主要规则</a>:</p>
<ul>
<li>一个线程内, 代码按控制流顺序执行</li>
<li>监视器上的unlock先于器lock操作</li>
<li>volatile的write先于随后的read</li>
<li>start()的调用先于此线程的所有action</li>
<li>所有action先于该线程的join()返回</li>
<li>对象初始化操作先于其他action</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://jcp.org/aboutJava/communityprocess/final/jsr133/index.html" target="_blank" rel="external">JSR-133</a><br><a href="http://gvsmirnov.ru/blog/tech/2014/02/10/jmm-under-the-hood.html" target="_blank" rel="external">Java Memory Model Under The Hood</a><br><a href="https://docs.oracle.com/javase/specs/jvms/se6/html/Threads.doc.html" target="_blank" rel="external">VM Spec Threads and Locks</a><br><a href="https://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html" target="_blank" rel="external">Chapter 17. Threads and Locks</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Java 并发之 CAS]]></title>
      <url>http://www.nikoai.pw/2016/04/05/java/concurrent/CAS_ABA_Java/</url>
      <content type="html"><![CDATA[<h1 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h1><hr>
<p>CAS, 全称是Compare-and-swap, 是多线程同步的一种原子操作. 它把预期值E(expected memory value)和内存中的M(memory value)进行比较, 如果没其他线程修改M, 那么E和M将是相同的, 然后可将M修改为N(new value), 这是一个<code>原子操作</code>. 如果更改的同时, M被其他线程修改了, M和E一般来说不相同, 那么修改就会失败.</p>
<p>CAS操作基于<code>CPU提供的原子操作</code>指令实现(现在几乎所有的CPU指令都支持CAS的原子操作，X86下对应的是 CMPXCHG 汇编指令), 这是保证数据一致的根本, 也是Java concurrent包并发机制的基础之一, 使用上CAS常被用于实现<code>无锁队列</code>.</p>
<p>从CAS的机制可以发现, 这和<code>乐观锁</code>很相似, 它假设在它修改之前，没有其它线程修改它, 直到提交的时候才进行检查；而synchronized是一种<code>悲观的策略</code>, 它假设会有线程同时修改它, 因此一开始就锁定, 无论是否真的有线程修改它, 因此性能比较低.</p>
<h2 id="以AtomicInteger为例"><a href="#以AtomicInteger为例" class="headerlink" title="以AtomicInteger为例:"></a>以AtomicInteger为例:</h2><p>这里使用的是 Jdk 8:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// setup to use Unsafe.compareAndSwapInt for updates</div><div class="line">private static final Unsafe unsafe = Unsafe.getUnsafe();</div><div class="line"></div><div class="line">public final int incrementAndGet() &#123;</div><div class="line">    return unsafe.getAndAddInt(this, valueOffset, 1) + 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">public final boolean compareAndSet(int expect, int update) &#123;</div><div class="line">    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这两个方法的实现要看openjdk8中的<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/misc/Unsafe.java" target="_blank" rel="external"><code>sun.misc.Unsafe.java</code></a> :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public final int getAndAddInt(Object o, long offset, int delta) &#123;</div><div class="line">    int v;</div><div class="line">    do &#123;</div><div class="line">        v = getIntVolatile(o, offset);</div><div class="line">    &#125; while (!compareAndSwapInt(o, offset, v, v + delta));</div><div class="line">    return v;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">public final native boolean compareAndSwapInt(java.lang.Object o, long l, int i, int i1);</div></pre></td></tr></table></figure>
<p>可知, 底层还是依赖native方法compareAndSwapInt(), 进行CAS的操作, 因此这个方法在concurrent和locks包中被大量使用.</p>
<h1 id="ABA-问题"><a href="#ABA-问题" class="headerlink" title="ABA 问题"></a>ABA 问题</h1><hr>
<p>CAS很好, 不过也有一个问题: <code>ABA问题</code>, 简单来说就是:</p>
<ol>
<li>一个进程P1读取值的时候是A</li>
<li>然后因为一些原因被挂起(时间片耗尽、中断等)</li>
<li>另一个进程P2把A改成了B, 然后又改回了A</li>
<li>P1被唤醒, 发现值仍然是A, 没有变化, 于是继续执行</li>
</ol>
<p>这个在某些场景下, 可能不会影响正确结果. 但是, 比如在设计一个队列时, <strong>地址重用机制</strong> 将可能导致top指针异常错乱和误修改next元素. <a href="https://en.wikipedia.org/wiki/Compare-and-swap" target="_blank" rel="external">这里有个案例</a></p>
<p><a href="https://en.wikipedia.org/wiki/Compare-and-swap" target="_blank" rel="external">wikipedia给出的一种解决方法</a> 是增加引用计数或者timeStamp(如Java的<code>AtomicStampedReference</code>).</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://en.wikipedia.org/wiki/Compare-and-swap" target="_blank" rel="external">https://en.wikipedia.org/wiki/Compare-and-swap</a><br><a href="http://coolshell.cn/articles/8239.html" target="_blank" rel="external">http://coolshell.cn/articles/8239.html</a><br><a href="http://www.ibm.com/developerworks/java/library/j-jtp04186/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/java/library/j-jtp04186/index.html</a><br><a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/misc/Unsafe.java" target="_blank" rel="external">http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/sun/misc/Unsafe.java</a><br><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.53.8674&amp;rep=rep1&amp;type=pdf" target="_blank" rel="external">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.53.8674&amp;rep=rep1&amp;type=pdf</a><br><a href="http://www.ibm.com/developerworks/cn/aix/library/au-multithreaded_structures2/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/aix/library/au-multithreaded_structures2/index.html</a><br><a href="http://blog.hesey.net/2011/09/resolve-aba-by-atomicstampedreference.html" target="_blank" rel="external">http://blog.hesey.net/2011/09/resolve-aba-by-atomicstampedreference.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[荣耀6刷入CM11]]></title>
      <url>http://www.nikoai.pw/2016/04/04/linux/android/honor6_root_rom/</url>
      <content type="html"><![CDATA[<h1 id="刷入过程"><a href="#刷入过程" class="headerlink" title="刷入过程"></a>刷入过程</h1><h2 id="0-准备"><a href="#0-准备" class="headerlink" title="0. 准备"></a>0. 准备</h2><ul>
<li>下载recovery和SU：<a href="http://forum.xda-developers.com/honor-6/orig-development/recovery-clockworkmod-recovery-t3060113" target="_blank" rel="external">http://forum.xda-developers.com/honor-6/orig-development/recovery-clockworkmod-recovery-t3060113</a></li>
<li>下载ROM：<a href="http://forum.xda-developers.com/honor-6/orig-development/rom-cyanogenmod-11-honor-6-t3019056" target="_blank" rel="external">http://forum.xda-developers.com/honor-6/orig-development/rom-cyanogenmod-11-honor-6-t3019056</a></li>
<li>保证1G的TF卡空闲空间</li>
</ul>
<h2 id="1-解锁"><a href="#1-解锁" class="headerlink" title="1. 解锁"></a>1. 解锁</h2><p>官网解锁说明：<a href="https://emui.huawei.com/cn/plugin.php?id=unlock&amp;mod=step" target="_blank" rel="external">https://emui.huawei.com/cn/plugin.php?id=unlock&amp;mod=step</a><br>获取解锁码：<a href="https://www.emui.com/plugin.php?id=unlock" target="_blank" rel="external">https://www.emui.com/plugin.php?id=unlock</a></p>
<h2 id="2-第三方recovery和root"><a href="#2-第三方recovery和root" class="headerlink" title="2. 第三方recovery和root"></a>2. 第三方recovery和root</h2><p>adb 连接手机，刷入recovery（ClockworkMod）：</p>
<pre><code>fastboot flash recovery cwm-6.0.5.1_2015xxxx_h60_l0x.img
（cwm-6.0.5.1_2015xxxx_h60_l0x.img 太长了，最好改个名）
</code></pre><p>进入recovery，安装SuperSU。</p>
<h2 id="3-ROM"><a href="#3-ROM" class="headerlink" title="3. ROM"></a>3. ROM</h2><p>我的是H60-L01,<code>20150822</code>这个版本已经可以使用<code>cm-11-20150822-UNOFFICIAL-h60_l02.zip</code>ROM了，有些教程会让你改<code>META-INF/com/google/android/updater-script</code>来跳过机型验证，这个版本的ROM并不需要。<br>由于我改了<code>updater-script</code>导致无法刷入，然而重新启动后，卡在开机画面无法继续。我必须拷贝原ROM到TF卡，再重新进入recovery。</p>
<p>然而，坑爹的是，荣耀6按住电源键10秒可以重启，没有强制关机的方法。而进入recovery必须在关机状态下，按住<code>电源和音量+</code>键。</p>
<p>所以准备拔电源了，但是荣耀拔电源是在苦逼，掀了后盖后缺少螺丝刀，于是去午睡准备晚上接着搞。<br>午休时迷迷糊糊灵光一现，能不能在重启的时候，有那几秒，快速进入recovery模式呢？哈哈，问题解决！插入TF卡，5分钟不到，就刷入了CM11。比起之前的EMUI，这流畅度简直让人上天啊。<br>好困，午休就这么过去了～～</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>【1】<a href="http://cn.club.vmall.com/forum.php?mod=viewthread&amp;tid=3280749&amp;highlight=%E9%B9%B0%E7%9C%BC" target="_blank" rel="external">http://cn.club.vmall.com/forum.php?mod=viewthread&amp;tid=3280749&amp;highlight=%E9%B9%B0%E7%9C%BC</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[motorola defy 刷到 android 4.4]]></title>
      <url>http://www.nikoai.pw/2016/04/01/linux/defy_to_cm_android44/</url>
      <content type="html"><![CDATA[<p>motorola defy，相信是很多人的回忆，他伴随我走过了大学四年，只要我在手里，就感觉是会到了大学校园，教室的最后一排。然而现在很多App已经不能安装了，因为系统仍然是2.x版本，所以需要升级到<code>4.x</code>才能重生。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>我的机子是android 2.3版本的，已root。<br>所以需要的工具只是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">终端模拟器.apk</div><div class="line">cm-11-20160330-NIGHTLY-mb52x.zip</div><div class="line">defy_bootstrap_ext3.img</div><div class="line">resize.zip</div></pre></td></tr></table></figure>
<p>模拟器需要先安装，后面三个文件要放到SD卡根目录。</p>
<h2 id="开搞"><a href="#开搞" class="headerlink" title="开搞"></a>开搞</h2><p>这次的刷机比以前简单多了，首先，安装完终端模拟器，进入终端使用<code>su</code>命令获取root权限：</p>
<p>把img写入<code>/dev/block/mmcblk1p21</code>  ：</p>
<pre><code>cat /sdcard/defy_bootstrap_ext3.img &gt; /dev/block/mmcblk1p21
</code></pre><p>重启，若无反应，拔电池重新开机：</p>
<p><img src="/images/defy_android44_recovery_home.jpg" alt=""></p>
<p>从图标可以看出，对应了手机底部的几个物理按键，选择<code>recovery</code>：</p>
<p>然后点击<code>install</code>， 进入sdcard选择<code>resize.zip</code>，滑动按钮到右边进行install：</p>
<p>重启：</p>
<p>再次进入recovery和install，这次选择<code>cm-11-20160330-NIGHTLY-mb52x.zip</code>，这次文件比较大，会比上次时间长一点，完成后选择<code>reboot system</code>：</p>
<p>这次进入home界面时，选择<code>Continue</code>进入系统，系统会有2～3分钟的loading动画进行初始化操作，然后就进入用户界面的初始设置，升级complete：</p>
<p><img src="/images/defy_android44_installed.jpg" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
<p><a href="http://tieba.baidu.com/p/3600016194" target="_blank" rel="external">http://tieba.baidu.com/p/3600016194</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[linux下ssd的4k对齐和trim]]></title>
      <url>http://www.nikoai.pw/2016/03/28/linux/tools/ssd_4k_trim/</url>
      <content type="html"><![CDATA[<h1 id="4K-对齐"><a href="#4K-对齐" class="headerlink" title="4K 对齐"></a>4K 对齐</h1><h2 id="为什么要4k对齐呢"><a href="#为什么要4k对齐呢" class="headerlink" title="为什么要4k对齐呢?"></a>为什么要4k对齐呢?</h2><p>主要是为了提高性能和延长寿命, 尤其是运行在window系统和NTFS格式的.</p>
<blockquote>
<p>從Windows NT開始，微軟導入了「NTFS」這個格式，自此取代了長久以來一直使用的FAT╱FAT32，一直到XP所使用的NTFS 5.X版本以來，硬碟分割區都是從第63個扇區開始（請注意這裡的扇區指的是傳統硬碟喔，不過XP並不會認SSD，所以一律都是以此方式來分割），也就是會保留512Byte＊63=31.5KB的空間大小才開始第一個分區，因此假如你的SSD沒有做過對齊的話，每128個叢集就會跨越兩個block，如果系統剛好操作到跨越兩個block之間的叢集時，就要同時擦除那是不是SSD就得同時操作兩個page來搬移寫入呢？這樣效能一定會下降，因此從Vista開始，就支援將NTFS磁區的起始點設定為4的倍數，這樣一來就不會在出現性能下降的情形，而將分割區設定為4可以整除的數字開始，就稱為「對齊」。</p>
</blockquote>
<p>下面是没有对齐的:</p>
<p><img src="/images/linux/kha7bnwQpeg5sBhVVLPA_unaligned.png" alt=""></p>
<p>下图是对齐之后的:</p>
<p><img src="/images/linux/pVxPJVszQR2MpN0SMBuj_aligned.png" alt=""></p>
<p>更多内容可以参考<a href="http://www.techbang.com/posts/10651-ssd-tuning-practice-3-4k-alignment-upgrade-ssd-performance-cheat-secretly-reported-63-issues-cover-story" target="_blank" rel="external">这个</a></p>
<h2 id="如何查看是否4k对齐呢"><a href="#如何查看是否4k对齐呢" class="headerlink" title="如何查看是否4k对齐呢 ?"></a>如何查看是否4k对齐呢 ?</h2><pre><code>sudo fdisk -l
</code></pre><p>查看<code>Primary分区</code>的start栏是否能被8整除, <code>Extended</code>分区可能不能整除8, 不用担心. 如果是ext4, 那是自动对齐的.</p>
<h2 id="进行-4k-对齐"><a href="#进行-4k-对齐" class="headerlink" title="进行 4k 对齐"></a>进行 4k 对齐</h2><p>window下面可以用系统自带工具或<code>DiskGenius</code>进行分区, linux下使用<code>gparted</code>等.</p>
<h1 id="trim"><a href="#trim" class="headerlink" title="trim"></a>trim</h1><hr>
<p>首先我们需要了解一下什么是trim ?</p>
<blockquote>
<p>一般来说, 存储设备只知道哪些地方存了数据，但不知道这个数据到底还有没有用（因为文件删除之后，数据实际上可能还留在数据块中），数据有没有用只有操作系统才知道。</p>
<p>对于物理存储设备来说，“写入空白数据块”和“覆盖已有内容的数据块”所需要的操作是完全相同的。</p>
</blockquote>
<p>上面的结论对机械硬盘成立, 但SSD却不是.</p>
<blockquote>
<p>由于硬件方面的限制，SSD单独对某个页面进行读/写的操作，但擦除操作却只能对整个块进行，也就是说，一旦擦除就必须一次性擦除整个块。</p>
<p>在SSD中，数据存储的最小单位是页面（page），一个页面的大小一般是4KB，若干个页面又被组合成块（block），一个块的大小一般是512KB。由于硬件方面的限制，SSD单独对某个页面进行读/写的操作，但擦除操作却只能对整个块进行，也就是说，一旦擦除就必须一次性擦除整个块。</p>
<p>想想看，如果操作系统要让SSD改写某个页面的数据，SSD需要执行怎样的操作呢：<br>将要改写的目标页面所在的整个块的数据读取到缓存。w<br>在缓存中修改目标页面的数据。<br>对整个块执行擦除操作。<br>将缓存中的数据重新写入整个块中。</p>
</blockquote>
<p>这就意味着，如果我要修改某个4KB大小的页面，就必须把512KB大小的整个块都折腾一遍，大家应该可以想象出这将带来何等巨大的性能和寿命上的损失。</p>
<blockquote>
<p>SSD中提供了一个TRIM命令，操作系统在删除文件时可以通过向SSD发送TRIM命令告诉它哪些数据块中的数据已经不再使用了。SSD在收到TRIM命令后，通常会在定期的垃圾收集操作中重新组织这些区块，为将来写入数据做好准备，不过每一款SSD在底层对TRIM命令的执行机制都不尽相同，但无论如何，通过TRIM能够显著改善SSD的性能和寿命。当然，大家可能已经发现了，有了TRIM，删除的文件数据会被SSD自动回收，这意味着以往在传统硬盘上能够使用的一些数据恢复（反删除）软件，在SSD上可能就不再管用了。</p>
</blockquote>
<h2 id="启用trim"><a href="#启用trim" class="headerlink" title="启用trim"></a>启用trim</h2><h2 id="方法一-discard"><a href="#方法一-discard" class="headerlink" title="方法一: discard"></a>方法一: discard</h2><pre><code>vim /etc/fstab
</code></pre><p>为SSD的每个分区option中加上<code>discard</code>选项, 每当系统删除文件时, 就会通知ssd进行trim. 可知, 当删除大量文件时, 性能也会有所下降的.<br>更多内容可参考<a href="https://patrick-nagel.net/blog/archives/337" target="_blank" rel="external">这里</a></p>
<h2 id="方法二-使用-cron-按计划执行-fstrim"><a href="#方法二-使用-cron-按计划执行-fstrim" class="headerlink" title="方法二: 使用 cron 按计划执行 fstrim"></a>方法二: 使用 cron 按计划执行 fstrim</h2><pre><code>sudo vim /etc/cron.daily/trim
</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">LOG=/var/log/trim.log</div><div class="line">echo &quot;*** $(date -R) ***&quot; &gt;&gt; $LOG</div><div class="line">fstrim -v / &gt;&gt; $LOG</div></pre></td></tr></table></figure>
<pre><code>sudo chmod +x /etc/cron.daily/trim
</code></pre><p>我的<code>/</code>目录时我要trim的ssd分区, 这个根据情况来设置.</p>
<p>至于cron.daily的具体执行时间, 是在6:25, 如下(<code>cat /etc/crontab</code>):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/crontab</div><div class="line"># /etc/crontab: system-wide crontab</div><div class="line"># Unlike any other crontab you don&apos;t have to run the `crontab&apos;</div><div class="line"># command to install the new version when you edit this file</div><div class="line"># and files in /etc/cron.d. These files also have username fields,</div><div class="line"># that none of the other crontabs do.</div><div class="line"></div><div class="line">SHELL=/bin/sh</div><div class="line">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</div><div class="line"></div><div class="line"># m h dom mon dow user	command</div><div class="line">17 *	* * *	root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</div><div class="line">25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</div><div class="line">47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )</div><div class="line">52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )</div></pre></td></tr></table></figure>
<h1 id="查看-fstrim-结果"><a href="#查看-fstrim-结果" class="headerlink" title="查看 fstrim 结果"></a>查看 fstrim 结果</h1><p>每天可以从日志中查看trim结果, <code>tail /var/log/trim.log</code>, 如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">*** Fri, 12 Aug 2016 08:26:23 +0800 ***</div><div class="line">/: 426609340416 bytes were trimmed</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>[1] Ubuntu 固态硬盘 4K 对齐及启用 Trim - <a href="http://www.slblog.net/2013/07/enable-trim-and-perform-4k-alignment-in-ubuntu/" target="_blank" rel="external">http://www.slblog.net/2013/07/enable-trim-and-perform-4k-alignment-in-ubuntu/</a><br>[2] 【无聊科普】固态硬盘（SSD）为什么需要TRIM？ - <a href="http://www.guokr.com/blog/483475/" target="_blank" rel="external">http://www.guokr.com/blog/483475/</a><br>[3] Ubuntu 固态硬盘 4K对齐及启用 Trim，及其验证方法 - <a href="http://www.cnblogs.com/welhzh/p/4261348.html" target="_blank" rel="external">http://www.cnblogs.com/welhzh/p/4261348.html</a><br>[4] <a href="http://pcedu.pconline.com.cn/504/5047738_all.html" target="_blank" rel="external">你以为数据都被删除了？谈彻底删除文件 </a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[disconf - 【1】 server 搭建]]></title>
      <url>http://www.nikoai.pw/2016/03/01/java/dist/disconf_1_server/</url>
      <content type="html"><![CDATA[<p>disconf是分布式配置管理服务平台，目前已经在 百度、滴滴出行、银联、网易、拉勾网、苏宁易购等公司使用，专注于解决分布式环境下的配置管理。</p>
<h1 id="部署web-server："><a href="#部署web-server：" class="headerlink" title="部署web server："></a>部署web server：</h1><hr>
<p>要使用disconf，首先需要搭建disconf服务端先，不过先把项目clone下来：</p>
<pre><code>git clone https://github.com/knightliao/disconf
</code></pre><h2 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h2><pre><code>mkdir /home/work/dsp/disconf-rd/online-resources
mkdir /home/work/dsp/disconf-rd/war
</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd  $DISCONF_HOME/disconf-web/</div><div class="line">cp  profile/rd/application-demo.properties /home/work/dsp/disconf-rd/online-resources/application.properties</div><div class="line">cp  profile/rd/jdbc-mysql.properties /home/work/dsp/disconf-rd/online-resources/</div><div class="line">cp  profile/rd/redis-config.properties /home/work/dsp/disconf-rd/online-resources/</div><div class="line">cp  profile/rd/zoo.properties /home/work/dsp/disconf-rd/online-resources/</div></pre></td></tr></table></figure>
<h2 id="build-amp-deploy"><a href="#build-amp-deploy" class="headerlink" title="build &amp; deploy"></a>build &amp; deploy</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ONLINE_CONFIG_PATH=/home/work/dsp/disconf-rd/online-resources</div><div class="line">WAR_ROOT_PATH=/home/work/dsp/disconf-rd/war</div><div class="line">export ONLINE_CONFIG_PATH</div><div class="line">export WAR_ROOT_PATH</div><div class="line">cd disconf-web</div><div class="line">sh deploy/deploy.sh</div></pre></td></tr></table></figure>
<h2 id="准备mysql"><a href="#准备mysql" class="headerlink" title="准备mysql"></a>准备mysql</h2><p>修改mysql用户和密码：</p>
<pre><code>vim /home/work/dsp/disconf-rd/online-resources/jdbc-mysql.properties
</code></pre><p>初始化数据库：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mysql&gt; source 0-init_table.sql</div><div class="line">mysql&gt; source 1-init_data.sql</div><div class="line">mysql&gt; source 201512/20151225.sql</div></pre></td></tr></table></figure></p>
<h2 id="准备Redis"><a href="#准备Redis" class="headerlink" title="准备Redis"></a>准备Redis</h2><p>默认配置，启动就行了。参考官方文档：<a href="http://redis.io/download" target="_blank" rel="external">http://redis.io/download</a></p>
<h2 id="准备zookeeper"><a href="#准备zookeeper" class="headerlink" title="准备zookeeper"></a>准备zookeeper</h2><p>默认的disconf的zookeeper客户端配置是三个实例的，如果只是为了体验disconf，可以改成standalone的配置。<br>修改zookeeper服务器的<code>clientPort</code>，使和disconf的zkClient配置一致：</p>
<p>vim $ZK_HOME/conf/zoo.cfg</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">##############</div><div class="line">clientPort=8581</div><div class="line">##############</div></pre></td></tr></table></figure>
<p>其他同理（127.0.0.1:8582,127.0.0.1:8583…）。</p>
<h2 id="准备tomcat"><a href="#准备tomcat" class="headerlink" title="准备tomcat"></a>准备tomcat</h2><p>vim $TOMCAT_HOME/conf/server.xml<br>在Host结点下增加：</p>
<pre><code>&lt;Context path=&quot;&quot; docBase=&quot;/home/work/dsp/disconf-rd/war&quot;&gt;&lt;/Context&gt;
</code></pre><p>访问端口设为<code>8015</code>。</p>
<h2 id="准备nginx"><a href="#准备nginx" class="headerlink" title="准备nginx"></a>准备nginx</h2><p>vim /path/nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">upstream disconf &#123;</div><div class="line">    server 127.0.0.1:8015;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line"></div><div class="line">    listen   8081;</div><div class="line">    server_name localhost;</div><div class="line">    access_log /home/work/var/logs/disconf/access.log;</div><div class="line">    error_log /home/work/var/logs/disconf/error.log;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        root /home/work/dsp/disconf-rd/war/html;</div><div class="line">        # niko , use alias if root not working</div><div class="line">        # alias /home/work/dsp/disconf-rd/war/html/;</div><div class="line">        if ($query_string) &#123;</div><div class="line">            expires max;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location ~ ^/(api|export) &#123;</div><div class="line">        proxy_pass_header Server;</div><div class="line">        proxy_set_header Host $http_host;</div><div class="line">        proxy_redirect off;</div><div class="line">        proxy_set_header X-Real-IP $remote_addr;</div><div class="line">        proxy_set_header X-Scheme $scheme;</div><div class="line">        proxy_pass http://disconf;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>记得要</p>
<pre><code>mkdir /home/work/var/logs/disconf/ -p
</code></pre><p>如果没有该目录，无法访问页面。</p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>完成以上的搭建后，访问<code>http://localhost:8081/main.html</code>，就可以看到管理页面了（账号密码是<code>admin/admin</code>）。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>【1】<a href="https://github.com/knightliao/disconf" target="_blank" rel="external">https://github.com/knightliao/disconf</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Git钩子Script之客户端`pre-push`]]></title>
      <url>http://www.nikoai.pw/2016/02/22/git/git-prevent-push-master-by-hook/</url>
      <content type="html"><![CDATA[<p>有个童鞋说，老是会忘记当前分支和误推了master，有没有办法防止这种低级错误。好吧，发生这种事，其实是那个repo没有设置服务器钩子脚本，来防止客户端的推送操作（我们用的不是gitlab，没有那种功能，暂时是人为终端控制）。<code>%&gt;_&lt;%</code>，我们要实现童鞋想要的功能，需要使用到 git hook scripts，git hook scripts又分为客户端和服务器端两种：</p>
<p><code>client side</code></p>
<ul>
<li>pre-commit</li>
<li>prepare-commit-msg</li>
<li>commit-msg</li>
<li>post-commit</li>
<li>post-merge</li>
<li>pre-push<br>…</li>
</ul>
<p><code>server side</code></p>
<ul>
<li>pre-receive</li>
<li>update</li>
<li>post-receive</li>
</ul>
<p>博客后面的链接【1】可以了解所有的script，这里需要的是叫做<code>pre-push</code>的script。</p>
<h1 id="pre-push"><a href="#pre-push" class="headerlink" title="pre-push"></a>pre-push</h1><p>首先，我们把工作目录切到git repo的根目录，然后编写<code>.git/hooks/pre-push</code>文件：</p>
<pre><code>vim .git/hooks/pre-push
</code></pre><p>文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"># Prevents force-pushing to master.</div><div class="line"># Based on: https://gist.github.com/pixelhandler/5718585</div><div class="line"># Install:</div><div class="line"># cd path/to/git/repo</div><div class="line"># curl -fL -o .git/hooks/pre-push https://gist.githubusercontent.com/stefansundin/d465f1e331fc5c632088/raw/pre-push</div><div class="line"># chmod +x .git/hooks/pre-push</div><div class="line"></div><div class="line">BRANCH=`git rev-parse --abbrev-ref HEAD`</div><div class="line">PUSH_COMMAND=`ps -ocommand= -p $PPID`</div><div class="line"></div><div class="line">if [[ &quot;$BRANCH&quot; == &quot;master&quot; &amp;&amp; &quot;$PUSH_COMMAND&quot; =~ push|force|delete|-f ]]; then</div><div class="line">  echo &quot;Prevented force-push to $BRANCH. This is a very dangerous command.&quot;</div><div class="line">  echo &quot;If you really want to do this, use --no-verify to bypass this pre-push hook.&quot;</div><div class="line">  exit 1</div><div class="line">fi</div><div class="line"></div><div class="line">exit 0</div></pre></td></tr></table></figure>
<p>这段script也很容易理解。</p>
<h2 id="执行结果："><a href="#执行结果：" class="headerlink" title="执行结果："></a>执行结果：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ chmod u+x .git/hooks/pre-push</div><div class="line">$ git push</div><div class="line">Prevented force-push to master. This is a very dangerous command.</div><div class="line">If you really want to do this, use --no-verify to bypass this pre-push hook.</div><div class="line">error: failed to push some refs to &apos;git@git.xxx.net:user/repo.git&apos;</div></pre></td></tr></table></figure>
<p>如上，如果执行<code>git push</code>，我们的echo提示出现了，说明script起作用了。<br>如果我们想跳过<code>pre-push</code>钩子，可以使用<code>--no-verify</code>参数。<br>或者把<code>.git/hooks/pre-push</code>改个名字。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>【1】<a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks" target="_blank" rel="external">https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks</a><br>【2】<a href="https://gist.github.com/stefansundin/d465f1e331fc5c632088" target="_blank" rel="external">https://gist.github.com/stefansundin/d465f1e331fc5c632088</a></p>
<p>#</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kdiff3 源码安装]]></title>
      <url>http://www.nikoai.pw/2016/02/16/linux/tools/kdiff3_install/</url>
      <content type="html"><![CDATA[<p>原先贪图方便， 用了ubuntu software center的包安装， 后面发现有<a href="https://bugs.launchpad.net/ubuntu/+source/kdiff3/+bug/563801" target="_blank" rel="external">显示偏移的bug</a>，只好重新安装最新版。</p>
<h1 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h1><hr>
<p><a href="https://sourceforge.net/projects/kdiff3/?source=typ_redirect" target="_blank" rel="external">下载</a>。</p>
<h1 id="解压编译安装"><a href="#解压编译安装" class="headerlink" title="解压编译安装"></a>解压编译安装</h1><figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">tar -xvf kdiff3-0.9.98.tar.gz</div><div class="line">sudo apt-get install libqt4-dev</div><div class="line"><span class="built_in">cd</span> kdiff3-0.9.98/src-QT4/</div><div class="line">qmake kdiff3.pro</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<h1 id="centos7"><a href="#centos7" class="headerlink" title="centos7"></a>centos7</h1><p>if you don’t have qt-devel.<br>sudo yum install qt-devel<br>sudo yum install qt4-devel</p>
<p>then qmake would be found under <code>/usr/lib64/qt4/bin</code> .</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd kdiff3-0.9.98/src-QT4/</div><div class="line">qmake kdiff3.pro</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p><a href="http://www.linuxquestions.org/questions/linux-newbie-8/qmake-command-in-centos-873289/" target="_blank" rel="external">http://www.linuxquestions.org/questions/linux-newbie-8/qmake-command-in-centos-873289/</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://sysads.co.uk/2014/08/04/install-kdiff3-0-9-98-ubuntu-14-04/" target="_blank" rel="external">http://sysads.co.uk/2014/08/04/install-kdiff3-0-9-98-ubuntu-14-04/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[共享 shadowsocks]]></title>
      <url>http://www.nikoai.pw/2016/02/11/linux/shadowsocks_share/</url>
      <content type="html"><![CDATA[<p>如果你的shadowsocks是从pip下载的python脚本，则默认是绑定监听lo网卡的（socks5），若是想分享给其他人（ <code>UI妹子⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄</code> ）上网用，可能就不行，需要做一些操作。对外暴露一个端口，然后把这个端口的请求转发到lo网卡。</p>
<h1 id="方法一：使用polipo"><a href="#方法一：使用polipo" class="headerlink" title="方法一：使用polipo"></a>方法一：使用polipo</h1><p>polipo是一款优秀的web代理工具，使用它可以容易的把ss分享给其他人，而且还能提供http代理。<br>据说</p>
<h2 id="安装-amp-配置"><a href="#安装-amp-配置" class="headerlink" title="安装 &amp; 配置"></a>安装 &amp; 配置</h2><pre><code>sudo apt-get install polipo

vim /etc/polipo/config
</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">### Basic configuration</div><div class="line"></div><div class="line"># Add your proxy&apos;s address</div><div class="line">proxyAddress = 0.0.0.0</div><div class="line">socksParentProxy = &quot;127.0.0.1:1080&quot;</div><div class="line"></div><div class="line"># Allow from anyone in the 192.168.0.* range to connect to your proxy</div><div class="line">allowedClients = 192.168.0.0/24</div></pre></td></tr></table></figure>
<h2 id="启动-amp-测试"><a href="#启动-amp-测试" class="headerlink" title="启动 &amp; 测试"></a>启动 &amp; 测试</h2><p>sudo /etc/init.d/polipo restart</p>
<p>export http_proxy=<a href="http://ip:8123/" target="_blank" rel="external">http://ip:8123/</a></p>
<p><code>8123</code>是默认的端口，其他机器设置好代理访问facebook：</p>
<p><img src="/images/linux/shadowsocks_share_ss-log-facebook.png" alt=""></p>
<p>可以看到请求的log，并成功访问facebook。</p>
<h1 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h1><p>privoxy<br>proxychains<br>…</p>
<p>#</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ubuntu安装nvidia显卡驱动]]></title>
      <url>http://www.nikoai.pw/2016/02/01/linux/install/install_nvidia_gpu_drive_on_ubuntu/</url>
      <content type="html"><![CDATA[<p>最近换硬盘重装了ubuntu, 但在用xmind和窗口切换时, 老是卡死(鼠标/键盘动不了, 但能ssh进去) , 想了一下, 应该是显卡驱动没装的原因, 由于自己的ubuntu关闭了所有动画和特效, 一直没有去装N卡驱动, 于是安装验证了一下是否这个原因导致的～</p>
<h1 id="安装前"><a href="#安装前" class="headerlink" title="安装前"></a>安装前</h1><p>安装前我们要先查看当前的显卡型号:</p>
<pre><code>lspci | grep VGA
01:00.0 VGA compatible controller: NVIDIA Corporation GF119 [GeForce GT 705] (rev a1)
</code></pre><p>可以发现这个显卡是<code>GT 705</code>(这个台式机显卡渣渣啊), 这个在接下来找驱动会用到.</p>
<blockquote>
<p>若要查看更多设备信息, 可以使用 <code>lspci -v</code></p>
</blockquote>
<h1 id="option-1-使用管理器安装"><a href="#option-1-使用管理器安装" class="headerlink" title="option 1: 使用管理器安装:"></a>option 1: 使用管理器安装:</h1><p>如果嫌麻烦的, 可以在<code>software &amp; update</code>管理器中选择显卡驱动安装.</p>
<p><img src="/images/linux/nvidia_manager_install.png" alt=""></p>
<p>我的是第二种方式安装的</p>
<h1 id="option-2-手动安装"><a href="#option-2-手动安装" class="headerlink" title="option 2: 手动安装:"></a>option 2: 手动安装:</h1><p>首先到[Nvidia官方网站]（<a href="http://www.geforce.cn/drivers）下载显卡对应的驱动，" target="_blank" rel="external">http://www.geforce.cn/drivers）下载显卡对应的驱动，</a> 需要对应自己的显卡和系统平台选择下载，比如我的是<code>NVIDIA-Linux-x86_64-352.79.run</code>。</p>
<p>接着删除已有nvidia的包:</p>
<pre><code>sudo apt-get --purge remove nvidia-*
sudo apt-get install ubuntu-desktop
echo &apos;nouveau&apos; | sudo tee -a /etc/modules
</code></pre><p>重启， 并进入tty1（按ctrl+alt+F1）：</p>
<pre><code>sudo service lightdm stop
cd  /directory/of/NVIDIA.run.file
sudo sh ./NVIDIA-Linux-x86_64-352.79.run
</code></pre><p>执行完后，<code>sudo reboot</code>。<br>重启后， 可以在程序搜索中找到nvidia manager。</p>
<p>查看当前驱动：</p>
<p>在所有应用中搜索<code>nvidia</code>，可以发现<code>nvidia x server settings</code>的程序：</p>
<p><img src="/images/linux/nvidia-config-01.png" alt=""></p>
<p>也可以在<code>software &amp; update</code>管理器中查看安装情况。</p>
<p>或者：</p>
<pre><code>prime-select query
</code></pre><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>最后，装了N卡驱动后，ubuntu的unity崩溃真的少了很多，xmind的卡死也没有再出现过。</p>
<h1 id="补充-使用apt安装"><a href="#补充-使用apt安装" class="headerlink" title="补充: 使用apt安装"></a>补充: 使用apt安装</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo apt-get purge nvidia*</div><div class="line">sudo add-apt-repository ppa:graphics-drivers/ppa</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install nvidia-352</div></pre></td></tr></table></figure>
<h1 id="参考引用"><a href="#参考引用" class="headerlink" title="参考引用"></a>参考引用</h1><hr>
<p>【1】<a href="http://us.download.nvidia.com/XFree86/Linux-x86_64/361.45.11/README/index.html" target="_blank" rel="external">http://us.download.nvidia.com/XFree86/Linux-x86_64/361.45.11/README/index.html</a><br>【2】<a href="http://www.sanesee.com/article/install-graphics-card-driver-on-ubuntu-14" target="_blank" rel="external">http://www.sanesee.com/article/install-graphics-card-driver-on-ubuntu-14</a></p>
<p>#</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[terminator 使用]]></title>
      <url>http://www.nikoai.pw/2016/01/30/linux/tools/terminator/</url>
      <content type="html"><![CDATA[<p>terminator是一个多窗口的控制台管理器( terminal multiplexer )，通过它我们可以很方便的切割多个控制台窗口，分类任务，充分地利用屏幕空间，使桌面下的工作效率大大提高。除了terminator，若是在纯console下作业，<code>tmux</code>也是不错的选择。</p>
<h1 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h1><hr>
<p>由于我们需要打开许多console，所以才需要terminator，但每次开启都要手工去建好tab和window，再进入不同的工作路径等等，实在太烦人。因此，terminator提供了layout的功能，能够满足我们的一键还原console工作环境的需求。接下来通过实操感受一下：</p>
<h2 id="1-新建一个layout"><a href="#1-新建一个layout" class="headerlink" title="1. 新建一个layout"></a>1. 新建一个layout</h2><p>首先，我们先建立好想要的窗口布局，然后进入<code>Preferences</code>-&gt;<code>layout tab</code>：<br>点击左下角<code>Add</code>一个Layout File, 并命名为<code>work1</code>，这个<code>layout</code>内容就是当前的布局。</p>
<p><img src="/images/linux/terminator_1.png" alt=""></p>
<h2 id="2-查看-amp-编辑配置文件"><a href="#2-查看-amp-编辑配置文件" class="headerlink" title="2. 查看&amp;编辑配置文件"></a>2. 查看&amp;编辑配置文件</h2><pre><code>vim ~/.config/terminator/config
</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[global_config]</div><div class="line">  inactive_color_offset = 0.74</div><div class="line">  title_transmit_fg_color = &quot;#fbebeb&quot;</div><div class="line">[keybindings]</div><div class="line">[profiles]</div><div class="line">  [[default]]</div><div class="line">    background_darkness = 0.73</div><div class="line">    palette = &quot;#000000:#aa0000:#00aa00:#aa5500:#0000aa:#aa00aa:#00aaaa:#aaaaaa:#555555:#ff5555:#55ff55:#ffff55:#5555ff:#ff55ff:#55ffff:#ffffff&quot;</div><div class="line">    background_type = transparent</div><div class="line">    background_image = None</div><div class="line">    foreground_color = &quot;#00ff00&quot;</div><div class="line">[layouts]</div><div class="line">  [[default]]</div><div class="line">    [[[child1]]]</div><div class="line">      type = Terminal</div><div class="line">      parent = window0</div><div class="line">      profile = default</div><div class="line">    [[[window0]]]</div><div class="line">      type = Window</div><div class="line">      parent = &quot;&quot;</div><div class="line">  [[work01]]</div><div class="line">    [[[child0]]]</div><div class="line">      position = 45:24</div><div class="line">      type = Window</div><div class="line">      order = 0</div><div class="line">      parent = &quot;&quot;</div><div class="line">      size = 1871, 904</div><div class="line">    [[[child1]]]</div><div class="line">      labels = localhost, servers</div><div class="line">      type = Notebook</div><div class="line">      order = 0</div><div class="line">      parent = child0</div><div class="line">    [[[child2]]]</div><div class="line">      position = 438</div><div class="line">      type = VPaned</div><div class="line">      order = 0</div><div class="line">      parent = child1</div><div class="line">    [[[child3]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 0</div><div class="line">      parent = child2</div><div class="line">    [[[child6]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 1</div><div class="line">      parent = child2</div><div class="line">    [[[child13]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 1</div><div class="line">      parent = child9</div><div class="line">    [[[child9]]]</div><div class="line">      position = 446</div><div class="line">      type = VPaned</div><div class="line">      order = 1</div><div class="line">      parent = child1</div><div class="line">    [[[child10]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 0</div><div class="line">      parent = child9</div><div class="line">    [[[terminal11]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child10</div><div class="line">    [[[terminal12]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child10</div><div class="line">    [[[terminal5]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child3</div><div class="line">    [[[terminal4]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child3</div><div class="line">    [[[terminal7]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child6</div><div class="line">    [[[terminal15]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child13</div><div class="line">    [[[terminal8]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child6</div><div class="line">    [[[terminal14]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child13</div><div class="line">[plugins]</div></pre></td></tr></table></figure>
<p>找到<code>work01</code>的节点，改名为<code>default</code>,原先的<code>default</code>改名为<code>default_bak</code>。</p>
<p>然后关闭重新打开terminator，可以发现自动打开了两个tab，分割成四个窗口，但是</p>
<h2 id="3-增加command"><a href="#3-增加command" class="headerlink" title="3. 增加command"></a>3. 增加command</h2><p>这一步可以编辑<code>~/.config/terminator/config</code>文件（如果不嫌麻烦），也可以通过<code>Preference</code>修改。</p>
<p>通过<code>Preference</code>方式修改：</p>
<p>找到Terminal，将<code>sslocal -c /etc/ss.json ; bash</code>填入<code>Custom command</code>，其他同理。重新打开</p>
<p><img src="/images/linux/terminator_2.png" alt=""></p>
<p>重新打开terminator, perfect。每个上午都可以愉悦的开始一天的工作！</p>
<p>最后附上修改后的配置文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[global_config]</div><div class="line">  inactive_color_offset = 0.74</div><div class="line">  title_transmit_fg_color = &quot;#fbebeb&quot;</div><div class="line">[keybindings]</div><div class="line">[profiles]</div><div class="line">  [[default]]</div><div class="line">    background_darkness = 0.73</div><div class="line">    palette = &quot;#000000:#aa0000:#00aa00:#aa5500:#0000aa:#aa00aa:#00aaaa:#aaaaaa:#555555:#ff5555:#55ff55:#ffff55:#5555ff:#ff55ff:#55ffff:#ffffff&quot;</div><div class="line">    background_type = transparent</div><div class="line">    background_image = None</div><div class="line">    foreground_color = &quot;#00ff00&quot;</div><div class="line">[layouts]</div><div class="line">  [[default]]</div><div class="line">    [[[child0]]]</div><div class="line">      position = 45:24</div><div class="line">      type = Window</div><div class="line">      order = 0</div><div class="line">      parent = &quot;&quot;</div><div class="line">      size = 1871, 904</div><div class="line">    [[[child1]]]</div><div class="line">      labels = localhost, servers</div><div class="line">      type = Notebook</div><div class="line">      order = 0</div><div class="line">      parent = child0</div><div class="line">    [[[child2]]]</div><div class="line">      position = 438</div><div class="line">      type = VPaned</div><div class="line">      order = 0</div><div class="line">      parent = child1</div><div class="line">    [[[child3]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 0</div><div class="line">      parent = child2</div><div class="line">    [[[child6]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 1</div><div class="line">      parent = child2</div><div class="line">    [[[child13]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 1</div><div class="line">      parent = child9</div><div class="line">    [[[child9]]]</div><div class="line">      position = 446</div><div class="line">      type = VPaned</div><div class="line">      order = 1</div><div class="line">      parent = child1</div><div class="line">    [[[child10]]]</div><div class="line">      position = 934</div><div class="line">      type = HPaned</div><div class="line">      order = 0</div><div class="line">      parent = child9</div><div class="line">    [[[terminal11]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child10</div><div class="line">      command = cd ~/dev/tools/servers/ ; bash</div><div class="line">    [[[terminal12]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child10</div><div class="line">      command = &quot;&quot;</div><div class="line">    [[[terminal5]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child3</div><div class="line">      command = top; bash</div><div class="line">    [[[terminal4]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child3</div><div class="line">      command = sslocal -c /etc/ss.json ; bash</div><div class="line">    [[[terminal7]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child6</div><div class="line">      command = cd  ~/dev/git_repos/HexoBlog/hexo-hello/; bash</div><div class="line">    [[[terminal15]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child13</div><div class="line">      command = &quot;&quot;</div><div class="line">    [[[terminal8]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 1</div><div class="line">      parent = child6</div><div class="line">      command = cd ~/dev/git_repos/Java/MavenProj/; bash</div><div class="line">    [[[terminal14]]]</div><div class="line">      profile = default</div><div class="line">      type = Terminal</div><div class="line">      order = 0</div><div class="line">      parent = child13</div><div class="line">      command = &quot;&quot;</div><div class="line">  [[default_bak]]</div><div class="line">    [[[child1]]]</div><div class="line">      type = Terminal</div><div class="line">      parent = window0</div><div class="line">      profile = default</div><div class="line">    [[[window0]]]</div><div class="line">      type = Window</div><div class="line">      parent = &quot;&quot;</div><div class="line">[plugins]</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>【1】<a href="http://askubuntu.com/questions/158159/how-do-i-get-terminator-to-start-up-with-my-custom-layout" target="_blank" rel="external">http://askubuntu.com/questions/158159/how-do-i-get-terminator-to-start-up-with-my-custom-layout</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[man的铺助工具——cheat]]></title>
      <url>http://www.nikoai.pw/2016/01/26/linux/tools/cheat-cmd/</url>
      <content type="html"><![CDATA[<h1 id="man"><a href="#man" class="headerlink" title="man"></a>man</h1><p>相信使用Linux的小伙伴, 想要查询一个命令的用法时, 都会使用<code>man</code>命令数据库，或者试一试命令自带的<code>--help</code>参数。<br>但是使用<code>man</code>有个不好的地方，就是信息太多太全了，对我们来说，需要的可能只是某个用法，而且例子是比较少的，有时man的效率确实比较低。<br>所以我的习惯是，写博客和笔记，并附有许多常用的例子。<br>其实，还有一个常用工具，可以满足需求的——<code>cheat</code>。</p>
<h1 id="cheat-命令"><a href="#cheat-命令" class="headerlink" title="cheat 命令"></a>cheat 命令</h1><p>首先，看一下效果，以tar为例：</p>
<p><img src="/images/linux/linux-python-cheat-tar.png" alt=""></p>
<h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><p>cheat是python写的，可以用pip安装。</p>
<pre><code>pip install cheat
</code></pre><h1 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h1><hr>
<p><a href="https://github.com/chrisallenlane/cheat" target="_blank" rel="external">github 地址</a></p>
<p>#</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[synergy 安装和使用 （一套键鼠掌握世界）]]></title>
      <url>http://www.nikoai.pw/2016/01/13/linux/synergy/</url>
      <content type="html"><![CDATA[<p>由于有两台电脑，四个显示器，在使用的时候，难免要切换，但笔记本的触控板和键盘实在太难用～<code>%&gt;_&lt;%</code> 但是机械键盘和鼠标只有一套，怎么办呢？<br>还好之前看一些大牛的工作环境时，看到有一个工具叫synergy，用来同步鼠标和键盘，可以随意在多台电脑中切换。</p>
<h1 id="通过apt-get-安装"><a href="#通过apt-get-安装" class="headerlink" title="通过apt-get 安装"></a>通过apt-get 安装</h1><p>因为我常用的操作系统是ubuntu和kali，当然是直接apt-get。</p>
<pre><code>apt-get install synergy
</code></pre><p>安装后，两台ubuntu（synergy版本1.4.12）之间操作没问题，然而在kali上是1.4.16版本，有不兼容的问题。于是找了下源，并没有找到对应的仓库，干脆就两边使用最新的源码install好了。</p>
<h1 id="通过源码安装"><a href="#通过源码安装" class="headerlink" title="通过源码安装"></a>通过源码安装</h1><p>首先，安装依赖</p>
<pre><code>sudo apt-get install cmake make g++ xorg-dev libqt4-dev libcurl4-openssl-dev libavahi-compat-libdnssd-dev libssl-dev
</code></pre><p>访问<a href="https://github.com/symless/synergy/releases" target="_blank" rel="external">synergy on github</a>，git clone或者直接<a href="https://github.com/symless/synergy/archive/v1.7.5-stable.tar.gz" target="_blank" rel="external">下载</a>，然后：</p>
<pre><code>tar xzvf v1.7.5-stable.tar.gz
cd synergy-1.7.5-stable
./hm setup
./hm conf -g1
./hm build
</code></pre><p>搞定。kali上也是如此操作，因为也是基于Debian。</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>跟着上面的操作，工作目录还在<code>synergy-1.7.5-stable</code>，执行<code>bin/synergy</code></p>
<p>1，开启服务器（服务器即是你鼠标和键盘连接的那台电脑），synergy 会有个向导，选择服务器模式；<br>2，点击<code>Configure Server</code>，拖拽显示右上角的显示到格子中，想要的放置位置，这里要注意显示器的name需要填写正确，这个name就是client（或server）的名称，client若对不上，会被server拒绝连接的（name在<code>Edit - Settings</code>中设置）。</p>
<p><img src="/images/synergy_server_conf.png" alt=""><br><img src="/images/synergy_name_settings.png" alt=""></p>
<p>3，主界面点击start，界面可以看到log，包括客户端的连接。<br>4，启动server后，其他主机同样<code>bin/synergy</code>启动，选择client模式，接着设置一下自己的name，填写server的IP，点击<code>Start</code>。<br>5，Okay，这时可以发现，一套键鼠可以操控多台计算机啦，尽情地享受多屏多机的快感吧，工作效率杠杠的。    :-D</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo apt-get install cmake make g++ xorg-dev libqt4-dev libcurl4-openssl-dev libavahi-compat-libdnssd-dev libssl-dev libxfont-dev libxft-dev xserver-xorg-dev libfreetype6-dev libfontconfig1-dev libfreetype6-dev libcheese-gtk23 libcheese7  libclutter-1.0-0 libclutter-gtk-1.0-0 libcogl15 libclutter-gst-2.0-0 gstreamer1.0-clutter libpng-dev libpng12-0</div><div class="line">Reading package lists... Done</div><div class="line">Building dependency tree       </div><div class="line">Reading state information... Done</div><div class="line">Note, selecting &apos;libpng12-dev&apos; instead of &apos;libpng-dev&apos;</div><div class="line">cmake is already the newest version.</div><div class="line">g++ is already the newest version.</div><div class="line">g++ set to manually installed.</div><div class="line">gstreamer1.0-clutter is already the newest version.</div><div class="line">gstreamer1.0-clutter set to manually installed.</div><div class="line">libcheese-gtk23 is already the newest version.</div><div class="line">libcheese-gtk23 set to manually installed.</div><div class="line">libcheese7 is already the newest version.</div><div class="line">libcheese7 set to manually installed.</div><div class="line">libclutter-1.0-0 is already the newest version.</div><div class="line">libclutter-1.0-0 set to manually installed.</div><div class="line">libclutter-gst-2.0-0 is already the newest version.</div><div class="line">libclutter-gst-2.0-0 set to manually installed.</div><div class="line">libcogl15 is already the newest version.</div><div class="line">libcogl15 set to manually installed.</div><div class="line">make is already the newest version.</div><div class="line">libcurl4-openssl-dev is already the newest version.</div><div class="line">libqt4-dev is already the newest version.</div><div class="line">libssl-dev is already the newest version.</div><div class="line">libclutter-gtk-1.0-0 is already the newest version.</div><div class="line">libclutter-gtk-1.0-0 set to manually installed.</div><div class="line">libpng12-0 is already the newest version.</div><div class="line">Some packages could not be installed. This may mean that you have</div><div class="line">requested an impossible situation or if you are using the unstable</div><div class="line">distribution that some required packages have not yet been created</div><div class="line">or been moved out of Incoming.</div><div class="line">The following information may help to resolve the situation:</div><div class="line"></div><div class="line">The following packages have unmet dependencies:</div><div class="line"> libpng12-dev : Depends: libpng12-0 (= 1.2.50-1ubuntu2.14.04.2) but 1.2.54-1ubuntu1k1 is to be installed</div><div class="line">E: Unable to correct problems, you have held broken packages.</div></pre></td></tr></table></figure>
<p>手动安装缺少的包.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">./hm.sh conf -g1                         </div><div class="line">Mapping command: conf -&gt; configure</div><div class="line">cmake version 2.8.12.2</div><div class="line">Entering dir: build/release</div><div class="line">CMake command: cmake -G &quot;Unix Makefiles&quot; -DCMAKE_BUILD_TYPE=Release ../..</div><div class="line">CMake Error at CMakeLists.txt:250 (message):</div><div class="line">  Missing library: Xtst</div><div class="line"></div><div class="line"></div><div class="line">-- Configuring incomplete, errors occurred!</div><div class="line">See also &quot;/home/niko/dev/tools/servers/synergy/synergy-1.7.5-stable/build/release/CMakeFiles/CMakeOutput.log&quot;.</div><div class="line">See also &quot;/home/niko/dev/tools/servers/synergy/synergy-1.7.5-stable/build/release/CMakeFiles/CMakeError.log&quot;.</div><div class="line">Going back to: /home/niko/dev/tools/servers/synergy/synergy-1.7.5-stable</div><div class="line">Error: CMake encountered error: 256</div></pre></td></tr></table></figure>
<p>sudo apt-get install libxtst-dev</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://blog.yangzhifei.com/?p=46" target="_blank" rel="external">http://blog.yangzhifei.com/?p=46</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【spring】事务提交后进行某些操作]]></title>
      <url>http://www.nikoai.pw/2016/01/12/java/spring/spring_transaction_manager/</url>
      <content type="html"><![CDATA[<p>在工作中，我们经常会有这样的需求。当修改了某些东西后，需要通知其他服务模块或系统进行某些处理。<br>这个如果硬编码的话，是一种很不优雅的方法：<br>首先，它的灵活性很差，当需求变更时，无可避免的要修改业务操作的代码，容易出bug，不符合<code>开关</code>原则（虽然不是讨论设计模式）。<br>其次，主业务操作（数据修改）部分和后续的通知处理应该是隔离的，后续的通知是否成功，对业务操作都不应有影响，或者在功能和时间上尽可能不影响主业务操作。</p>
<p>那么如果不用硬编码，事件（消息）驱动的方式是常用的一种方法，这样我们就可以把后续通知的相关处理和主业务操作解耦开来，就算要进行拓展也是很安全和方便的。</p>
<h2 id="spring-的-TransactionSynchronizationManager"><a href="#spring-的-TransactionSynchronizationManager" class="headerlink" title="spring 的 TransactionSynchronizationManager"></a>spring 的 TransactionSynchronizationManager</h2><p>在spring中，TransactionSynchronizationManager有一个事务提交后的回调支持，我们可以视线注册需要在事务commit后才进行的某些操作，如<code>afterCommit()</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// 这里是上下文</div><div class="line">TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() &#123;</div><div class="line">        @Override</div><div class="line">        public void suspend() &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void resume() &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void flush() &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void beforeCommit(boolean readOnly) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void beforeCompletion() &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void afterCommit() &#123;</div><div class="line">            log.info(&apos;afterCommit()&apos;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void afterCompletion(int status) &#123;</div><div class="line">        &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>因为TransactionSynchronization是interface，所以TransactionSynchronization的实现是一个匿名内部类，相当于一个闭包，可以访问上下文的变量等，方便我们进行某些操作。</p>
<h2 id="运行细节-源码"><a href="#运行细节-源码" class="headerlink" title="运行细节 ( 源码 )"></a>运行细节 ( 源码 )</h2><p>接下来看一下TransactionSynchronizationManager的实现，它的成员中，有个ThreadLocal副本，保存了不同线程已注册的同步操作：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">private static final ThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations =</div><div class="line">			new NamedThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt;(&quot;Transaction synchronizations&quot;);</div></pre></td></tr></table></figure>
<p>在spring运行过程中，事务相关的操作会通过TransactionInterceptor执行invocation：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public class TransactionInterceptor extends TransactionAspectSupport implements MethodInterceptor, Serializable &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">	public Object invoke(final MethodInvocation invocation) throws Throwable &#123;</div><div class="line">		// Work out the target class: may be &#123;@code null&#125;.</div><div class="line">		// The TransactionAttributeSource should be passed the target class</div><div class="line">		// as well as the method, which may be from an interface.</div><div class="line">		Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);</div><div class="line"></div><div class="line">		// Adapt to TransactionAspectSupport&apos;s invokeWithinTransaction...</div><div class="line">		return invokeWithinTransaction(invocation.getMethod(), targetClass, new InvocationCallback() &#123;</div><div class="line">			@Override</div><div class="line">			public Object proceedWithInvocation() throws Throwable &#123;</div><div class="line">				return invocation.proceed();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">    protected Object invokeWithinTransaction(Method method, Class&lt;?&gt; targetClass, final InvocationCallback invocation)</div><div class="line">			throws Throwable &#123;</div><div class="line">            ...</div><div class="line">            ...</div><div class="line">			commitTransactionAfterReturning(txInfo);</div><div class="line">			return retVal;</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>invokeWithinTransaction()是父类TransactionAspectSupport的方法，并会调用commitTransactionAfterReturning(TransactionInfo txInfo))来提交事务：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">   // TransactionInterceptor.java</div><div class="line"></div><div class="line">   protected void commitTransactionAfterReturning(TransactionInfo txInfo) &#123;</div><div class="line">	if (txInfo != null &amp;&amp; txInfo.hasTransaction()) &#123;</div><div class="line">		if (logger.isTraceEnabled()) &#123;</div><div class="line">			logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;]&quot;);</div><div class="line">		&#125;</div><div class="line">		txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// AbstractPlatformTransactionManager.java</div><div class="line"></div><div class="line">@Override</div><div class="line">public final void commit(TransactionStatus status) throws TransactionException &#123;</div><div class="line">    ...</div><div class="line">	processCommit(defStatus);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>processCommit()这个方法中很详细的介绍了提交事务的处理细节，包括beforeCommit() / beforeCompletion() / afterCommit() / afterCompletion()在事务提交时的调用和发生异常时的处理方法，还可以看到如isNewTransaction、globalRollbackOnly等对事务处理的影响。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">private void processCommit(DefaultTransactionStatus status) throws TransactionException &#123;</div><div class="line">    try &#123;</div><div class="line">        boolean beforeCompletionInvoked = false;</div><div class="line">        try &#123;</div><div class="line">            prepareForCommit(status);</div><div class="line">            triggerBeforeCommit(status);</div><div class="line">            triggerBeforeCompletion(status);</div><div class="line">            beforeCompletionInvoked = true;</div><div class="line">            boolean globalRollbackOnly = false;</div><div class="line">            if (status.isNewTransaction() || isFailEarlyOnGlobalRollbackOnly()) &#123;</div><div class="line">                globalRollbackOnly = status.isGlobalRollbackOnly();</div><div class="line">            &#125;</div><div class="line">            if (status.hasSavepoint()) &#123;</div><div class="line">                if (status.isDebug()) &#123;</div><div class="line">                    logger.debug(&quot;Releasing transaction savepoint&quot;);</div><div class="line">                &#125;</div><div class="line">                status.releaseHeldSavepoint();</div><div class="line">            &#125;</div><div class="line">            else if (status.isNewTransaction()) &#123;</div><div class="line">                if (status.isDebug()) &#123;</div><div class="line">                    logger.debug(&quot;Initiating transaction commit&quot;);</div><div class="line">                &#125;</div><div class="line">                doCommit(status);</div><div class="line">            &#125;</div><div class="line">            // Throw UnexpectedRollbackException if we have a global rollback-only</div><div class="line">            // marker but still didn&apos;t get a corresponding exception from commit.</div><div class="line">            if (globalRollbackOnly) &#123;</div><div class="line">                throw new UnexpectedRollbackException(</div><div class="line">                        &quot;Transaction silently rolled back because it has been marked as rollback-only&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        catch (UnexpectedRollbackException ex) &#123;</div><div class="line">            // can only be caused by doCommit</div><div class="line">            triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</div><div class="line">            throw ex;</div><div class="line">        &#125;</div><div class="line">        catch (TransactionException ex) &#123;</div><div class="line">            // can only be caused by doCommit</div><div class="line">            if (isRollbackOnCommitFailure()) &#123;</div><div class="line">                doRollbackOnCommitException(status, ex);</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</div><div class="line">            &#125;</div><div class="line">            throw ex;</div><div class="line">        &#125;</div><div class="line">        catch (RuntimeException ex) &#123;</div><div class="line">            if (!beforeCompletionInvoked) &#123;</div><div class="line">                triggerBeforeCompletion(status);</div><div class="line">            &#125;</div><div class="line">            doRollbackOnCommitException(status, ex);</div><div class="line">            throw ex;</div><div class="line">        &#125;</div><div class="line">        catch (Error err) &#123;</div><div class="line">            if (!beforeCompletionInvoked) &#123;</div><div class="line">                triggerBeforeCompletion(status);</div><div class="line">            &#125;</div><div class="line">            doRollbackOnCommitException(status, err);</div><div class="line">            throw err;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Trigger afterCommit callbacks, with an exception thrown there</div><div class="line">        // propagated to callers but the transaction still considered as committed.</div><div class="line">        try &#123;</div><div class="line">            triggerAfterCommit(status);</div><div class="line">        &#125;</div><div class="line">        finally &#123;</div><div class="line">            triggerAfterCompletion(status, TransactionSynchronization.STATUS_COMMITTED);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    finally &#123;</div><div class="line">        cleanupAfterCompletion(status);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到triggerAfterCommit()在doCommit(status)，不管是否抛出异常都会执行afterCompletion()，这个细节在平时开发也要留意，做好异常的处理。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">   private void triggerAfterCommit(DefaultTransactionStatus status) &#123;</div><div class="line">	if (status.isNewSynchronization()) &#123;</div><div class="line">		if (status.isDebug()) &#123;</div><div class="line">			logger.trace(&quot;Triggering afterCommit synchronization&quot;);</div><div class="line">		&#125;</div><div class="line">		TransactionSynchronizationUtils.triggerAfterCommit();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>终于，前面我们注册在TransactionSynchronizationManager的TransactionSynchronization，在这里被get出来执行，如果注册了多个通知操作，会被按顺序执行，因为这个Set的实现是LinkedHashSet。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">   // TransactionSynchronizationUtils</div><div class="line">   public static void triggerAfterCommit() &#123;</div><div class="line">	invokeAfterCommit(TransactionSynchronizationManager.getSynchronizations());</div><div class="line">&#125;</div><div class="line"></div><div class="line">   public static void invokeAfterCommit(List&lt;TransactionSynchronization&gt; synchronizations) &#123;</div><div class="line">	if (synchronizations != null) &#123;</div><div class="line">		for (TransactionSynchronization synchronization : synchronizations) &#123;</div><div class="line">			synchronization.afterCommit();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至今为止，以上讨论的是弱一致性的业务场景，一致性要求比较高的，需要分布式事务或者其他的手段来实现。<br>而且需要注意的，afterCommit()中的操作是同步的，和业务操作在同一个响应时间内的，所以，尽量不要做一些耗时的操作。<br>afterCommit()中，除了直接发送消息到队列，也可以使用本地队列来优化，用来存储和异步发送消息，这样会快很多。</p>
<p>``</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【spring】自我调用中transaction的常见问题]]></title>
      <url>http://www.nikoai.pw/2016/01/05/java/spring/spring-transactional-aop/</url>
      <content type="html"><![CDATA[<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><hr>
<p>最近有个实习生开发了一个job，这个job提测之后，测试那边很快反映有数据异常，看了下log发现已有几条异常信息，但我惊讶的是有数据不一致的问题。我浏览了一下代码，并没有发现什么问题，发现都有用Transactional和rollback声明（当时脑子有点短路，一时没有看出来），但直觉告诉我这种错误八成与事务处理不当有关。<br>既然如此只好debug一下，接着很快便知道了。</p>
<h2 id="代码大概是这样的"><a href="#代码大概是这样的" class="headerlink" title="代码大概是这样的"></a>代码大概是这样的</h2><hr>
<p><a href="https://github.com/niko2014/blog-demo/tree/master/java/starter-jpa-transaction-self-invoke" target="_blank" rel="external">示例代码</a>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">    @Transactional(rollbackFor = Exception.class)</div><div class="line">    public void methodMain() throws Exception &#123;</div><div class="line">        int status = 5;</div><div class="line">        methodA(status);</div><div class="line">        try &#123;</div><div class="line">            methodB(status);        // 位置A</div><div class="line">//            memberOrderCopyService.methodB(status);     // 位置B</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        methodC(status);</div><div class="line">    &#125;</div><div class="line">    @Transactional(rollbackFor = Exception.class)</div><div class="line">    public void methodA(Integer status) &#123;</div><div class="line">        MemberOrder mo = memberOrderRepository.findOne(1L);</div><div class="line">        mo.setStatus(status);</div><div class="line">        memberOrderRepository.save(mo);</div><div class="line">    &#125;</div><div class="line">    @Transactional(rollbackFor = Exception.class, propagation = Propagation.REQUIRES_NEW)</div><div class="line">    public void methodB(Integer status) throws Exception &#123;</div><div class="line">        MemberOrder mo = memberOrderRepository.findOne(2L);</div><div class="line">        mo.setStatus(status);</div><div class="line">        memberOrderRepository.save(mo);</div><div class="line">        th();</div><div class="line">    &#125;</div><div class="line">    public void methodC(Integer status) throws Exception &#123;</div><div class="line">        MemberOrder mo = memberOrderRepository.findOne(3L);</div><div class="line">        mo.setStatus(status);</div><div class="line">        memberOrderRepository.save(mo);</div><div class="line">    &#125;</div><div class="line">    private void th() throws Exception &#123;</div><div class="line">        throw new Exception(&quot;test&quot;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>如上，methodB()中有一个持久化的操作，在那之后有可能会抛异常(th()方法)。<br>实习生的想法是，methodB()加一个注解@Transactional(rollbackFor)，想让methodB执行失败时回滚事务。<br>然而，这种是对spring aop不了解导致的错误。</p>
<h2 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h2><hr>
<p>我对实习生说了这个错误之后，他却坚持这样是有效的。。没办法，只好以理服人。断点debug，翻源码。</p>
<p><img src="/images/spring-tx-aop/error_debug_01.png" alt=""></p>
<p>如上图，可看到methodB()的调用栈，发现methodMaster()是经过拦截器后调用的（Cglib生成代理对象的情况下，AOP拦截和回调可在<code>DynamicAdvisedInterceptor.intercept()</code>方法中找到，如下）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Override</div><div class="line">public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;</div><div class="line">    Object oldProxy = null;</div><div class="line">    boolean setProxyContext = false;</div><div class="line">    Class&lt;?&gt; targetClass = null;</div><div class="line">    Object target = null;</div><div class="line">    try &#123;</div><div class="line">        if (this.advised.exposeProxy) &#123;</div><div class="line">            // Make invocation available if necessary.</div><div class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</div><div class="line">            setProxyContext = true;</div><div class="line">        &#125;</div><div class="line">        // May be null. Get as late as possible to minimize the time we</div><div class="line">        // &quot;own&quot; the target, in case it comes from a pool...</div><div class="line">        target = getTarget();</div><div class="line">        if (target != null) &#123;</div><div class="line">            targetClass = target.getClass();</div><div class="line">        &#125;</div><div class="line">        List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</div><div class="line">        Object retVal;</div><div class="line">        // Check whether we only have one InvokerInterceptor: that is,</div><div class="line">        // no real advice, but just reflective invocation of the target.</div><div class="line">        if (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</div><div class="line">            // We can skip creating a MethodInvocation: just invoke the target directly.</div><div class="line">            // Note that the final invoker must be an InvokerInterceptor, so we know</div><div class="line">            // it does nothing but a reflective operation on the target, and no hot</div><div class="line">            // swapping or fancy proxying.</div><div class="line">            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</div><div class="line">            retVal = methodProxy.invoke(target, argsToUse);</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            // We need to create a method invocation...</div><div class="line">            retVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</div><div class="line">        &#125;</div><div class="line">        retVal = processReturnType(proxy, target, method, retVal);</div><div class="line">        return retVal;</div><div class="line">    &#125;</div><div class="line">    finally &#123;</div><div class="line">        if (target != null) &#123;</div><div class="line">            releaseTarget(target);</div><div class="line">        &#125;</div><div class="line">        if (setProxyContext) &#123;</div><div class="line">            // Restore old proxy.</div><div class="line">            AopContext.setCurrentProxy(oldProxy);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在在来看methodB()：</p>
<p><img src="/images/spring-tx-aop/error_debug_03_self_invoke.png" alt=""></p>
<p>很明显，methodB是在methodMaster()中调用的，<code>TransactionInterceptor</code>并没有拦截，因此@Transactional是无效的。</p>
<p>现在来对比一下，切换启用位置B代码（使用<code>memberOrderCopyService.methodB(status)</code>）的执行情况：</p>
<p><img src="/images/spring-tx-aop/error_debug_03_of_copy_service.png" alt=""></p>
<p>从上图可知，此时memberOrderCopyService.methodB()和原先的memberOrderService.methodMaster()都经过了TransactionInterceptor，然后通过代理invoke，这种是正确的，当有异常出现，事务也会正常回滚。</p>
<p>其实，这是一个简单的问题，通过推理也可以猜到，而且如果内部每个方法都用拦截器，会是一个很大的性能问题。</p>
<div style="display:none"><br>    FastClassBySpringCGLIB<br>    EnhancerBySpringCGLIB<br>    其实如果用Aspect也可以实现类似Transactional的功能，<br>    下次有空写一个<code>Aspect 和 Transactional</code>的对比。<br></div>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[IR - 索引检索过程简述]]></title>
      <url>http://www.nikoai.pw/2016/01/01/search/lucene/ir-index-search-intro/</url>
      <content type="html"><![CDATA[<p>上次我们简单了解了lucene索引的构建过程，这次再来了解一下索引检索的过程。开始 !</p>
<h1 id="输入查询语句"><a href="#输入查询语句" class="headerlink" title="输入查询语句"></a>输入查询语句</h1><hr>
<p>经常使用搜索引擎的童鞋应该都知道，搜索时有一些操作符，比如 <a href="https://support.google.com/websearch/answer/2466433?hl=en" target="_blank" rel="external">google Search operators</a>，有一些简单的语法。这里讨论底层和简单一点的，比如输入 <code>kafka AND java NOT scala</code>，表示要查找一个包含 kafka 和 java 但不包括 scala 的文档。</p>
<h1 id="查询语句的词法分析-语法分析-语言处理。"><a href="#查询语句的词法分析-语法分析-语言处理。" class="headerlink" title="查询语句的词法分析/语法分析/语言处理。"></a>查询语句的词法分析/语法分析/语言处理。</h1><hr>
<p>对输入的查询语句进行:</p>
<ul>
<li><p>词法分析：识别关键字和搜索单词</p>
</li>
<li><p>语法分析：根据语法规则将查询语句转化成语法树，比如前面的 <code>kafka AND java NOT scala</code> 的语法树为：</p>
<p><img src="/images/java/lucene/lucene-search-grammar-tree-01.png" alt=""></p>
</li>
<li><p>语言处理：这一步骤和前一篇博客的语言处理操作一样，<a href="/2015/12/30/search/lucene/ir-index-create-intro/">传送</a>。</p>
</li>
</ul>
<p>这时我们得到一颗经过语言处理的语法树.</p>
<h1 id="从索引中搜索符合语法树的-document"><a href="#从索引中搜索符合语法树的-document" class="headerlink" title="从索引中搜索符合语法树的 document"></a>从索引中搜索符合语法树的 document</h1><hr>
<p>接着正面的例子, 这里我们需要:</p>
<ul>
<li>找出包含 <code>kafka</code> 、<code>java</code>、<code>scala</code> 的文档链表，</li>
<li>然后对<code>kafka</code> 和 <code>java</code> 的链表进行交集合并，</li>
<li>接着把处理后的链表和 <code>scala</code> 文档链表进行减操作，排除掉 <code>scala</code> 的文档链表</li>
</ul>
<p>最终得到我们想要的文档链表。</p>
<h1 id="文档和查询语句的相关性排序"><a href="#文档和查询语句的相关性排序" class="headerlink" title="文档和查询语句的相关性排序"></a>文档和查询语句的相关性排序</h1><hr>
<p>这里主要解决查询语句和文档间的相关性判断问题，如果把查询语句当做是一个小文档，那么问题就变成如何判断文档间的相似度。方法是首先我们找出不同 terms 是对这些文档的重要性，然后使用向量空间模型判断文档之间的相似度。</p>
<h2 id="1-计算词的权重-term-weight"><a href="#1-计算词的权重-term-weight" class="headerlink" title="1. 计算词的权重 (term weight)"></a>1. 计算词的权重 (term weight)</h2><p>计算词的权重(term weight)，是用来衡量 term 对文档的重要性的一种手段。用 term weight 来表示 term 在某文档中的重要程度，越重要的 term 其 weight 越大。</p>
<p>词的权重 (term weight) 有两个参数，<a href="/2015/12/30/search/lucene/ir-index-create-intro/">前一篇博客结尾</a>我们提到了 tf 和 df：</p>
<ul>
<li>tf, 对于某个文档来说, tf 越大, term weight 越高.</li>
<li>df, 对于多个文档来说, df 越大, term weight 越低.</li>
</ul>
<p>term weight 的简单计算公式如下：</p>
<p><img src="/images/java/lucene/lucene-weight-td-01.png" alt=""></p>
<blockquote>
<p>图片来自： <a href="http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html" target="_blank" rel="external">http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html</a></p>
</blockquote>
<p>更详细的介绍可以查看斯坦福的 information retrieval 文档: <a href="http://nlp.stanford.edu/IR-book/html/htmledition/tf-idf-weighting-1.html" target="_blank" rel="external">Tf-idf weighting</a> 和 <a href="http://nlp.stanford.edu/IR-book/html/htmledition/inverse-document-frequency-1.html" target="_blank" rel="external">Inverse document frequency</a>.</p>
<h2 id="2-向量空间模型-Vector-Space-Model"><a href="#2-向量空间模型-Vector-Space-Model" class="headerlink" title="2. 向量空间模型 (Vector Space Model)"></a>2. 向量空间模型 (Vector Space Model)</h2><hr>
<p>从 terms 之间的 weight 得到文档相关性, 我们可以使用向量空间模型的算法 (Vector Space Model):</p>
<p><img src="/images/java/lucene/term-sentence-vector-space-model-02.png" alt=""></p>
<blockquote>
<p>图片来自： <a href="http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html" target="_blank" rel="external">http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html</a></p>
</blockquote>
<p>如上图, 我们把 query 也当做是一个文档, weight 向量对应着 term 向量, 如果 document 和 query 的terms 维度不同, 取并集; 如果文档不含某个 term , weight 则为0.</p>
<p>为了得到相关性的评分, 需要计算 document 和 query 向量的夹角, 公式如下：</p>
<p><img src="/images/java/lucene/lucene-score-qd-01.png" alt=""></p>
<p>这样, 当我们计算得出的夹角越小时, cos(q, d)值越大, 表示相关性就越高, 然后根据这个评分按序返回相关的文档.</p>
<h1 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h1><hr>
<p>以上只是一个简单的 IR 搜索过程的基本原理, 在现实使用中, 评分会比这个复杂得多, 针对不同的应用和场景有着不同的实现和变化, 以后也会介绍到这些不同的评分模型 ~</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://nlp.stanford.edu/IR-book/html/htmledition/irbook.html" target="_blank" rel="external">斯坦福 - 信息检索</a><br><a href="http://www.slideshare.net/jitinpillai1/vector-spaces-50642309" target="_blank" rel="external">Vector spaces - SlideShare</a><br><a href="http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html" target="_blank" rel="external">http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html</a><br><a href="https://support.google.com/websearch/answer/2466433?hl=en" target="_blank" rel="external">https://support.google.com/websearch/answer/2466433?hl=en</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【书：自控力】（六） 低落的情绪 为何使人屈服于诱惑？]]></title>
      <url>http://www.nikoai.pw/2015/12/30/books/self_ctrl/self_ctrl_6/</url>
      <content type="html"><![CDATA[<h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><hr>
<p><img src="/images/book_self_ctrl_6.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[IR - 索引创建过程概述]]></title>
      <url>http://www.nikoai.pw/2015/12/30/search/lucene/ir-index-create-intro/</url>
      <content type="html"><![CDATA[<p>在搜索方面，lucene 可谓是大名鼎鼎，为什么使用 lucene 可以做到这么快的搜索， 首先我们要先来了解一下倒排索引。</p>
<h1 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h1><hr>
<p>lucene 全文索引的搜索速度很快， 关键数据结构就是这个倒排索引， 那什么是倒排索引呢 ？</p>
<p><img src="/images/java/lucene/lucene-inverted-index-01.png" alt=""></p>
<blockquote>
<p>图片来自:  <a href="http://nlp.stanford.edu/IR-book/html/htmledition/an-example-information-retrieval-problem-1.html" target="_blank" rel="external">http://nlp.stanford.edu/</a></p>
</blockquote>
<p>如上图， 倒排索引， 顾名思义就是<code>词 -&gt; 文档</code>作为一个反向(相对于<code>文档 -&gt; 词</code>)的关系。可以看到, 左边有一个词典， 每个词指向一个文档链表， 称为 <code>posting list</code> ( 倒排表 )。</p>
<p>虽然索引构建和写入可能会比读慢，但索引只要一次构建了，以后就可以多次使用了。</p>
<h1 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h1><hr>
<p>接下来开始索引文档。</p>
<h2 id="准备要索引的文档"><a href="#准备要索引的文档" class="headerlink" title="准备要索引的文档"></a>准备要索引的文档</h2><hr>
<p>假设有一些要被索引的文档，比如：</p>
<p>文档一：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">They drove luxurious cars and lived in splendid houses with their beautiful wives.</div></pre></td></tr></table></figure>
<p>文档二：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">As the carrier of the social culture and the art aesthetics, the Chinese ancient furniture has rich traditional culture connotation and shows different aesthetic ideology of different times.</div></pre></td></tr></table></figure>
<h2 id="文档-gt-tokenizer-（分词组件）-gt-token"><a href="#文档-gt-tokenizer-（分词组件）-gt-token" class="headerlink" title="文档 -&gt; tokenizer （分词组件） -&gt; token"></a>文档 -&gt; tokenizer （分词组件） -&gt; token</h2><hr>
<p>我们将文档传给 tokenizer （分词组件）， tokenizer 进行 tokenize 分词操作， 将文档分成一个个单词，去除标点符号和 stop word。<br>stop word 是指语言中普遍的词， 这些词没有什么特别的意义， 不足以成为文档的关键词，写入索引也会浪费空间，如 <code>a</code>、<code>the</code> 等。<br>这里针对是英文的 tokenizer， 中文 tokenizer 会有不同的分词方法和 stop word 集合。</p>
<p>这一步 tokenizer 处理后的结果称为 token。</p>
<h2 id="token-gt-Linguistic-Processor-gt-term"><a href="#token-gt-Linguistic-Processor-gt-term" class="headerlink" title="token -&gt; Linguistic Processor -&gt; term"></a>token -&gt; Linguistic Processor -&gt; term</h2><hr>
<p>linguistic processor (语言处理组件) 主要对 token 进行语言上的处理， 比如英语：</p>
<ul>
<li>转为小写</li>
<li><code>stemming</code> 词干提取，如“cars”到“car”等这样的操作</li>
<li><code>lemmatization</code> 词形还原， 如“drove”到“drive”等这样的操作</li>
</ul>
<p>stemming 和 lemmatization 的不同之处在于：</p>
<ul>
<li>stemming 使用一些固定算法对词进行缩减， 如去除复数<code>s</code>、<code>tional -&gt; tion</code>等等</li>
<li>lemmatization 是使用已保存的字典映射来进行转换，如一些非常规的过去式和过去分词：<code>written -&gt; write</code>、<code>are is am -&gt; be</code>等，需要保存在映射中。</li>
</ul>
<p>但 stemming 和 lemmatization 不是互斥关系， 有些词用两种方法都可以得到相同的结果。</p>
<p>这一步 linguistic processor 处理之后的结果叫做 term。</p>
<h2 id="term-gt-indexer"><a href="#term-gt-indexer" class="headerlink" title="term -&gt; indexer"></a>term -&gt; indexer</h2><hr>
<p>现在我们可以把 term 和 其文档id 对应起来， 很明显，一个 term 可能对应多个文档， 把这些文档使用链表来串在一起， 就是我们的 Posting List，如上图所示。<br>当然，实际中存储除了文档id，还有 <code>Document Frequency</code>、<code>Frequency</code> 等信息， 这些在后面搜索的时候会用到，如下图：</p>
<p><img src="/images/java/lucene/lucene-inverted-index-02.png" alt=""></p>
<blockquote>
<p>图片来自：<a href="http://horicky.blogspot.com/2013/02/text-processing-part-2-inverted-index.html" target="_blank" rel="external">http://horicky.blogspot.com/2013/02/text-processing-part-2-inverted-index.html</a></p>
</blockquote>
<p>Document Frequency（文档频次），表示有多少文档包含这个 term。<br>Term Frequency （词频率），表示此 term 在此文档中有多少个。</p>
<h1 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h1><hr>
<p>创建完索引后，接下来就可以进行搜索了，下一篇博客将简述索引搜索的过程。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://horicky.blogspot.com/2013/02/text-processing-part-2-inverted-index.html" target="_blank" rel="external">http://horicky.blogspot.com/2013/02/text-processing-part-2-inverted-index.html</a><br><a href="https://zh.wikipedia.org/wiki/%E8%AF%8D%E5%B9%B2%E6%8F%90%E5%8F%96" target="_blank" rel="external">https://zh.wikipedia.org/wiki/%E8%AF%8D%E5%B9%B2%E6%8F%90%E5%8F%96</a><br><a href="http://nlp.stanford.edu/IR-book/html/htmledition/an-example-information-retrieval-problem-1.html" target="_blank" rel="external">http://nlp.stanford.edu/IR-book/html/htmledition/an-example-information-retrieval-problem-1.html</a><br><a href="http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html" target="_blank" rel="external">http://www.cnblogs.com/forfuture1978/archive/2010/06/13/1757479.html</a><br><a href="http://www.infotech.ac.cn/CN/article/downloadArticleFile.do?attachType=PDF&amp;id=3533" target="_blank" rel="external">http://www.infotech.ac.cn/CN/article/downloadArticleFile.do?attachType=PDF&amp;id=3533</a><br><a href="http://udn.yyuap.com/doc/mastering-elasticsearch/chapter-1/112_README.html" target="_blank" rel="external">http://udn.yyuap.com/doc/mastering-elasticsearch/chapter-1/112_README.html</a><br><a href="http://www.ideaeng.com/stemming-lemmatization-0601" target="_blank" rel="external">http://www.ideaeng.com/stemming-lemmatization-0601</a><br><a href="http://www.zmonster.me/2016/01/21/lemmatization-survey.html" target="_blank" rel="external">http://www.zmonster.me/2016/01/21/lemmatization-survey.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【zookeeper】 集群搭建和测试]]></title>
      <url>http://www.nikoai.pw/2015/12/29/java/zookeeper/zookeeper-cluster/</url>
      <content type="html"><![CDATA[<p>本文记录zookeeper集群的搭建过程及简单测试。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><hr>
<p>zk1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">dataDir=/foo/data</div><div class="line">dataLogDir=/foo/logs</div><div class="line">clientPort=2181</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">server.1=zk1:2888:3888</div><div class="line">server.2=zk2:2889:3889</div><div class="line">server.3=zk3:2890:3890</div></pre></td></tr></table></figure>
<blockquote>
<p>The entries of the form server.X list the servers that make up the ZooKeeper service. When the server starts up, it knows which server it is by looking for the file myid in the data directory. That file has the contains the server number, in ASCII.</p>
<p>Finally, note the two port numbers after each server name: “ 2888” and “3888”. Peers use the former port to connect to other peers. Such a connection is necessary so that peers can communicate, for example, to agree upon the order of updates. More specifically, a ZooKeeper server uses this port to connect followers to the leader. When a new leader arises, a follower opens a TCP connection to the leader using this port. Because the default leader election also uses TCP, we currently require another port for leader election. This is the second port in the server entry.</p>
</blockquote>
<p>zk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">dataDir=/foo/data</div><div class="line">dataLogDir=/foo/logs</div><div class="line">clientPort=2182</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">server.1=zk1:2888:3888</div><div class="line">server.2=zk2:2889:3889</div><div class="line">server.3=zk3:2890:3890</div></pre></td></tr></table></figure>
<p>zk3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">tickTime=2000</div><div class="line">dataDir=/foo/data</div><div class="line">dataLogDir=/foo/logs</div><div class="line">clientPort=2183</div><div class="line">initLimit=5</div><div class="line">syncLimit=2</div><div class="line">server.1=zk1:2888:3888</div><div class="line">server.2=zk2:2889:3889</div><div class="line">server.3=zk3:2890:3890</div></pre></td></tr></table></figure>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><hr>
<p>zk1</p>
<p>echo 1 &gt; data/myid</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-01$ bin/zkServer.sh start</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-01/bin/../conf/zoo.cfg</div><div class="line">Starting zookeeper ... STARTED</div></pre></td></tr></table></figure>
<p>日志在<code>./zookeeper.out</code>文件中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">2015-12-29 22:07:45,673 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-01/bin/../conf/zoo.cfg</div><div class="line">2015-12-29 22:07:45,675 [myid:] - INFO  [main:QuorumPeerConfig@340] - Defaulting to majority quorums</div><div class="line">2015-12-29 22:07:45,677 [myid:1] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount set to 3</div><div class="line">2015-12-29 22:07:45,677 [myid:1] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval set to 0</div><div class="line">2015-12-29 22:07:45,678 [myid:1] - INFO  [main:DatadirCleanupManager@101] - Purge task is not scheduled.</div><div class="line">2015-12-29 22:07:45,684 [myid:1] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer</div><div class="line">2015-12-29 22:07:45,693 [myid:1] - INFO  [main:NIOServerCnxnFactory@94] - binding to port 0.0.0.0/0.0.0.0:2181</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@959] - tickTime set to 2000</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@979] - minSessionTimeout set to -1</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@990] - maxSessionTimeout set to -1</div><div class="line">2015-12-29 22:07:45,706 [myid:1] - INFO  [main:QuorumPeer@1005] - initLimit set to 5</div><div class="line">2015-12-29 22:07:45,714 [myid:1] - INFO  [main:QuorumPeer@473] - currentEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</div><div class="line">2015-12-29 22:07:45,717 [myid:1] - INFO  [main:QuorumPeer@488] - acceptedEpoch not found! Creating with a reasonable default of 0. This should only happen when you are upgrading your installation</div><div class="line">2015-12-29 22:07:45,721 [myid:1] - INFO  [Thread-1:QuorumCnxManager$Listener@504] - My election bind port: zk1/127.0.1.1:3888</div><div class="line">2015-12-29 22:07:45,726 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumPeer@714] - LOOKING</div><div class="line">2015-12-29 22:07:45,727 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@815] - New election. My id =  1, proposed zxid=0x0</div><div class="line">2015-12-29 22:07:45,729 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@597] - Notification: 1 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEpoch) LOOKING (my state)</div><div class="line">2015-12-29 22:07:45,731 [myid:1] - WARN  [WorkerSender[myid=1]:QuorumCnxManager@382] - Cannot open channel to 2 at election address zk2/127.0.1.1:3889</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:341)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:449)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:430)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">2015-12-29 22:07:45,732 [myid:1] - WARN  [WorkerSender[myid=1]:QuorumCnxManager@382] - Cannot open channel to 3 at election address zk3/127.0.1.1:3890</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:341)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:449)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:430)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">2015-12-29 22:07:45,931 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumCnxManager@382] - Cannot open channel to 2 at election address zk2/127.0.1.1:3889</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">2015-12-29 22:09:27,956 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumCnxManager@382] - Cannot open channel to 2 at election address zk2/127.0.1.1:3889</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)</div><div class="line">2015-12-29 22:09:27,957 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:QuorumCnxManager@382] - Cannot open channel to 3 at election address zk3/127.0.1.1:3890</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)</div><div class="line">	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)</div><div class="line">	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)</div><div class="line">2015-12-29 22:09:27,958 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@849] - Notification time out: 60000</div></pre></td></tr></table></figure>
<p>zk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">echo 2 &gt; data/myid</div><div class="line">.../zookeeper-3.4.6_server-02$ bin/zkServer.sh start</div></pre></td></tr></table></figure>
<p>zk3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">echo 3 &gt; data/myid</div><div class="line">.../zookeeper-3.4.6_server-03$ bin/zkServer.sh start</div></pre></td></tr></table></figure>
<h1 id="检查-status"><a href="#检查-status" class="headerlink" title="检查 status"></a>检查 status</h1><hr>
<p>zk1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-01$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-01/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure>
<p>zk2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-02$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-02/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div></pre></td></tr></table></figure>
<p>zk3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.../zookeeper-3.4.6_server-03$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-03/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure>
<p>可知， zk2 被选为 leader。</p>
<h1 id="宕机测试"><a href="#宕机测试" class="headerlink" title="宕机测试"></a>宕机测试</h1><hr>
<p>把 zk2 kill掉后, 查看各个 zk server 的 status, 发现 zk3 变成 master :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">zookeeper-3.4.6_server-03$ bin/zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/niko/dev/tools/servers/zookeeper/zookeeper-3.4.6_server-03/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div></pre></td></tr></table></figure>
<p>用<a href="https://zookeeper.apache.org/doc/trunk/javaExample.html#sc_completeSourceCode" target="_blank" rel="external">java客户端api</a>连接三个服务器, 然后用zkCli.sh测试, java client 工作正常:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[zk: 127.0.0.1:2182(CONNECTED) 3] set /test niko2</div><div class="line">$ cat /tmp/niko/zk_test</div><div class="line">niko2</div></pre></td></tr></table></figure>
<p>然后关掉master zk3后, 集群将停止服务, 因为选举不能获得不能超过<code>3/2=1</code>张票了, 无法得出leader :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">  &lt;2015-12-29 22:42:57,889&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Unable to read additional data from server sessionid 0x3585e1413050000, likely server has closed socket, closing socket connection and attempting reconnect</div><div class="line">  &lt;2015-12-29 22:42:58,324&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Opening socket connection to server 127.0.0.1/127.0.0.1:2182. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">  &lt;2015-12-29 22:42:58,325&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Socket connection established to 127.0.0.1/127.0.0.1:2182, initiating session</div><div class="line">  &lt;2015-12-29 22:42:58,327&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Unable to read additional data from server sessionid 0x3585e1413050000, likely server has closed socket, closing socket connection and attempting reconnect</div><div class="line">  &lt;2015-12-29 22:42:58,699&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Opening socket connection to server 127.0.0.1/127.0.0.1:2183. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">  &lt;2015-12-29 22:42:58,700&gt; &lt;ClientCnxn:WARN&gt;	main-SendThread(127.0.0.1:2183)	Session 0x3585e1413050000 for server null, unexpected error, closing socket connection and attempting reconnect</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)</div><div class="line">	at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)</div><div class="line">	at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)</div><div class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)</div><div class="line">  &lt;2015-12-29 22:43:00,543&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">  &lt;2015-12-29 22:43:00,543&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Socket connection established to 127.0.0.1/127.0.0.1:2181, initiating session</div><div class="line">  &lt;2015-12-29 22:43:00,545&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Session establishment complete on server 127.0.0.1/127.0.0.1:2181, sessionid = 0x3585e1413050000, negotiated timeout = 4000</div></pre></td></tr></table></figure>
<p>我们重新启动zk3, 集群将恢复服务:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;2015-12-29 22:53:34,232&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Opening socket connection to server 127.0.0.1/127.0.0.1:2183. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:34,232&gt; &lt;ClientCnxn:WARN&gt;	main-SendThread(127.0.0.1:2183)	Session 0x3585e2c18ed0000 for server null, unexpected error, closing socket connection and attempting reconnect</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">  at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)</div><div class="line">  at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)</div><div class="line">  at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)</div><div class="line">  at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)</div><div class="line">&lt;2015-12-29 22:53:34,485&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2181)	Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:34,486&gt; &lt;ClientCnxn:WARN&gt;	main-SendThread(127.0.0.1:2181)	Session 0x3585e2c18ed0000 for server null, unexpected error, closing socket connection and attempting reconnect</div><div class="line">java.net.ConnectException: Connection refused</div><div class="line">  at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)</div><div class="line">  at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)</div><div class="line">  at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)</div><div class="line">  at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)</div><div class="line">&lt;2015-12-29 22:53:36,450&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Opening socket connection to server 127.0.0.1/127.0.0.1:2182. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:36,451&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Socket connection established to 127.0.0.1/127.0.0.1:2182, initiating session</div><div class="line">&lt;2015-12-29 22:53:36,451&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2182)	Unable to read additional data from server sessionid 0x3585e2c18ed0000, likely server has closed socket, closing socket connection and attempting reconnect</div><div class="line">&lt;2015-12-29 22:53:37,115&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Opening socket connection to server 127.0.0.1/127.0.0.1:2183. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">&lt;2015-12-29 22:53:37,116&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Socket connection established to 127.0.0.1/127.0.0.1:2183, initiating session</div><div class="line">&lt;2015-12-29 22:53:37,164&gt; &lt;ClientCnxn:INFO&gt;	main-SendThread(127.0.0.1:2183)	Session establishment complete on server 127.0.0.1/127.0.0.1:2183, sessionid = 0x3585e2c18ed0000, negotiated timeout = 4000</div></pre></td></tr></table></figure>
<p>接下来将会了解<code>基于docker搭建zookeeper集群</code>及其<code>zookeeper集群的选举算法</code>, 另起博客介绍.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://zookeeper.apache.org/doc/trunk/zookeeperStarted.html#sc_RunningReplicatedZooKeeper" target="_blank" rel="external">https://zookeeper.apache.org/doc/trunk/zookeeperStarted.html#sc_RunningReplicatedZooKeeper</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[git 常用命令清单]]></title>
      <url>http://www.nikoai.pw/2015/12/26/git/git_cmd/</url>
      <content type="html"><![CDATA[<p>这个清单是基于<a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html" target="_blank" rel="external">常用 Git 命令清单 - 阮一峰</a>的博客修改的， 加上了安装配置部分和一些demo例子，并补充了一些命令（不断更新）。</p>
<h1 id="常用-Git-命令清单"><a href="#常用-Git-命令清单" class="headerlink" title="常用 Git 命令清单"></a>常用 Git 命令清单</h1><blockquote>
<p>我每天使用 Git ，但是很多命令记不住。<br>　　一般来说，日常使用只要记住下图6个命令，就可以了。但是熟练使用，恐怕要记住60～100个命令。</p>
</blockquote>
<p><img src="http://www.ruanyifeng.com/blogimg/asset/2015/bg2015120901.png" alt=""></p>
<blockquote>
<p>下面是我整理的常用 Git 命令清单。几个专用名词的译名如下。<br>Workspace：工作区<br>Index / Stage：暂存区<br>Repository：仓库区（或本地仓库）<br>Remote：远程仓库</p>
</blockquote>
<h1 id="安装配置-niko"><a href="#安装配置-niko" class="headerlink" title="安装配置 - niko"></a>安装配置 - niko</h1><h2 id="ssh-key-简要流程"><a href="#ssh-key-简要流程" class="headerlink" title="ssh key 简要流程"></a>ssh key 简要流程</h2><ol>
<li>ssh-keygen -t rsa -C “foo@gmail.com”，选择生成位置（~/.ssh/foo_rsa）。</li>
<li><p>ssh-agent -s<br>若提示 <code>Could not open a connection to your authentication agent.</code>, 使用：</p>
<p> eval <code>ssh-agent -s</code></p>
</li>
<li><p>ssh-add ~/.ssh/foo_rsa</p>
</li>
<li>clip &lt; ~/.ssh/foo_rsa.pub</li>
<li>添加到远程服务器的ssh_keys；</li>
<li>git clone …</li>
</ol>
<h3 id="设置ssh配置"><a href="#设置ssh配置" class="headerlink" title="设置ssh配置"></a>设置ssh配置</h3><p>vim ~/.ssh/config</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Host dev</div><div class="line">    HostName dev.example.com</div><div class="line">    Port 22000</div><div class="line">    User fooey&lt;/p&gt;</div><div class="line">Host github.com</div><div class="line">    IdentityFile ~/.ssh/github.key</div><div class="line">Host oschina.net</div><div class="line">    IdentityFile ~/.ssh/id_rsa_osc</div><div class="line">Host github.com</div><div class="line">    IdentityFile ~/.ssh/id_rsa_github</div></pre></td></tr></table></figure>
<div style="display:none"><br><a href="http://nerderati.com/2011/03/17/simplify-your-life-with-an-ssh-config-file/" target="_blank" rel="external">http://nerderati.com/2011/03/17/simplify-your-life-with-an-ssh-config-file/</a><br></div>

<h1 id="一、新建代码库"><a href="#一、新建代码库" class="headerlink" title="一、新建代码库"></a>一、新建代码库</h1><ul>
<li><p>在当前目录新建一个Git代码库<br>$ git init</p>
</li>
<li><p>新建一个目录，将其初始化为Git代码库<br>$ git init [project-name]</p>
</li>
<li><p>下载一个项目和它的整个代码历史<br>$ git clone [url]</p>
</li>
</ul>
<h1 id="二、git-配置"><a href="#二、git-配置" class="headerlink" title="二、git 配置"></a>二、git 配置</h1><p>　　Git的设置文件为.gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。</p>
<ul>
<li><p>显示当前的Git配置<br>$ git config –list</p>
</li>
<li><p>编辑Git配置文件<br>$ git config -e [–global]</p>
</li>
<li><p>设置提交代码时的用户信息<br>$ git config [–global] user.name “[name]”<br>$ git config [–global] user.email “[email address]”</p>
</li>
<li><p>push pull 策略</p>
</li>
</ul>
<p>ref ： <a href="http://blog.angular.in/git-pushmo-ren-fen-zhi/" target="_blank" rel="external">http://blog.angular.in/git-pushmo-ren-fen-zhi/</a></p>
<p><code>push.default</code> 未设置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">warning: push.default is unset; its implicit value is changing in</div><div class="line">Git 2.0 from &apos;matching&apos; to &apos;simple&apos;. To squelch this message</div><div class="line">and maintain the current behavior after the default changes, use:</div><div class="line"></div><div class="line">  git config --global push.default matching</div><div class="line"></div><div class="line">To squelch this message and adopt the new behavior now, use:</div><div class="line"></div><div class="line">  git config --global push.default simple</div><div class="line"></div><div class="line">When push.default is set to &apos;matching&apos;, git will push local branches</div><div class="line">to the remote branches that already exist with the same name.</div><div class="line"></div><div class="line">In Git 2.0, Git will default to the more conservative &apos;simple&apos;</div><div class="line">behavior, which only pushes the current branch to the corresponding</div><div class="line">remote branch that &apos;git pull&apos; uses to update the current branch.</div><div class="line"></div><div class="line">See &apos;git help config&apos; and search for &apos;push.default&apos; for further information.</div><div class="line">(the &apos;simple&apos; mode was introduced in Git 1.7.11. Use the similar mode</div><div class="line">&apos;current&apos; instead of &apos;simple&apos; if you sometimes use older versions of Git)</div></pre></td></tr></table></figure>
<p>git config –global push.default ‘option’</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">option：</div><div class="line"></div><div class="line">nothing - push操作无效，除非显式指定远程分支，例如git push origin develop（我觉得。。。可以给那些不愿学git的同事配上此项）。</div><div class="line"></div><div class="line">current - push当前分支到远程同名分支，如果远程同名分支不存在则自动创建同名分支。</div><div class="line"></div><div class="line">upstream - push当前分支到它的upstream分支上（这一项其实用于经常从本地分支push/pull到同一远程仓库的情景，这种模式叫做central workflow）。</div><div class="line"></div><div class="line">simple - simple和upstream是相似的，只有一点不同，simple必须保证本地分支和它的远程 upstream分支同名，否则会拒绝push操作。</div><div class="line"></div><div class="line">matching - push所有本地和远程两端都存在的同名分支。</div></pre></td></tr></table></figure>
<h1 id="三、增加-删除文件"><a href="#三、增加-删除文件" class="headerlink" title="三、增加/删除文件"></a>三、增加/删除文件</h1><ul>
<li><p>添加指定文件到暂存区<br>$ git add [file1] [file2] …</p>
</li>
<li><p>添加指定目录到暂存区，包括子目录<br>$ git add [dir]</p>
</li>
<li><p>添加当前目录的所有文件到暂存区<br>git add .<br>git add –all (对删除文件有效)</p>
</li>
<li><p>删除工作区文件，并且将这次删除放入暂存区<br>git rm [file1] [file2] …</p>
</li>
<li><p>停止追踪指定文件，但该文件会保留在工作区<br>git rm <code>--cached</code> [file]</p>
</li>
<li><p>取消放入暂存区<br>use “git reset HEAD <file>…” to unstage</file></p>
</li>
<li><p>改名文件，并且将这个改名放入暂存区<br>git mv [file-original] [file-renamed]</p>
</li>
<li><p>取消改名<br>git mv [file-renamed] [file-original]</p>
</li>
</ul>
<h1 id="四、代码提交"><a href="#四、代码提交" class="headerlink" title="四、代码提交"></a>四、代码提交</h1><hr>
<ul>
<li><p>提交暂存区到仓库区<br>git commit -m [message]</p>
</li>
<li><p>提交暂存区的指定文件到仓库区<br>git commit [file1] [file2] … -m [message]</p>
</li>
<li><p>提交工作区自上次commit之后的变化，直接到仓库区<br>git commit -a</p>
</li>
<li><p>提交时显示所有diff信息<br>git commit -v</p>
</li>
<li><p>使用一次新的commit，替代上一次提交</p>
</li>
<li>重做上一次commit，并包括指定文件的新变化</li>
<li>如果代码没有任何新变化，则用来改写上一次commit的提交信息<br>$ git commit <code>--amend</code> -m [message]<br>$ git commit –amend   …</li>
</ul>
<h1 id="五、分支"><a href="#五、分支" class="headerlink" title="五、分支"></a>五、分支</h1><ul>
<li><p>列出所有本地分支<br>$ git branch</p>
</li>
<li><p>列出所有远程分支<br>$ git branch -r</p>
</li>
<li><p>列出所有本地分支和远程分支<br>$ git branch -a</p>
</li>
<li><p>新建一个分支，但依然停留在当前分支<br>$ git branch [branch-name]</p>
</li>
<li><p>新建一个分支，并切换到该分支<br>$ git checkout -b [branch]</p>
</li>
<li><p>新建一个分支，指向指定commit<br>$ git branch [branch] [commit]</p>
</li>
<li><p>新建一个分支，与指定的远程分支建立追踪关系<br>$ git branch –track [branch] [remote-branch]</p>
</li>
<li><p>切换到指定分支，并更新工作区<br>$ git checkout [branch-name]</p>
</li>
<li><p>remote<br>git checkout -b test <name of="" remote="">/test<br><a href="https://stackoverflow.com/questions/1783405/how-do-i-check-out-a-remote-git-branch" target="_blank" rel="external">https://stackoverflow.com/questions/1783405/how-do-i-check-out-a-remote-git-branch</a></name></p>
</li>
</ul>
<ul>
<li><p>建立追踪关系，在现有分支与指定的远程分支之间<br>$ git branch –set-upstream [branch] [remote-branch]</p>
</li>
<li><p>合并指定分支到当前分支<br>$ git merge [branch]</p>
</li>
<li><p>选择一个commit，合并进当前分支<br>$ git <code>cherry-pick</code> [commit]</p>
</li>
<li><p>终止(abort) merge 操作：<br>$ git reset –hard HEAD<br><a href="http://stackoverflow.com/questions/101752/i-ran-into-a-merge-conflict-how-can-i-abort-the-merge" target="_blank" rel="external">http://stackoverflow.com/questions/101752/i-ran-into-a-merge-conflict-how-can-i-abort-the-merge</a></p>
</li>
<li><p>删除分支<br>$ git branch -d [branch-name]</p>
</li>
<li><p>删除远程分支<br>git push origin –delete <branchname><br>git push origin –delete<br>git branch -dr</branchname></p>
</li>
</ul>
<h1 id="六、标签"><a href="#六、标签" class="headerlink" title="六、标签"></a>六、标签</h1><ul>
<li><p>列出所有tag<br>$ git tag</p>
</li>
<li><p>新建一个tag在当前commit<br>git tag [tag]<br>注释：<br>git tag -a v1.4 -m ‘my version 1.4’</p>
</li>
<li><p>新建一个tag在指定commit<br>$ git tag [tag] [commit]</p>
</li>
<li><p>查看tag信息<br>$ git show [tag]</p>
</li>
<li><p>提交指定tag<br>$ git push [remote] [tag]</p>
</li>
<li><p>提交所有tag<br>$ git push [remote] –tags</p>
</li>
<li><p>新建一个分支，指向某个tag<br>$ git checkout -b [branch] [tag]</p>
</li>
</ul>
<h1 id="七、查看信息"><a href="#七、查看信息" class="headerlink" title="七、查看信息"></a>七、查看信息</h1><ul>
<li><p>显示有变更的文件<br>$ git status</p>
</li>
<li><p>GUI 审查代码<br>git difftool</p>
</li>
<li><p>显示当前分支的版本历史<br>$ git log</p>
</li>
<li><p>显示commit历史，以及每次commit发生变更的文件<br>$ git log –stat</p>
</li>
<li><p>显示某个文件的版本历史，包括文件改名<br>$ git log –follow [file]<br>$ git whatchanged [file]</p>
</li>
<li><p>显示指定文件相关的每一次diff<br>$ git log -p [file]</p>
</li>
<li><p>华丽的分支log<br>$ git log –graph –decorate –pretty=oneline –abbrev-commit develop  origin/develop  temp-branch</p>
</li>
<li><p>显示指定文件是什么人在什么时间修改过<br><code>git blame</code> [file]</p>
</li>
<li><p>显示暂存区和工作区的差异<br>git diff</p>
</li>
<li><p>显示暂存区和上一个commit的差异<br>$ git diff <code>--cached</code> []</p>
</li>
<li><p>显示工作区与当前分支最新commit之间的差异<br>$ git diff <code>HEAD</code></p>
</li>
<li><p>显示两次提交之间的差异<br>$ git diff [first-branch]…[second-branch]</p>
</li>
<li><p>显示某次提交的元数据和内容变化<br>$ git show [commit]</p>
</li>
<li><p>显示某次提交发生变化的文件<br>$ git show <code>--name-only</code> [commit]</p>
</li>
<li><p>显示某次提交时，某个文件的内容<br>$ git show [commit]:[filename]</p>
</li>
<li><p>显示当前分支的最近几次提交<br>git reflog</p>
<blockquote>
<p>Reference logs, or “reflogs”, record when the tips of branches and other references were updated in the local repository. Reflogs are useful in various Git commands, to specify the old value of a reference.</p>
</blockquote>
</li>
</ul>
<p>reflog可以看到被删除的记录(如)，而git log不能。</p>
<h1 id="八、远程同步"><a href="#八、远程同步" class="headerlink" title="八、远程同步"></a>八、远程同步</h1><hr>
<ul>
<li>下载远程仓库的所有变动<br>$ git fetch [remote]</li>
</ul>
<blockquote>
<p>Download objects and refs from another repository<br>用”git fetch”” 来执行”git pull”前半部分的工作， 但是这条命令并不会把抓下来的修改合并到当前分支里。</p>
</blockquote>
<ul>
<li><p>显示所有远程仓库<br>$ git remote -v</p>
</li>
<li><p>显示某个远程仓库的信息<br>$ git remote show [remote]</p>
</li>
<li><p>增加一个新的远程仓库，并命名<br>$ git remote add [shortname] [url]</p>
</li>
<li><p>取回远程仓库的变化，并与本地分支合并<br>$ git pull [remote] [branch]</p>
</li>
<li><p>上传本地指定分支到远程仓库<br>$ git push [remote] [branch]</p>
</li>
<li><p>推送本地指定的分支名到远程仓库 - niko<br>$ git push origin develop:develop_remote<br>$ git push <remote> <local branch="" name="">:<remote branch="" to="" push="" into=""></remote></local></remote></p>
</li>
<li><p>强行推送当前分支到远程仓库，即使有冲突<br>$ git push [remote] –force</p>
</li>
<li><p>推送所有分支到远程仓库<br>$ git push [remote] –all</p>
</li>
<li><p>with rebase<br>git pull –rebase</p>
</li>
</ul>
<h1 id="九、撤销"><a href="#九、撤销" class="headerlink" title="九、撤销"></a>九、撤销</h1><ul>
<li><p>恢复暂存区的指定文件到工作区<br>$ git checkout [file]</p>
</li>
<li><p>恢复某个commit的指定文件到工作区<br>$ git checkout [commit] [file]</p>
</li>
<li><p>恢复上一个commit的所有文件到工作区<br>$ git checkout .</p>
</li>
<li><p>取消commit<br>$ git reset –soft HEAD~</p>
</li>
<li><p>重置暂存区的指定文件，与上一次commit保持一致，但工作区不变<br>$ git reset [file]<br>REF: <a href="http://stackoverflow.com/questions/927358/how-do-you-undo-the-last-commit" target="_blank" rel="external">http://stackoverflow.com/questions/927358/how-do-you-undo-the-last-commit</a></p>
</li>
<li><p>重置暂存区与工作区，与上一次commit保持一致<br>$ git <code>reset --hard</code></p>
</li>
<li><p>重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变<br>$ git reset [commit]</p>
</li>
<li><p>重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致<br>$ git reset <code>--hard</code> [commit]</p>
</li>
<li><p>重置当前HEAD为指定commit，但保持暂存区和工作区不变<br>$ git reset <code>--keep</code> [commit]</p>
</li>
<li><p>undo reset<br>git reflog<br>git reset HEAD@{1}<br><a href="http://stackoverflow.com/questions/2510276/undoing-git-reset" target="_blank" rel="external">undo reset</a></p>
</li>
<li><p>新建一个commit，用来撤销指定commit</p>
</li>
<li><p>后者的所有变化都将被前者抵消，并且应用到当前分支<br>$ git <code>revert [commit]</code></p>
</li>
<li><p>恢复删除的分支<br>// TODO<br><a href="http://stackoverflow.com/questions/16793637/recover-deleted-branch-git" target="_blank" rel="external">http://stackoverflow.com/questions/16793637/recover-deleted-branch-git</a><br><a href="https://confluence.atlassian.com/bbkb/how-to-restore-a-deleted-branch-765757540.html" target="_blank" rel="external">https://confluence.atlassian.com/bbkb/how-to-restore-a-deleted-branch-765757540.html</a></p>
</li>
<li><p>TODO rebase<br>If you prefer to skip this patch,<br><a href="https://help.github.com/articles/resolving-merge-conflicts-after-a-git-rebase/" target="_blank" rel="external">https://help.github.com/articles/resolving-merge-conflicts-after-a-git-rebase/</a></p>
</li>
</ul>
<h1 id="十、其他"><a href="#十、其他" class="headerlink" title="十、其他"></a>十、其他</h1><ul>
<li><p>生成一个可供发布的压缩包<br>git archive<br>via：ruanyifeng.com</p>
</li>
<li><p>git rebase<br>使分支历史看起来像没有经过合并一样。</p>
</li>
<li><p>分支上一次合并的信息 - niko<br>git show –summary <code>git merge-base A B</code></p>
</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【书：自控力】（五） 大脑的弥天大谎 为什么我们误把渴望当幸福？]]></title>
      <url>http://www.nikoai.pw/2015/12/23/books/self_ctrl/self_ctrl_5/</url>
      <content type="html"><![CDATA[<h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><hr>
<p><img src="/images/book_self_ctrl_5.png" alt=""></p>
<p>##</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用 docker 部署 java webapp]]></title>
      <url>http://www.nikoai.pw/2015/12/23/docker/docker_deploy_java_boot/</url>
      <content type="html"><![CDATA[<p>本文主要记录一下如何使用 docker 部署 java 的 webapp。</p>
<h1 id="建立-demo-webapp"><a href="#建立-demo-webapp" class="headerlink" title="建立 demo webapp"></a>建立 demo webapp</h1><hr>
<p>这里为了方便， 使用spring-boot来搭建一个webapp。</p>
<p>首先使用 maven 下载依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.niko.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>starter-web-docker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Boot Starter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Spring Boot Starter<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://projects.spring.io/spring-boot/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">organization</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Pivotal Software, Inc.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.spring.io<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">organization</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">main.basedir</span>&gt;</span>$&#123;basedir&#125;/../..<span class="tag">&lt;/<span class="name">main.basedir</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Add Spring repositories --&gt;</span></div><div class="line">    <span class="comment">&lt;!-- (you don't need this if you are using a .RELEASE version) --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>然后编写 启动器 和 Controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">home</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello Docker World"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构建包：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">mvn package</div></pre></td></tr></table></figure>
<p>成功后， <code>target</code> 文件夹下面会有一个 <code>starter-web-docker-1.3.1.RELEASE.jar</code> 文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ll ./target/</div><div class="line">total 15196</div><div class="line">drwxrwxr-x 8 niko niko     4096 Nov 13 17:13 ./</div><div class="line">drwxrwxr-x 5 niko niko     4096 Nov 13 17:12 ../</div><div class="line">drwxrwxr-x 3 niko niko     4096 Nov 13 17:12 classes/</div><div class="line">drwxrwxr-x 3 niko niko     4096 Nov 13 17:12 generated-sources/</div><div class="line">drwxrwxr-x 3 niko niko     4096 Nov 13 17:12 generated-test-sources/</div><div class="line">drwxrwxr-x 2 niko niko     4096 Nov 13 17:13 maven-archiver/</div><div class="line">drwxrwxr-x 3 niko niko     4096 Nov 13 17:13 maven-status/</div><div class="line">-rw-rw-r-- 1 niko niko 15521233 Nov 13 17:13 starter-web-docker-1.3.1.RELEASE.jar</div><div class="line">-rw-rw-r-- 1 niko niko     3594 Nov 13 17:13 starter-web-docker-1.3.1.RELEASE.jar.original</div><div class="line">drwxrwxr-x 2 niko niko     4096 Nov 13 17:12 test-classes/</div></pre></td></tr></table></figure>
<h1 id="编写-Dockerfile"><a href="#编写-Dockerfile" class="headerlink" title="编写 Dockerfile"></a>编写 Dockerfile</h1><hr>
<figure class="highlight docker"><table><tr><td class="code"><pre><div class="line"><span class="keyword">FROM</span> frolvlad/alpine-oraclejdk8:slim</div><div class="line"><span class="keyword">VOLUME</span> <span class="bash">/tmp</span></div><div class="line"><span class="keyword">ADD</span> <span class="bash">starter-web-docker-1.3.1.RELEASE.jar app.jar</span></div><div class="line"><span class="keyword">RUN</span> <span class="bash">sh -c <span class="string">'touch /app.jar'</span></span></div><div class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">""</span></div><div class="line">ENTRYPOINT [ <span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar"</span> ]</div></pre></td></tr></table></figure>
<h1 id="用-docker-maven-plugin-提高生产力"><a href="#用-docker-maven-plugin-提高生产力" class="headerlink" title="用 docker-maven-plugin 提高生产力"></a>用 docker-maven-plugin 提高生产力</h1><hr>
<p>自动生成 image.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>springio<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>src/main/docker<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="构建-image"><a href="#构建-image" class="headerlink" title="构建 image"></a>构建 image</h1><hr>
<p>现在开始构建 docker image.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ mvn package docker:build</div><div class="line">[INFO] Scanning for projects...</div><div class="line">[INFO]                                                                         </div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Building Spring Boot Starter 1.3.1.RELEASE</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO]</div><div class="line">[INFO] --- docker-maven-plugin:0.4.11:build (default-cli) @ starter-web-docker-hello ---</div><div class="line">[INFO] Copying /home/niko/dev/code/java/MavenProj/OpenSources/spring/spring-boot/starter-web-docker/target/starter-web-docker-hello-1.3.1.RELEASE.jar -&gt; /home/niko/dev/code/java/MavenProj/OpenSources/spring/spring-boot/starter-web-docker/target/docker/starter-web-docker-hello-1.3.1.RELEASE.jar</div><div class="line">[INFO] Copying src/main/docker/Dockerfile -&gt; /home/niko/dev/code/java/MavenProj/OpenSources/spring/spring-boot/starter-web-docker/target/docker/Dockerfile</div><div class="line">[INFO] Building image springio/starter-web-docker-hello</div><div class="line">Step 1 : FROM frolvlad/alpine-oraclejdk8:slim</div><div class="line"> ---&gt; a290f8607aef</div><div class="line">Step 2 : VOLUME /tmp</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; c4ed57bbd8e3</div><div class="line">Step 3 : ADD starter-web-docker-hello-1.3.1.RELEASE.jar app.jar</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 57c7382f828d</div><div class="line">Step 4 : RUN sh -c &apos;touch /app.jar&apos;</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 37ee84639687</div><div class="line">Step 5 : ENV JAVA_OPTS &quot;&quot;</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 3fd3017669ff</div><div class="line">Step 6 : ENTRYPOINT sh -c java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; e12ac1f796a2</div><div class="line">Successfully built e12ac1f796a2</div><div class="line">[INFO] Built springio/starter-web-docker-hello</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Total time: 2.745 s</div></pre></td></tr></table></figure>
<h1 id="查看-image"><a href="#查看-image" class="headerlink" title="查看 image"></a>查看 image</h1><hr>
<p>构建完成后， 可以查看主机上现有的 images ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ docker images</div><div class="line">REPOSITORY                          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">springio/starter-web-docker-hello   latest              e12ac1f796a2        5 minutes ago       198.2 MB</div><div class="line">frolvlad/alpine-oraclejdk8          slim                a290f8607aef        2 weeks ago         167.2 MB</div><div class="line">hello-world                         latest              c54a2cc56cbb        4 months ago        1.848 kB</div></pre></td></tr></table></figure>
<h1 id="启动-image"><a href="#启动-image" class="headerlink" title="启动 image"></a>启动 image</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ docker run -p 8080:8080 -t springio/starter-web-docker-hello:latest</div></pre></td></tr></table></figure>
<p>说明：<br>-p 进行端口映射， 格式为 <code>主机端口:容器端口</code><br>-t 分配一个 pseudo-TTY</p>
<h1 id="查看正在运行的-image"><a href="#查看正在运行的-image" class="headerlink" title="查看正在运行的 image"></a>查看正在运行的 image</h1><hr>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ docker ps</div><div class="line">CONTAINER ID        IMAGE                                      COMMAND                  CREATED              STATUS              PORTS                    NAMES</div><div class="line">b5154800fbeb        springio/starter-web-docker-hello:latest   &quot;sh -c &apos;java $JAVA_OP&quot;   About a minute ago   Up About a minute   0.0.0.0:8080-&gt;8080/tcp   ecstatic_ardinghelli</div></pre></td></tr></table></figure>
<p>可以看到， <code>springio/starter-web-docker-hello:latest</code> 正在运行， 此时打开 <code>localhost:8080</code> 也可以看到 <code>Hello Docker World</code> 的页面消息了。</p>
<h1 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h1><hr>
<p>可以指定 CONTAINER ID 来停止运行。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ docker stop b5154800fbeb</div><div class="line">b5154800fbeb</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://spring.io/guides/gs/spring-boot-docker/" target="_blank" rel="external">https://spring.io/guides/gs/spring-boot-docker/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【zookeeper 编程】 - 处理状态变化]]></title>
      <url>http://www.nikoai.pw/2015/12/22/java/zookeeper/zookeeper_prog_watcher-01/</url>
      <content type="html"><![CDATA[<p>下面通过一个示例演示, 如何监听一个node并接收和处理状态变更.</p>
<h1 id="监听和处理事件"><a href="#监听和处理事件" class="headerlink" title="监听和处理事件"></a>监听和处理事件</h1><hr>
<p>要实现监听, 首先需要实现<code>Watcher</code>接口:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Watcher</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(org.apache.zookeeper.WatchedEvent watchedEvent)</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Event</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后再使用<code>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher)</code>创建实例同时设置<code>Watcher</code>, 当有事件发生的时候, 那么<code>Watcher.process(WatchedEvent watchedEvent)</code> 将会被调用以处理事件, 比如连接、过期、中断、node 修改、子node修改等事件。</p>
<p>代码示例:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</div><div class="line">    String path = event.getPath();</div><div class="line">    <span class="keyword">if</span> (event.getType() == Event.EventType.None) &#123;</div><div class="line">        <span class="comment">// We are are being told that the state of the</span></div><div class="line">        <span class="comment">// connection has changed</span></div><div class="line">        <span class="keyword">switch</span> (event.getState()) &#123;</div><div class="line">        <span class="keyword">case</span> SyncConnected:</div><div class="line">            <span class="comment">// In this particular example we don't need to do anything</span></div><div class="line">            <span class="comment">// here - watches are automatically re-registered with</span></div><div class="line">            <span class="comment">// server and any watches triggered while the client was</span></div><div class="line">            <span class="comment">// disconnected will be delivered (in order of course)</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Expired:</div><div class="line">            <span class="comment">// It's all over</span></div><div class="line">            dead = <span class="keyword">true</span>;</div><div class="line">            listener.closing(KeeperException.Code.SessionExpired);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.equals(znode)) &#123;</div><div class="line">            <span class="comment">// Something has changed on the node, let's find out</span></div><div class="line">            zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (chainedWatcher != <span class="keyword">null</span>) &#123;</div><div class="line">        chainedWatcher.process(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="StatCallback"><a href="#StatCallback" class="headerlink" title="StatCallback"></a>StatCallback</h1><hr>
<p>上面的代码中有一个 <code>exists()</code>, 主要是进行检查node的状态并处理变更, 源码如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher,</span></span></div><div class="line">        StatCallback cb, Object ctx)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">final</span> String clientPath = path;</div><div class="line">    PathUtils.validatePath(clientPath);</div><div class="line"></div><div class="line">    <span class="comment">// the watch contains the un-chroot path</span></div><div class="line">    WatchRegistration wcb = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (watcher != <span class="keyword">null</span>) &#123;</div><div class="line">        wcb = <span class="keyword">new</span> ExistsWatchRegistration(watcher, clientPath);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> String serverPath = prependChroot(clientPath);</div><div class="line"></div><div class="line">    RequestHeader h = <span class="keyword">new</span> RequestHeader();</div><div class="line">    h.setType(ZooDefs.OpCode.exists);</div><div class="line">    ExistsRequest request = <span class="keyword">new</span> ExistsRequest();</div><div class="line">    request.setPath(serverPath);</div><div class="line">    request.setWatch(watcher != <span class="keyword">null</span>);</div><div class="line">    SetDataResponse response = <span class="keyword">new</span> SetDataResponse();</div><div class="line">    cnxn.queuePacket(h, <span class="keyword">new</span> ReplyHeader(), request, response, cb,</div><div class="line">            clientPath, serverPath, ctx, wcb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> watch, StatCallback cb, Object ctx)</span> </span>&#123;</div><div class="line">    exists(path, watch ? watchManager.defaultWatcher : <span class="keyword">null</span>, cb, ctx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div style="display: none"><br>获取 Stat的 exists() API docs:<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">org.apache.zookeeper.<span class="function">ZooKeeper</span></div><div class="line"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(String path,</span></div><div class="line">                   <span class="keyword">boolean</span> watch)</div><div class="line">           <span class="keyword">throws</span> KeeperException,</div><div class="line">                  InterruptedException</div><div class="line"></div><div class="line">Return the stat of the node of the given path. Return <span class="keyword">null</span> <span class="keyword">if</span> no such a node exists.</div><div class="line">If the watch is <span class="keyword">true</span> and the call is <span class="title">successful</span> <span class="params">(no exception is thrown)</span>, a watch will be left on the node with the given path. The watch will be triggered by a successful operation that creates/delete the node or sets the data on the node.</div><div class="line">Parameters:</div><div class="line">path - the node path</div><div class="line">watch - whether need to watch <span class="keyword">this</span> node</div><div class="line">Returns:</div><div class="line">the stat of the node of the given path; <span class="keyword">return</span> <span class="keyword">null</span> <span class="keyword">if</span> no such a node exists.</div><div class="line">Throws:</div><div class="line">KeeperException - If the server signals an error</div><div class="line">InterruptedException - If the server transaction is interrupted.</div></pre></td></tr></table></figure><br><br></div>






<p>从上可知, 我们需要传入一个<code>StatCallback</code>的实现, 进行 node state 改变的相关处理， <code>org.apache.zookeeper.AsyncCallback.StatCallback</code>接口定义如下 :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">StatCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, Stat stat)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">DataCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, <span class="keyword">byte</span> data[],</span></span></div><div class="line">                Stat stat);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ACLCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx,</span></span></div><div class="line">                List&lt;ACL&gt; acl, Stat stat);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ChildrenCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx,</span></span></div><div class="line">                List&lt;String&gt; children);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Children2Callback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx,</span></span></div><div class="line">                List&lt;String&gt; children, Stat stat);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">StringCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, String name)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">VoidCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现代码举例:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, Stat stat)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> exists;</div><div class="line">    <span class="keyword">switch</span> (rc) &#123;</div><div class="line">    <span class="keyword">case</span> Code.Ok:</div><div class="line">        exists = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> Code.NoNode:</div><div class="line">        exists = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> Code.SessionExpired:</div><div class="line">    <span class="keyword">case</span> Code.NoAuth:</div><div class="line">        dead = <span class="keyword">true</span>;</div><div class="line">        listener.closing(rc);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="comment">// Retry errors</span></div><div class="line">        zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">byte</span> b[] = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (exists) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            b = zk.getData(znode, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</div><div class="line">            <span class="comment">// We don't need to worry about recovering now. The watch</span></div><div class="line">            <span class="comment">// callbacks will kick off any exception handling</span></div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ((b == <span class="keyword">null</span> &amp;&amp; b != prevData)</div><div class="line">            || (b != <span class="keyword">null</span> &amp;&amp; !Arrays.equals(prevData, b))) &#123;</div><div class="line">        <span class="comment">// TODO</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>processResult()</code> 的调用关系图如下:</p>
<p><img src="/images/java/zookeeper/DataMonitor.processResult.invoke-relation-01.png" alt=""></p>
<p>可知, 当执行以下动作时, <code>processResult()</code>将会被调用 (因为 node state changed):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ZooKeeper.create(String, byte[], List&lt;ACL&gt;, CreateMode, StringCallback, Object)</div><div class="line">ZooKeeper.delete(String, int, VoidCallback, Object)</div><div class="line">ZooKeeper.exists(String, Watcher, StatCallback, Object)</div><div class="line">等等...</div></pre></td></tr></table></figure>
<p>然后在<code>processResult()</code>里面我们就可以处理变更的node了.</p>
<h1 id="示例源码"><a href="#示例源码" class="headerlink" title="示例源码"></a>示例源码</h1><hr>
<p>最后， 附上官网的 example 源码， 可以运行以下的代码体验一下更深刻:</p>
<h2 id="DataMonitor"><a href="#DataMonitor" class="headerlink" title="DataMonitor"></a><code>DataMonitor</code></h2><p>主要用来进行事件处理 <code>process(WatchedEvent event)</code>和 state changed 处理 <code>processResult(int rc, String path, Object ctx, Stat stat)</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataMonitor</span> <span class="keyword">implements</span> <span class="title">Watcher</span>, <span class="title">StatCallback</span> </span>&#123;</div><div class="line"></div><div class="line">    ZooKeeper zk;</div><div class="line"></div><div class="line">    String znode;</div><div class="line"></div><div class="line">    Watcher chainedWatcher;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> dead;</div><div class="line"></div><div class="line">    DataMonitorListener listener;</div><div class="line"></div><div class="line">    <span class="keyword">byte</span> prevData[];</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataMonitor</span><span class="params">(ZooKeeper zk, String znode, Watcher chainedWatcher,</span></span></div><div class="line">            DataMonitorListener listener) &#123;</div><div class="line">        <span class="keyword">this</span>.zk = zk;</div><div class="line">        <span class="keyword">this</span>.znode = znode;</div><div class="line">        <span class="keyword">this</span>.chainedWatcher = chainedWatcher;</div><div class="line">        <span class="keyword">this</span>.listener = listener;</div><div class="line">        <span class="comment">// Get things started by checking if the node exists. We are going</span></div><div class="line">        <span class="comment">// to be completely event driven</span></div><div class="line">        zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Other classes use the DataMonitor by implementing this method</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataMonitorListener</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * The existence status of the node has changed.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">byte</span> data[])</span></span>;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * The ZooKeeper session is no longer valid.</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> rc</div><div class="line">         *                the ZooKeeper reason code</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">closing</span><span class="params">(<span class="keyword">int</span> rc)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</div><div class="line">        String path = event.getPath();</div><div class="line">        <span class="keyword">if</span> (event.getType() == Event.EventType.None) &#123;</div><div class="line">            <span class="comment">// We are are being told that the state of the</span></div><div class="line">            <span class="comment">// connection has changed</span></div><div class="line">            <span class="keyword">switch</span> (event.getState()) &#123;</div><div class="line">            <span class="keyword">case</span> SyncConnected:</div><div class="line">                <span class="comment">// In this particular example we don't need to do anything</span></div><div class="line">                <span class="comment">// here - watches are automatically re-registered with</span></div><div class="line">                <span class="comment">// server and any watches triggered while the client was</span></div><div class="line">                <span class="comment">// disconnected will be delivered (in order of course)</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Expired:</div><div class="line">                <span class="comment">// It's all over</span></div><div class="line">                dead = <span class="keyword">true</span>;</div><div class="line">                listener.closing(KeeperException.Code.SessionExpired);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; path.equals(znode)) &#123;</div><div class="line">                <span class="comment">// Something has changed on the node, let's find out</span></div><div class="line">                zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (chainedWatcher != <span class="keyword">null</span>) &#123;</div><div class="line">            chainedWatcher.process(event);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, Stat stat)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> exists;</div><div class="line">        <span class="keyword">switch</span> (rc) &#123;</div><div class="line">        <span class="keyword">case</span> Code.Ok:</div><div class="line">            exists = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Code.NoNode:</div><div class="line">            exists = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Code.SessionExpired:</div><div class="line">        <span class="keyword">case</span> Code.NoAuth:</div><div class="line">            dead = <span class="keyword">true</span>;</div><div class="line">            listener.closing(rc);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="comment">// Retry errors</span></div><div class="line">            zk.exists(znode, <span class="keyword">true</span>, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">byte</span> b[] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (exists) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                b = zk.getData(znode, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</div><div class="line">                <span class="comment">// We don't need to worry about recovering now. The watch</span></div><div class="line">                <span class="comment">// callbacks will kick off any exception handling</span></div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((b == <span class="keyword">null</span> &amp;&amp; b != prevData)</div><div class="line">                || (b != <span class="keyword">null</span> &amp;&amp; !Arrays.equals(prevData, b))) &#123;</div><div class="line">            listener.exists(b);</div><div class="line">            prevData = b;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a><code>Executor</code></h2><p>启动程序和初始化, 根 Watcher，资源管理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executor</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Watcher</span>, <span class="title">Runnable</span>, <span class="title">DataMonitor</span>.<span class="title">DataMonitorListener</span></div><div class="line">&#123;</div><div class="line">    String znode;</div><div class="line"></div><div class="line">    DataMonitor dm;</div><div class="line"></div><div class="line">    ZooKeeper zk;</div><div class="line"></div><div class="line">    String filename;</div><div class="line"></div><div class="line">    String exec[];</div><div class="line"></div><div class="line">    Process child;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Executor</span><span class="params">(String hostPort, String znode, String filename,</span></span></div><div class="line">                    String exec[]) <span class="keyword">throws</span> KeeperException, IOException &#123;</div><div class="line">        <span class="keyword">this</span>.filename = filename;</div><div class="line">        <span class="keyword">this</span>.exec = exec;</div><div class="line">        zk = <span class="keyword">new</span> ZooKeeper(hostPort, <span class="number">3000</span>, <span class="keyword">this</span>);</div><div class="line">        dm = <span class="keyword">new</span> DataMonitor(zk, znode, <span class="keyword">null</span>, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> args</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">4</span>) &#123;</div><div class="line">            System.err</div><div class="line">                    .println(<span class="string">"USAGE: Executor hostPort znode filename program [args ...]"</span>);</div><div class="line">            System.exit(<span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line">        String hostPort = args[<span class="number">0</span>];</div><div class="line">        String znode = args[<span class="number">1</span>];</div><div class="line">        String filename = args[<span class="number">2</span>];</div><div class="line">        String exec[] = <span class="keyword">new</span> String[args.length - <span class="number">3</span>];</div><div class="line">        System.arraycopy(args, <span class="number">3</span>, exec, <span class="number">0</span>, exec.length);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Executor(hostPort, znode, filename, exec).run();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/***************************************************************************</span></div><div class="line">     * We do process any events ourselves, we just need to forward them on.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> org.apache.zookeeper.Watcher#process(org.apache.zookeeper.proto.WatcherEvent)</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</div><div class="line">        dm.process(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                <span class="keyword">while</span> (!dm.dead) &#123;</div><div class="line">                    wait();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closing</span><span class="params">(<span class="keyword">int</span> rc)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            notifyAll();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWriter</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        OutputStream os;</div><div class="line"></div><div class="line">        InputStream is;</div><div class="line"></div><div class="line">        StreamWriter(InputStream is, OutputStream os) &#123;</div><div class="line">            <span class="keyword">this</span>.is = is;</div><div class="line">            <span class="keyword">this</span>.os = os;</div><div class="line">            start();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">byte</span> b[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">80</span>];</div><div class="line">            <span class="keyword">int</span> rc;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> ((rc = is.read(b)) &gt; <span class="number">0</span>) &#123;</div><div class="line">                    os.write(b, <span class="number">0</span>, rc);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                System.out.println(<span class="string">"Killing process"</span>);</div><div class="line">                child.destroy();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    child.waitFor();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            child = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                System.out.println(<span class="string">"Stopping child"</span>);</div><div class="line">                child.destroy();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    child.waitFor();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(filename);</div><div class="line">                fos.write(data);</div><div class="line">                fos.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                System.out.println(<span class="string">"Starting child"</span>);</div><div class="line">                child = Runtime.getRuntime().exec(exec);</div><div class="line">                <span class="keyword">new</span> StreamWriter(child.getInputStream(), System.out);</div><div class="line">                <span class="keyword">new</span> StreamWriter(child.getErrorStream(), System.err);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://zookeeper.apache.org/doc/r3.4.6/zookeeperProgrammers.html#_introduction" target="_blank" rel="external">ZooKeeper Programmer’s Guide</a><br><a href="https://zookeeper.apache.org/doc/r3.4.6/javaExample.html" target="_blank" rel="external">https://zookeeper.apache.org/doc/r3.4.6/javaExample.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【转】 如何用十条命令在一分钟内检查Linux服务器性能]]></title>
      <url>http://www.nikoai.pw/2015/12/20/linux/ten-cmd-linux-performance/</url>
      <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>通过执行以下命令，可以在1分钟内对系统资源使用情况有个大致的了解。</p>
<p>其中一些命令需要安装sysstat包，有一些由procps包提供。这些命令的输出，有助于快速定位性能瓶颈，检查出所有资源（CPU、内存、磁盘IO等）的利用率（utilization）、饱和度（saturation）和错误（error）度量，也就是所谓的<a href="http://www.brendangregg.com/usemethod.html" target="_blank" rel="external">USE方法</a>。</p>
<p>下面我们来逐一介绍下这些命令，有关这些命令更多的参数和说明，请参照命令的手册。</p>
<h2 id="uptime"><a href="#uptime" class="headerlink" title="uptime"></a>uptime</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ uptime</div><div class="line">23:51:26 up 21:31,  1 user,  load average: 30.02, 26.43, 19.02</div></pre></td></tr></table></figure>
<p>分别表示1分钟、5分钟、15分钟的平均负载情况</p>
<h2 id="dmesg-tail"><a href="#dmesg-tail" class="headerlink" title="dmesg | tail"></a>dmesg | tail</h2><p>该命令会输出系统日志，可以帮助排查性能问题（如内核的oom kill和一次TCP丢包等）。</p>
<h2 id="vmstat-1"><a href="#vmstat-1" class="headerlink" title="vmstat 1"></a>vmstat 1</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">niko@ubuntu:~$ vmstat 1</div><div class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</div><div class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</div><div class="line"> 2  0   4176 2746396 160728 1916384    0    0    15    85   12   47  9  7 84  0  0</div><div class="line"> 0  0   4176 2746228 160728 1916416    0    0     0     0 2129 4270  3  4 93  0  0</div><div class="line"> 1  0   4176 2746420 160748 1916468    0    0     0   372 1865 3960  4  5 91  0  0</div><div class="line"> 0  0   4176 2744964 160748 1916416    0    0     0     0 2000 4256  2  4 93  0  0</div><div class="line"> 1  0   4176 2745316 160748 1916420    0    0     0     0 2032 4288  2  4 94  0  0</div><div class="line"> 0  0   4176 2745052 160748 1916420    0    0     0     0 2070 4496  1  5 94  0  0</div><div class="line"> 0  0   4176 2744984 160748 1916420    0    0     0     0 2099 4202  2  5 93  0  0</div></pre></td></tr></table></figure>
<p>vmstat(8) 命令，每行会输出一些系统核心指标，这些指标可以让我们更详细的了解系统状态。后面跟的参数1，表示每秒输出一次统计信息，表头提示了每一列的含义，这几介绍一些和性能调优相关的列：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">FIELD DESCRIPTION FOR VM MODE</div><div class="line">   Procs</div><div class="line">       r: The number of runnable processes (running or waiting for run time).</div><div class="line">       b: The number of processes in uninterruptible sleep.</div><div class="line"></div><div class="line">   Memory</div><div class="line">       swpd: the amount of virtual memory used.</div><div class="line">       free: the amount of idle memory.</div><div class="line">       buff: the amount of memory used as buffers.</div><div class="line">       cache: the amount of memory used as cache.</div><div class="line">       inact: the amount of inactive memory.  (-a option)</div><div class="line">       active: the amount of active memory.  (-a option)</div><div class="line"></div><div class="line">   Swap</div><div class="line">       si: Amount of memory swapped in from disk (/s).</div><div class="line">       so: Amount of memory swapped to disk (/s).</div><div class="line"></div><div class="line">   IO</div><div class="line">       bi: Blocks received from a block device (blocks/s).</div><div class="line">       bo: Blocks sent to a block device (blocks/s).</div><div class="line"></div><div class="line">   System</div><div class="line">       in: The number of interrupts per second, including the clock.</div><div class="line">       cs: The number of context switches per second.</div></pre></td></tr></table></figure>
<p>r：等待在CPU资源的进程数。这个数据比平均负载更加能够体现CPU负载情况，数据中不包含等待IO的进程。如果这个数值大于机器CPU核数，那么机器的CPU资源已经饱和。<br>free：系统可用内存数（以千字节为单位），如果剩余内存不足，也会导致系统性能问题。下文介绍到的free命令，可以更详细的了解系统内存的使用情况。</p>
<p>si, so：交换区写入和读取的数量。如果这个数据不为0，说明系统已经在使用交换区（swap），机器物理内存已经不足。</p>
<p>us, sy, id, wa, st：这些都代表了CPU时间的消耗，它们分别表示用户时间（user）、系统（内核）时间（sys）、空闲时间（idle）、IO等待时间（wait）和被偷走的时间（stolen，一般被其他虚拟机消耗）。</p>
<p>上述这些CPU时间，可以让我们很快了解CPU是否出于繁忙状态。一般情况下，如果用户时间和系统时间相加非常大，CPU出于忙于执行指令。如果IO等待时间很长，那么系统的瓶颈可能在磁盘IO。</p>
<p>示例命令的输出可以看见，大量CPU时间消耗在用户态，也就是用户应用程序消耗了CPU时间。这不一定是性能问题，需要结合r队列，一起分析。</p>
<h2 id="mpstat-P-ALL-1"><a href="#mpstat-P-ALL-1" class="headerlink" title="mpstat -P ALL 1"></a>mpstat -P ALL 1</h2><p>显示每个CPU的使用情况：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">niko@ubuntu:~$ mpstat -P ALL 1</div><div class="line">Linux 3.13.0-39-generic (ubuntu) 	03/18/2016 	_x86_64_	(4 CPU)</div><div class="line"></div><div class="line">01:18:13 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle</div><div class="line">01:18:14 PM  all    8.70    0.00   18.84    0.58    0.00    1.45    0.00    0.00    0.00   70.43</div><div class="line">01:18:14 PM    0    7.06    0.00   16.47    0.00    0.00    2.35    0.00    0.00    0.00   74.12</div><div class="line">01:18:14 PM    1    7.78    0.00   18.89    1.11    0.00    2.22    0.00    0.00    0.00   70.00</div><div class="line">01:18:14 PM    2   11.76    0.00   17.65    2.35    0.00    1.18    0.00    0.00    0.00   67.06</div><div class="line">01:18:14 PM    3    8.24    0.00   21.18    0.00    0.00    0.00    0.00    0.00    0.00   70.59</div></pre></td></tr></table></figure>
<h2 id="pidstat-1"><a href="#pidstat-1" class="headerlink" title="pidstat 1"></a>pidstat 1</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pidstat 1</div><div class="line">Linux 3.13.0-49-generic (titanclusters-xxxxx)  07/14/2015    _x86_64_    (32 CPU)</div><div class="line">07:41:02 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command</div><div class="line">07:41:03 PM     0         9    0.00    0.94    0.00    0.94     1  rcuos/0</div><div class="line">07:41:03 PM     0      4214    5.66    5.66    0.00   11.32    15  mesos-slave</div><div class="line">07:41:03 PM     0      4354    0.94    0.94    0.00    1.89     8  java</div><div class="line">07:41:03 PM     0      6521 1596.23    1.89    0.00 1598.11    27  java</div><div class="line">07:41:03 PM     0      6564 1571.70    7.55    0.00 1579.25    28  java</div><div class="line">07:41:03 PM 60004     60154    0.94    4.72    0.00    5.66     9  pidstat</div><div class="line">07:41:03 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command</div><div class="line">07:41:04 PM     0      4214    6.00    2.00    0.00    8.00    15  mesos-slave</div><div class="line">07:41:04 PM     0      6521 1590.00    1.00    0.00 1591.00    27  java</div><div class="line">07:41:04 PM     0      6564 1573.00   10.00    0.00 1583.00    28  java</div><div class="line">07:41:04 PM   108      6718    1.00    0.00    0.00    1.00     0  snmp-pass</div><div class="line">07:41:04 PM 60004     60154    1.00    4.00    0.00    5.00     9  pidstat</div><div class="line">^C</div></pre></td></tr></table></figure>
<p>pidstat命令输出进程的CPU占用率，该命令会持续输出，并且不会覆盖之前的数据，可以方便观察系统动态。如上的输出，可以看见两个JAVA进程占用了将近1600%的CPU时间，既消耗了大约16个CPU核心的运算资源。</p>
<h2 id="iostat-xz-1"><a href="#iostat-xz-1" class="headerlink" title="iostat -xz 1"></a>iostat -xz 1</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ iostat -xz 1</div><div class="line"></div><div class="line">Linux 3.13.0-49-generic (titanclusters-xxxxx)  07/14/2015  _x86_64_ (32 CPU)</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">          73.96    0.00    3.73    0.03    0.06   22.21</div><div class="line"></div><div class="line">Device:   rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</div><div class="line">xvda        0.00     0.23    0.21    0.18     4.52     2.08    34.37     0.00    9.98   13.80    5.42   2.44   0.09</div><div class="line">xvdb        0.01     0.00    1.02    8.94   127.97   598.53   145.79     0.00    0.43    1.78    0.28   0.25   0.25</div><div class="line">xvdc        0.01     0.00    1.02    8.86   127.79   595.94   146.50     0.00    0.45    1.82    0.30   0.27   0.26</div><div class="line">dm-0        0.00     0.00    0.69    2.32    10.47    31.69    28.01     0.01    3.23    0.71    3.98   0.13   0.04</div><div class="line">dm-1        0.00     0.00    0.00    0.94     0.01     3.78     8.00     0.33  345.84    0.04  346.81   0.01   0.00</div><div class="line">dm-2        0.00     0.00    0.09    0.07     1.35     0.36    22.50     0.00    2.55    0.23    5.62   1.78   0.03</div><div class="line">[...]</div><div class="line">^C</div></pre></td></tr></table></figure>
<p>iostat命令主要用于查看机器磁盘IO情况。该命令输出的列，主要含义是：</p>
<p>r/s, w/s, rkB/s, wkB/s：分别表示每秒读写次数和每秒读写数据量（千字节）。读写量过大，可能会引起性能问题。</p>
<p>await：IO操作的平均等待时间，单位是毫秒。这是应用程序在和磁盘交互时，需要消耗的时间，包括IO等待和实际操作的耗时。如果这个数值过大，可能是硬件设备遇到了瓶颈或者出现故障。</p>
<p>avgqu-sz：向设备发出的请求平均数量。如果这个数值大于1，可能是硬件设备已经饱和（部分前端硬件设备支持并行写入）。</p>
<p>%util：设备利用率。这个数值表示设备的繁忙程度，经验值是如果超过60，可能会影响IO性能（可以参照IO操作平均等待时间）。如果到达100%，说明硬件设备已经饱和。<br>如果显示的是逻辑设备的数据，那么设备利用率不代表后端实际的硬件设备已经饱和。值得注意的是，即使IO性能不理想，也不一定意味这应用程序性能会不好，可以利用诸如预读取、写缓存等策略提升应用性能。</p>
<h2 id="free-m"><a href="#free-m" class="headerlink" title="free -m"></a><code>free</code> -m</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ free -m</div><div class="line">             total       used       free     shared    buffers     cached</div><div class="line">Mem:        245998      24545     221453         83         59        541</div><div class="line">-/+ buffers/cache:      23944     222053</div><div class="line">Swap:            0          0          0</div></pre></td></tr></table></figure>
<p>free命令可以查看系统内存的使用情况，-m参数表示按照兆字节展示。最后两列分别表示用于IO缓存的内存数，和用于文件系统页缓存的内存数。需要注意的是，第二行-/+ buffers/cache，看上去缓存占用了大量内存空间。这是Linux系统的内存使用策略，尽可能的利用内存，如果应用程序需要内存，这部分内存会立即被回收并分配给应用程序。因此，这部分内存一般也被当成是可用内存。</p>
<p>如果可用内存非常少，系统可能会动用交换区（如果配置了的话），这样会增加IO开销（可以在iostat命令中提现），降低系统性能。</p>
<h2 id="网络吞吐"><a href="#网络吞吐" class="headerlink" title="网络吞吐"></a>网络吞吐</h2><p><code>sar -n DEV 1</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sar -n DEV 1</div><div class="line">Linux 3.13.0-49-generic (titanclusters-xxxxx)  07/14/2015     _x86_64_    (32 CPU)</div><div class="line">12:16:48 AM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</div><div class="line">12:16:49 AM      eth0  18763.00   5032.00  20686.42    478.30      0.00      0.00      0.00      0.00</div><div class="line">12:16:49 AM        lo     14.00     14.00      1.36      1.36      0.00      0.00      0.00      0.00</div><div class="line">12:16:49 AM   docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</div><div class="line">12:16:49 AM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil</div><div class="line">12:16:50 AM      eth0  19763.00   5101.00  21999.10    482.56      0.00      0.00      0.00      0.00</div><div class="line">12:16:50 AM        lo     20.00     20.00      3.25      3.25      0.00      0.00      0.00      0.00</div><div class="line">12:16:50 AM   docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00</div><div class="line">^C</div></pre></td></tr></table></figure>
<p>sar命令在这里可以查看网络设备的吞吐率。在排查性能问题时，可以通过网络设备的吞吐量，判断网络设备是否已经饱和。如示例输出中，eth0网卡设备，吞吐率大概在22 Mbytes/s，既176 Mbits/sec，没有达到1Gbit/sec的硬件上限。</p>
<p><code>sar -n TCP,ETCP 1</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sar -n TCP,ETCP 1</div><div class="line">Linux 3.13.0-49-generic (titanclusters-xxxxx)  07/14/2015    _x86_64_    (32 CPU)</div><div class="line">12:17:19 AM  active/s passive/s    iseg/s    oseg/s</div><div class="line">12:17:20 AM      1.00      0.00  10233.00  18846.00</div><div class="line">12:17:19 AM  atmptf/s  estres/s retrans/s isegerr/s   orsts/s</div><div class="line">12:17:20 AM      0.00      0.00      0.00      0.00      0.00</div><div class="line">12:17:20 AM  active/s passive/s    iseg/s    oseg/s</div><div class="line">12:17:21 AM      1.00      0.00   8359.00   6039.00</div><div class="line">12:17:20 AM  atmptf/s  estres/s retrans/s isegerr/s   orsts/s</div><div class="line">12:17:21 AM      0.00      0.00      0.00      0.00      0.00</div><div class="line">^C</div></pre></td></tr></table></figure>
<p>sar命令在这里用于查看TCP连接状态，其中包括：</p>
<p>active/s：每秒本地发起的TCP连接数，既通过connect调用创建的TCP连接；<br>passive/s：每秒远程发起的TCP连接数，即通过accept调用创建的TCP连接；<br>retrans/s：每秒TCP重传数量；</p>
<p>atmptf/s<br>     The number of times per second TCP connections have made a direct transition to the CLOSED state from either the SYN-SENT state or the SYN-RCVD state, plus the number of times  per  second  TCP  connections<br>     have made a direct transition to the LISTEN state from the SYN-RCVD state [tcpAttemptFails].</p>
<p>estres/s<br>     The number of times per second TCP connections have made a direct transition to the CLOSED state from either the ESTABLISHED state or the CLOSE-WAIT state [tcpEstabResets].</p>
<p>retrans/s<br>     The total number of segments retransmitted per second - that is, the number of TCP segments transmitted containing one or more previously transmitted octets [tcpRetransSegs].</p>
<p>isegerr/s<br>     The total number of segments received in error (e.g., bad TCP checksums) per second [tcpInErrs].</p>
<p>TCP连接数可以用来判断性能问题是否由于建立了过多的连接，进一步可以判断是主动发起的连接，还是被动接受的连接。TCP重传可能是因为网络环境恶劣，或者服务器压力过大导致丢包。</p>
<h2 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h2><p>top命令包含了前面好几个命令的检查的内容。比如系统负载情况（uptime）、系统内存使用情况（free）、系统CPU使用情况（vmstat）等。因此通过这个命令，可以相对全面的查看系统负载的来源。同时，top命令支持排序，可以按照不同的列排序，方便查找出诸如内存占用最多的进程、CPU占用率最高的进程等。</p>
<p>但是，top命令相对于前面一些命令，输出是一个瞬间值，如果不持续盯着，可能会错过一些线索。这时可能需要暂停top命令刷新，来记录和比对数据。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>排查Linux服务器性能问题还有很多工具，上面介绍的一些命令，可以帮助我们快速的定位问题。例如前面的示例输出，多个证据证明有JAVA进程占用了大量CPU资源，之后的性能调优就可以针对应用程序进行。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
<p>【1】原文：<a href="http://techblog.netflix.com/2015/11/linux-performance-analysis-in-60s.html" target="_blank" rel="external">Netflix性能工程团队的这篇博文</a><br>【2】 <a href="http://www.infoq.com/cn/news/2015/12/linux-performance?utm_campaign=rightbar_v2&amp;utm_source=infoq&amp;utm_medium=news_link&amp;utm_content=link_text" target="_blank" rel="external">金灵杰 译 InfoQ</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在ubuntu上安装vmware]]></title>
      <url>http://www.nikoai.pw/2015/12/19/linux/install/install_vmware_on_ubuntu/</url>
      <content type="html"><![CDATA[<h1 id="install-vmware-on-ubuntu"><a href="#install-vmware-on-ubuntu" class="headerlink" title="install vmware on ubuntu"></a>install vmware on ubuntu</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">download VMware-Workstation-Full-10.0.6-2700073.x86_64.bundle</div><div class="line">chmod u+x ./VMware-Workstation-Full-10.0.6-2700073.x86_64.bundle</div><div class="line">./VMware-Workstation-Full-10.0.6-2700073.x86_64.bundle</div></pre></td></tr></table></figure>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="super-键被宿主机拦截"><a href="#super-键被宿主机拦截" class="headerlink" title="super 键被宿主机拦截"></a>super 键被宿主机拦截</h2><p><a href="http://askubuntu.com/questions/485303/how-do-i-stop-ubuntu-from-intercepting-the-super-key-when-running-vmware" target="_blank" rel="external">解决方法</a>是:</p>
<blockquote>
<p>Pressing the Super key invokes the Unity Dash.<br>Pressing and holding the Super key invokes the keyboard shortcut overlay.<br>I suspect you are doing the later, based on your description.<br>Nevertheless, you could change the key used to invoke the Unity Dash using Unity Tweak Tool. This way, VMware will get your key-press signal immediately, when you press Super.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">Install Unity Tweak Tool</div><div class="line"></div><div class="line">sudo apt-get install unity-tweak-tool</div><div class="line"></div><div class="line">Launch Unity Tewak Tool.</div><div class="line"></div><div class="line">In the Unity section, select Additional.</div><div class="line"></div><div class="line">Click on &lt;Super&gt; next to Show the launcher.</div><div class="line"></div><div class="line">Select a different key (or key-combination) to invoke the launcher.</div></pre></td></tr></table></figure>
<h2 id="cached-Memory"><a href="#cached-Memory" class="headerlink" title="cached Memory"></a>cached Memory</h2><p>有同学反应, 在关闭vmware后, free内存并没有增加, 大概是下面这样: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">top - 11:59:35 up  3:14, 13 users,  load average: 0.49, 0.52, 0.51</div><div class="line">Tasks: 264 total,   3 running, 261 sleeping,   0 stopped,   0 zombie</div><div class="line">%Cpu(s):  4.8 us,  2.9 sy,  0.0 ni, 92.0 id,  0.2 wa,  0.1 hi,  0.0 si,  0.0 st</div><div class="line">KiB Mem:  16380532 total, 12103952 used,  4276580 free,  3168896 buffers</div><div class="line">KiB Swap:  8386556 total,        0 used,  8386556 free.  5171564 cached Mem</div><div class="line"></div><div class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                        </div><div class="line"> 6520 niko      20   0 4635876 971856  35672 S   4.6  5.9  15:55.71 java                                           </div><div class="line">10006 niko      20   0 2750752 365712 101492 S   1.7  2.2   0:58.00 et</div></pre></td></tr></table></figure>
<p>如上, 我的是16G内存的机子, 但是显示使用了12G, 刚才关闭了5G的vmware虚拟机, 但是内存仍在<code>cached Mem</code>中.</p>
<p>其实, 当你执行复制文件时, 也是这样的, 不用担心, 相关内容请看另一篇博客.<br>// TODO</p>
<p>#</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java版目录watchdog]]></title>
      <url>http://www.nikoai.pw/2015/12/01/java/utils/java_dir_watchdog/</url>
      <content type="html"><![CDATA[<p>工作中我们经常会用到监听目录的功能, 当目录中有文件增加删除等操作时, 执行某些任务. 如果是Java来写, 怎么做呢 ?</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><p>实现这个功能, 我们要使用到<code>WatchService</code>和<code>Path</code>这两个东西, 首先创建一个WatchService:</p>
<pre><code>WatchService watcher = FileSystems.getDefault().newWatchService();
</code></pre><p>接着就可以注册这个WatchService到某个Path了:</p>
<pre><code>Path dir = ...;
WatchKey key = dir.register(watcher, ENTRY_CREATE, ENTRY_DELETE, ENTRY_MODIFY);
`ENTRY_CREATE`等事件定义在`StandardWatchEventKinds`中.
</code></pre><p>注册后, 我们使用<code>WatchService.take()</code>就可以获取目录变更的事件了, 若没有, 则wait .</p>
<h1 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h1><p>接下来就是写一个工具类<code>WatchDirUtils</code>, 用来接收和注册监听请求及回调.</p>
<p>相对于<code>WatchDirUtils</code>, 客户端的需求无非就两个, 一个是要监听的目录, 另一个是变更时的Callback. 我们可以封装成一个类.</p>
<p>我们暂且定义<code>WatchPath</code>和<code>WatchCallback</code>两个接口:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public interface WatchPath &#123;</div><div class="line">    public java.nio.file.Path getPath();</div><div class="line">&#125;</div><div class="line">public interface WatchCallback &#123;</div><div class="line">    public void handle(WatchEvent&lt;?&gt; event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后, 定义一个<code>WatchRequest</code>接口, 继承<code>WatchPath</code>和<code>WatchCallback</code>, 同时要求返回是否递归监听.<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public interface WatchRequest extends WatchPath, WatchCallback &#123;</div><div class="line">    public boolean isRecursive();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接口定义好了, 接下来就是实现了, 我们新建一个<code>DebugWatchRequest</code>实现类,</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public class DebugWatchRequest implements WatchRequest &#123;</div><div class="line">    ...</div><div class="line">    @Override</div><div class="line">    public void handle(WatchEvent&lt;Path&gt; ev) &#123;</div><div class="line">        Path name = ev.context();</div><div class="line">        Path child = dir.resolve(name);</div><div class="line">        System.out.format(&quot;%s: %s\n&quot;, event.kind().name(), child);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>封装好了watch请求, 只需要定义一个静态方法, 把请求传入即可.</p>
<pre><code>WatchDirUtils.register(new DebugWatchRequest(Path dir));
</code></pre><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public static void register(WatchRequest watchRequest) throws IOException &#123;</div><div class="line">        if (started.compareAndSet(false, true)) &#123;</div><div class="line">            init();</div><div class="line">        &#125;</div><div class="line">        if (serviceDown.get()) &#123;</div><div class="line">            throw new Exception(&quot;watch service down.&quot;);</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            Path dir = watchRequest.getPath();</div><div class="line">            if (watchRequest.isRecursive()) &#123;</div><div class="line">                System.out.format(&quot;Scanning %s ...\n&quot;, dir);</div><div class="line">                registerRecursive(dir, watchRequest);</div><div class="line">                System.out.println(&quot;Done.&quot;);</div><div class="line">            &#125; else &#123;</div><div class="line">                registerNonRecursive(watchRequest);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>当该方法第一次被调用时, 会进行初始化:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">private static void init() throws IOException &#123;</div><div class="line">        watcher = FileSystems.getDefault().newWatchService();</div><div class="line">        keysToWatchRequest = new ConcurrentHashMap&lt;&gt;();</div><div class="line">        trace = true;</div><div class="line"></div><div class="line">        // 启动线程来处理事件</div><div class="line">        ExecutorService exec = Executors.newSingleThreadExecutor();</div><div class="line">        exec.execute(new EventProcessor());</div><div class="line"></div><div class="line">        serviceDown.set(false);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>初始化包括新建watcher, 还有keysToWatchRequest(<br>在前面的介绍中, 我们已经知道, register某个目录后, 会有一个WatchKey返回, 所以需要有一个Map来关联WatchKey和Callback ).</p>
<p>最后启动一个线程来从watcher获取变更的事件, 并调用对应的Callback去handle该事件.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// EventProcessor</div><div class="line"></div><div class="line">private static class EventProcessor implements Runnable &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            while (!Thread.interrupted()) &#123;</div><div class="line">                // wait for key to be signalled</div><div class="line">                WatchKey key;</div><div class="line">                try &#123;</div><div class="line">                    key = watcher.take();</div><div class="line">                &#125; catch (InterruptedException x) &#123;</div><div class="line">                    serviceDown();</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                WatchRequest watchRequest = keysToWatchRequest.get(key);</div><div class="line">                if (watchRequest == null) &#123;</div><div class="line">                    System.err.println(&quot;WatchKey not recognized (no cb) !!&quot;);</div><div class="line">                    continue;</div><div class="line">                &#125;</div><div class="line">                Path dir = watchRequest.getPath();</div><div class="line">                if (dir == null) &#123;</div><div class="line">                    System.err.println(&quot;WatchKey not recognized (no path) !!&quot;);</div><div class="line">                    continue;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                for (WatchEvent&lt;?&gt; event: key.pollEvents()) &#123;</div><div class="line">                    WatchEvent.Kind kind = event.kind();</div><div class="line">                    // TBD - provide example of how OVERFLOW event is handled</div><div class="line">                    if (kind == OVERFLOW) &#123;</div><div class="line">                        continue;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    // handle</div><div class="line">                    watchRequest.handle(event);</div><div class="line"></div><div class="line">                    // Context for directory entry event is the file name of entry</div><div class="line">                    WatchEvent&lt;Path&gt; ev = cast(event);</div><div class="line">                    Path name = ev.context();</div><div class="line">                    Path child = dir.resolve(name);</div><div class="line"></div><div class="line">                    // if directory is created, and watching recursively, then</div><div class="line">                    // register it and its sub-directories</div><div class="line">                    if (watchRequest.isRecursive() &amp;&amp; (kind == ENTRY_CREATE)) &#123;</div><div class="line">                        try &#123;</div><div class="line">                            if (Files.isDirectory(child, NOFOLLOW_LINKS)) &#123;</div><div class="line">                                registerRecursive(child, new DebugWatchRequest(child).setIsRecursive(true));</div><div class="line">                            &#125;</div><div class="line">                        &#125; catch (IOException x) &#123;</div><div class="line">                            // ignore to keep sample readbale</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // reset key and remove from set if directory no longer accessible</div><div class="line">                boolean valid = key.reset();</div><div class="line">                if (!valid) &#123;</div><div class="line">                    keysToWatchRequest.remove(key);</div><div class="line"></div><div class="line">                    // all directories are inaccessible</div><div class="line">                    if (keysToWatchRequest.isEmpty()) &#123;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            serviceDown();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private void serviceDown() &#123;</div><div class="line">            serviceDown.set(true);</div><div class="line">            // TODO REPORT IT</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h1 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h1><p>这个demo实现了一个简单的目录watch功能, 还有许多地方需要改进. 比如:</p>
<ul>
<li><strong>InterruptedException等异常 及 客户端自定义通知方</strong></li>
</ul>
<p>当发生interrupt时, 应该停止服务释放资源, 进行记录日志并通过一些report通知给中控或相关人员, 关闭WatchService等 不过也应支持一下客户端自定义通知方式.<br>同时,  OVERFLOW等异常也要有对应的处理方式, 这个WatchService也不能100%保证可靠, 可以采取一些定时扫描的其他措施来弥补.</p>
<ul>
<li><strong>事件的处理和Callback的调用效率</strong></li>
</ul>
<p>目前的事件处理线程是只有一个的, 而且Callback的handle()时同步调用的.</p>
<p><strong> 那能够改成异步的呢 ? </strong></p>
<p>这个要看情况.<br>如果这个回调操作是次要业务, 那就不能使用异步. 因为如果一瞬间促发了许多回调, 那么这些回调同时运行, 极有可能迅速占用系统功能, 影响主业务, 甚至崩溃.<br>使用异步是有一定风险的, 不过开多几个线程还是可以考虑的.</p>
<ul>
<li><strong>支持多个WatchCallback</strong></li>
</ul>
<p>这个demo支持一个WatchKey对应一个Callback, 当有新的到来时, 就会覆盖旧的, 这个明显不太好. 不过要支持多个WatchCallback也很容易修改.</p>
<ul>
<li><strong>增加取消注册的功能</strong></li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://docs.oracle.com/javase/tutorial/essential/io/notification.html" target="_blank" rel="external">https://docs.oracle.com/javase/tutorial/essential/io/notification.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Git 分支管理]]></title>
      <url>http://www.nikoai.pw/2015/11/30/git/git_flow/</url>
      <content type="html"><![CDATA[<h2 id="为什么要用分支"><a href="#为什么要用分支" class="headerlink" title="为什么要用分支"></a>为什么要用分支</h2><hr>
<p>记得刚加入现在团队的时候，和boss搭了GOGS（类似的还有gitlab），到最近完成v0.1版本，一直都是用一个分支了。最近团队加入了几个新成员，产品那边也有大量的新需求和迭代。若还不进行分支管理，必定一定会陷入混乱（如果你问为什么？看了后面的分支管理模型，你就会恍然大悟）。</p>
<p>这也让我想起在第一家公司实习的时候，有一个team，用了git，后来发现，只是用来更新和提交，真是高射炮打蚊子。就算是后来人员扩充了之后，仍然没有分支管理，当时觉得不可思议。他们的产品迭代速度很慢，质量也很差，我觉得这跟他们的代码管理也有一点关系。</p>
<h2 id="一个通用模型"><a href="#一个通用模型" class="headerlink" title="一个通用模型"></a>一个通用模型</h2><hr>
<p>关于分支的管理和工程实践上，最广为认知的是Vincent Driessen在2010年发表的一篇博客：<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="external">《一种成功的Git分支管理模型》</a>，这篇博客总结了一种通用的分支管理模型，这个模型可以覆盖大部分的场景和研发流程。或许你没看过这篇博客，但如果你参与过团队分支管理策略的制定，你一定可以找到共鸣。</p>
<p>博客中有一张图很清晰地描述了这个模型和各种场景：<br><img src="/images/git-model@2x.png" alt=""></p>
<p>我记得在第一次实习时，团队中用的是svn，那时还没看过这篇博客，不过那时我们根据研发流程和需求场景制定出来的svn分支管理策略和这个类似，只是一个简化版，没有做太细。有一部分原因是因为svn的分支功能确实sucks，团队也不想浪费太多精力和成本。据说现在他们也换为git了，因为并行开发的功能太多了，svn终于让他们“心力交瘁”。</p>
<h3 id="git-flow"><a href="#git-flow" class="headerlink" title="git-flow"></a>git-flow</h3><hr>
<p>git的分支管理非常强大和方便，而git-flow可以让我们简化分支管理的操作。git-flow是git的一个扩展集，按<code>Vincent Driessen</code>的分支模型提供高层的操作，具体可参考<a href="http://danielkummer.github.io/git-flow-cheatsheet/index.zh_CN.html" target="_blank" rel="external">这篇指南</a>。</p>
<p>（现在想起当年用svn的分支管理，仍隐隐觉得蛋疼。那一堆堆tree-conflict（尤其是目录）历历在目，还好后来转到git）</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>修改配置<br>git flow config<br>或者，修改配置文件：<br>vim your_repo/.git/config</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr>
<p>分支管理是一门管理艺术，一味地盲目模仿不切实际，只会增加混乱和成本，在执行上也会遇到各种阻碍，所以针对自身团队和业务特点，找到最适合自己的管理策略。不过若你的产品需要快速的更新和迭代，你一定要试一下git。</p>
<!--
1. 小张和小何在开发两个大功能（`A-v0.1`和`B-v0.1`），小张先完成了A，然后部署生产了，小何继续B开发。
小何过了两天也完成了B，然后提交代码，自动化部署B后，发现A功能出问题了，原来小张在这两天在进行A功能小优化（`A-v0.1.1`），还未完成就“被”部署上去了。
这个故事告诉我们，需要把必须将正式（master）和开发（develop）的代码分开。

2. 现在代码分成了两个分支，小张小何都在develop开发。小张完成`A-v0.2`，要部署。合并的代码发现有小何的代码，于是问小何，小何说`我在做B-v0.2`，还没做完，你不可以合并。
所以问题还是没有解决，产品汪质问小张，为什么还不部署，这个功能很急的，小何表示压力很大。
这次，小张小何约定，从develop分支再建立分支，叫做feature分支，用来。

3...  场景太多了， 不写了
-->
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><hr>
<ol>
<li><a href="http://danielkummer.github.io/git-flow-cheatsheet/index.zh_CN.html" target="_blank" rel="external">git-flow 备忘清单</a></li>
<li><a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="external">A successful Git branching model » nvie.com</a></li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[github 上的 vim 配色项目 - solarized]]></title>
      <url>http://www.nikoai.pw/2015/11/29/linux/solarized_colors/</url>
      <content type="html"><![CDATA[<h1 id="Solarized"><a href="#Solarized" class="headerlink" title="Solarized"></a>Solarized</h1><p>Solarized是github上比较完整的支持多平台终端及GUI的配色项目，<br>支持Vim、Emacs、Xcode、IntelliJ、NetBeans、Putty、Visual Studio等工具，<br>当然支持大量编程语言或文件的语法。<br>如果感兴趣的，赶紧google “solarized your-tool “试试吧，<br>或者进入<a href="http://ethanschoonover.com/solarized" target="_blank" rel="external">官网</a>了解更多。</p>
<h2 id="for-vim"><a href="#for-vim" class="headerlink" title="for vim"></a>for vim</h2><hr>
<p>vim的配置非常简单，有两种方式：</p>
<h4 id="1-手工安装"><a href="#1-手工安装" class="headerlink" title="1. 手工安装"></a>1. 手工安装</h4><p>下载：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 任意目录下载源码</div><div class="line">git clone git://github.com/altercation/vim-colors-solarized.git</div><div class="line">cd vim-colors-solarized/colors</div><div class="line">mv solarized.vim ~/.vim/colors/</div></pre></td></tr></table></figure>
<p>修改vimrc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">syntax enable</div><div class="line">set background=dark</div><div class="line">colorscheme solarized</div></pre></td></tr></table></figure>
<p>如果不喜欢dark，可以换成<code>set background=light</code>主题。</p>
<h4 id="2-使用pathogen插件管理"><a href="#2-使用pathogen插件管理" class="headerlink" title="2. 使用pathogen插件管理"></a>2. 使用pathogen插件管理</h4><p>使用pathogen可以很好的管理插件， 解决vim文件分散、管理麻烦的问题，这也是官方推荐的方式。</p>
<p>安装pathogen</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd ~/.vim/</div><div class="line">mkdir autoload</div><div class="line">cd autoload/</div><div class="line">wget https://github.com/tpope/vim-pathogen/raw/master/autoload/pathogen.vim</div></pre></td></tr></table></figure>
<p>启用pathogen</p>
<pre><code>vim ~/.vimrc
// 增加以下内容， 注意需要在`filetype plugin indent on `之前。
call pathogen#infect()
or
execute pathogen#infect()
</code></pre><p>这样pathogen就安装好了，接下来就是下载solarized插件了。</p>
<pre><code>cd ~/.vim/bundle
git clone git://github.com/altercation/vim-colors-solarized.git
</code></pre><p>然后跟方式一的<code>修改vimrc</code>步骤一样执行。</p>
<h4 id="效果图："><a href="#效果图：" class="headerlink" title="效果图："></a>效果图：</h4><p>虽然官方文档有很多案例图，还是贴一下个人的效果图：</p>
<p><img src="/images/solarized_vim_show.png" alt=""></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>如果你希望保留之前terminal的透明度，可以在<code>～/.vimrc</code>增加以下配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">let g:solarized_termtrans=1</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://github.com/altercation/vim-colors-solarized" target="_blank" rel="external">https://github.com/altercation/vim-colors-solarized</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[【docker】 get started - with ubuntu]]></title>
      <url>http://www.nikoai.pw/2015/11/03/docker/docker_get_started/</url>
      <content type="html"><![CDATA[<p><code>docker</code> 是什么？docker 起初是dotCloud公司的一个业余项目， 是基于Go和LXC实现的一个轻量级的操作系统虚拟化方案。他可以实现更快的交付部署、更高效的虚拟化、更耿丹的迁移拓展和管理等，具体的在后面会慢慢体会到。首先我们先要把 docker 装到你的机子上，下面以 ubuntu 为例：</p>
<h1 id="docker-获取安装"><a href="#docker-获取安装" class="headerlink" title="docker 获取安装"></a>docker 获取安装</h1><hr>
<p>最新的安装说明， 请查阅 <a href="https://docs.docker.com/engine/getstarted/step_one/" target="_blank" rel="external">官方文档</a></p>
<p>首先查看 ubuntu 发行版本号， 文档上针对不同版本的系统会有一些注意事项。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ uname -r</div><div class="line">3.13.0-98-generic</div></pre></td></tr></table></figure>
<p>导入 apt key：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install apt-transport-https ca-certificates</div><div class="line">$ sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</div></pre></td></tr></table></figure>
<p>选择对应的仓库， 根据 Ubuntu version 选择 Repository：</p>
<ul>
<li>Precise 12.04 (LTS)    deb <a href="https://apt.dockerproject.org/repo" target="_blank" rel="external">https://apt.dockerproject.org/repo</a> ubuntu-precise main</li>
<li>Trusty 14.04 (LTS)    deb <a href="https://apt.dockerproject.org/repo" target="_blank" rel="external">https://apt.dockerproject.org/repo</a> ubuntu-trusty main</li>
<li>Wily 15.10    deb <a href="https://apt.dockerproject.org/repo" target="_blank" rel="external">https://apt.dockerproject.org/repo</a> ubuntu-wily main</li>
<li>Xenial 16.04 (LTS)    deb <a href="https://apt.dockerproject.org/repo" target="_blank" rel="external">https://apt.dockerproject.org/repo</a> ubuntu-xenial main</li>
</ul>
<p>选择后， 写入 docker.list：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ echo &quot;deb https://apt.dockerproject.org/repo ubuntu-trusty main&quot; | sudo tee /etc/apt/sources.list.d/docker.list</div><div class="line">$ sudo apt-get update</div><div class="line">$ apt-cache policy docker-engine</div><div class="line">docker-engine:</div><div class="line">  Installed: (none)</div><div class="line">  Candidate: 1.12.3-0~trusty</div><div class="line">  Version table:</div><div class="line">     1.12.3-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.12.2-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.12.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.12.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.11.2-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.11.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.11.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.10.3-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.10.2-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.10.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.10.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.9.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.9.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.8.3-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.8.2-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.8.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.8.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.7.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.7.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.6.2-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.6.1-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.6.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div><div class="line">     1.5.0-0~trusty 0</div><div class="line">        500 https://apt.dockerproject.org/repo/ ubuntu-trusty/main amd64 Packages</div></pre></td></tr></table></figure>
<p>对于以下版本：</p>
<ul>
<li>Ubuntu Xenial 16.04 (LTS)</li>
<li>Ubuntu Wily 15.10</li>
<li>Ubuntu Trusty 14.04 (LTS)</li>
</ul>
<p>推荐安装 <code>linux-image-extra-*</code> 内核包， 因为 <code>linux-image-extra-*</code> 包允许你使用 <code>aufs</code> 存储驱动.</p>
<p>安装如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">sudo apt-get install linux-image-extra-$(uname -r) linux-image-extra-virtual</div></pre></td></tr></table></figure>
<p>安装 docker-engine：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install docker-engine</div><div class="line">$ sudo service docker start</div></pre></td></tr></table></figure>
<h1 id="hello-world-测试一下-docker-运行情况"><a href="#hello-world-测试一下-docker-运行情况" class="headerlink" title="hello-world 测试一下 docker 运行情况"></a>hello-world 测试一下 docker 运行情况</h1><hr>
<p>由于本地没有<code>hello-world</code> 这个image， docker会去远程搜索并拉取下来。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ sudo docker run hello-world</div><div class="line">Unable to find image <span class="string">'hello-world:latest'</span> locally</div><div class="line">latest: Pulling from library/hello-world</div><div class="line">c04b14da8d14: Pull complete</div><div class="line">Digest: sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9</div><div class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</div><div class="line"></div><div class="line">Hello from Docker!</div><div class="line">This message shows that your installation appears to be working correctly.</div><div class="line"></div><div class="line">To generate this message, Docker took the following steps:</div><div class="line"> 1. The Docker client contacted the Docker daemon.</div><div class="line"> 2. The Docker daemon pulled the <span class="string">"hello-world"</span> image from the Docker Hub.</div><div class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</div><div class="line">    executable that produces the output you are currently reading.</div><div class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</div><div class="line">    to your terminal.</div><div class="line"></div><div class="line">To try something more ambitious, you can run an Ubuntu container with:</div><div class="line"> $ docker run -it ubuntu bash</div><div class="line"></div><div class="line">Share images, automate workflows, and more with a free Docker Hub account:</div><div class="line"> https://hub.docker.com</div><div class="line"></div><div class="line">For more examples and ideas, visit:</div><div class="line"> https://docs.docker.com/engine/userguide/</div></pre></td></tr></table></figure>
<p><code>Hello from Docker!
This message shows that your installation appears to be working correctly.</code></p>
<p>恭喜你， docker 正常工作。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><hr>
<h1 id="docker-user"><a href="#docker-user" class="headerlink" title="docker user"></a>docker user</h1><hr>
<blockquote>
<p>docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can access it with sudo. For this reason, docker daemon always runs as the root user.</p>
</blockquote>
<p>因为 docker daemon 绑定了unix socket 而不是 tcp socket, 而 Unix socket 一般被root所拥有，正因如此，docker daemon 总是以root身份运行。</p>
<p>为了避免总是使用<code>sudo</code>来执行， 可以创建一个<code>docker</code>group， 当 docker daemon 启动时， 会使 Unix socket 的 read/writable 拥有权设为 <code>docker</code> 组.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo groupadd docker</div><div class="line">$ sudo usermod -aG docker $USER</div><div class="line"></div><div class="line">Log out and log back in ？</div><div class="line">This ensures your user is running with the correct permissions.</div><div class="line"></div><div class="line">$ docker run hello-world</div></pre></td></tr></table></figure>
<p>上面不用<code>sudo</code>来 run hello-world， 如果失败， 会有类似下面的提示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Cannot connect to the Docker daemon. Is &apos;docker daemon&apos; running on this host?</div></pre></td></tr></table></figure>
<h1 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h1><hr>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">移除 docker-engine 包：</div><div class="line"></div><div class="line">$ sudo apt-get purge docker-engine</div><div class="line"></div><div class="line">移除 docker-engine 包及无用依赖：</div><div class="line"></div><div class="line">$ sudo apt-get autoremove --purge docker-engine</div><div class="line"></div><div class="line">移除所有 images, containers, and volumes：</div><div class="line"></div><div class="line">$ rm -rf /var/lib/docker</div></pre></td></tr></table></figure>
<h1 id="异常情况"><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h1><hr>
<h2 id="异常：执行用户不在docker组"><a href="#异常：执行用户不在docker组" class="headerlink" title="异常：执行用户不在docker组"></a>异常：执行用户不在docker组</h2><p>如果不能run，提示<code>Cannot connect to the Docker daemon. Is the docker daemon running on this host</code>，可能是没有把当前用户加入docker组。</p>
<p><code>sudo usermod -aG docker your-user</code><br><code>Log out and log back in</code></p>
<p><a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/#create-a-docker-group" target="_blank" rel="external">参考这里</a></p>
<h2 id="异常：服务未启动"><a href="#异常：服务未启动" class="headerlink" title="异常：服务未启动"></a>异常：服务未启动</h2><blockquote>
<p>docker run hello-world<br>docker: Cannot connect to the Docker daemon. Is the docker daemon running on this host?.<br>See ‘docker run –help’.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo service docker start</div><div class="line">sudo docker run hello-world</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://docs.docker.com/linux/started/" target="_blank" rel="external">https://docs.docker.com/linux/started/</a><br><a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/" target="_blank" rel="external">https://docs.docker.com/engine/installation/linux/ubuntulinux/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring配置加载顺序]]></title>
      <url>http://www.nikoai.pw/2015/11/01/java/spring/spring-boot_config_order/</url>
      <content type="html"><![CDATA[<h1 id="spring的配置加载顺序"><a href="#spring的配置加载顺序" class="headerlink" title="spring的配置加载顺序"></a>spring的配置加载顺序</h1><hr>
<p>Spring 使用了特定的配置属性加载顺序，目的在利用一些约定的配置提升框架的易用性之外，也可以被用户自定义覆盖。<br>下面是优先级顺序， 前面的可以覆盖后面的配置：</p>
<ul>
<li>Command line arguments.</li>
<li>Properties from SPRING_APPLICATION_JSON (inline JSON embedded in an environment variable or system property)</li>
<li>JNDI attributes from java:comp/env.</li>
<li>Java System properties (System.getProperties()).</li>
<li>OS environment variables.</li>
<li>A RandomValuePropertySource that only has properties in <code>random.*.</code></li>
<li>Profile-specific application properties outside of your packaged jar (application-{profile}.properties and YAML variants)</li>
<li>Profile-specific application properties packaged inside your jar (application-{profile}.properties and YAML variants)</li>
<li>Application properties outside of your packaged jar (application.properties and YAML variants).</li>
<li>Application properties packaged inside your jar (application.properties and YAML variants).</li>
<li>@PropertySource annotations on your @Configuration classes.</li>
<li>Default properties (specified using SpringApplication.setDefaultProperties).</li>
</ul>
<h1 id="配置覆写测试和验证"><a href="#配置覆写测试和验证" class="headerlink" title="配置覆写测试和验证"></a>配置覆写测试和验证</h1><hr>
<p>使用starter-web来测试：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Controller</div><div class="line">@EnableAutoConfiguration</div><div class="line">public class SampleController &#123;</div><div class="line"></div><div class="line">    @Value(&quot;$&#123;myname&#125;&quot;)</div><div class="line">    String myName;</div><div class="line"></div><div class="line">    @RequestMapping(&quot;/&quot;)</div><div class="line">    @ResponseBody</div><div class="line">    String home() &#123;</div><div class="line">        return &quot;Hello, &quot; + myName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws Exception &#123;</div><div class="line">        SpringApplication.run(SampleController.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="测试用命令行传入："><a href="#测试用命令行传入：" class="headerlink" title="测试用命令行传入："></a>测试用命令行传入：</h2><pre><code>java -jar target/app.jar --myname=&quot;niko&quot;
</code></pre><p>结果是：<code>Hello, niko</code></p>
<h2 id="测试-shell-环境变量和-java-系统变量"><a href="#测试-shell-环境变量和-java-系统变量" class="headerlink" title="测试 shell 环境变量和 java 系统变量"></a>测试 shell 环境变量和 java 系统变量</h2><pre><code>export SPRING_APPLICATION_JSON=&apos;{&quot;myname&quot;: &quot;niko_shell_env&quot;}&apos;
java -jar target/app.jar --myname=&quot;niko&quot;

or
java -jar target/app.jar -Dspring.application.json=&apos;{&quot;myname&quot;: &quot;niko_shell_env&quot;}&apos; --myname=&quot;niko&quot;

or
java -jar myapp.jar --spring.application.json=&apos;{&quot;myname&quot;: &quot;niko_shell_env&quot;}&apos; --myname=&quot;niko&quot;
</code></pre><p>结果是：<code>Hello, niko</code>, 被命令行覆盖了。</p>
<h2 id="测试application-properties："><a href="#测试application-properties：" class="headerlink" title="测试application.properties："></a>测试<code>application.properties</code>：</h2><p>application.properties：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">spring.profiles.active=dev</div><div class="line">myname=application.properties</div></pre></td></tr></table></figure>
<p>java -jar myapp.jar -Dspring.application.json=’{“myname”: “niko_shell_env”}’</p>
<p>结果是：<code>Hello, niko_shell_env</code>, 被<code>-Dspring.application.json</code>覆盖了。SPRING_APPLICATION_JSON 和 –spring.application.json 结果一样。</p>
<blockquote>
<p>值得注意的是 SPRING_APPLICATION_JSON 是会被 -Dspring.application.json 覆盖的。</p>
</blockquote>
<p>取消掉环境变量和系统变量后，结果是：<code>Hello, application.properties</code>。</p>
<h2 id="测试-config-application-dev-properties："><a href="#测试-config-application-dev-properties：" class="headerlink" title="测试 config/application-dev.properties："></a>测试 config/application-dev.properties：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">myname=application-dev.properties</div></pre></td></tr></table></figure>
<p>结果是：<code>Hello, application-dev.properties</code>， <code>application.properties</code> 被 <code>config/application-dev.properties</code> 覆盖了。</p>
<h1 id="其他细节"><a href="#其他细节" class="headerlink" title="其他细节"></a>其他细节</h1><h2 id="application-properties-的查找顺序"><a href="#application-properties-的查找顺序" class="headerlink" title="application.properties 的查找顺序"></a>application.properties 的查找顺序</h2><p>Spring会加载配置文件<code>application.properties</code>从以下位置：</p>
<ul>
<li>A <code>/config</code> subdirectory of the current directory.</li>
<li>The current directory</li>
<li>A classpath <code>/config</code> package</li>
<li>The classpath root</li>
</ul>
<p>如果你不喜欢<code>application</code>这个name，可以传入<code>--spring.config.name=othername</code>来设置，或者是使用<code>--spring.config.location=classpath:/default.properties,classpath:/override.properties</code>。<br>值得注意的是，<code>spring.config.location</code>声明的加载优先级是从低到高，即是会先加载<code>classpath:/override.properties</code>。</p>
<h2 id="占位符使用"><a href="#占位符使用" class="headerlink" title="占位符使用"></a>占位符使用</h2><p><code>application.properties</code></p>
<pre><code>app.name=MyApp
app.description=${app.name} is a Spring Boot application
</code></pre><p>这个就算是<code>app.name</code>的声明顺序倒过来也是okay的。</p>
<h2 id="部署小技巧"><a href="#部署小技巧" class="headerlink" title="部署小技巧"></a>部署小技巧</h2><p>部署时， 可以把 <code>application.properties</code> 放在 jar 包之外（用 <code>-cp path1:path2</code> 方式指定）， 这样修改配置会比较方便。而不必打开 spring boot jar（在生产环境也不容易解压和重打包）。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://docs.spring.io/autorepo/docs/spring-boot/1.3.0.M1/reference/html/boot-features-external-config.html" target="_blank" rel="external">http://docs.spring.io/autorepo/docs/spring-boot/1.3.0.M1/reference/html/boot-features-external-config.html</a><br><a href="http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html" target="_blank" rel="external">http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[git stash 使用]]></title>
      <url>http://www.nikoai.pw/2015/10/30/git/git-stash/</url>
      <content type="html"><![CDATA[<h1 id="git-stash-干嘛滴"><a href="#git-stash-干嘛滴" class="headerlink" title="git stash 干嘛滴"></a>git stash 干嘛滴</h1><p>假如你正在开发feature-01，但是依赖的一个模块代码修改了，你必须pull代码，然而你又不想commit，这时可以使用<code>git stash</code>来保存当前未commit的代码更改。</p>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><p>假设仓库已经有stash-01.txt空文件，vim stash-01.txt，你加了一行文本：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">I am developing feature-01</div></pre></td></tr></table></figure>
<p>这时同学A说，你必须pull代码，然后你微笑着用<code>git stash</code>保存当前未commit的代码：</p>
<blockquote>
<p>$ git stash<br>Saved working directory and index state WIP on develop: 80ccebf add stash file<br>HEAD is now at 80ccebf add stash file</p>
</blockquote>
<p>之后<code>git status</code>再次确认了当前状态是干净的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git st</div><div class="line">On branch develop</div><div class="line">Your branch is up-to-date with &apos;origin/develop&apos;.</div><div class="line">nothing to commit, working directory clean</div></pre></td></tr></table></figure>
<p>这时候可以放心的pull了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git pull</div><div class="line">remote: Counting objects: 4, done.</div><div class="line">remote: Compressing objects: 100% (2/2), done.</div><div class="line">remote: Total 4 (delta 1), reused 0 (delta 0)</div><div class="line">Unpacking objects: 100% (4/4), done.</div><div class="line">From git.foo.net:niko2014/GitExperiment</div><div class="line">   80ccebf..d2b1d0b  develop    -&gt; origin/develop</div><div class="line">Updating 80ccebf..d2b1d0b</div><div class="line">Fast-forward</div><div class="line"> git-stash/stash-01.txt | 1 +</div><div class="line"> 1 file changed, 1 insertion(+)</div></pre></td></tr></table></figure>
<p>这个pull操作可能修改了多个文件，很可能涉及到你刚才stash的文件，这时会发生什么呢？我们接着看：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git stash pop</div><div class="line">Auto-merging git-stash/stash-01.txt</div><div class="line">CONFLICT (content): Merge conflict in git-stash/stash-01.txt</div></pre></td></tr></table></figure>
<p>Ohhh，冲突了，这是当然的啦。就算是commit之后再pull也是会冲突，只要merge一下就好了。</p>
<p><img src="/images/git/git-stash-pop-merge.png" alt=""></p>
<p>这时你检查了一下，发现其实已经完成feature-01了，所以commit and push了。</p>
<p>之后，你开始了feature-02的开发，同样你加了一行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">common lib modified</div><div class="line">I am developing feature-01</div><div class="line">I am developing feature-02</div></pre></td></tr></table></figure>
<p>这时，同学A又让你pull代码，所以你又再次微笑着：</p>
<blockquote>
<p>$ git stash<br>Saved working directory and index state WIP on develop: 425394b feature-01 done<br>HEAD is now at 425394b feature-01 done</p>
<p>$ git pull</p>
<p>$ git stash pop</p>
<p>$ git merge</p>
</blockquote>
<p>这时候你被打断，没有commit feature-02，后来继续开发feature-03了，接着第三次pull来了：</p>
<blockquote>
<p>$ git stash<br>Saved working directory and index state WIP on develop: 7ed8d8d 2th, common lib2 modified<br>HEAD is now at 7ed8d8d 2th, common lib2 modified</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git pull</div><div class="line">remote: Counting objects: 4, done.</div><div class="line">remote: Compressing objects: 100% (3/3), done.</div><div class="line">remote: Total 4 (delta 1), reused 0 (delta 0)</div><div class="line">Unpacking objects: 100% (4/4), done.</div><div class="line">From git.foo.net:niko2014/GitExperiment</div><div class="line">   7ed8d8d..a73e880  develop    -&gt; origin/develop</div><div class="line">Updating 7ed8d8d..a73e880</div><div class="line">Fast-forward</div><div class="line"> git-stash/stash-01.txt | 1 +</div><div class="line"> 1 file changed, 1 insertion(+)</div></pre></td></tr></table></figure>
<p><img src="/images/git/git-stash-merge-not-commited-2nd.png" alt=""></p>
<p>上图， 可以发现，刚才未提交的merge结果（同学A竟然把2nd写错了⊙﹏⊙），相同的位置现在需要重新merge，这时赶紧commit &amp; push。</p>
<pre><code>$ git commit -m &quot;Add: feature-02 and 03 done&quot;
</code></pre><p>如果刚才不是同一个文件，可以stash多次，这个堆栈可以这样查看：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ git stash list</div><div class="line">stash@&#123;0&#125;: WIP on develop: 7ed8d8d 2th, common lib2 modified</div><div class="line">stash@&#123;1&#125;: WIP on develop: 425394b feature-01 done</div><div class="line">stash@&#123;2&#125;: WIP on develop: 80ccebf add stash file</div></pre></td></tr></table></figure>
<p>发现pop出来的stash还存在着，还可以切回去某一次stash：</p>
<pre><code>$ git stash apply stash@{0}
</code></pre><p>当然，你可能面临冲突，谨慎使用，看场景～～</p>
<p>#</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring-boot 简介]]></title>
      <url>http://www.nikoai.pw/2015/10/26/java/spring/spring-boot/</url>
      <content type="html"><![CDATA[<h2 id="spring-boot-是什么？"><a href="#spring-boot-是什么？" class="headerlink" title="spring-boot 是什么？"></a>spring-boot 是什么？</h2><p>每次开始一个新的spring应用，少不了要细心准备各种文件和基础配置项，配置完还要进行测试，少不了的会有配置遗漏或错误。如果是老手，可能很快的看出问题，或者有保存自己的配置模板，复制一下改一改。但毕竟是有问题的，为什么创建一个spring应用这么麻烦，为什么不向其他语言和框架脚手架等工具借鉴一下呢？正因如此，spring社区也感受到了开发者的痛点，于是退出了spring-boot这个项目。</p>
<p>spring-boot，目标是减少创建spring应用的工作量，免除繁琐的XML配置而无需生成代码，遵循<code>约定优于配置</code>的哲学，还提供许多常用的特性和功能（如内置服务器、安全、健康检查等），使开发者能够快速的创建工业级配置的spring应用。让你专心做事，不再因为配置而分心烦躁。而且就算在命令行中，也可以迅速地 get things done。</p>
<p><a href="https://github.com/spring-projects/spring-boot" target="_blank" rel="external">github传送门</a></p>
<h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><p>首先当然，除了java环境，maven和gradle之一还是要装的，毕竟需要一种构建工具（这里使用maven），spring-boot提供了许多starter和samples进行参考，下面就来体验一下。</p>
<h3 id="例：spring-web-starter"><a href="#例：spring-web-starter" class="headerlink" title="例：spring web starter"></a>例：spring web starter</h3><p>创建一个maven项目，并继承<code>spring-boot-starter-parent</code>的pom：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;parent&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.3.1.RELEASE&lt;/version&gt;</div><div class="line">&lt;/parent&gt;</div></pre></td></tr></table></figure>
<p>增加对<code>starter-web</code>的依赖：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>如果要用jetty而非tomcat，替换掉依赖即可：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div class="line">    &lt;exclusions&gt;</div><div class="line">        &lt;exclusion&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;</div><div class="line">        &lt;/exclusion&gt;</div><div class="line">    &lt;/exclusions&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-jetty&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>新建一个Controller：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@RestController</div><div class="line">@EnableAutoConfiguration</div><div class="line">public class SampleController &#123;</div><div class="line"></div><div class="line">    @RequestMapping(&quot;/&quot;)</div><div class="line">    @ResponseBody</div><div class="line">    String home() &#123;</div><div class="line">        return &quot;Hello World!&quot;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws Exception &#123;</div><div class="line">        SpringApplication.run(SampleController.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行：</p>
<pre><code>mvn spring-boot:run
</code></pre><p>这个是在命令行是使用maven运行，需要安装spring-boot插件（也可以不适用maven插件，运行main()方法亦可）：</p>
<p><code>pom.xml</code>：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;build&gt;</div><div class="line">    &lt;plugins&gt;</div><div class="line">        &lt;plugin&gt;</div><div class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div class="line">        &lt;/plugin&gt;</div><div class="line">    &lt;/plugins&gt;</div><div class="line">&lt;/build&gt;</div></pre></td></tr></table></figure></p>
<p>打开浏览器访问<a href="http://localhost:8080/" target="_blank" rel="external">http://localhost:8080/</a>，出现了熟悉的”Hello World!”。</p>
<p>从上面的sample可以感受到，<code>starter-web</code>为我们简化了许多操作，其实看一下当前的依赖tree就可以知道：</p>
<p><code>mvn dependency:tree &gt; deps.txt</code></p>
<p>依赖树：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[INFO] --- maven-dependency-plugin:2.10:tree (default-cli) @ learning-starter-web ---</div><div class="line">[INFO] org.niko.learn.spring.boot:learning-starter-web:jar:1.3.1.RELEASE</div><div class="line">[INFO] \- org.springframework.boot:spring-boot-starter-web:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    +- org.springframework.boot:spring-boot-starter:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    |  +- org.springframework.boot:spring-boot:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    |  +- org.springframework.boot:spring-boot-autoconfigure:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    |  +- org.springframework.boot:spring-boot-starter-logging:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    |  |  +- ch.qos.logback:logback-classic:jar:1.1.3:compile</div><div class="line">[INFO]    |  |  |  +- ch.qos.logback:logback-core:jar:1.1.3:compile</div><div class="line">[INFO]    |  |  |  \- org.slf4j:slf4j-api:jar:1.7.13:compile</div><div class="line">[INFO]    |  |  +- org.slf4j:jcl-over-slf4j:jar:1.7.13:compile</div><div class="line">[INFO]    |  |  +- org.slf4j:jul-to-slf4j:jar:1.7.13:compile</div><div class="line">[INFO]    |  |  \- org.slf4j:log4j-over-slf4j:jar:1.7.13:compile</div><div class="line">[INFO]    |  +- org.springframework:spring-core:jar:4.2.4.RELEASE:compile</div><div class="line">[INFO]    |  \- org.yaml:snakeyaml:jar:1.16:runtime</div><div class="line">[INFO]    +- org.springframework.boot:spring-boot-starter-tomcat:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    |  +- org.apache.tomcat.embed:tomcat-embed-core:jar:8.0.30:compile</div><div class="line">[INFO]    |  +- org.apache.tomcat.embed:tomcat-embed-el:jar:8.0.30:compile</div><div class="line">[INFO]    |  +- org.apache.tomcat.embed:tomcat-embed-logging-juli:jar:8.0.30:compile</div><div class="line">[INFO]    |  \- org.apache.tomcat.embed:tomcat-embed-websocket:jar:8.0.30:compile</div><div class="line">[INFO]    +- org.springframework.boot:spring-boot-starter-validation:jar:1.3.1.RELEASE:compile</div><div class="line">[INFO]    |  \- org.hibernate:hibernate-validator:jar:5.2.2.Final:compile</div><div class="line">[INFO]    |     +- javax.validation:validation-api:jar:1.1.0.Final:compile</div><div class="line">[INFO]    |     +- org.jboss.logging:jboss-logging:jar:3.3.0.Final:compile</div><div class="line">[INFO]    |     \- com.fasterxml:classmate:jar:1.1.0:compile</div><div class="line">[INFO]    +- com.fasterxml.jackson.core:jackson-databind:jar:2.6.4:compile</div><div class="line">[INFO]    |  +- com.fasterxml.jackson.core:jackson-annotations:jar:2.6.4:compile</div><div class="line">[INFO]    |  \- com.fasterxml.jackson.core:jackson-core:jar:2.6.4:compile</div><div class="line">[INFO]    +- org.springframework:spring-web:jar:4.2.4.RELEASE:compile</div><div class="line">[INFO]    |  +- org.springframework:spring-aop:jar:4.2.4.RELEASE:compile</div><div class="line">[INFO]    |  |  \- aopalliance:aopalliance:jar:1.0:compile</div><div class="line">[INFO]    |  +- org.springframework:spring-beans:jar:4.2.4.RELEASE:compile</div><div class="line">[INFO]    |  \- org.springframework:spring-context:jar:4.2.4.RELEASE:compile</div><div class="line">[INFO]    \- org.springframework:spring-webmvc:jar:4.2.4.RELEASE:compile</div><div class="line">[INFO]       \- org.springframework:spring-expression:jar:4.2.4.RELEASE:compile</div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>【1】 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-first-application.html" target="_blank" rel="external">https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-first-application.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kill & signal]]></title>
      <url>http://www.nikoai.pw/2015/10/22/linux/tools/kill_sign/</url>
      <content type="html"><![CDATA[<h1 id="kill-命令"><a href="#kill-命令" class="headerlink" title="kill 命令"></a>kill 命令</h1><p>使用kill可以用来终止进程，不过先要获取进程PID（可以使用ps/pstree/top/pidof等工具），向该进程发送终止信号，例如：</p>
<pre><code>kill -9 &lt;PID&gt;
</code></pre><p><code>-9</code>应该是最多人认识的信号，更多的信号及其说明可使用<code>man 7 kill</code> 或者 <code>kill -l</code>查看：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ kill -l</div><div class="line"></div><div class="line"> 1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL	 5) SIGTRAP</div><div class="line"> 6) SIGABRT	 7) SIGBUS	 8) SIGFPE	 9) SIGKILL	10) SIGUSR1</div><div class="line">11) SIGSEGV	12) SIGUSR2	13) SIGPIPE	14) SIGALRM	15) SIGTERM</div><div class="line">16) SIGSTKFLT	17) SIGCHLD	18) SIGCONT	19) SIGSTOP	20) SIGTSTP</div><div class="line">21) SIGTTIN	22) SIGTTOU	23) SIGURG	24) SIGXCPU	25) SIGXFSZ</div><div class="line">26) SIGVTALRM	27) SIGPROF	28) SIGWINCH	29) SIGIO	30) SIGPWR</div><div class="line">31) SIGSYS	34) SIGRTMIN	35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3</div><div class="line">38) SIGRTMIN+4	39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8</div><div class="line">43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12	47) SIGRTMIN+13</div><div class="line">48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14	51) SIGRTMAX-13	52) SIGRTMAX-12</div><div class="line">53) SIGRTMAX-11	54) SIGRTMAX-10	55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7</div><div class="line">58) SIGRTMAX-6	59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2</div><div class="line">63) SIGRTMAX-1	64) SIGRTMAX</div></pre></td></tr></table></figure>
<p>使用manual：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ man 7 kill</div><div class="line"></div><div class="line">...</div><div class="line">Signal     Value     Action   Comment</div><div class="line">       ──────────────────────────────────────────────────────────────────────</div><div class="line">       SIGHUP        1       Term    Hangup detected on controlling terminal</div><div class="line">                                     or death of controlling process</div><div class="line">       SIGINT        2       Term    Interrupt from keyboard</div><div class="line">       SIGQUIT       3       Core    Quit from keyboard</div><div class="line">       SIGILL        4       Core    Illegal Instruction</div><div class="line">       SIGABRT       6       Core    Abort signal from abort(3)</div><div class="line">       SIGFPE        8       Core    Floating point exception</div><div class="line">       SIGKILL       9       Term    Kill signal</div><div class="line">       SIGSEGV      11       Core    Invalid memory reference</div><div class="line">       SIGPIPE      13       Term    Broken pipe: write to pipe with no</div><div class="line">                                     readers</div><div class="line">       SIGALRM      14       Term    Timer signal from alarm(2)</div><div class="line">       SIGTERM      15       Term    Termination signal</div><div class="line">       SIGUSR1   30,10,16    Term    User-defined signal 1</div><div class="line">       SIGUSR2   31,12,17    Term    User-defined signal 2</div><div class="line">       SIGCHLD   20,17,18    Ign     Child stopped or terminated</div><div class="line"></div><div class="line">       SIGCONT   19,18,25    Cont    Continue if stopped</div><div class="line">       SIGSTOP   17,19,23    Stop    Stop process</div><div class="line">       SIGTSTP   18,20,24    Stop    Stop typed at terminal</div><div class="line">       SIGTTIN   21,21,26    Stop    Terminal input for background process</div><div class="line">       SIGTTOU   22,22,27    Stop    Terminal output for background process</div></pre></td></tr></table></figure>
<p>其实，一开始就<code>kill -9</code>不是一个好主意。默认的情况（不指定信号），kill会发送<code>SIGTERM</code>（信号15）给进程，如果一段时间后，仍未退出，才使用<code>SIGKILL</code>杀死进程。</p>
<p>因此优秀的程序都会注册SIGTERM信号的处理函数，用以做一些进程退出的准备工作，例如释放资源/写回磁盘/打印重要日志等。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[锁之MySQL和JPA]]></title>
      <url>http://www.nikoai.pw/2015/10/12/java/lock__mysql_jpa/</url>
      <content type="html"><![CDATA[<h2 id="今天"><a href="#今天" class="headerlink" title="今天"></a>今天</h2><p>今天做了一个订单状态数据修改的需求，主要工作点是要避免并发修改导致数据的错误不一致，<br>当前这个模块的技术栈，需要用到MySQL行级锁和JPA的锁规范。</p>
<h2 id="MySQL-行级锁"><a href="#MySQL-行级锁" class="headerlink" title="MySQL 行级锁"></a>MySQL 行级锁</h2><p>行级锁是粒度比较小的一种锁，它可以减少许多冲突，因为他只要锁住一行，而不是一张表。<br>（MySQL的行级锁需要使用INNODB引擎来支持，MyISAM引擎只支持表级锁）</p>
<p>首先回顾一下大学的基础知识：<br>数据库的锁，是事务在某个数据对象（如表、行等）进行操作前，对数据库发起请求，对其加锁，<br>使其不被其他事务所修改。<br>基本的锁有两种：读锁和写锁。<br>写锁，也称排它锁（ExclusiveLock，也称X锁），若事务对数据D加了X锁，则其他事务不能读取和修改D。<br>读锁，也称共享锁（ShareLock，也称S锁），若事务对数据D加了S锁，则其他事务只能对D加S锁，不能修改D。</p>
<h3 id="S-LOCK-在MySQL："><a href="#S-LOCK-在MySQL：" class="headerlink" title="S LOCK 在MySQL："></a>S LOCK 在MySQL：</h3><p><img src="/images/mysql_x_lock_demo_02.png" alt=""><br><img src="/images/mysql_x_lock_demo_04.png" alt=""><br>从上面的测试中可以发现，事务1（窗口1）加了S锁后，事务2不能加X锁和进行修改。<br>如果S锁一段时间后仍未释放就会超时，如下图：<br><img src="/images/mysql_x_lock_demo_03.png" alt=""></p>
<h3 id="X-LOCK-在MySQL："><a href="#X-LOCK-在MySQL：" class="headerlink" title="X LOCK 在MySQL："></a>X LOCK 在MySQL：</h3><p><img src="/images/mysql_x_lock_demo_01.png" alt=""></p>
<p>从上面的测试中可以发现，事务1加了X锁之后，事务2不能加S锁，但只要去掉<br><code>LOCK IN SHARE MODE</code>就可以查询了。</p>
<p>其他的场景，可用以上SQL测试验证一下。<br>（注意：当用到索引时，MySql才会使用row-lock，否则table-lock。）</p>
<h2 id="JPA-规范"><a href="#JPA-规范" class="headerlink" title="JPA 规范"></a>JPA 规范</h2><hr>
<p>看完了锁在MySQL的实现，那在Java中如何使用呢？这里以spring+JPA为例（为了方便，使用了starter-jpa）：</p>
<h3 id="JPA-锁相关规范"><a href="#JPA-锁相关规范" class="headerlink" title="JPA 锁相关规范"></a>JPA 锁相关规范</h3><p>在spring-data-jpa中，<code>@Lock + LockModeType</code> 可以为某个数据操作进行锁控制，比如用X锁：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Lock(LockModeType.PESSIMISTIC_WRITE)</div><div class="line">List&lt;MemberOrder&gt; findByOrderNo(String orderNo);</div></pre></td></tr></table></figure>
<p>可以跑一下测试：</p>
<ol>
<li>使用上面的窗口二先加S锁，不commit。</li>
<li>然后调用findByOrderNo()查询。</li>
<li>可以发现，程序抛出LockAcquisitionException异常，不能获取锁，等待超时，如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Caused by: org.hibernate.exception.LockAcquisitionException: could not extract ResultSet</div><div class="line">        at org.hibernate.dialect.MySQLDialect$1.convert(MySQLDialect.java:451)</div><div class="line">        ...</div><div class="line">Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Lock wait timeout exceeded; try restarting transaction</div><div class="line">        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</div><div class="line">        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</div><div class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">        at com.mysql.jdbc.Util.handleNewInstance(Util.java:404)</div><div class="line">        at com.mysql.jdbc.Util.getInstance(Util.java:387)</div><div class="line">        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:946)</div><div class="line">        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:3878)</div><div class="line">        at com.mysql.jdbc.MysqlIO.nextRowFast(MysqlIO.java:2090)</div><div class="line">        at com.mysql.jdbc.MysqlIO.nextRow(MysqlIO.java:1964)</div><div class="line">        at com.mysql.jdbc.MysqlIO.readSingleRowSet(MysqlIO.java:3306)</div><div class="line">        atannotation com.mysql.jdbc.MysqlIO.getResultSet(MysqlIO.java:463)</div><div class="line">        at com.mysql.jdbc.MysqlIO.readResultsForQueryOrUpdate(MysqlIO.java:3040)</div><div class="line">        at com.mysql.jdbc.MysqlIO.readAllResults(MysqlIO.java:2288)</div><div class="line">        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2681)</div><div class="line">        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2551)</div><div class="line">        at com.mysql.jdbc.PreparedStatement.executeInternal(PreparedStatement.java:1861)</div><div class="line">        at com.mysql.jdbc.PreparedStatement.executeQuery(PreparedStatement.java:1962)</div><div class="line">        at org.hibernate.engine.jdbc.internal.ResultSetReturnImpl.extract(ResultSetReturnImpl.java:82)</div><div class="line">        ... 64 more</div></pre></td></tr></table></figure>
<p>现在来看Lock和LockModeType，Lock是spring-data的annotation，<br>LockModeType属于JPA规范，可作为EntityManager的方法参数传入或者使用Query.setLockMode()或TypedQuery.setLockMode()进行设置。<br>当然使用spring-data的话，直接使用@Lock即可，如果对细节感兴趣，可以去看spring-data的源码。<br>LockModeType是一个enum，它包括：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">READ：同OPTIMISTIC</div><div class="line">WRITE：同OPTIMISTIC_FORCE_INCREMENT</div><div class="line">OPTIMISTIC：乐观锁</div><div class="line">OPTIMISTIC_FORCE_INCREMENT：乐观锁，带版本更新</div><div class="line">PESSIMISTIC_READ：悲观读 （MySQL对应： `lock in share mode`）</div><div class="line">PESSIMISTIC_WRITE：悲观写 （MySQL对应： `for update`）</div><div class="line">PESSIMISTIC_FORCE_INCREMENT：悲观写，带版本更新</div></pre></td></tr></table></figure>
<p>上面涉及到了悲观锁和乐观锁：<br>所谓悲观锁，就是对数据被其他事务修改的概率保持悲观态度，<br>因此在处理过程中，都将数据锁定。<br>而乐观锁，反过来即是保持乐观态度，认为数据被其他事务修改的概率是较低的，所以在真正提交更新的时候，<br>才去检测数据是否冲突，实现方式可以是版本号或者时间戳，这里不再赘述。</p>
<p>悲观锁能严格保证数据的正确性，但凡事有利必有弊，很多事情我们都需要去平衡。<br>如果一个并发冲突的概率不高，而使用悲观锁，会对数据库性能开销影响比较大。<br>除此之外，良好的设计也可有效地避免一些并发问题。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><hr>
<p>【1】 <a href="https://spring.io/guides/gs/accessing-data-jpa/" target="_blank" rel="external">https://spring.io/guides/gs/accessing-data-jpa/</a><br>【2】 <a href="http://docs.oracle.com/javaee/6/tutorial/doc/gkjiu.html" target="_blank" rel="external">http://docs.oracle.com/javaee/6/tutorial/doc/gkjiu.html</a><br>【3】 <a href="https://dev.mysql.com/doc/refman/5.5/en/innodb-lock-modes.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.5/en/innodb-lock-modes.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[jvm 的 gc roots 有哪些 ?]]></title>
      <url>http://www.nikoai.pw/2015/10/02/java/jvm/gc_root/</url>
      <content type="html"><![CDATA[<p>在之前的博客中, 我们提到过<code>引用树的可达性分析</code>, 用来判断是否可以进行GC, 出发点是 GC roots, 那么 GC Roots 有哪些呢 ?</p>
<p><a href="/images/java/jvm/gc-roots-01.png"></a></p>
<h1 id="GC-Roots"><a href="#GC-Roots" class="headerlink" title="GC Roots"></a>GC Roots</h1><hr>
<ul>
<li>栈中引用的本地变量</li>
<li>Class, 系统类加载器加载的, 这些不会被卸载. 但自定义类加载器加载的不是roots.</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常常量引用的对象</li>
<li>JNI 引用的本地变量</li>
<li>JNI 全局引用</li>
<li>线程, 活着的线程</li>
<li>被用于 synchronization 监视的对象</li>
<li>被 jvm 持有引用的</li>
<li>main 方法中的本地变量</li>
<li>main 线程</li>
<li>main class 的静态变量</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="https://www.dynatrace.com/resources/ebooks/javabook/how-garbage-collection-works/" target="_blank" rel="external">https://www.dynatrace.com/resources/ebooks/javabook/how-garbage-collection-works/</a><br><a href="https://www.yourkit.com/docs/80/help/gc_roots.jsp" target="_blank" rel="external">https://www.yourkit.com/docs/80/help/gc_roots.jsp</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[JVM 常用GC算法简介]]></title>
      <url>http://www.nikoai.pw/2015/10/01/java/jvm/jvm_gc_algo_introduce/</url>
      <content type="html"><![CDATA[<p>在对Java内存区域进行回收时, 我们会涉及到不同的算法, 这些算法或多或少都有自身的优缺点, 正因如此, 它们有着自己的用武之地(适合的内存区), 能在适合自己的场景下发挥长处.</p>
<h1 id="可回收判断方法"><a href="#可回收判断方法" class="headerlink" title="可回收判断方法"></a>可回收判断方法</h1><hr>
<p>在介绍回收算法前, 我们需要了解一下, 如何进行对象可回收的判断, 常见的有两种方法:</p>
<h2 id="1-引用计数"><a href="#1-引用计数" class="headerlink" title="1 引用计数:"></a>1 引用计数:</h2><p>这个方法简单高效, 但是很难解决对象循环引用的问题</p>
<h2 id="2-引用树-可达性分析"><a href="#2-引用树-可达性分析" class="headerlink" title="2 引用树 (可达性分析) :"></a>2 引用树 (可达性分析) :</h2><p>主流商用语言的主流实现中, 都是通过可达性分析(Reachability Analysis)实现的, 也有人称为引用树.<br>这个方法以<code>GC Roots</code>为起点, 当一个对象不能通过起点到达, 则说明次对象是可回收的.</p>
<p><code>GC Roots</code>包括以下几种:</p>
<ul>
<li>虚拟机栈(栈帧中的本地变量表)引用的对象</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常常量引用的对象</li>
<li>本地方法栈中JNI(Native方法)引用的对象</li>
</ul>
<p>当然, Java 引用再细说还分为<code>强引用 软引用 弱引用 虚引用</code>, 他们有特定的回收规则, 这里不再赘述.</p>
<h1 id="mark-sweep-标记-清除算法"><a href="#mark-sweep-标记-清除算法" class="headerlink" title="mark-sweep 标记-清除算法"></a>mark-sweep 标记-清除算法</h1><hr>
<p>首先介绍<code>标记-清除</code>算法, 顾名思义, 该算法分为两个阶段:</p>
<ul>
<li><p>标记<br>标记出需要回收的对象</p>
</li>
<li><p>清除<br>在标记完成后, 统一回收所有被标记的对象</p>
</li>
</ul>
<p>用图来表示会直观一点, 我们首先定义以下图例:</p>
<p><img src="/images/java/jvm-gc-algo-define-01.png" alt=""></p>
<p>算法工作过程如下:</p>
<p><img src="/images/java/jvm-gc-algo-mark-sweep-01.png" alt=""></p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>从这个回收过程看, 我们也可以发现有以下缺点:</p>
<ul>
<li>内存碎片问题<br>大量不连续的内存碎片, 如果碎片过多, 在需要分配大对象时, 无法满足连续的内存需求, 会导致提前触发GC.</li>
</ul>
<h1 id="copying-复制算法"><a href="#copying-复制算法" class="headerlink" title="copying 复制算法"></a>copying 复制算法</h1><hr>
<p>为了解决低存活率内存区的效率问题, 出现了一种”复制”算法.<br>该算法将内存分为大小相同的两部分, 只使用其中的一块, 当其内存快用完时, 将存活对象复制到另外一块, 并将使用内存切换到另外另外一块, 同时原来的整个内存块进行回收. 这种方法不用考虑内存碎片问题, 简单高效(只需移动堆顶指针, 按序分配内存).</p>
<p>算法工作过程如下:</p>
<p><img src="/images/java/jvm-gc-algo-copy-01.png" alt=""></p>
<h2 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h2><p>内存缩小到了原来的一半.</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>新生代的回收:</p>
<p>因为新生代的对象98%都是朝生夕死(根据IBM的研究), 比如Hotspot虚拟机, 有一个大的eden内存区和两个survivor区, 运行时使用eden和其中一块survivor, 默认<code>8:1</code>的eden:survivor比例.<br>即是有10%的内存会被用作第二块survivor内存. 当然, 如果survivor空间不足时, 会有其他内存如老年代进行担保, 而且survivor也并不需要很大内存.</p>
<h1 id="标记整理算法"><a href="#标记整理算法" class="headerlink" title="标记整理算法"></a>标记整理算法</h1><hr>
<p>针对老年代, mark-compact (标记整理) 算法是比较适合的.<br>标记过程和<code>标记-清除</code>算法一样, 不过回收的时候, 是会让存活对象往一端移动, 再清理掉存货对象边界外的内存.</p>
<p>算法工作过程如下:</p>
<p><img src="/images/java/jvm-gc-algo-mark-compact-01.png" alt=""></p>
<h1 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h1><hr>
<p>该算法主要思想是, 根据对象存活周期和其他特点的不同, 去选择适当的收集算法, 这个策略也在前面提到过了.<br>比如新生代存活比例小, 选择复制算法; 而老年代的存活比例高, 则采用”标记-清除”或”标记-整理”; 分代收集也算是顶层的指导策略了.</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>&lt;深入理解Java虚拟机 JVM高级特性和最佳实践&gt;.周志明</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[使用 Java 8 函数接口避免 Null Check]]></title>
      <url>http://www.nikoai.pw/2015/10/01/java/j8/java8_null_check/</url>
      <content type="html"><![CDATA[<h1 id="使用-Optional"><a href="#使用-Optional" class="headerlink" title="使用 Optional"></a>使用 <code>Optional</code></h1><hr>
<p>Optional是核心类库的新成员，用来替换null。相信大家对NPE已经司空见惯，在代码里也有不少 null check，null 这个东西也是颇有争议的， 而Optional可以消除我们这种厌恶感，鼓励我们适当时候去检查null值，防止程序崩溃。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例 :"></a>示例 :</h2><p>Shop.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class Shop &#123;</div><div class="line">    private Integer provinceId;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不使用 Java8 的 Null Check：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">if (shop.getProvinceId() != null) &#123;</div><div class="line">    ProvinceEntity productEntity = provinceJpaRepository.findOne(shop.getProvinceId());</div><div class="line">    if (productEntity != null) &#123;</div><div class="line">        shop.setProvinceName(productEntity.getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 Java8 的 Null Check：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Optional.of(shop).map(Shop::getProvinceId)</div><div class="line">                .map(id -&gt; provinceJpaRepository.findOne(id))</div><div class="line">                .ifPresent(p -&gt; shop.setProvinceName(p.getName()));</div></pre></td></tr></table></figure>
<p>对比上面的代码，可以发现使用Java8的特性，可以大大减少代码量，Optional的API文档化提高了可读性。</p>
<h2 id=""><a href="#" class="headerlink" title="#"></a>#</h2>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[edup 无线网卡驱动安装]]></title>
      <url>http://www.nikoai.pw/2015/08/22/linux/tools/edup_rtl8192cu_wireless_driver/</url>
      <content type="html"><![CDATA[<p>最近买了一个新无线网卡, 可惜在linux上用时, 总是几分钟后就断, 停止working, 于是尝试安装官方光盘中的驱动, 竟然有许多编译错误…只能在网上找驱动了~~</p>
<h1 id="查询网卡型号"><a href="#查询网卡型号" class="headerlink" title="查询网卡型号"></a>查询网卡型号</h1><p>使用<code>lsusb -v</code>查到usb无线网卡的相关信息, 如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Bus 003 Device 002: ID 0bda:8178 Realtek Semiconductor Corp. RTL8192CU 802.11n WLAN Adapter</div><div class="line">Device Descriptor:</div><div class="line">  bLength                18</div><div class="line">  bDescriptorType         1</div><div class="line">  bcdUSB               2.00</div><div class="line">  bDeviceClass            0 (Defined at Interface level)</div><div class="line">  bDeviceSubClass         0</div><div class="line">  bDeviceProtocol         0</div><div class="line">  bMaxPacketSize0        64</div><div class="line">  idVendor           0x0bda Realtek Semiconductor Corp.</div><div class="line">  idProduct          0x8178 RTL8192CU 802.11n WLAN Adapter</div><div class="line">  bcdDevice            2.00</div><div class="line">  iManufacturer           1 Realtek</div><div class="line">  iProduct                2 802.11n WLAN Adapter</div><div class="line">  iSerial                 3 00e04c000001</div><div class="line">  bNumConfigurations      1</div><div class="line">  Configuration Descriptor:</div><div class="line">    bLength                 9</div><div class="line">    bDescriptorType         2</div><div class="line">    wTotalLength           46</div><div class="line">    bNumInterfaces          1</div><div class="line">    bConfigurationValue     1</div><div class="line">    iConfiguration          0</div><div class="line">    bmAttributes         0xa0</div><div class="line">      (Bus Powered)</div><div class="line">      Remote Wakeup</div><div class="line">    MaxPower              500mA</div><div class="line">    Interface Descriptor:</div><div class="line">      bLength                 9</div><div class="line">      bDescriptorType         4</div><div class="line">      bInterfaceNumber        0</div><div class="line">      bAlternateSetting       0</div><div class="line">      bNumEndpoints           4</div><div class="line">      bInterfaceClass       255 Vendor Specific Class</div><div class="line">      bInterfaceSubClass    255 Vendor Specific Subclass</div><div class="line">      bInterfaceProtocol    255 Vendor Specific Protocol</div><div class="line">      iInterface              0</div><div class="line">      Endpoint Descriptor:</div><div class="line">        bLength                 7</div><div class="line">        bDescriptorType         5</div><div class="line">        bEndpointAddress     0x81  EP 1 IN</div><div class="line">        bmAttributes            2</div><div class="line">          Transfer Type            Bulk</div><div class="line">          Synch Type               None</div><div class="line">          Usage Type               Data</div><div class="line">        wMaxPacketSize     0x0200  1x 512 bytes</div><div class="line">        bInterval               0</div><div class="line">      Endpoint Descriptor:</div><div class="line">        bLength                 7</div><div class="line">        bDescriptorType         5</div><div class="line">        bEndpointAddress     0x02  EP 2 OUT</div><div class="line">        bmAttributes            2</div><div class="line">          Transfer Type            Bulk</div><div class="line">          Synch Type               None</div><div class="line">          Usage Type               Data</div><div class="line">        wMaxPacketSize     0x0200  1x 512 bytes</div><div class="line">        bInterval               0</div><div class="line">      Endpoint Descriptor:</div><div class="line">        bLength                 7</div><div class="line">        bDescriptorType         5</div><div class="line">        bEndpointAddress     0x03  EP 3 OUT</div><div class="line">        bmAttributes            2</div><div class="line">          Transfer Type            Bulk</div><div class="line">          Synch Type               None</div><div class="line">          Usage Type               Data</div><div class="line">        wMaxPacketSize     0x0200  1x 512 bytes</div><div class="line">        bInterval               0</div><div class="line">      Endpoint Descriptor:</div><div class="line">        bLength                 7</div><div class="line">        bDescriptorType         5</div><div class="line">        bEndpointAddress     0x84  EP 4 IN</div><div class="line">        bmAttributes            3</div><div class="line">          Transfer Type            Interrupt</div><div class="line">          Synch Type               None</div><div class="line">          Usage Type               Data</div><div class="line">        wMaxPacketSize     0x0040  1x 64 bytes</div><div class="line">        bInterval               1</div><div class="line">Device Qualifier (for other device speed):</div><div class="line">  bLength                10</div><div class="line">  bDescriptorType         6</div><div class="line">  bcdUSB               2.00</div><div class="line">  bDeviceClass            0 (Defined at Interface level)</div><div class="line">  bDeviceSubClass         0</div><div class="line">  bDeviceProtocol         0</div><div class="line">  bMaxPacketSize0        64</div><div class="line">  bNumConfigurations      1</div><div class="line">Device Status:     0x0000</div><div class="line">  (Bus Powered)</div></pre></td></tr></table></figure>
<p>可知, 这个网卡型号是<code>Realtek Semiconductor Corp. RTL8192CU 802.11n</code>, 接下来就是搜索驱动.</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>直接google上面查询到的型号, 很容易找到驱动, 接下来就是安装即可:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo add-apt-repository ppa:hanipouspilot/rtlwifi</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install rtl8192cu-dkms linux-firmware</div></pre></td></tr></table></figure>
<p>完成后要进行reboot.</p>
<h1 id="生效-amp-测试"><a href="#生效-amp-测试" class="headerlink" title="生效 &amp; 测试"></a>生效 &amp; 测试</h1><p>查看网络状态可以用<code>ethstatus</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ethstatus -i wlan0</div></pre></td></tr></table></figure>
<p>开个米神的视频测测:</p>
<p><img src="/images/linux/tools/edup-wireless-card-ethstatus-test-01.png" alt=""></p>
<p>整首&lt;恰空&gt;播放流畅稳定, 测试完美 ! :-D</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p><a href="http://askubuntu.com/questions/650887/problem-with-wifi-on-kubuntu-15-04-with-realtek-rtl8192cu-usb-dongle" target="_blank" rel="external">http://askubuntu.com/questions/650887/problem-with-wifi-on-kubuntu-15-04-with-realtek-rtl8192cu-usb-dongle</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[（随笔）shadowsocks 科学上网工具]]></title>
      <url>http://www.nikoai.pw/2015/08/22/shadowsocks/</url>
      <content type="html"><![CDATA[<p>最近网络比较“不稳定”，上google也是断断续续的，<br>三个科学上网工具 —— 红杏/VPN/shadowsocks， 已经跪了两个，只剩shadowsocks了，中国的程序员效率降低了一半以上。<br>看来平时的”冗余容错”很重要啊，几百块花得值了，T_T, 虽然两个工具暂时不能用，还好现在还能通过shadowsocks上网。</p>
<h2 id="简单原理"><a href="#简单原理" class="headerlink" title="简单原理"></a>简单原理</h2><p>当前的gfw的特征检测对shadowsocks还是没什么特别好的办法，我们可以看一下shadowsocks原理:</p>
<p><img src="/images/what-is-shadowsocks.png" alt=""></p>
<p>如上图，sslocal是你本机的一个代理，ss server是部署在国外（vps）。<br>shadowsocks使用的是socks5协议， 该协议处于OSI的会话层层，在传输层之上。<br>所以数据在ss local和ss server做了加密解密，在gfw的特征检查下就是个普通的tcp包，因此允许通过。</p>
<hr>
<h3 id="小事件"><a href="#小事件" class="headerlink" title="小事件"></a>小事件</h3><p>BTW, 在github上看到一个留言：</p>
<p><img src="/images/shadowsocks_clowwindy.jpg" alt=""></p>
<p>随便逛了一下，clowwindy大神（任职知乎）的项目还真全删了，twitter也设成私密模式了。<br>根据各大科学上网工具的公告，我也理解最近是特殊时期。<br>最后想说的和能说的是，感谢clowwindy。</p>
<hr>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<p>页面已被访问<span id="busuanzi_value_site_pv"></span>次</p>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c4a2e0d0f7d88e69bc22f35fd12b1f3f";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
<p>[1] <a href="https://tumutanzi.com/archives/13005" target="_blank" rel="external">https://tumutanzi.com/archives/13005</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[monit 监控]]></title>
      <url>http://www.nikoai.pw/2015/07/18/linux/monit/</url>
      <content type="html"><![CDATA[<p>Monit 是一个开源的非常实用的进程管理和监控工具，如Linux下的apache、nginx、MySql、FTP等服务都可以使用。</p>
<h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><hr>
<pre><code># for RedHat/CentOS/Fedora/
yum install monit
# for Ubuntu/Debian/Linux Mint
sudo apt-get install monit
</code></pre><h2 id="configure"><a href="#configure" class="headerlink" title="configure"></a>configure</h2><hr>
<pre><code>安装完后，配置文件目录如下所示：
</code></pre><p><img src="/images/etc-monit.png" alt=""></p>
<pre><code># 这个是monit的配置文件，里边记录了log位置、deamon数、监控脚本等配置。
sudo vim /etc/monit/monitrc
</code></pre><p>翻到最后，可以发现有个<code>include</code>指令，后面跟你的监控脚本的位置，这样可以避免全部脚本写在同一个地方。</p>
<pre><code>include /etc/monit/include/*
</code></pre><h2 id="for-tomcat"><a href="#for-tomcat" class="headerlink" title="for tomcat"></a>for tomcat</h2><hr>
<p>这里以tomcat为例，写一个monit脚本，实现停机时的邮件提醒和自动重启：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">set alert alertwho@foo.com</div><div class="line"></div><div class="line">set mailserver mail.×××.com</div><div class="line">  port 25</div><div class="line">  username &quot;mail&quot; password &quot;pwd&quot;</div><div class="line">  using tlsv1</div><div class="line">  with timeout 30 seconds</div><div class="line"></div><div class="line">check host tomcat with address localhost</div><div class="line">  stop program &quot;/.../bin/catalina.sh stop&quot;</div><div class="line">  start program &quot;/.../bin/catalina.sh restart&quot;</div><div class="line">  if failed port 8080 and protocol http</div><div class="line">  # then start 重启</div><div class="line">  then alert</div></pre></td></tr></table></figure>
<p>mail server 的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SET MAILSERVER &lt;hostname|ip-address [PORT number] [USERNAME string]</div><div class="line"> [PASSWORD string] [using SSLAUTO|SSLV2|SSLV3|TLSV1|TLSV11|TLSV12]</div><div class="line"> [CERTMD5 checksum]&gt;, ...</div><div class="line">   [with TIMEOUT X SECONDS]</div><div class="line">   [using HOSTNAME hostname]</div></pre></td></tr></table></figure>
<p>其他语法都很易懂。<br>monit监控tomcat的方式其实有两种，一种是检查pid文件，另一种就是上面的port检查。</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h2 id="others"><a href="#others" class="headerlink" title="others"></a>others</h2><p><a href="http://www.tecmint.com/command-line-tools-to-monitor-linux-performance/" target="_blank" rel="external">20 Command Line Tools to Monitor Linux Performance</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[vim 大法好 - 命令指南]]></title>
      <url>http://www.nikoai.pw/2015/07/01/linux/tools/vim_cmd/</url>
      <content type="html"><![CDATA[<h1 id="基本模式"><a href="#基本模式" class="headerlink" title="基本模式"></a>基本模式</h1><ul>
<li>命令模式</li>
</ul>
<p>进入vim后, 默认就是命令模式.</p>
<ul>
<li><code>input</code>模式</li>
</ul>
<p>命令模式下, 输入<code>i</code>进入input模式, <code>esc</code>返回命令模式.</p>
<h1 id="文本操作"><a href="#文本操作" class="headerlink" title="文本操作"></a>文本操作</h1><hr>
<p><code>文本选择</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>V</td>
<td>selects entire lines</td>
</tr>
<tr>
<td>v</td>
<td>selects range of text</td>
</tr>
<tr>
<td>ctrl-v</td>
<td>列选择</td>
</tr>
<tr>
<td>gv</td>
<td>重新选择上次选择的区块</td>
</tr>
</tbody>
</table>
<p><code>选择 / 复制 / 粘贴 ...</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>v(V for lines) -&gt; y  (yank)</td>
<td>选择-&gt;复制</td>
</tr>
<tr>
<td>p</td>
<td>粘贴</td>
</tr>
<tr>
<td>v -&gt; d  (delete)</td>
<td></td>
</tr>
<tr>
<td>ctrl + shift + v</td>
<td>paster from clipboard in <code>input</code> mode</td>
</tr>
<tr>
<td>ctrl + ;</td>
<td>弹出clipboard菜单, 选择一个粘贴 (<code>input</code> mode)</td>
</tr>
</tbody>
</table>
<p><code>输入</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>u</td>
<td>undo</td>
</tr>
<tr>
<td>ctrl + r</td>
<td>redo</td>
</tr>
<tr>
<td>ctrl-p or ctrl-n</td>
<td>使用当前session中的pattern来自动完成</td>
</tr>
<tr>
<td>a</td>
<td>在光标后开始编辑</td>
</tr>
<tr>
<td>o</td>
<td>当前行后面插入一个新行</td>
</tr>
<tr>
<td>O</td>
<td>当前行前面插入一个新行</td>
</tr>
<tr>
<td>cw</td>
<td>选择一个词</td>
</tr>
<tr>
<td>ctrl-v + 大写I + 字符 + esc</td>
<td>列选择插入</td>
</tr>
<tr>
<td>v + gU</td>
<td>(变大写)</td>
</tr>
<tr>
<td>v + gu</td>
<td>gu (变小写)</td>
</tr>
<tr>
<td>ye</td>
<td>复制当前光标到单词结尾的部分</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p><code>缩进</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>v or V</td>
<td>区块缩进前需要选择文本</td>
</tr>
<tr>
<td>5&gt;</td>
<td>表示右缩进5个tab</td>
</tr>
<tr>
<td><code>4&lt;</code></td>
<td>同理, 左向4个tab</td>
</tr>
</tbody>
</table>
<p><code>:set expandtab ts=4 sw=4 ai</code></p>
<p><a href="https://stackoverflow.com/questions/234564/tab-key-4-spaces-and-auto-indent-after-curly-braces-in-vim" target="_blank" rel="external">https://stackoverflow.com/questions/234564/tab-key-4-spaces-and-auto-indent-after-curly-braces-in-vim</a></p>
<p><code>浏览 / 移动</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ctrl + e</td>
<td>向下滚屏，保持光标</td>
</tr>
<tr>
<td>ctrl + y</td>
<td>向上滚屏, 保持光标</td>
</tr>
<tr>
<td>ctrl + d</td>
<td>向下, 不保持光标</td>
</tr>
<tr>
<td>ctrl + u</td>
<td>向上, 不保持光标</td>
</tr>
<tr>
<td>0 或 ^</td>
<td>跳至行头</td>
</tr>
<tr>
<td>$</td>
<td>跳至行尾</td>
</tr>
<tr>
<td>G</td>
<td>移至档尾（最后一行的第一个非空白字元处）</td>
</tr>
<tr>
<td>gg</td>
<td>移至档首（第一行之第一个非空白字元处）</td>
</tr>
<tr>
<td>ctrl+f</td>
<td>下翻页</td>
</tr>
<tr>
<td>ctrl+b</td>
<td>上翻页</td>
</tr>
<tr>
<td>w</td>
<td>移至次一个字（word）字首。当然是指英文单字。</td>
</tr>
<tr>
<td>W</td>
<td>同上，但会忽略一些标点符号。</td>
</tr>
<tr>
<td>)</td>
<td>移至下一个句子（sentence）首。</td>
</tr>
<tr>
<td>(</td>
<td>移至上一个句子（sentence）首。</td>
</tr>
<tr>
<td>}</td>
<td>移至下一个段落（paragraph）首。</td>
</tr>
<tr>
<td>{</td>
<td>移至上一个段落（paragraph）首。</td>
</tr>
</tbody>
</table>
<p><code>查找 / 替换</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>/ + your-search-string</td>
<td>搜索, 可以使用正则, 注意转义</td>
</tr>
<tr>
<td>ggn</td>
<td></td>
</tr>
<tr>
<td>GN</td>
<td>最后一个</td>
</tr>
<tr>
<td>/ + ↑或↓</td>
<td>搜索历史</td>
</tr>
<tr>
<td>:%s/源字符串/目的字符串/g</td>
<td>全局替换， <code>%</code>表示所有行</td>
</tr>
<tr>
<td>:4s/源字符串/目的字符串/g</td>
<td>替换从第4行</td>
</tr>
<tr>
<td>:1,4s/源字符串/目的字符串/g</td>
<td>替换从第1行到第4行</td>
</tr>
</tbody>
</table>
<h1 id="多窗口"><a href="#多窗口" class="headerlink" title="多窗口"></a>多窗口</h1><hr>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>:sp file_path(able to use tab)</td>
<td>新增窗口打开</td>
</tr>
<tr>
<td>:vsp file_path</td>
<td>新增窗口垂直打开</td>
</tr>
<tr>
<td>:sv</td>
<td>复制分割当前窗口</td>
</tr>
<tr>
<td>ctrl + w, s</td>
<td>复制分割当前窗口</td>
</tr>
<tr>
<td>ctrl + w, v</td>
<td>垂直, 复制分割当前窗口</td>
</tr>
<tr>
<td>ctrl w + up/down</td>
<td>切换窗口</td>
</tr>
<tr>
<td>ctrl w, w</td>
<td>循环切换窗口</td>
</tr>
<tr>
<td>ctrl w, h/j/k/l</td>
<td>按方向切换窗口</td>
</tr>
<tr>
<td>ctrl w, H/J/K/L</td>
<td>按方向移动窗口</td>
</tr>
<tr>
<td>ctrl w , q 或 c</td>
<td>关闭窗口</td>
</tr>
</tbody>
</table>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><table>
<thead>
<tr>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>:sp file_path(able to use tab)</td>
<td>新增窗口打开</td>
</tr>
<tr>
<td>:set noautoindent</td>
<td></td>
</tr>
<tr>
<td>:set number</td>
<td></td>
</tr>
<tr>
<td>:set number!</td>
<td>切换</td>
</tr>
<tr>
<td>:set number&amp;</td>
<td>Set option to default value</td>
</tr>
<tr>
<td>:set number?</td>
<td>Show value of option</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>更多请参看另一博客，将会记录常见的配置及相关命令。</p>
<h2 id="执行shell命令"><a href="#执行shell命令" class="headerlink" title="执行shell命令"></a>执行shell命令</h2><p>1.<br><code>:!command</code><br>如：</p>
<pre><code>:!ls -al
</code></pre><p>执行一个命令, 但不退出vim.</p>
<p>2.<br><code>:r !command</code><br>将shell命令command的结果插入到当前行的下一行</p>
<p>这个命令比较常用, 比如输入当前目录:</p>
<pre><code>:r !pwd
</code></pre><p>3.<br><code>:起始行号,结束行号 !command</code><br>将起始行号和结束行号指定的范围中的内容输入到shell命令command处理，并将处理结果替换起始行号和结束行号指定的范围中的内容</p>
<p>4.<br><code>:起始行号,结束行号 w !command</code><br>将起始行号和结束行号所指定的范围的内容作为命令command的输入。不会改变当前编辑的文件的内容</p>
<h2 id="编辑root权限的文件"><a href="#编辑root权限的文件" class="headerlink" title="编辑root权限的文件"></a>编辑root权限的文件</h2><p>这个功能也经常用到, 比如编辑某个root的文件(readonly)时, 忘记了sudo, 当改了很多内容才发现, 怎么办呢 ?</p>
<pre><code>:w !sudo tee %
</code></pre><p>若是sudo不能解决的, 先写到临时文件:</p>
<pre><code>:w! ~/tempfile.ext
</code></pre><h2 id="其他-待续…"><a href="#其他-待续…" class="headerlink" title="其他, 待续…"></a>其他, 待续…</h2><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>[1] <a href="http://vimgifs.com/" target="_blank" rel="external">http://vimgifs.com/</a><br>[2] <a href="http://vimcasts.org/episodes/working-with-windows/" target="_blank" rel="external">http://vimcasts.org/episodes/working-with-windows/</a><br>[3] <a href="http://blog.csdn.net/topgun_chenlingyun/article/details/8013115" target="_blank" rel="external">http://blog.csdn.net/topgun_chenlingyun/article/details/8013115</a><br>[4] <a href="http://superuser.com/questions/694450/using-vim-to-force-edit-a-file-when-you-opened-without-permissions" target="_blank" rel="external">http://superuser.com/questions/694450/using-vim-to-force-edit-a-file-when-you-opened-without-permissions</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[log 为什么使用isDebugEnable()和isTraceEnabled()]]></title>
      <url>http://www.nikoai.pw/2015/05/30/java/log_why_use_isDebug/</url>
      <content type="html"><![CDATA[<p>今天看源码，发现许多框架的log部分都会有log.isTraceEnabled()之类的判断，然后再进行调用trace()打印日志。<br>我不禁想，为什么不直接使用log.trace(),结果不是一样吗。但细细想来，肯定有原因的。</p>
<p>再看看if(isTraceEnabled()){}中的内容，有些打印日志的字符是比较多的，如果不判断直接调用的话，势必造成大量的资源消耗，如字符串拼接和对象toString()的操作。如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">if (log.isTraceEnabled()) &#123;</div><div class="line">    log.trace(&quot;attempting to get session; create = &quot; + create +</div><div class="line">            &quot;; session is null = &quot; + (this.session == null) +</div><div class="line">            &quot;; session has id = &quot; + (this.session != null &amp;&amp; session.getId() != null));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原因就是这样～～</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[spring aop 简介 & JDK 动态代理]]></title>
      <url>http://www.nikoai.pw/2015/05/01/java/spring/spring-aop/</url>
      <content type="html"><![CDATA[<h2 id="aop-简介"><a href="#aop-简介" class="headerlink" title="aop 简介"></a>aop 简介</h2><p>aop，全称：aspect-oriented programming，即是面向切面编程。<br>aop和Ioc并称为spring的两大特性，但aop有什么用呢？</p>
<p>场景一：</p>
<blockquote>
<p>对功能重复的代码，并被不同地方使用，我们都会把它简单的封装成util，以供调用。但是，我们并不能很好的灵活控制这个util的被调用。<br>假如我们需要在每次数据库操作之前或之后使用某个util记录日志，使用直接调用的话，要是有100个操作，你就需要在这100个操作前后调用log util。<br>又有可能，后来你不需要这个util了，你又需要在100个地方取消它。是不是很痛苦呢～～<br>当然，可以通过面向对象和设计模式的方法来解决一部分问题，但仍显得不够优雅和敏捷。</p>
</blockquote>
<p>当然应用场景还不仅这些，还有如session管理，验证，事务，权限等等方面都有类似的问题。</p>
<p>为了解决这些痛点，于是便有了AOP。那AOP是如何解决这个问题的呢？首先了解基本概念。</p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><hr>
<p><img src="/images/spring-pointcut.png" alt=""></p>
<p><img src="/images/aop-gif.gif" alt=""></p>
<p>以上两张图，很好的展示了AOP的工作方式，以及为什么叫切面编程。<br>这里主要涉及到几个概念：</p>
<h4 id="Advice（通知）："><a href="#Advice（通知）：" class="headerlink" title="Advice（通知）："></a>Advice（通知）：</h4><p>如图，主要描述要增强的行为，如场景一中的log行为，但不仅如此，Advice还分BeforeAdvice、AfterAdvice、ThrowsAdvice等类型。</p>
<h4 id="Pointcut（切点）："><a href="#Pointcut（切点）：" class="headerlink" title="Pointcut（切点）："></a>Pointcut（切点）：</h4><p>这个描述了Advice或切面要嵌入的位置，比如场景一中的数据库操作，其实就是一个Pointcut。</p>
<p>现在，有了Advice和Pointcut，总感觉差点什么。没错，需要一个配置器（通知器），把两者关联起来。因此定义为：</p>
<h4 id="Advisor（通知器）："><a href="#Advisor（通知器）：" class="headerlink" title="Advisor（通知器）："></a>Advisor（通知器）：</h4><p>通知器建立了Advice和Pointcut的关联，因此我们终于可以知道在某个切点要用哪个通知了。</p>
<hr>
<p>因此，场景一的AOP解决方案，以Spring Aspect（注解版）为例：</p>
<p>1, 使用spring注解，如下代码， 定义Advice，下面我们使用<code>@Before</code>注解，被标注的方法相当与一个Advice。<br>2, <code>@Before</code>注解中有个参数，这个参数定义了切点的描述，这里可以使用一些通配符来简化配置。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Aspect</div><div class="line">@Component</div><div class="line">public class LogAspect &#123;</div><div class="line"></div><div class="line">    @Before(&quot;execution(* foo.FooDao.op(..))&quot;)</div><div class="line">    public void log(JoinPoint joinPoint) &#123;</div><div class="line">        LOG.info(&quot;before ...&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用注解，好处就是省去了Advisor的配置，偷个懒～～  当然在<code>applicationContext.xml</code>中要启用<code>&lt;aop:aspectj-autoproxy/&gt;</code>和<code>&lt;context:component-scan</code>才行。<br><a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/aop.html" target="_blank" rel="external">XML 声明文档传送门</a></p>
<p>看完这个，你一定对spring aop的实现很好奇，接下来就简单看一下spring aop的工作flow吧。</p>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><hr>
<p>也许你已经猜到，要实现AOP，必须使用反射和动态代理。没错，Java的这个特性可以实现AOP。<br>spring环境下，再结合Ioc的统一对象管理，功能无比强大啊。<br>接下来我们就一起结合源码看一下aop是怎么工作的。</p>
<h3 id="生成-aop-proxy"><a href="#生成-aop-proxy" class="headerlink" title="生成 aop proxy"></a>生成 aop proxy</h3><hr>
<p>这里Ioc部分不介绍了（请参阅另一博文<code>spring Ioc</code>），直接以aop proxy生成为入口。<br>以下是主要的类，接下来让我们慢慢体会这样设计的原因：</p>
<p><img src="/images/ProxyCreatorSupport-hierarchy.png" alt=""></p>
<p>具体的aop代理对象的生成，分别是由AspectJProxyFactory、ProxyFactoryBean和ProxyFactory来完成的。</p>
<p>以ProxyFactoryBean.getObject()为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public Object getObject() throws BeansException &#123;</div><div class="line">    initializeAdvisorChain();</div><div class="line">    if (isSingleton()) &#123;</div><div class="line">        return getSingletonInstance();</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        ...</div><div class="line">        return newPrototypeInstance();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>initializeAdvisorChain()代码比较长，主要流程是 : 根据内置成员<code>interceptorNames : String[]</code>生成bean，然后namedBeanToAdvisor()转换成Advisor，<br>再调用父类AdvisedSupport.addAdvisor(Advisor)增加到通知器链<code>LinkedList&lt;Advisor&gt;</code>中，后面也会对这部分进行更详细介绍。</p>
<p>结合上面的class hierarchy图，可知AdvisedSupport主要封装了对通知和通知器的相关操作（从命名也可以知道），这些操作对不同的代理对象应该是一致的，<br>而代理对象的生成，是交给子类去实现的，<code>ProxyCreatorSupport</code>则协助子类进行proxy的生成。</p>
<p>而生成的proxy, 可以是singleton或者prototype，这个功能都是由AopProxy完成的。<br>而这个AopProxy是由AopProxyFactory创建，这部分代码在ProxyCreatorSupport中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// ProxyCreatorSupport.java</div><div class="line">protected final synchronized AopProxy createAopProxy() &#123;</div><div class="line">    if (!this.active) &#123;</div><div class="line">        activate();</div><div class="line">    &#125;</div><div class="line">    return getAopProxyFactory().createAopProxy(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中getAopProxyFactory()，即this.aopProxyFactory，是spring封装的DefaultAopProxyFactory：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public ProxyCreatorSupport() &#123;</div><div class="line">    this.aopProxyFactory = new DefaultAopProxyFactory();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DefaultAopProxyFactory createAopProxy()会根据target class是否接口来选择不同的生成方式(下图)。<br>如果是接口，则使用jdk动态代理；否则使用cglib，如下所示：<br>所以，上面提到的AopProxy是一个接口，它有两个实现：CglibAopProxy和JdkDynamicAopProxy。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123;</div><div class="line">    if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</div><div class="line">        Class targetClass = config.getTargetClass();</div><div class="line">        if (targetClass == null) &#123;</div><div class="line">            throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; +</div><div class="line">                    &quot;Either an interface or a target is required for proxy creation.&quot;);</div><div class="line">        &#125;</div><div class="line">        if (targetClass.isInterface()) &#123;</div><div class="line">            return new JdkDynamicAopProxy(config);</div><div class="line">        &#125;</div><div class="line">        return CglibProxyFactory.createCglibProxy(config);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        return new JdkDynamicAopProxy(config);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jdk和cglib的生成方式这里略过，感兴趣的话查看<code>new JdkDynamicAopProxy(AdvisedSupport)</code>和<code>CglibProxyFactory.createCglibProxy(config)</code>即可。</p>
<h3 id="拦截器调用"><a href="#拦截器调用" class="headerlink" title="拦截器调用"></a>拦截器调用</h3><hr>
<p>生成代理完成时，相关的拦截器已经配置完成了，现在只需在代理对象调用时回调这些拦截器即可，Jdk和cglib的代理和回调有些不同。</p>
<p>这里以大家熟悉的jdk dynamic proxy为例，如下图，JdkDynamicAopProxy实现了InvocationHandler：</p>
<p><img src="/images/JdkDynamicAopProxy.png" alt=""></p>
<p>invoke()的源码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</div><div class="line">    MethodInvocation invocation;</div><div class="line">    Object oldProxy = null;</div><div class="line">    boolean setProxyContext = false;</div><div class="line"></div><div class="line">    TargetSource targetSource = this.advised.targetSource;</div><div class="line">    Class&lt;?&gt; targetClass = null;</div><div class="line">    Object target = null;</div><div class="line"></div><div class="line">    ...</div><div class="line">    // Get the interception chain for this method.</div><div class="line">    List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</div><div class="line"></div><div class="line">    // Check whether we have any advice. If we don&apos;t, we can fallback on direct</div><div class="line">    // reflective invocation of the target, and avoid creating a MethodInvocation.</div><div class="line">    if (chain.isEmpty()) &#123;</div><div class="line">        // We can skip creating a MethodInvocation: just invoke the target directly</div><div class="line">        // Note that the final invoker must be an InvokerInterceptor so we know it does</div><div class="line">        // nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</div><div class="line">        retVal = AopUtils.invokeJoinpointUsingReflection(target, method, args);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        // We need to create a method invocation...</div><div class="line">        invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</div><div class="line">        // Proceed to the joinpoint through the interceptor chain.</div><div class="line">        retVal = invocation.proceed();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上可知，<code>chain</code>是通过<code>AdvisedSupport</code>（this.advised）的getInterceptorsAndDynamicInterceptionAdvice()获取的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(Method method, Class targetClass) &#123;</div><div class="line">    MethodCacheKey cacheKey = new MethodCacheKey(method);</div><div class="line">    List&lt;Object&gt; cached = this.methodCache.get(cacheKey);</div><div class="line">    if (cached == null) &#123;</div><div class="line">        cached = this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice(</div><div class="line">                this, method, targetClass);</div><div class="line">        this.methodCache.put(cacheKey, cached);</div><div class="line">    &#125;</div><div class="line">    return cached;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中，this.advisorChainFactory是一个叫DefaultAdvisorChainFactory的工厂，主要实现了拦截器链的获取。<br>而且，会注册到<code>AdvisorAdapterRegistry</code>接口的实现<code>DefaultAdvisorAdapterRegistry</code>中。<br>DefaultAdvisorAdapterRegistry的构造器如下所示，可以看到，这里注册了一些常见的AdviceAdapter：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public DefaultAdvisorAdapterRegistry() &#123;</div><div class="line">    registerAdvisorAdapter(new MethodBeforeAdviceAdapter());</div><div class="line">    registerAdvisorAdapter(new AfterReturningAdviceAdapter());</div><div class="line">    registerAdvisorAdapter(new ThrowsAdviceAdapter());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/AdvisorAdapter-hierarchy.png" alt=""></p>
<p>上面这些adapters，主要有两个作用，以<code>AfterReturningAdviceAdapter</code>为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class AfterReturningAdviceAdapter implements AdvisorAdapter, Serializable &#123;</div><div class="line"></div><div class="line">    public boolean supportsAdvice(Advice advice) &#123;</div><div class="line">        return (advice instanceof AfterReturningAdvice);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MethodInterceptor getInterceptor(Advisor advisor) &#123;</div><div class="line">        AfterReturningAdvice advice = (AfterReturningAdvice) advisor.getAdvice();</div><div class="line">        return new AfterReturningAdviceInterceptor(advice);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>作用之一是判断某个Advice属于什么类型;还有就是返回相对应的AdviceInterceptor。</p>
<p>advice的实现其实也是拦截器(实现了MethodInterceptor)，如下所示：</p>
<p><img src="/images/AdviceInterceptor.png" alt=""></p>
<p>和上面保持一致，以AfterReturingInterceptor为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public Object invoke(MethodInvocation mi) throws Throwable &#123;</div><div class="line">    Object retVal = mi.proceed();</div><div class="line">    this.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());</div><div class="line">    return retVal;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>回到<code>JdkDynamicAopProxy.invoke()</code>，其中的ReflectiveMethodInvocation.proceed()就是链调用主要入口, 如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">public Object proceed() throws Throwable &#123;</div><div class="line">    //  We start with an index of -1 and increment early.</div><div class="line">    if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</div><div class="line">        return invokeJoinpoint();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Object interceptorOrInterceptionAdvice =</div><div class="line">            this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</div><div class="line">    if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</div><div class="line">        // Evaluate dynamic method matcher here: static part will already have</div><div class="line">        // been evaluated and found to match.</div><div class="line">        InterceptorAndDynamicMethodMatcher dm =</div><div class="line">                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</div><div class="line">        if (dm.methodMatcher.matches(this.method, this.targetClass, this.arguments)) &#123;</div><div class="line">            return dm.interceptor.invoke(this);</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            // Dynamic matching failed.</div><div class="line">            // Skip this interceptor and invoke the next in the chain.</div><div class="line">            return proceed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        // It&apos;s an interceptor, so we just invoke it: The pointcut will have</div><div class="line">        // been evaluated statically before this object was constructed.</div><div class="line">        return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面主要是遍历每个 interceptorOrInterceptionAdvice，并调用相应的拦截器，这样串起来，整个流程就清晰了。<br>其中InterceptorAndDynamicMethodMatcher组合MethodInterceptor和MethodMatcher，使其作为通知链的一个element使用，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class InterceptorAndDynamicMethodMatcher &#123;</div><div class="line"></div><div class="line">    final MethodInterceptor interceptor;</div><div class="line"></div><div class="line">    final MethodMatcher methodMatcher;</div><div class="line"></div><div class="line">    public InterceptorAndDynamicMethodMatcher(MethodInterceptor interceptor, MethodMatcher methodMatcher) &#123;</div><div class="line">        this.interceptor = interceptor;</div><div class="line">        this.methodMatcher = methodMatcher;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上就是ProxyFactoryBean调用的主要流程，只是一个大概的流程，看源码的话，spring会有许多细节验证和处理。不过阅读时，一定要抓住重要的主线，还有熟悉常见的设计模式，这会让你有个全景的认识和理解。</p>
<h2 id="DIY-属于自己的AOP"><a href="#DIY-属于自己的AOP" class="headerlink" title="DIY 属于自己的AOP"></a>DIY 属于自己的AOP</h2><p>// TODO still in drafts 。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Python Scrapy 爬虫初体验]]></title>
      <url>http://www.nikoai.pw/2015/03/30/python/python_scrapy_get_started/</url>
      <content type="html"><![CDATA[<p>之前写爬虫都是用Java，换成Python来写，开发速度应该会更快，今天就来试试。</p>
<h1 id="初体验"><a href="#初体验" class="headerlink" title="初体验"></a>初体验</h1><hr>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><hr>
<p>首先，安装Python（for Ubuntu）:</p>
<pre><code>sudo apt-get install python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev libffi-dev libssl-dev
</code></pre><p>安装<a href="https://pip.pypa.io/en/latest/installing/" target="_blank" rel="external">pip</a>，pip类似Java的Maven</p>
<p>安装使用虚拟环境：</p>
<pre><code>sudo pip install virtualenv
virtualenv foo_env
source ./foo_env/bin/active
</code></pre><p>安装scrapy (1.4.0)：</p>
<pre><code>pip install scrapy
</code></pre><h1 id="scrapy-架构"><a href="#scrapy-架构" class="headerlink" title="scrapy 架构"></a>scrapy 架构</h1><p>Scrapy 的架构图如下所示，有个大概的印象即可，以后会陆续使用到：</p>
<p><img src="/images/scrapy_architecture.png" alt=""></p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><hr>
<p>写一个小爬虫，来获取一个网页的所有图片：</p>
<p>进入一个新建目录，生成项目结构：</p>
<pre><code>scrapy startproject hello
</code></pre><p>目录结构：</p>
<pre><code>.
├── hello
│   ├── __init__.py
│   ├── items.py
│   ├── pipelines.py
│   ├── settings.py
│   └── spiders
│       └── __init__.py
└── scrapy.cfg
</code></pre><p>首先，我们定义要crawl的东西，会把它封装成一个Item，传递给框架的其他组件处理：</p>
<p><code>hello/items.py</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">import scrapy</div><div class="line"></div><div class="line"></div><div class="line">class HelloItem(scrapy.Item):</div><div class="line">    # define the fields for your item here like:</div><div class="line">    link = scrapy.Field()</div></pre></td></tr></table></figure>
<p>这个Item只定义了一个属性<code>link</code>，来保存图片链接。</p>
<p>接下来编写Spider：</p>
<p>新建<code>hello/spiders/img_spider.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">from</span> hello.items <span class="keyword">import</span> HelloItem</div><div class="line"></div><div class="line">__author__ = <span class="string">'niko'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> scrapy</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloSpider</span><span class="params">(scrapy.Spider)</span>:</span></div><div class="line">    name = <span class="string">"img"</span></div><div class="line">    allowed_domains = [<span class="string">"moegirl.org"</span>]</div><div class="line">    start_urls = [</div><div class="line">        <span class="string">"https://zh.moegirl.org/index.php?title=%E7%BB%AB%E6%B3%A2%E4%B8%BD&amp;mobileaction=toggle_view_desktop"</span>,</div><div class="line">    ]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></div><div class="line">        title = response.xpath(<span class="string">'//title/text()'</span>).extract()[<span class="number">0</span>]</div><div class="line">        <span class="comment"># TODO make dir with value of title</span></div><div class="line">        items = []</div><div class="line">        <span class="keyword">for</span> image_link <span class="keyword">in</span> response.xpath(<span class="string">'//img/@src'</span>).extract():</div><div class="line">            item = HelloItem()</div><div class="line">            item[<span class="string">'link'</span>] = image_link</div><div class="line">            items.append(item)</div><div class="line">        <span class="keyword">return</span> items</div></pre></td></tr></table></figure>
<p>上面的代码是使用xpath的选择器，简单的选取了<code>img</code>标签的src属性，并构造了HelloItem实例，传递给框架的pipelines来处理，下面我们看一下pipelines：</p>
<p><code>hello/pipelines.py</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class HelloPipeline(object):</div><div class="line">    def process_item(self, item, spider):</div><div class="line">        print &apos;\n\n processing image =&gt; &apos; + item[&apos;link&apos;]</div><div class="line">        return item</div></pre></td></tr></table></figure>
<p>上面定义了一个HelloPipeline，第二个参数<code>item</code>就是我们刚才构造的HelloItem；在process_item()方法中，我们通常会做如下处理：</p>
<ul>
<li>清洗数据</li>
<li>验证数据</li>
<li>数据去重</li>
<li>持久化数据</li>
<li>～～～</li>
</ul>
<p>写好自定义的Pipeline之后，我们还需要在<code>settings.py</code>注册：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ITEM_PIPELINES = &#123;</div><div class="line">   &apos;hello.pipelines.HelloPipeline&apos;: 300</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>300</code>是多个pipelines执行的顺序值。</p>
<p>现在可以执行刚才定义的<code>img</code>小蜘蛛了：</p>
<pre><code>scrapy crawl img
</code></pre><p>在console可以看到我们我们爬取网页的所有图片URL了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在这个小例子中，只涉及到了架构图中的Spider和Pipeline，这些middleware还需要更深入的学习和实践。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><hr>
<p>【1】<a href="http://doc.scrapy.org/en/latest/intro/tutorial.html" target="_blank" rel="external">http://doc.scrapy.org/en/latest/intro/tutorial.html</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[slf4j 绑定机制浅析]]></title>
      <url>http://www.nikoai.pw/2015/03/03/java/slf4j/</url>
      <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Simple Logging Facade for Java， 顾名思义，它是作为一个许多logging库（如log4j，logback，commons-logging等）的简单门面，提供一个简单统一的接口，从而使得最终用户能够很方便的使用和切换想要的logging实现。</p>
<p>可能你还是要问， 为什么要使用slf4j呢？<br>举个例子，如果你直接用log4j来写日志，你的代码里有100个地方是这样做的。<br>现在你想换成logback或其他的日志实现，你就需要修改100个地方。<br>而如果使用slf4j来写入日志，因为多了一层绑定的过程，你只要切换你的依赖即可。</p>
<p>使用slf4j很简单，只要加入slf4j-api-xxx.jar、第三方日志实现及其binding包的依赖即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;!-- slf4j api --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;!-- logback binding --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;logback.version&#125;&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;!-- logback impl --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;logback-core&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;logback.version&#125;&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>接下来， 你就可以“hello world”啦！</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line">public class HelloWorld &#123;</div><div class="line">  public static void main(String[] args) &#123;</div><div class="line">    Logger logger = LoggerFactory.getLogger(HelloWorld.class);</div><div class="line">    logger.info(&quot;Hello World&quot;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据slf4j的介绍，</p>
<blockquote>
<p>each SLF4J binding is hardwired at compile time to use one and only one specific logging framework</p>
</blockquote>
<p>它是静态绑定的， 接下来，让我们一起来揭开绑定的神秘面纱吧。</p>
<h2 id="绑定原理"><a href="#绑定原理" class="headerlink" title="绑定原理"></a>绑定原理</h2><p>这是官网的一张图, 这里展示了常见的一些log实现和绑定：</p>
<p><img src="/images/slf4j-concrete-bindings.png" alt=""></p>
<p>前面说过， slf4j是在静态绑定， 为什么这么说呢？ 答案就在绑定实现的包中， 如下：</p>
<p>logback-classic.jar<br><img src="/images/logback-jar.png" alt=""></p>
<p>slf4j-log4j.jar<br><img src="/images/slf4j-log4j.png" alt=""></p>
<p>如上图，可以发现都有<code>org.slf4j.impl.StaticLoggerBinder</code>,<br>再看LoggerFactory.getLogger()时，即<code>org.slf4j.LoggerFactory.getILoggerFactory</code>的调用hierarchy：</p>
<p><img src="/images/slf4j_LoggerFactory_bind_called.png" alt=""></p>
<p>其中bind()内部是我们想要的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"></div><div class="line">private final static void bind() &#123;</div><div class="line">  try &#123;</div><div class="line">    Set staticLoggerBinderPathSet = findPossibleStaticLoggerBinderPathSet();</div><div class="line">    reportMultipleBindingAmbiguity(staticLoggerBinderPathSet);</div><div class="line">    // the next line does the binding</div><div class="line">    StaticLoggerBinder.getSingleton();</div><div class="line">    INITIALIZATION_STATE = SUCCESSFUL_INITIALIZATION;</div><div class="line">    reportActualBinding(staticLoggerBinderPathSet);</div><div class="line">    emitSubstituteLoggerWarning();</div><div class="line">  &#125; catch (NoClassDefFoundError ncde) &#123;</div><div class="line">    String msg = ncde.getMessage();</div><div class="line">    if (messageContainsOrgSlf4jImplStaticLoggerBinder(msg)) &#123;</div><div class="line">      INITIALIZATION_STATE = NOP_FALLBACK_INITIALIZATION;</div><div class="line">      Util.report(&quot;Failed to load class \&quot;org.slf4j.impl.StaticLoggerBinder\&quot;.&quot;);</div><div class="line">      Util.report(&quot;Defaulting to no-operation (NOP) logger implementation&quot;);</div><div class="line">      Util.report(&quot;See &quot; + NO_STATICLOGGERBINDER_URL</div><div class="line">              + &quot; for further details.&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">      failedBinding(ncde);</div><div class="line">      throw ncde;</div><div class="line">    &#125;</div><div class="line">  &#125; catch (java.lang.NoSuchMethodError nsme) &#123;</div><div class="line">    String msg = nsme.getMessage();</div><div class="line">    if (msg != null &amp;&amp; msg.indexOf(&quot;org.slf4j.impl.StaticLoggerBinder.getSingleton()&quot;) != -1) &#123;</div><div class="line">      INITIALIZATION_STATE = FAILED_INITIALIZATION;</div><div class="line">      Util.report(&quot;slf4j-api 1.6.x (or later) is incompatible with this binding.&quot;);</div><div class="line">      Util.report(&quot;Your binding is version 1.5.5 or earlier.&quot;);</div><div class="line">      Util.report(&quot;Upgrade your binding to version 1.6.x.&quot;);</div><div class="line">    &#125;</div><div class="line">    throw nsme;</div><div class="line">  &#125; catch (Exception e) &#123;</div><div class="line">    failedBinding(e);</div><div class="line">    throw new IllegalStateException(&quot;Unexpected initialization failure&quot;, e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如代码，绑定方法bind()，首先通过<code>findPossibleStaticLoggerBinderPathSet()：staticLoggerBinderPathSet</code>来获取classpath中可能的binder paths, 如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Enumeration&lt;URL&gt; ClassLoader.getSystemResources(String STATIC_LOGGER_BINDER_PATH)</div></pre></td></tr></table></figure></p>
<p>其中STATIC_LOGGER_BINDER_PATH = “org/slf4j/impl/StaticLoggerBinder.class”。</p>
<h3 id="多个绑定存在的情况"><a href="#多个绑定存在的情况" class="headerlink" title="多个绑定存在的情况"></a>多个绑定存在的情况</h3><p>当发生多个绑定同时存在时，官方的说明是这样的：</p>
<blockquote>
<p>The warning emitted by SLF4J is just that, a warning. Even when multiple bindings are present, SLF4J will pick one logging framework/implementation and bind with it. The way SLF4J picks a binding is determined by the JVM and for all practical purposes should be considered random.</p>
</blockquote>
<p>实际运行结果并结合以上代码，当返回的URL有多个时，reportMultipleBindingAmbiguity()会打印出警告：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Class path contains multiple SLF4J bindings.</div><div class="line">Found binding in [jar:file:/home/niko/.m2/repository/.../logback-classic-1.1.3.jar!/org/slf4j/impl/StaticLoggerBinder.class[]</div><div class="line">Found binding in [...]</div></pre></td></tr></table></figure>
<p>然后reportActualBinding()再打印出真正被加载的<code>StaticLoggerBinder</code>的class name，比如：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Actual binding is of type [org.slf4j.impl.Log4jLoggerFactory]</div></pre></td></tr></table></figure></p>
<p>为了避免这种问题，可以使用maven的全局排除依赖来保证只会出现某一个实现。</p>
<blockquote>
<p>more info -&gt; <a href="http://www.slf4j.org/codes.html" target="_blank" rel="external">http://www.slf4j.org/codes.html</a></p>
</blockquote>
<h2 id="MDC-Mapped-Diagnostic-Context"><a href="#MDC-Mapped-Diagnostic-Context" class="headerlink" title="MDC (Mapped Diagnostic Context )"></a>MDC (Mapped Diagnostic Context )</h2><p>这个功能只有log4j和logback支持。<br>具体内容请查看log4j和logback部分。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[maven 模块聚合与继承]]></title>
      <url>http://www.nikoai.pw/2015/01/02/java/maven/maven_aggregate/</url>
      <content type="html"><![CDATA[<p>在开发中，出于分工和设计和管理上的原因，我们无可避免地要进行分模块开发。<br>虽然OSGi、Jigsaw都有涉及到模块化，但常见的应用中，我们会使用一些构建工具（如maven）进行模块的管理。</p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>举个例子（<a href="https://github.com/niko2014/blog-demo/tree/master/java/maven-aggregator-quick-start" target="_blank" rel="external">示例代码</a>），假设有两个模块：<br>user-model，用来定义用户的领域对象;<br>user-service，用来定义用户相关的业务操作，并依赖<code>user-model</code>模块。</p>
<p>如今我们需要构建这个项目，如果没有模块之间没有关联，可能需要cd到每个模块，进行<code>mvn package</code>，build我们想要的模块。<br>而且这些依赖模块代码若有更新，手工去重新build，明显是不现实的。</p>
<p>为了解决这个痛点，maven为我们提供了聚合模块的功能。</p>
<p>在maven中，我们只需要：</p>
<h3 id="1-定义一个-pom-packaging类型的module"><a href="#1-定义一个-pom-packaging类型的module" class="headerlink" title="1. 定义一个 pom packaging类型的module"></a>1. 定义一个 <code>pom</code> packaging类型的module</h3><p>模块暂且称为<code>user-aggregator</code>，<br>并在<code>user-aggregator/pom.xml</code>中定义其他模块成员的信息（<code>&lt;modules&gt;</code>）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;groupId&gt;org.niko.blog.demo.aggregator&lt;/groupId&gt;</div><div class="line">&lt;artifactId&gt;user-aggregator&lt;/artifactId&gt;</div><div class="line">&lt;packaging&gt;pom&lt;/packaging&gt;</div><div class="line">&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;</div><div class="line">...</div><div class="line">&lt;modules&gt;</div><div class="line">    &lt;module&gt;user-model&lt;/module&gt;</div><div class="line">    &lt;module&gt;../user-service&lt;/module&gt;</div><div class="line">&lt;/modules&gt;</div></pre></td></tr></table></figure>
<p>说明一下，maven 的聚合模块可以使用两种结构：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">- 父子结构  </div><div class="line">| aggregator</div><div class="line">|-- son1  </div><div class="line">|-- son2</div><div class="line"></div><div class="line">- 平行结构</div><div class="line">|--aggregator  </div><div class="line">|--son1  </div><div class="line">|--son2</div></pre></td></tr></table></figure></p>
<p>然而像上面那样混合使用也是可以的，目录结构类似下面：</p>
<p><img src="/images/demo_user_modules_aggregate.png" alt=""></p>
<p>个人经验来说，平行结构的一个好处就是，当你的不同模块在不同git仓库时，平行模块会比较适合。<br>即son1和son2是两个git仓库，这时候平行结构可以使其互不影响，这种场景在开发中还是经常会有的。</p>
<h3 id="2-子项目增加parent的声明："><a href="#2-子项目增加parent的声明：" class="headerlink" title="2. 子项目增加parent的声明："></a>2. 子项目增加parent的声明：</h3><p>user-model/pom.xml 模块：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;parent&gt;</div><div class="line">      &lt;groupId&gt;org.niko.blog.demo.aggregator&lt;/groupId&gt;</div><div class="line">      &lt;artifactId&gt;user-aggregator&lt;/artifactId&gt;</div><div class="line">      &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;</div><div class="line">      &lt;relativePath&gt;../pom.xml&lt;/relativePath&gt;</div><div class="line">  &lt;/parent&gt;</div></pre></td></tr></table></figure></p>
<p>user-service/pom.xml 模块：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;parent&gt;</div><div class="line">      &lt;groupId&gt;org.niko.blog.demo.aggregator&lt;/groupId&gt;</div><div class="line">      &lt;artifactId&gt;user-aggregator&lt;/artifactId&gt;</div><div class="line">      &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;</div><div class="line">      &lt;relativePath&gt;../user-aggregator/pom.xml&lt;/relativePath&gt;</div><div class="line">  &lt;/parent&gt;</div></pre></td></tr></table></figure></p>
<h3 id="3-构建所有模块"><a href="#3-构建所有模块" class="headerlink" title="3. 构建所有模块"></a>3. 构建所有模块</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[INFO] Scanning for projects...</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Reactor Build Order:</div><div class="line">[INFO]</div><div class="line">[INFO] user-aggregator</div><div class="line">[INFO] user-model</div><div class="line">[INFO] user-service</div><div class="line">...</div><div class="line">...</div><div class="line">[INFO] Reactor Summary:</div><div class="line">[INFO]</div><div class="line">[INFO] user-aggregator ................................... SUCCESS [3.804s]</div><div class="line">[INFO] user-model ........................................ SUCCESS [33.208s]</div><div class="line">[INFO] user-service ...................................... SUCCESS [2.032s]</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div></pre></td></tr></table></figure>
<h2 id="Reactor-反应堆"><a href="#Reactor-反应堆" class="headerlink" title="Reactor 反应堆"></a>Reactor 反应堆</h2><hr>
<p>细心的童鞋已经发现，上面一次构建的输出信息中有<code>Reactor Build Order</code>这几个单词，那这又是什么东西呢？<br>翻译过来就是反应堆，顾名思义，表示所有模块组成的一个构建集合（一个模块可以看做一个反应堆）。<br>不过反应堆还包含了模块间的依赖和继承，并会计算出构建顺序。</p>
<h3 id="裁剪反应堆"><a href="#裁剪反应堆" class="headerlink" title="裁剪反应堆"></a>裁剪反应堆</h3><p>上面的操作，是构建所有模块。那如果现在我想只构建某个模块（不构建没用到的模块）呢？这时就应该裁剪反应堆了。</p>
<h4 id="具体使用"><a href="#具体使用" class="headerlink" title="具体使用"></a>具体使用</h4><p>&lt;！–<br>Maven 3.2.1 has added this feature, you can use -pl ! for exclude certain modules. This can be comma separated list of values that you want to include/exclude, exc<br>–&gt;</p>
<p>假设user-service依赖user-model，现在使用裁剪反应堆来构建user-service，user-model也会被自动构建：</p>
<pre><code>/.../user-aggregator/$ `mvn clean package -pl ../user-service -am`
</code></pre><p>参数说明：</p>
<pre><code>Options:
-amd,--also-make-dependents：构建依赖于指定模块的模块
-rf,--resume-from：从构建顺序的某个模块开始构建
-pl，--projects: 构建指定的模块，模块间用逗号分割
-am，--also-make : 同时构健模块的所依赖的模块
</code></pre><h2 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h2><hr>
<p>从上面介绍可以发现，使用聚合模块和继承有以下好处：</p>
<ol>
<li>配置重用（继承）；</li>
<li>依赖和插件统一管理，如dependencyManagement和pluginManagement；</li>
<li>自动分析和构建依赖，而且方便自身项目的version管理。</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><hr>
<p>【1】<a href="https://maven.apache.org/guides/mini/guide-multiple-modules.html" target="_blank" rel="external">https://maven.apache.org/guides/mini/guide-multiple-modules.html</a><br>【2】Maven实战.徐晓斌</p>
]]></content>
    </entry>
    
  
  
</search>
